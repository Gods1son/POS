
<template>
    <div class="page">
        <div class="navbar">
            <div class="navbar navbar-bg"></div>
            <div class="navbar-inner sliding">
              <div class="left">
                <a href="#" class="link back">
                  <i class="icon icon-back"></i>
                  <span class="if-not-md">Back</span>
                </a>
              </div>
              <div class="title">Settings</div>
            </div>
          </div>

            <div class="page-content">
                <div class="list no-hairlines-md margin-top-half">
                    <div class="block-title text-color-black no-margin-bottom margin-left-half no-padding-bottom margin-top-half">Company Info and Taxes</div>
                    <div class="block-header no-margin-vertical margin-horizontal-half no-padding-horizontal">The information is used for invoicing!</div>
                    <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company Name</div>
                          <div class="item-input-wrap">
                            <input id="companyname" type="text" class="settingsInput" placeholder="Company Name">
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company Address</div>
                          <div class="item-input-wrap">
                            <textarea class="settingsInput" id="companyaddress" placeholder="Company Address"></textarea>
                            <!--<input id="companyaddress" type="text" placeholder="Company Address">-->
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Currency</div>
                          <div class="item-input-wrap">
                            <input id="autocomplete-dropdown-all" class="settingsInput" type="text" placeholder="Currency">
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Taxes in percentage (do not include %)</div>
                          <div class="item-input-wrap">
                            <input id="taxes" type="text" class="settingsInput" placeholder="Enter % taxes">
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-input-wrap">
                            <a id="savecompanyinfo" class="button button-fill button-raised bg-color-green" @click="savecompanyinfo">Save Info</a>
                          </div>
                        </div>
                      </li>
                    </ul>

                    <!--<div class="block-title text-color-black no-margin-bottom margin-left-half padding-bottom-half margin-top-half">Choose currency</div>
                    <ul>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Currency</div>
                          <div class="item-input-wrap">
                            <input id="autocomplete-dropdown-all" class="settingsInput" type="text" placeholder="Currency">
                          </div>
                        </div>
                      </li>
                    </ul>-->

                </div>
            </div>
  
    </div> 
  </template>
  <script>
      import currencies from '../js/currencies.js';
      var dbSettings = null;
    export default {
      data() {
        return {
          user: {
            firstName: 'John',
            lastName: 'Doe',
          },
          // Login screen demo data
          username: '',
          password: '',
          country:'',
          settingsID: 'settings',
          settings: null
  
        };
      },
      methods: {
        helloWorld() {
          this.$f7.dialog.alert('Hello World!');
        },
        getData: function(){
          var self = this;
          var id = self.settingsID;
          dbSettings.get(id).then(function(doc) {
                   //console.log(doc);
                   var comName = doc.companyName;
                  if(comName != ""){
                      $("#companyname").val(comName);
                  }
                  var taxes = doc.taxes;
                  if(taxes != ""){
                      $("#taxes").val(taxes);
                  }
                  var comAdd = doc.companyAddress;
                  if(comAdd != ""){
                      $("#companyaddress").val(comAdd);
                  }
                  var savedCurr = doc.currency;
                  if(savedCurr != ""){
                      $('#autocomplete-dropdown-all').val(savedCurr);
                  }
                  self.$setState({
                      settings: doc
                    })
            }).catch(function(err){
              //console.log(err);
            })
        },
        startPouch: function(){
          var self = this;
          //db = null;
          try{//id,name,unit_size,unit,cost_per_unit,status,created_date
            if(pdf != undefined){
              dbSettings = new PouchDB('settings.db', { adapter: 'cordova-sqlite' });
                self.getData();
              }
          }catch(err){
            dbSettings = new PouchDB('settings.db');
              self.getData();
            }
        },
        showToast: function(text, position){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: 2000,
                        }).open();
        },
        savecompanyinfo: function(){
            var self = this;
            var comName = $("#companyname").val().trim();
            var comAdd = $("#companyaddress").val().trim();
            var taxes = $("#taxes").val().trim();
            var currency = $('#autocomplete-dropdown-all').val();
            if(taxes != ""){
                var tax = Number(taxes);
                if(isNaN(tax)){
                    self.showToast("Please enter tax in number or decimal only!", "center");
                    return;
                }
            }
            var obj = {};
            obj.companyName = comName;
            obj.companyAddress = comAdd;
            obj.taxes = taxes;
            obj.currency = currency;
            obj.country = self.country;
            if(self.settings == null){
              obj._id = self.settingsID;
              dbSettings.put(obj).then(function(){
              self.showToast("Information Saved!", "center");
              }).catch(function(err){
                console.log(err);
                self.showToast("An error occured, please try again!", "center");
              })
            }else{
              obj._id = self.settingsID;
              dbSettings.get(self.settingsID).then(function(doc) {
                   // console.log(doc);
                    obj._rev = doc._rev;
                    return dbSettings.put(obj);
                  }).then(function(){
                    localStorage.setItem("currency", currency);
                    self.showToast("Information Saved!", "center");
                }).catch(function(err){
                  console.log(err);
                  self.showToast("An error occured, please try again!", "center");
                })
            }
            
        }
      },
      on: {
      pageInit: function(e, page) {
            var self = this;
            self.startPouch();
            
            var cur = Object.keys(currencies);
            var autocompleteDropdownAll = self.$app.autocomplete.create({
                inputEl: '#autocomplete-dropdown-all',
                openIn: 'dropdown',
                source: function (query, render) {
                    var results = [];
                    // Find matched items
                    for (var i = 0; i < cur.length; i++) {
                    if (cur[i].toLowerCase().indexOf(query.toLowerCase()) >= 0) results.push(cur[i]);
                    }
                    // Render items by passing array with result items
                    render(results);
                    },
                on:{
                    change: function (value) {
                        var cnt = value[0];
                        var val = currencies[cnt];
                        $('#autocomplete-dropdown-all').val(val);
                        self.$setState({
                            country: cnt
                        })
                        //localStorage.setItem("currency", val);
                    }     
                }
                });
            }  
        }
    }
  </script>
  