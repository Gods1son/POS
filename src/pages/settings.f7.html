
<template>
    <div class="page" data-name="settings">
        <div class="navbar">
            <div class="navbar navbar-bg"></div>
            <div class="navbar-inner sliding">
              <div class="left">
                <a href="#" class="link back">
                  <i class="icon icon-back"></i>
                  <span class="if-not-md">Back</span>
                </a>
              </div>
              <div class="title padding-vertical-half">Settings</div>
              <div class="right">
                <a href="#" class="link icon-only panel-toggle" data-panel="left">
                  <i class="icon f7-icons if-not-md">menu</i>
                  <i class="icon material-icons if-md">menu</i>
                </a>
              </div>
            </div>
          </div>

            <div class="page-content">
                <div class="list no-hairlines-md margin-top-half settingsWrapper">
                    <div class="block-title text-color-black no-margin-bottom margin-left-half margin-top-half padding-vertical-half">Company Info and Taxes</div>
                    <div class="block-header no-margin-vertical margin-horizontal-half no-padding-horizontal">The information is used for invoicing!</div>
                    <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company Name</div>
                          <div class="item-input-wrap">
                            <input id="companyname" type="text" class="settingsInput" placeholder="Company Name">
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company URL</div>
                          <div class="item-input-wrap">
                            <input id="companyurl" type="text" class="settingsInput" placeholder="Company URL">
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company Address</div>
                          <div class="item-input-wrap">
                            <textarea class="settingsInput" id="companyaddress" placeholder="Company Address"></textarea>
                            <!--<input id="companyaddress" type="text" placeholder="Company Address">-->
                          </div>
                        </div>
                      </li>

                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company Phone Number</div>
                          <div class="item-input-wrap">
                            <input id="phoneNumber" type="text" class="settingsInput" placeholder="phone number with country code">
                          </div>
                        </div>
                      </li>

                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company Tagline (shown in invoice)</div>
                          <div class="item-input-wrap">
                            <textarea class="settingsInput" id="companytagline" placeholder="Company Tagline"></textarea>
                            <!--<input id="companyaddress" type="text" placeholder="Company Address">-->
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company Logo</div>
                          <div class="item-input-wrap display-inline-flex1">
                            <div><input id="logo" type="file" class="settingsInput"></div>
                            <div class="margin-left-half1 margin-top-half"><img id="logoShow" style="max-width: 100px;"/></div>
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Company Signature (for invoice)</div>
                          <div class="item-input-wrap display-inline-flex1">
                            <div><input id="signature" type="file" class="settingsInput"></div>
                            <div class="margin-left-half1 margin-top-half"><img id="signatureShow" style="max-width: 100px;"/></div>
                          </div>
                        </div>
                      </li>
                      <li>
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title">Terms and Conditions</div>
                            <div class="item-input-wrap">
                              <div class="text-editor terms_condition margin-top-half" data-placeholder="Terms and Condition" 
                                data-buttons='[["bold", "italic", "underline", "strikeThrough"], ["orderedList", "unorderedList"]]'>
                                <div class="text-editor-content" contenteditable></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Taxes in percentage (do not include %)</div>
                          <div class="item-input-wrap">
                            <input id="taxes" type="text" class="settingsInput" placeholder="Enter % taxes">
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Currency</div>
                          <div class="item-input-wrap">
                            <input id="autocomplete-dropdown-all" class="settingsInput" type="text" placeholder="Currency">
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label margin-bottom-half">Select Primary Color</div>
                          <div class="item-input-wrap display-flex"><div class="item-media margin-right-half">
                            <i class="icon demo-list-icon primaryColor" id="demo-color-picker-wheel-value"></i>
                          </div>
                          <input type="text" placeholder="Color" id="demo-color-picker-wheel" readonly="" class="input-with-value">
                        </div>
                      </div>
                    </li>
                      <li class="margin-top-half">
                        <div class="item-inners">
                          <div class="item-input-wraps">
                            <a id="savecompanyinfo" class="button button-outline button-raised mainButton" @click="savecompanyinfo">Save Info</a>
                          </div>
                        </div>
                      </li>
                    </ul>

                    <!--<div class="block-title text-color-black no-margin-bottom margin-left-half padding-bottom-half margin-top-half">Choose currency</div>
                    <ul>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Currency</div>
                          <div class="item-input-wrap">
                            <input id="autocomplete-dropdown-all" class="settingsInput" type="text" placeholder="Currency">
                          </div>
                        </div>
                      </li>
                    </ul>-->

                </div>
            </div>
  
    </div> 
  </template>
  <script>
      import currencies from '../js/currencies.js';
      var dbSettings = null, dbSettingsImages = null, mogulsheetdb = null;
    export default {
      data() {
        return {
          user: {
            firstName: 'John',
            lastName: 'Doe',
          },
          // Login screen demo data
          username: '',
          password: '',
          country:'',
          settingsID: 'settings',
          settings: null,
          signature: null,
          logo: null,
          signatureUpload: null,
          logoUpload: null
  
        };
      },
      methods: {
        helloWorld() {
          this.$f7.dialog.alert('Hello World!');
        },
        getBase64: function(input, id) {
          var self = this;
          
              if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
                  self.showToast('The File APIs are not fully supported in this browser.', "center");
                  return;
              } 
              if (input.files && input.files[0]) {
                  var type =input.files[0].type;
                  var reader = new FileReader();
                  reader.readAsDataURL(input.files[0]);
                  reader.onload = function (e) {
                      $('#' + id + "Show").attr('src', e.target.result);
                      //console.log(e.target.result);
                      var obj = [];
                      obj.push(e.target.result);
                      obj.push(type);
                      //console.log(obj);
                      if(id == "logo"){
                        self.$setState({
                          logoUpload: obj
                        })
                      }
                      if(id == "signature"){
                        self.$setState({
                          signatureUpload: obj
                        })
                      }
                  }   
                  reader.onerror = function (error) {
                   // console.log('Error: ', error);
                    //reject("");
                  };
              }else{
                return "";
              }
            
        },
        checkUrl: function(){
          var self = this;
          var check = true;
          if(self.settings != null && self.settings.businessUrl != null){
            var currURL = $("#companyurl").val();
            if(currURL == "" || currURL == self.settings.businessUrl){
              check = false;
            }
          }

          if(check){
            var obj = {};
            obj.name = $("#companyurl").val();
            self.$app.preloader.show();
            $.when(self.$app.methods.postDataAPI("business/CheckBusinessName", obj, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                //console.log("when data ings save ", data); // JSON data parsed by `data.json()` call
                if(data == true){
                  self.$app.methods.showToast("URL is good", "center", true);
                }else{
                  self.$app.methods.showToast("URL is taken", "center", false);
                }
                
            }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
            })
          }
        },
        getProfile:function(){
          var self = this;
          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("business/GetBusinessProfile")).then(function( data, textStatus, jqXHR ) {
            self.$app.preloader.hide();
              var doc = data;
              var comName = doc.name;
              if(comName != ""){
                  $("#companyname").val(comName);
              }
              var taxes = doc.taxes;
              if(taxes != ""){
                  $("#taxes").val(taxes);
              }
              var comAdd = doc.address;
              if(comAdd != ""){
                  $("#companyaddress").val(comAdd);
              }
              var comNumber = doc.phoneNumber;
              if(comNumber != null && comNumber != ""){
                $("#phoneNumber").val(comNumber);
              }
              var tagline = doc.tagline;
              if(tagline != ""){
                  $("#companytagline").val(tagline);
              }
              var terms = doc.termsConditions;
              if(terms != "" && terms != undefined){
                var textEditor = self.$app.textEditor.get('.terms_condition');
                textEditor.setValue(terms);
              }
              var savedCurr = doc.currency;
              if(savedCurr != ""){
                  $('#autocomplete-dropdown-all').val(savedCurr);
                  localStorage.setItem("currency", savedCurr);
              }
              var url = doc.businessUrl;
              if(url != null && url != ""){
                $("#companyurl").val(url);
              }

              var primColor = doc.primaryColor;
              if(primColor != null && primColor != ""){
                $(".primaryColor").css("background-color", primColor);
                $("#demo-color-picker-wheel").val(primColor);
              }

              //logo
              if(doc.logo != null && doc.logo != ""){
                $("#logoShow").attr("src", doc.logo);
              }

              //signature
              if(doc.signature != null && doc.signature != ""){
                $("#signatureShow").attr("src", doc.signature);
              }

              self.$setState({
                  settings: doc
              })
          }).catch((data, textStatus, jqXHR) => {
            self.$app.preloader.hide();
              if(data != null && data.status == 404){
                console.log("profile not found"); 
                return;
              }
              self.$app.methods.showToast("An error occurred", "center");
          })
        },
        getData: function(){
          var self = this;
          
          
        },
        showToast: function(text, position){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: 2000,
                        }).open();
        },
        savecompanyinfo: function(){
            var self = this;
            var comName = $("#companyname").val().trim();
            var comAdd = $("#companyaddress").val().trim();
            var taxes = $("#taxes").val().trim();
            var currency = $('#autocomplete-dropdown-all').val();
            var tagline = $("#companytagline").val();
            var terms = self.$app.textEditor.get('.terms_condition').value;
            var busURL = $("#companyurl").val().trim();
            var primColor = $("#demo-color-picker-wheel").val();
            var phone = $("#phoneNumber").val();

            if(taxes != ""){
                var tax = Number(taxes);
                if(isNaN(tax)){
                    self.showToast("Please enter tax in number or decimal only!", "center");
                    return;
                }
            }
            if(busURL == ""){
              self.showToast("Please enter url", "center");
              return;
            }
            
            var saved = false;
            var obj = {};
            obj.name = comName;
            obj.address = comAdd;
            obj.taxes = taxes;
            obj.currency = currency;
            obj.country = self.country;
            obj.tagline = tagline;
            obj.termsConditions = terms;
            obj.businessUrl = busURL;
            obj.primaryColor = primColor;
            obj.phoneNumber = phone;

            var form_data = new FormData();

              for ( var key in obj ) {
                  form_data.append(key, obj[key]);
              }

            var fileUploadLogo = $("#logo").get(0);
            var filesLogo = fileUploadLogo.files;
            if(filesLogo.length > 0){
               // if there are multiple files , loop through each files
              for (var i = 0; i < filesLogo.length; i++) {
                form_data.append("logoImage", filesLogo[i]);
              }
            }

            var fileUploadSign = $("#signature").get(0);
            var filesSign = fileUploadSign.files;
            if(filesSign.length > 0){
               // if there are multiple files , loop through each files
              for (var i = 0; i < filesSign.length; i++) {
                form_data.append("signatureImage", filesSign[i]);
              }
            }
           
            /*self.$app.preloader.show();
            $.when(self.$app.methods.postDataAPI("business/SaveBusinessForm", form_data, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data == true){
                  self.$app.methods.showToast("Information saved", "center", true);
                }
                
            }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })*/
            $.when(self.$app.methods.postFormDataAPI("business/SaveBusinessForm", form_data, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data == true){
                  self.$app.methods.showToast("Information saved", "center", true);
                  self.$app.methods.resaveSettings(obj);
                }
                
            }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })

            //obj.logo = logo;
            //obj.signature = sig;

            /*if(self.settings == null){
              obj._id = self.settingsID;
              obj.settingID = obj._id;
              mogulsheetdb.put(obj).then(function(){
                saved = true;
                self.uploadImages();
                self.showToast("Information Saved!", "center");
              }).catch(function(err){
                console.log(err);
                self.showToast("An error occured, please try again!", "center");
              })
            }else{
              var getid = self.settingsID;
              mogulsheetdb.get(getid).then(function(doc) {
                   // console.log(doc);
                   obj._id = doc._id;
                   obj.settingID = obj._id;
                    obj._rev = doc._rev;
                    return mogulsheetdb.put(obj);
                  }).then(function(){
                    saved = true;
                    self.uploadImages();
                    localStorage.setItem("currency", currency);
                    self.showToast("Information Saved!", "center");
                }).catch(function(err){
                  console.log(err);
                  self.showToast("An error occured, please try again!", "center");
                })
            }*/
        },
        uploadImages: function(){
              var self = this;
                if(document.getElementById("logo").files && document.getElementById("logo").files[0]){
                  var rev = self.logo == null ? null : self.logo._rev;
                  var myDoc = {
                      _id: "logoImage",
                      _attachments: {
                        "logoImage": {
                          content_type: document.getElementById("logo").files[0].type,
                          data: document.getElementById("logo").files[0]
                        }
                      }
                    }
                    if(self.logo != null){
                      myDoc._rev = self.logo._rev;
                    }
                    dbSettingsImages.put(myDoc).then(function (result) {
                              // handle result
                              self.showToast("Logo saved!", "center");
                              //console.log(result);
                      }).catch(function (err) {
                        //console.log(err);
                      });
                  }
              
                  if(document.getElementById("signature").files && document.getElementById("signature").files[0]){
                  var rev = self.signature == null ? null : self.signature._rev;
                  var myDoc = {
                      _id: "signatureImage",
                      _attachments: {
                        "signatureImage": {
                          content_type: document.getElementById("signature").files[0].type,
                          data: document.getElementById("signature").files[0]
                        }
                      }
                    }
                    if(self.signature != null){
                      myDoc._rev = self.signature._rev;
                    }
                    dbSettingsImages.put(myDoc).then(function (result) {
                              // handle result
                              self.showToast("Signature saved!", "center");
                              //console.log(result);
                      }).catch(function (err) {
                        //console.log(err);
                      });
                  }
          }
      },
      on: {
        pageAfterIn: function(e, page) {
        var self = this;
        //trackSettingsPage();
      },
      pageInit: function(e, page) {
            var self = this;
            self.getProfile();
            $("#logo").change(function(){
                self.getBase64(this, "logo");
            });
            $('#companyurl').on('keypress', function (event) {
                var regex = new RegExp("^[a-zA-Z0-9-_]+$");
                var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
                if (!regex.test(key)) {
                  event.preventDefault();
                  return false;
                }
            });
            $("#companyurl").on("blur", function(){
              self.checkUrl();
            });
            $("#signature").change(function(){
              self.getBase64(this, "signature");
            });
            var cur = Object.keys(currencies);
            
            //initialize color picker
            var colorPickerWheel = self.$app.colorPicker.create({
                inputEl: '#demo-color-picker-wheel',
                targetEl: '#demo-color-picker-wheel-value',
                targetElSetBackgroundColor: true,
                modules: ['wheel'],
                openIn: 'popover',
                value: {
                  hex: '#000000',
                },
              });

            var autocompleteDropdownAll = self.$app.autocomplete.create({
                inputEl: '#autocomplete-dropdown-all',
                openIn: 'dropdown',
                source: function (query, render) {
                    var results = [];
                    // Find matched items
                    for (var i = 0; i < cur.length; i++) {
                    if (cur[i].toLowerCase().indexOf(query.toLowerCase()) >= 0) results.push(cur[i]);
                    }
                    // Render items by passing array with result items
                    render(results);
                    },
                on:{
                    change: function (value) {
                        var cnt = value[0];
                        var val = currencies[cnt];
                        $('#autocomplete-dropdown-all').val(val);
                        self.$setState({
                            country: cnt
                        })
                        //localStorage.setItem("currency", val);
                    }     
                }
                });
                var textEditorCustomButtons = self.$app.textEditor.create({
                  el: '.terms_condition',
                  buttons: [["bold", "italic", "underline", 'h1', 'h2', 'h3', 'orderedList', 'unorderedList']],
                  on: {
                    buttonClick: function (editor, button) {
                        var act = $('button[data-button="' + button + '"]').hasClass("active");
                        if(act){
                          $('button[data-button="' + button + '"]').removeClass("active");
                        }else{
                          $('button[data-button="' + button + '"]').addClass("active");
                        }
                      }
                    }
                });
            }  
        }
    }

    function trackSettingsPage(){
      try{
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
    'event': 'Pageview',
    'pagePath': 'https://www.mogulsheet.com/settings',
    'pageTitle': 'Settings' //some arbitrary name for the page/state
    });
  }catch(err){
    
  }
    }
  </script>
  