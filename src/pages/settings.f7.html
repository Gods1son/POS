
<template>
    <div class="page" data-name="settings">
        <div class="navbar">
            <div class="navbar navbar-bg"></div>
            <div class="navbar-inner sliding">
              <div class="left">
                <a href="#" class="link back">
                  <i class="icon icon-back"></i>
                  <span class="if-not-md">Back</span>
                </a>
              </div>
              <div class="title padding-vertical-half">Settings</div>
              <div class="right">
                <a href="#" class="link icon-only panel-toggle" data-panel="left">
                  <i class="icon f7-icons if-not-md">menu</i>
                  <i class="icon material-icons if-md">menu</i>
                </a>
              </div>
            </div>
          </div>

          <div class="toolbar tabbar toolbar-bottom">
            <div class="toolbar-inner">
              <a href="/settings/company-details/" class="tab-link tab-link-active">Profile</a>
              <a href="/settings/plan-pricing/" class="tab-link">Plans</a>
              <a href="/settings/payment-settings/" class="tab-link hideSubs">Payment</a>
              <a href="/settings/delivery-settings/" class="tab-link">Delivery</a>
            </div>
          </div>


          <div class="tabs-swipeable-wrap">
            <!-- Tabs, tabs wrapper -->
              <div class="tabs">
                  <!-- Tab 1, active by default -->
                  <div id="company-details" class="page-content tab tab-active">
                      <div class="list no-hairlines-md margin-top-half settingsWrapper">
                        <div class="block-title text-color-black no-margin-bottom margin-left-half margin-top-half padding-vertical-half">Business Info and Taxes</div>
                        <div class="block-header no-margin-vertical margin-horizontal-half no-padding-horizontal">This information will be used for your online store, invoices and taxes</div>
                        <ul>
                        <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Business Name</div>
                              <div class="item-input-wrap">
                                <input id="companyname" type="text" class="settingsInput" placeholder="Business Name">
                              </div>
                            </div>
                          </li>
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Online Store Name (store link URL)</div>
                              <div class="item-input-wrap">
                                <input id="companyurl" type="text" class="settingsInput" placeholder="Online Store Name">
                              </div>
                            </div>
                          </li>
    
                        <!-- <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Company Address</div>
                              <div class="item-input-wrap">
                                <textarea class="settingsInput" id="companyaddress" placeholder="Company Address"></textarea>
                              </div>
                            </div>
                          </li>-->
    
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Country</div>
                              <div class="item-input-wrap input input-dropdown">
                                <select id="companyCountry" disabled>
                                  <option value="">Select One</option>
                                  {{#each countries}}
                                    <option value="{{isoCode}}">{{name}}</option>
                                  {{/each}}
                                </select>
                              </div>
                            </div>
                          </li>
    
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Province/State</div>
                              <div class="item-input-wrap input input-dropdown">
                                <select id="companyProvince">
                                  <option value="">Select One</option>
                                  {{#each states}}
                                    <option value="{{state_code}}">{{name}}</option>
                                  {{/each}}
                                </select>
                              </div>
                            </div>
                          </li>
    
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Street</div>
                              <div class="item-input-wrap">
                                <input id="companyStreet" type="text" class="settingsInput" placeholder="Street">
                              </div>
                            </div>
                          </li>
    
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">City</div>
                              <div class="item-input-wrap">
                                <input id="companyCity" type="text" class="settingsInput" placeholder="City">
                              </div>
                            </div>
                          </li>
    
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Postal Code</div>
                              <div class="item-input-wrap">
                                <input id="companyPostalCode" type="text" class="settingsInput" placeholder="Postal Code">
                              </div>
                            </div>
                          </li>

                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Currency</div>
                              <div class="item-input-wrap input input-dropdown">
                                <select id="currency">
                                  <option value="">Select one</option>
                                  {{#each currencies}}
                                  <option value="{{name}} {{symbol}}" data-value="{{symbol}}">{{name}}</option>
                                  {{/each}}
                                  </select>
                              </div>
                            </div>
                          </li>
    
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Whatsapp Phone Number</div>
                              <div class="item-input-wrap">
                                <input id="phoneNumber" type="text" class="settingsInput" placeholder="Whatsapp phone number with country code">
                              </div>
                            </div>
                          </li>
    
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Business Tagline (shown on invoices and online store)</div>
                              <div class="item-input-wrap">
                                <textarea class="settingsInput" id="companytagline" placeholder="Business Tagline"></textarea>
                                <!--<input id="companyaddress" type="text" placeholder="Company Address">-->
                              </div>
                            </div>
                          </li>
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Business Logo</div>
                              <div class="item-input-wrap display-inline-flex1">
                                <div><input id="logo" type="file" class="settingsInput"></div>
                                <div class="margin-left-half1 margin-top-half"><img id="logoShow" style="max-width: 100px;"/></div>
                              </div>
                            </div>
                          </li>
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Business Signature (for invoices)</div>
                              <div class="item-input-wrap display-inline-flex1">
                                <div><input id="signature" type="file" class="settingsInput"></div>
                                <div class="margin-left-half1 margin-top-half"><img id="signatureShow" style="max-width: 100px;"/></div>
                              </div>
                            </div>
                          </li>
                          <li>
                            <div class="item-content item-input">
                              <div class="item-inner">
                                <div class="item-title item-label">Terms and Conditions (shown on invoices)</div>
                                <div class="item-input-wrap">
                                  <div class="text-editor terms_condition margin-top-half" data-placeholder="Terms and Conditions" 
                                    data-buttons='[["bold", "italic", "underline", "strikeThrough"], ["orderedList", "unorderedList"]]'>
                                    <div class="text-editor-content" contenteditable></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </li>
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Taxes in percentage (do not include %)</div>
                              <div class="item-input-wrap">
                                <input id="taxes" type="text" class="settingsInput" placeholder="Enter % taxes">
                              </div>
                            </div>
                          </li>
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label margin-bottom-half">Select Primary Color (for your online store)</div>
                              <div class="item-input-wrap display-flex"><div class="item-media margin-right-half">
                                <i class="icon demo-list-icon primaryColor" id="demo-color-picker-wheel-value"></i>
                              </div>
                              <input type="text" placeholder="Color" id="demo-color-picker-wheel" readonly="" class="input-with-value">
                            </div>
                          </div>
                        </li>
                          <li class="margin-top-half">
                            <div class="item-inners">
                              <div class="item-input-wraps">
                                <a id="savecompanyinfo" class="button button-outline button-raised mainButton" @click="savecompanyinfo">Save</a>
                              </div>
                            </div>
                          </li>
    

                        </ul>
    
                        <!--<div class="block-title text-color-black no-margin-bottom margin-left-half padding-bottom-half margin-top-half">Choose currency</div>
                        <ul>
                          <li class="item-content item-input">
                            <div class="item-inner">
                              <div class="item-title item-label">Currency</div>
                              <div class="item-input-wrap">
                                <input id="autocomplete-dropdown-all" class="settingsInput" type="text" placeholder="Currency">
                              </div>
                            </div>
                          </li>
                        </ul>-->
    
                    </div>
                  </div>
                  
                  <!-- Tab 2 -->
                  <div id="plan-pricing" class="page-content tab">  
                    <div class="no-margin-vertical padding-horizontal">
                      <div class="">
                        <div class="block no-margin-vertical no-padding">
                          <div id="SubscribePage" class="">
                            <div class="subscribeText margin-top">Start and manage your business on Omni with a 30-day free trial</div>
                            <div>Whether you sell online or offline, Omni has your back. Subscribe to the starter plan to enjoy ease and efficiency, you can cancel anytime.</div>
                            
                            <div class="subscribeBox margin-top row">
                              <div class="col-100 medium-30 subscribeCard margin-vertical padding-horizontal padding-vertical">
                                <h4 class="no-margin-top">Starter</h4>
                                <div class="hideSubs" style="text-decoration: line-through;">$16</div>
                                <div class="margin-top-half">
                                  <span class="subscribeCost">$8</span>
                                  <span>/month</span>
                                </div>
                                <div class="text-color-gray hideSubs" style="font-weight: 500;">Save 50% for 6 months</div>
                                <div class="margin-vertical-half">
                                  <a href="#" class="button button-outline button-raised btn-primary" @click="StartFreeTrial">Start Free Trial</a>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Online store</span>
                                </div>
                                <div class="display-flex align-items-center hideSubs">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Secure payment processing</span>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Unlimited products</span>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Invoices/Receipts/Estimates</span>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Expense Tracking</span>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Reports</span>
                                </div>
                                <div class="display-flex align-items-center hideSubs">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Transaction Fees (2.9% + $0.3)</span>
                                </div>
                                <div class="display-flex align-items-center hideSubs">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Instant Payout (1%)</span>
                                </div>
                              </div>
                            </div>

                            
                          </div>
                          <div class="display-none" id="UserIsSubscribed">
                            <div class="subscribeText margin-top">You are an active subscription</div>
                            <div class="subscribeBox margin-top row">
                              <div class="col-100 medium-30 subscribeCard margin-vertical padding-horizontal padding-vertical">
                                <h4 class="no-margin-top">Starter</h4>
                                <div class="hideSubs" style="text-decoration: line-through;">$16</div>
                                <div class="margin-top-half">
                                  <span class="subscribeCost">$8</span>
                                  <span>/month</span>
                                </div>
                                <div class="hideSubs text-color-gray" style="font-weight: 500;">Save 50% for 6 months</div>
                                <div class="margin-vertical-half">
                                  <a href="#" class="button button-outline button-raised btn-primary" @click="ManageSubscription">Manage subscription</a>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Online store</span>
                                </div>
                                <div class="display-flex align-items-center hideSubs">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Secure payment processing</span>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Unlimited products</span>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Invoices/Receipts/Estimates</span>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Expense Tracking</span>
                                </div>
                                <div class="display-flex align-items-center">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Reports</span>
                                </div>
                                <div class="display-flex align-items-center hideSubs">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Transaction Fees (2.9% + $0.3)</span>
                                </div>
                                <div class="display-flex align-items-center hideSubs">
                                  <span><i class="f7-icons text-color-green">checkmark_alt</i></span>
                                  <span class="margin-left-half">Instant Payout (1%)</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                </div>
              </div>
                  
                  <!-- Tab 3 -->
                  <div id="payment-settings" class="page-content tab">  
                        <div class="no-margin-vertical padding-horizontal-half display-none" id="stripepaymentdashboard">
                          <div class="">
                            <div class="block no-margin-vertical no-padding">
                              <div class="row no-gap dash">

                                  <div class="col-100 medium-50">
                                    <div class="card card-outline padding-vertical-half totalSales">
                                      <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder text-color-white">Available Balance</div>
                                      <div class="card-content text-color-white" id="availableBalance"></div>
                                    </div>
                                  </div>
                        
                                  <div class="col-100 medium-50">
                                    <div class="card card-outline padding-vertical-half">
                                      <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Pending Balance</div>
                                      <div class="card-content" id="pendingBalance"></div>
                                    </div>
                                  </div>
                              </div>
                            </div>
                          </div>
                          <div class="block-header no-margin-vertical margin-horizontal-half no-padding-horizontal text-align-center text-90">Your revenue is automatically deposited in your registered account within 2 to 3 business days. Please note that the first deposit will take 7 days</div>

                          <div id="payoutParent">
                            <div class="list no-hairlines-md no-margin-bottom">
                              <ul>
                                  <li class="item-content item-input">
                                    <div class="item-inner">
                                      <div class="item-input-wrap">
                                        <input id="payOutAmount" type="number" class="settingsInput" placeholder="Enter amount to payout">
                                      </div>
                                  </div>
                                </li>
                                <li class="item-content">
                                  <div class="item-inner">
                                    <div class="item-input-wrap">
                                      <a id="payoutNow" class="button button-outline button-raised mainButton" @click="payoutmoney">Pay Out</a>
                                    </div>
                                </div>
                              </li>
                              </ul>
                            </div>
                            <div class="block-header no-margin-vertical margin-horizontal-half no-padding-horizontal text-align-center text-90">You can also receive payment instantly with our pay out button (a charge of 1.2% of the withdrawn amount applies)</div>
                          </div>
                          
                    </div>

                    <div class="no-margin-vertical padding-horizontal-half setUpPaymentHolder">
                      <div class="">
                        <a id="setPayment" class="button button-outline button-raised mainButton" @click="setPayment">Set Up Payment</a>
                        <a class="link external display-none openStripeLink" target="_blank" href="#">Open Stripe</a>
                      </div>
                      <div class="block-header no-margin-vertical margin-horizontal-half no-padding-horizontal text-90">Set up payment and start receiving money from 150+ countries</div>
                    </div>

                  </div>
                  
                  <!-- Tab 4 -->
                  <div id="delivery-settings" class="page-content tab">

                      <!--fab-->
                        <div class="fab-backdrop"></div>
                        <div class="fab fab-extended fab-right-bottom">
                          <a href="#" @click="openPopUpDelivery(null)"> 
                            <i class="icon f7-icons">plus</i>
                            <i class="icon f7-icons">multiply</i>
                            <div class="fab-text">Delivery Option</div>
                          </a>
                            
                        </div>
                        <!--fab-->

                        <!--pop up-->
                        <div class="popup newDeliveryOption popup-tablet-fullscreen">
                          <div class="view">
                            <div class="page">
                              <div class="navbar">
                                <div class="navbar-bg"></div>
                                <div class="navbar-inner">
                                  <div class="title">Add/Edit Delivery Option</div>
                                  <div class="right">
                                    <!-- Link to close popup -->
                                    <a class="link" @click="closePopUpDelivery"><i class="icon f7-icons">multiply</i></a>
                                  </div>
                                </div>
                              </div>
                              <div class="page-content">
                                  <div class="list no-hairlines-md margin-top-half margin-bottom-half deliveryForm">
                                    <ul>
                                      <li>
                                        <div class="item-content item-input">
                                          <div class="item-inner">
                                            <div class="item-title item-label">Location</div>
                                            <div class="item-input-wrap">
                                              <input type="text" class="delivery_location" placeholder="Location" required validate/>
                                              <span class="input-clear-button"></span>
                                            </div>
                                          </div>
                                        </div>
                                      </li>
                                      
                                      <li>
                                        <div class="item-content item-input">
                                          <div class="item-inner">
                                            <div class="item-title item-label">Delivery Cost</div>
                                            <div class="item-input-wrap">
                                              <input type="number" class="delivery_cost" placeholder="delivery cost" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                                              <span class="input-clear-button"></span>
                                            </div>
                                          </div>
                                        </div>
                                      </li>
                                      <li>
                                        <div class="item-content">
                                          <div class="item-inner">
                                            <a href="#" class="col button button-outline button-raised mainButton" @click='saveDeliveryOption'>Save Delivery Option</a>
                                          </div>
                                        </div>
                                      </li>
                                    </ul>
                                  </div>
                              </div>
                            </div>
                          </div>
                        
                        </div>
                        <!--Pop -up-->


                      <div class="block-title text-color-black no-margin-bottom margin-left-half margin-top-half padding-vertical-half">Set cost of delivery</div>
                      <div class="block-header no-margin-vertical margin-horizontal-half no-padding-horizontal">Create as many as you want e.g. Within city, within province, out of province</div>

                      <div class="delivery-table data-table margin-vertical-half">
                        <table>
                            <thead>
                              <tr>
                                <th>Location</th>
                                <th>Cost</th>
                                <th>Action</th>
                              </tr>
                            </thead>
                            <tbody class="">
                              {{#each delivery}}
                                  <tr>
                                    <td>{{location}}</td>
                                    <td>{{costFormatted}}</td>
                                    <td>
                                          <a href="#" data-popover=".orders-popover-{{id}}" class="popover-open"><i class="f7-icons">ellipsis_vertical</i></a>
                                          <div class="popover my-popover orders-popover orders-popover-{{id}}" data-close-on-escape="true" data-backdrop="false">
                                          <div class="popover-angle"></div><div class="popover-inner padding-half">
                                            <a class="button popover-close margin-bottom-half" data-id="{{id}}" @click="openPopUpDelivery({{id}})">View / Edit</a>
                                            <a class="button popover-close deleteDelivery" data-id="{{id}}" @click="DeleteDelivery({{id}})">Delete</a>
                                          </div>
                                        </div>
                                    </td>
                                  </tr>
                                {{/each}}
                            </tbody>
                        </table>
                      </div>
                  </div>
              </div>
          </div>

            <div class="page-content">
                
            </div>
  
    </div> 
  </template>
  <script>
      import currencies from '../js/currencies.js';
      import countryList from '../js/countries.js';
      import stateList from '../js/states.js';
      var dbSettings = null, dbSettingsImages = null, mogulsheetdb = null;
    export default {
      data() {
        return {
          user: {
            firstName: 'John',
            lastName: 'Doe',
          },
          // Login screen demo data
          username: '',
          password: '',
          country:'',
          province: null,
          region: null,
          settingsID: 'settings',
          settings: null,
          signature: null,
          logo: null,
          currencies: [],
          signatureUpload: null,
          logoUpload: null,
          delivery: [],
          countries: [],
          states: [],
          currentDeliveryOption: null
  
        };
      },
      methods: {
        helloWorld() {
          this.$f7.dialog.alert('Hello World!');
        },
        getBase64: function(input, id) {
          var self = this;
          
              if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
                  self.showToast('The File APIs are not fully supported in this browser.', "center");
                  return;
              } 
              if (input.files && input.files[0]) {
                  var type =input.files[0].type;
                  var reader = new FileReader();
                  reader.readAsDataURL(input.files[0]);
                  reader.onload = function (e) {
                      $('#' + id + "Show").attr('src', e.target.result);
                      //console.log(e.target.result);
                      var obj = [];
                      obj.push(e.target.result);
                      obj.push(type);
                      //console.log(obj);
                      if(id == "logo"){
                        self.$setState({
                          logoUpload: obj
                        })
                      }
                      if(id == "signature"){
                        self.$setState({
                          signatureUpload: obj
                        })
                      }
                  }   
                  reader.onerror = function (error) {
                   // console.log('Error: ', error);
                    //reject("");
                  };
              }else{
                return "";
              }
            
        },
        payoutmoney: function(){
          var self = this;
          var pay = $("#payOutAmount").val();
          if(pay != ''){
            pay = parseFloat($("#payOutAmount").val());
            var bal = parseFloat($("#availableBalance").attr("data-amount"));
            if((pay > bal) || bal == 0){
              self.showToast("You do not have enough money in your available balance", "center", false);
              return;
            }

            var obj = {};
            obj.amount = pay;
            self.$app.preloader.show();
                $.when(self.$app.methods.postDataAPI("business/CreatePayout", obj, true)).then(function( data, textStatus, jqXHR ) {
                    self.$app.preloader.hide();
                    console.log(data);
                    self.$app.methods.showToast("Payout was successful", "center", true);
                    $("#payOutAmount").val("");
                    self.getBalance();
                }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
          }
        },
        StartFreeTrial: function(){
          var self = this;
          var sett = self.$app.data.settings;
          if(sett == null || sett.name == null || sett.currency == null || self.region == null){
            self.$app.methods.showToast("Please complete filling your business profile first", "center");
            self.$app.views.main.router.navigate('/settings/company-details/');
            return;
          }
          self.$app.preloader.show();
            $.when(self.$app.methods.getDataAPI("Subscription/Subscribe?region=" + self.region)).then(function( data, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                if(data != null){
                  window.open(data.url, "_blank");
                }
                //self.$app.methods.showToast("Payout was successful", "center", true);

            }).catch((data, textStatus, jqXHR) => {
            console.log(data, textStatus, jqXHR);
            self.$app.preloader.hide();
            self.$app.methods.showToast("An error occurred", "center");
            })
        },
        ManageSubscription: function(){
          var self = this;
          self.$app.preloader.show();
            $.when(self.$app.methods.getDataAPI("Subscription/CreateCustomerPortal")).then(function( data, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                if(data != null){
                  window.open(data, "_blank");
                }
                //self.$app.methods.showToast("Payout was successful", "center", true);

            }).catch((data, textStatus, jqXHR) => {
            console.log(data, textStatus, jqXHR);
            self.$app.preloader.hide();
            self.$app.methods.showToast("An error occurred", "center");
            })
        },
        openPopUpDelivery: function(id){
          var self = this;
        
        //popup.once("opened", function(){
          if(id != null || id != undefined){
            var item = self.delivery.find(x => x.id == id);
            if(item != null){
                  self.$setState({
                  currentDeliveryOption: item
                });
                        
                $(".delivery_location").val(item.location);
                $(".delivery_cost").val(item.cost);
            }else{
              self.showToast("Delivery option not found", "center");
            }
            var popup = self.$app.popup.open('.newDeliveryOption', true);
            } else{
              var popup = self.$app.popup.open('.newDeliveryOption', true);
              self.$setState({
                currentDeliveryOption:null
              });
            }
        },
        closePopUpDelivery: function(){
          var self = this;
          var popup = self.$app.popup.close('.newDeliveryOption', true);
          $$(".delivery_location, .delivery_cost").val("");
          popup.once("closed", function(){
            self.getDeliveryOptions();
          });
        },
        saveDeliveryOption:function (){
          var self = this;
          var err = self.$app.input.validateInputs(".deliveryForm");
          if(err){

            var obj = {
                location: $(".delivery_location").val().trim(), 
                cost: parseFloat($(".delivery_cost").val()), 
                status:true
              };
            if(self.currentDeliveryOption != null){
              obj.id = self.currentDeliveryOption.id;
            }

            $.when(self.$app.methods.postDataAPI("business/SaveDeliveryOption", obj, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                //console.log("when data ings save ", data); // JSON data parsed by `data.json()` call
                if(data == true){
                  self.$app.methods.showToast("Delivery option saved", "center", true);
                  $(".delivery_location,.delivery_cost").val("");
                  //self.getData();
                  self.$setState({
                    currentDeliveryOption:null
                  });
                }
                
            }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
          }
        },
        getDeliveryOptions: function(){
          var self = this;

          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("business/GetDeliveries")).then(function( data, textStatus, jqXHR ) {
            self.$app.preloader.hide();
            if(data != null){
              if(data.length == 0){
                self.$app.methods.showToast("No delivery option added yet", "center");
                return;
              };

              $.each(data, function(ind, elem){
                data[ind].costFormatted = self.formatMoney(data[ind].cost);
              })

              self.$setState({
                    delivery: data
                })
            }

          }).catch((data, textStatus, jqXHR) => {
            self.$app.preloader.hide();
              if(data != null && data.status == 404){
                return;
              }
              self.$app.methods.showToast("An error occurred", "center");
          })
        },
        DeleteDelivery: function(id){
        var self = this;
        var checked = false;
        var text = "delete"
        self.$app.dialog.confirm("Are you sure you want to " + text + "?", "Omni", function(){
          self.$app.preloader.show();
              $.when(self.$app.methods.getDataAPI("business/DeleteDelivery?id=" + id)).then(function( data, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                if(data){

                  self.$app.methods.showToast("Delivery option deleted", "center", true);

                  self.delivery = self.delivery.filter(function(e){ 
                      return e.id != id;
                  });

                  self.$setState({
                    delivery: self.delivery
                  })
                }
                  
              }).catch((data, textStatus, jqXHR) => {
                self.$app.preloader.hide();
                  if(data != null && data.status == 404){
                    self.$app.methods.showToast("Delivery option not found", "center");
                    return;
                  }
                  self.$app.methods.showToast("An error occurred", "center");
              })
                
        }, null);
        //}, null);
    },
        checkUrl: function(){
          var self = this;
          var check = true;
          if(self.settings != null && self.settings.businessUrl != null){
            var currURL = $("#companyurl").val();
            if(currURL == "" || currURL == self.settings.businessUrl){
              check = false;
            }
          }

          if(check){
            var obj = {};
            obj.name = $("#companyurl").val();
            self.$app.preloader.show();
            $.when(self.$app.methods.postDataAPI("business/CheckBusinessName", obj, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                //console.log("when data ings save ", data); // JSON data parsed by `data.json()` call
                if(data == true){
                  self.$app.methods.showToast("URL is good", "center", true);
                }else{
                  self.$app.methods.showToast("URL is taken", "center", false);
                }
                
            }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
            })
          }
        },
        getProfile:function(){
          var self = this;
          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("business/GetBusinessProfile")).then(function( data, textStatus, jqXHR ) {
            self.$app.preloader.hide();
              $(".provinceOptGrp").show();
              var doc = data;
              var comName = doc.name;
              if(comName != ""){
                  $("#companyname").val(comName);
              }
              var taxes = doc.taxes;
              if(taxes != ""){
                  $("#taxes").val(taxes);
              }
              /*var comAdd = doc.address;
              if(comAdd != ""){
                  $("#companyaddress").val(comAdd);
              }*/
              $("#companyStreet").val(doc.street == null ? "" : doc.street);
              $("#companyCity").val(doc.city == null ? "" : doc.city);
              $("#companyPostalCode").val(doc.postalCode == null ? "" : doc.postalCode);

              if(doc.countryTwoDigit != null){
                $("#companyCountry").val(doc.countryTwoDigit).change();
              }

              if(doc.provinceCode != null){
                $("#companyProvince").val(doc.provinceCode);
                self.$setState({
                  province: doc.provinceCode
                })
              }

              var comNumber = doc.phoneNumber;
              if(comNumber != null && comNumber != ""){
                $("#phoneNumber").val(comNumber);
              }
              var tagline = doc.tagline;
              if(tagline != ""){
                  $("#companytagline").val(tagline);
              }
              var terms = doc.termsConditions;
              if(terms != "" && terms != undefined){
                var textEditor = self.$app.textEditor.get('.terms_condition');
                textEditor.setValue(terms);
              }
              var savedCurr = doc.currency;
              if(savedCurr != ""){
                  $('#currency').val(doc.country + " " + savedCurr);
              }
              var url = doc.businessUrl;
              if(url != null && url != ""){
                $("#companyurl").val(url);
              }

              var primColor = doc.primaryColor;
              if(primColor != null && primColor != ""){
                $(".primaryColor").css("background-color", primColor);
                $("#demo-color-picker-wheel").val(primColor);
              }

              //logo
              if(doc.logo != null && doc.logo != ""){
                $("#logoShow").attr("src", doc.logo);
              }

              //signature
              if(doc.signature != null && doc.signature != ""){
                $("#signatureShow").attr("src", doc.signature);
              }

              if(doc.stripeDetailsCompleted == true && doc.stripeChargesEnabled == true){
                $(".setUpPaymentHolder").addClass("display-none");
              }

              self.$setState({
                  settings: doc
              })
          }).catch((data, textStatus, jqXHR) => {
            self.$app.preloader.hide();
              if(data != null && data.status == 404){
                console.log("profile not found"); 
                return;
              }
              self.$app.methods.showToast(data.responseText, "center");
          })
        },
        getData: function(){
          var self = this;
          
          
        },
        showToast: function(text, position){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: 2000,
                        }).open();
        },
        setPayment: function(){
          var self = this;
          if(self.$app.data.settings == null || self.$app.data.settings.name == null || self.$app.data.settings.currency == null){
            self.$app.methods.showToast("Please complete filling your business profile first", "center");
            self.$app.views.main.router.navigate('/settings/company-details/');
            return;
          }
          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("business/StartStripeOnboard")).then(function( data, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                if(data != null){
                  if(data == "all set"){
                    self.$app.methods.showToast("Your payment settings is all set", "center", true);
                    return false;
                  }
                  //console.log("stripe url", data);
                  //$(".openStripeLink").attr("href", data);
                  //$(".openStripeLink").click();
                  var win = window.open(data, '_blank');
                  if (win) {
                      //Browser has allowed it to be opened
                      win.focus();
                  } else {
                      //Browser has blocked it
                      alert('Please allow popups for this website');
                  }
                }
            }).catch(function(err){
              self.$app.preloader.hide();
                    if(err != null && err.status == 404){

                    }
                    self.$app.methods.showToast("An error occurred", "center");
            });
        },
        getBalance: function(){
          var self = this;
          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("business/GetBalance")).then(function( data, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                if(data != null){
                  $("#stripepaymentdashboard").removeClass("display-none");
                  var av = data.available[0].amount/100 + " " + data.available[0].currency;
                  var pd = data.pending[0].amount/100 + " " + data.pending[0].currency;

                  $("#availableBalance").text(av);
                  $("#availableBalance").attr("data-amount", data.available[0].amount/100);
                  $("#pendingBalance").text(pd);
                  $("#pendingBalance").attr("data-amount", data.pending[0].amount/100);
                }
            }).catch(function(err){
              self.$app.preloader.hide();
                    if(err != null && err.status == 404){

                    }
                    self.$app.methods.showToast("An error occurred", "center");
            });
        },
        savecompanyinfo: function(){
            var self = this;
            var comName = $("#companyname").val().trim();
            //var comAdd = $("#companyaddress").val().trim();
            var taxes = $("#taxes").val().trim();
            var currency = $('#currency option:selected').data("value");
            var tagline = $("#companytagline").val();
            var terms = self.$app.textEditor.get('.terms_condition').value;
            var busURL = $("#companyurl").val().trim();
            var primColor = $("#demo-color-picker-wheel").val();
            var phone = $("#phoneNumber").val();

            if(taxes != ""){
                var tax = Number(taxes);
                if(isNaN(tax)){
                    self.showToast("Please enter tax in number or decimal only!", "center");
                    return;
                }
            }
            if(busURL == ""){
              self.showToast("Please enter url", "center");
              return;
            }

            if($("#companyStreet").val().trim() == ""){
              self.showToast("Please enter company street", "center");
              return;
            }

            if($("#companyCity").val().trim() == ""){
              self.showToast("Please enter company city", "center");
              return;
            }

            if($("#companyPostalCode").val().trim() == ""){
              self.showToast("Please enter company postal code", "center");
              return;
            }

            if($("#companyProvince").val().trim() == ""){
              self.showToast("Please choose company province", "center");
              return;
            }
            
            var saved = false;
            var obj = {};
            obj.name = comName;
            //obj.address = comAdd;
            obj.taxes = taxes;
            obj.currency = currency;
            obj.country = $("#currency option:selected").text().trim();
            obj.tagline = tagline;
            obj.termsConditions = terms;
            obj.businessUrl = busURL;
            obj.primaryColor = primColor;
            obj.phoneNumber = phone;
            obj.street = $("#companyStreet").val().trim();
            obj.postalCode = $("#companyPostalCode").val().trim();
            obj.city = $("#companyCity").val().trim();
            obj.provinceCode = $("#companyProvince").val().trim();
            obj.province = $("#companyProvince option:selected").text().trim();
            obj.countryTwoDigit = $("#companyCountry").val().trim();
            obj.countryName = $("#companyCountry option:selected").text().trim();

            var form_data = new FormData();

              for ( var key in obj ) {
                  form_data.append(key, obj[key]);
              }

            var fileUploadLogo = $("#logo").get(0);
            var filesLogo = fileUploadLogo.files;
            if(filesLogo.length > 0){
               // if there are multiple files , loop through each files
              for (var i = 0; i < filesLogo.length; i++) {
                form_data.append("logoImage", filesLogo[i]);
              }
            }

            var fileUploadSign = $("#signature").get(0);
            var filesSign = fileUploadSign.files;
            if(filesSign.length > 0){
               // if there are multiple files , loop through each files
              for (var i = 0; i < filesSign.length; i++) {
                form_data.append("signatureImage", filesSign[i]);
              }
            }
           
            /*self.$app.preloader.show();
            $.when(self.$app.methods.postDataAPI("business/SaveBusinessForm", form_data, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data == true){
                  self.$app.methods.showToast("Information saved", "center", true);
                }
                
            }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })*/
            $.when(self.$app.methods.postFormDataAPI("business/SaveBusinessForm", form_data, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data == true){
                  self.$app.methods.showToast("Information saved", "center", true);
                  self.$app.methods.resaveSettings(obj);
                }
                
            }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
        },

        formatMoney:function(val){   
          var self = this;   
          var ret = self.$app.methods.formatMoney(val);
          return ret;
        },
      },
      on: {
        pageAfterIn: function(e, page) {
        var self = this;
        //trackSettingsPage();
      },
      pageInit: function(e, page) {
            var self = this;

            var listCurr = [];
            Object.keys(currencies).forEach(function(key) {
              var eachCur = {
                "name": key,
                "symbol": currencies[key]
              }
              listCurr.push(eachCur);
            });

            self.$setState({
                countries: countryList.map(x => ({"isoCode":x.iso2,"name":x.name})),
                currencies: listCurr
            });

            /*fetch delivery*/
            
            $("#delivery-settings").on('tab:show', function() { 
                self.getDeliveryOptions();
            });

            /*fetch delivery*/

            /* payment page*/

            $("#payment-settings").on('tab:show', function() { 
                if(self.settings.stripeChargesEnabled == true && self.settings.stripeDetailsCompleted == true){
                  self.getBalance();
                }
            })

            //plans and subscription page
            $("#plan-pricing").on('tab:show', function() { 
                if(self.settings.storeSubscribed == true){
                  $("#SubscribePage").addClass("display-none");
                  $("#UserIsSubscribed").removeClass("display-none");
                }
            })

            /* payment page*/
            /*if(self.$app.views.main.router.previousRoute?.path != "/signup/"){
              self.getProfile();
            };*/
            
            self.getProfile();

            $("#logo").change(function(){
                self.getBase64(this, "logo");
            });
            $('#companyurl').on('keypress', function (event) {
                var regex = new RegExp("^[a-zA-Z0-9-_]+$");
                var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
                if (!regex.test(key)) {
                  event.preventDefault();
                  return false;
                }
            });
            $("#companyurl").on("blur", function(){
              var url = $("#companyurl").val().trim();
              if(url != ""){
                var hasSlash = url.indexOf("/");
                var regex = new RegExp("^[a-zA-Z0-9-_]+$");
                var pass = regex.test(url);
                if(!pass || hasSlash > -1){
                  self.$app.methods.showToast("Please enter a valid name as URL", "center");
                  return;
                }
                self.checkUrl();
              }
            });

            $("#companyCountry").on("change", function(){
              var val = $("#companyCountry").val();
              var theStates = [];
              var theRegion = "";
              if(val != ""){
                theStates = stateList.filter(x => x.country_code == val);
                theRegion = countryList.find(x => x.iso2 == val).region;
              }
                self.$setState({
                  states: theStates,
                  region: theRegion
                }, function(){
                  if(self.province  != null){
                    $("#companyProvince").val(self.province);
                  }
                });
                if(theRegion == "Africa"){
                  $(".hideSubs").addClass("display-none");
                  $(".subscribeCost").text("$2");
                }else{
                  $(".hideSubs").removeClass("display-none");
                  $(".subscribeCost").text("$8");
                }
                //hideSubs

                //var theCurrency = currencies[Country.getCountryByCode(val).currency];
                //$("#currency").val(theCurrency);
            })

            $("#signature").change(function(){
              self.getBase64(this, "signature");
            });
            var cur = Object.keys(currencies);
            
            //initialize color picker
            var colorPickerWheel = self.$app.colorPicker.create({
                inputEl: '#demo-color-picker-wheel',
                targetEl: '#demo-color-picker-wheel-value',
                targetElSetBackgroundColor: true,
                modules: ['wheel'],
                openIn: 'popover',
                value: {
                  hex: '#000000',
                },
              });

            var autocompleteDropdownAll = self.$app.autocomplete.create({
                inputEl: '#autocomplete-dropdown-all',
                openIn: 'dropdown',
                source: function (query, render) {
                    var results = [];
                    // Find matched items
                    for (var i = 0; i < cur.length; i++) {
                    if (cur[i].toLowerCase().indexOf(query.toLowerCase()) >= 0) results.push(cur[i]);
                    }
                    // Render items by passing array with result items
                    render(results);
                    },
                on:{
                    change: function (value) {
                        var cnt = value[0];
                        var val = currencies[cnt];
                        $('#autocomplete-dropdown-all').val(val);
                        self.$setState({
                            country: cnt
                        })
                        //localStorage.setItem("currency", val);
                    }     
                }
                });
                var textEditorCustomButtons = self.$app.textEditor.create({
                  el: '.terms_condition',
                  buttons: [["bold", "italic", "underline", 'h1', 'h2', 'h3', 'orderedList', 'unorderedList']],
                  on: {
                    buttonClick: function (editor, button) {
                        var act = $('button[data-button="' + button + '"]').hasClass("active");
                        if(act){
                          $('button[data-button="' + button + '"]').removeClass("active");
                        }else{
                          $('button[data-button="' + button + '"]').addClass("active");
                        }
                      }
                    }
                });
            }  
        }
    }

    function trackSettingsPage(){
      try{
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
    'event': 'Pageview',
    'pagePath': 'https://www.mogulsheet.com/settings',
    'pageTitle': 'Settings' //some arbitrary name for the page/state
    });
  }catch(err){
    
  }
    }
  </script>
  