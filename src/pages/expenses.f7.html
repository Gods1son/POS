<template>
<div class="page" data-name="expenses">
  <div class="navbar">
    <div class="navbar navbar-bg"></div>
    <div class="navbar-inner sliding">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title">Expenses</div>
    </div>
  </div>

      <!--fab-->
    <div class="fab fab-extended fab-right-bottom">
      <a href="#" @click="openPopUp(null)">
        <i class="icon f7-icons">plus</i>
        <!-- Element with FAB text  -->
        <div class="fab-text">Expense</div>
      </a>
    </div>
    <!--fab-->

  <div class="page-content">
    
    <div class="item-content block-title margin-bottom-half margin-top-half">
        <div class="row padding-vertical">
            <div class="col">
                
            </div>
    
                <div class="col">
                    <span class="item-after float-right margin-left-half">
                        <label class="toggle toggle-init color-red showInactiveExpenses">
                        <input type="checkbox">
                        <span class="toggle-icon"></span>
                        </label>
                    </span>
                    <span class="item-title float-right">Show Deleted</span>
                </div>
            </div>
    </div>

    <div class="list accordion-list no-margin-vertical">
      <ul>
        <li class="accordion-item myOrange"><a href="#" class="item-content item-link text-color-white bg-color-orange">
            <div class="item-inner">
              <div class="item-title">Summary of Expenses</div>
            </div></a>
          <div class="accordion-item-content">
            <div class="block no-margin-vertical no-padding-vertical">
              <div class="row no-gap">
        
                  <div class="col-100 medium-50 small-50 xsmall-100">
                    <div class="card card-outline text-align-center no-margin">
                      <div class="block-title padding-vertical-half no-margin ruleUnder">Total {{js "this.totalMat > 1 ? 'Expenses' : 'Expense'"}}</div>
                      <div class="card-content padding-vertical-half block-title-large text-color-orange">{{totalMat}}</div>
                    </div>
                  </div>
        
                  <div class="col-100 medium-50 small-50 xsmall-100">
                    <div class="card card-outline text-align-center no-margin">
                      <div class="block-title padding-vertical-half no-margin ruleUnder">Total amount of expenses</div>
                      <div class="card-content padding-vertical-half block-title-large text-color-orange">{{money totalToPay}}</div>
                    </div>
                  </div>
        
                  <div class="col-100 medium-50 small-50 xsmall-100">
                    <div class="card card-outline text-align-center no-margin">
                      <div class="block-title padding-vertical-half no-margin ruleUnder">Total amount paid</div>
                      <div class="card-content padding-vertical-half block-title-large text-color-orange">{{money totalPaid}}</div>
                    </div>
                  </div>
        
                  <div class="col-100 medium-50 small-50 xsmall-100">
                    <div class="card card-outline text-align-center no-margin">
                      <div class="block-title padding-vertical-half no-margin ruleUnder">(Total Expenses - Total Amount Paid)</div>
                      <div class="card-content padding-vertical-half block-title-large text-color-orange">{{money totalDifference}}</div>
                    </div>
                  </div>
              </div>
            </div>
          </div>
        </li>
        </ul>
    </div>

  <div class="block no-margin-vertical">
    <div class="list no-hairlines-md no-margin-bottom margin-top-half">
                <ul>
                    <li>
                    <div class="item-content item-input">
                        <div class="item-inner">
                        <div class="item-input-wrap">
                            <input type="text" placeholder="Filter expenses by date" id="expenses-calendar-modal"/>
                            <span class="input-clear-button" @click="resetTableExpenses"></span>
                        </div>
                        </div>
                    </div>
                    </li>
                </ul>
                </div>

      <table id="expenseTable" class="compact row-border">
        <thead>
          <tr>
            <th class="label-cell1">ID</th>
            <th class="input-cell">Expense Name</th>
            <th class="numeric-cell1">Amount to be paid</th>
            <th class="label-cell1">Recurring Payment</th>
            <th class="numeric-cell1">Amount paid</th>
            <th class="label-cell1">Date paid</th>
            <th class="label-cell1">Created Date</th>
            <th></th>
          </tr>
        </thead>
        <!--<tbody class="search-content-list-exp">
          {{#each expenses}}
            <tr>
              <td class="label-cell">{{js "@index + 1"}}</td>
              <td class="label-cell searchRowName">{{name}}</td>
              <td class="label-cell">{{money amount_to_pay}}</td>
              <td class="label-cell">{{money amount_paid}}</td>
              <td class="label-cell">
                    <label class="toggle toggle-init expense-{{id}}">
                    <input type="checkbox" {{js "this.recurring == 1 ? 'checked' : ''"}} disabled>
                    <span class="toggle-icon"></span>
                    </label>
                  </td>
              <td class="label-cell"><span class={{js "this.amount_paid < this.amount_to_pay ? 'display-none' : ''"}}>{{convertDate date_paid}}</span></td>
              <td class="label-cell">{{convertDate created_date}}</td>
              <td>
                  <p class="display-inline-flex">
                      <a class="button button-fill margin-right-half" @click="openPopUp({{id}})">Edit</a>
                      <a class="button button-fill color-red" @click="deleteExpense({{id}})">
                        {{js "this.status == 1 ? 'delete' : 'activate'"}}
                    </a>
                  </p>
              </td>
            </tr>
          {{/each}}
        </tbody>-->
      </table>
    </div>
  </div>

  <!--pop up-->
  <div class="popup newExpense popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner bg-color-blue text-color-white">
            <div class="title">Add New Expense</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link text-color-white" @click="closePopUp"><i class="icon f7-icons">multiply</i>Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half expenseForm">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Expense Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="name" placeholder="expense name" required validate/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Amount to be paid</div>
                      <div class="item-input-wrap">
                        <input type="text" class="amount_to_pay" placeholder="Amount to pay" value="0" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Amount paid</div>
                      <div class="item-input-wrap">
                        <input type="text" class="amount_paid" placeholder="Amount Paid" value="0" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Date expense got paid</div>
                      <div class="item-input-wrap">
                          <input type="text" placeholder="Date expense got paid" id="paid-calendar-modal"/>
                          <span class="input-clear-button"></span>
                      </div>
                      </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner-1">
                      <span class="item-title">Recurring Payment</span>
                      <!--<div class="item-after">-->
                        <label class="toggle toggle-init recurring margin-left-half">
                          <input type="checkbox">
                          <span class="toggle-icon"></span>
                        </label>
                      <!--</div>-->
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Date of Expense</div>
                      <div class="item-input-wrap">
                          <input type="text" placeholder="Date of purchase" id="expense-calendar-modal"/>
                          <span class="input-clear-button"></span>
                      </div>
                      </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-fill button-raised color-green" @click='saveData'>Save Expense</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

</div>
</template>
<script>
import Dom7 from 'dom7';
import Dexie from 'dexie';

var db = new Dexie("BizExpenseManagerDB");
          db.version(1).stores({
            ingredients: "++id,name,unit_size,unit,cost_per_unit,status,created_date",
            products: "++id,name,cost,status,created_date",
            product_ingredient: "++id,productID,ingredientID,unit_size,cost,status,created_date",
            product_otherMaterials: "++id,productID,name,cost,status,created_date",
            sales: "++id,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses: "++id,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status",

            ingredients_history: "++id,ingID,name,unit_size,unit,cost_per_unit,status,created_date",
            products_history: "++id,prodID,name,cost,status,created_date",
            sales_history: "++id,salesID,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses_history: "++id,expID,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status"
          })

var $$ = Dom7;
export default {
  data: function () {
      // Must return an object
      return {
        expenses: null,
        totalMat:0,
        currentExpense:null,
        totalToPay: 0,
        totalPaid: 0,
        totalDifference: 0,
      }
    },
  methods:{
    deleteExpense: function(id){
        var self = this;
        var checked = 0;
        var text = "delete"
        var toggle = self.$app.toggle.get(".showInactiveExpenses");
        if(toggle != undefined){
            if(toggle.checked){
                text = "activate";
                checked = 1;
            }
        }
        self.$app.dialog.confirm("Are you sure you want to " + text + " this expense?", function(){
            db.expenses.update(Number(id), {status: checked}).then(function (updated) {
              if (updated){
                self.expenses = self.expenses.filter(function(e){ 
                      return e.id != Number(id);
                  });
                  var act = checked == 0 ? "deleted!" : "activated!";
                  self.showToast("Expense " + act, "center");
                  //console.log(self.ings);
                  self.$setState({
                      expenses:self.expenses,
                      totalMat:self.expenses.length
                  }, function(){
                    var but = $("#expenseTable").find(".deleteExpense[data-id='" + id + "']");
                      var row = $(but).parents("tr").eq(0);
                      self.showToast("Expense " + text + "d!", "center");
                      $("#expenseTable").DataTable().row(row).remove().draw(false);
                    self.calculateTotalMoneyExpense();
                  });
              }
            });
        }, null);
    },
    openPopUp: function(id){
        var self = this;
        var calendar = self.$app.calendar.create({
                inputEl: '#paid-calendar-modal',
                timePicker: true,
                dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });
              var calendarPurchase = self.$app.calendar.create({
                  inputEl: '#expense-calendar-modal',
                  timePicker: true,
                  dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });
        //popup.once("opened", function(){
          if(id != null || id != undefined){
              var item = self.expenses.find(function(e){ 
                        return e.id == Number(id);
                    });
                    self.$setState({
                      currentExpense:Number(id)
                    });
                    $$("input.name").val(item.name);
                    $$("input.amount_to_pay").val(item.amount_to_pay);
                    $$("input.amount_paid").val(item.amount_paid);
                    var toggle = self.$app.toggle.get(".recurring").checked;
                    if((toggle == true && item.recurring == 0) || (toggle == false && item.recurring == 1)){
                        self.$app.toggle.get(".recurring").toggle();
                    }
                    if(item.created_date != ""){
                      var myDate = new Date(item.created_date);
                      myDate = myDate.toLocaleString();
                      $("#expense-calendar-modal").val(myDate);
                    }
                    if(item.date_paid != ""){
                      var myDate = new Date(item.date_paid);
                      myDate = myDate.toLocaleString();
                      $("#paid-calendar-modal").val(myDate);
                    }
                    var popup = self.$app.popup.open('.newExpense', true);
            } else{
              var popup = self.$app.popup.open('.newExpense', true);
              self.$setState({
                  currentExpense:null
              });
            }
        //})
        
    },
    calculateTotalMoneyExpense: function(){
        var self = this;
        var totalToPay = 0;
        var totalPaid = 0;
        //var totalMoney = 0;
        $.each(self.expenses, function(index,item){
            if(item.amount_to_pay != 0 && item.amount_to_pay != ""){
                totalToPay += Number(item.amount_to_pay);
            }
            if(item.amount_paid != 0 && item.amount_paid != ""){
                totalPaid += Number(item.amount_paid);
            }
            //totalMoney += Number(item.cost);
        })
        self.$setState({
            totalToPay: totalToPay,
            totalPaid: totalPaid,
            totalDifference: (totalToPay - totalPaid),
        }, function(){
          self.calculateTotalMoneyExpense();
        });
    },
    resetTableExpenses: function(){
        var self = this;
        console.log("empty");
        self.getData();
    },
    showCalendarPopup: function(){
        var self = this;
        var calendarModal = self.$app.calendar.create({
            inputEl: '#expenses-calendar-modal',
            openIn: 'sheet',
            header: true,
            footer: true
        });
      },
    closePopUp: function(){
        var self = this;
        $$("input.name,input.amount_to_pay,input.amount_paid, #expense-calendar-modal, #paid-calendar-modal").val("");
        var popup = self.$app.popup.close('.newExpense', true);
        popup.once("closed", function(){

        });
    },
    saveData: function(){
      //var $$ = this.Dom7;
      var self = this;
      var elem = $$("input:required");
      var err = self.$app.input.validateInputs(".expenseForm");
      var toggle = self.$app.toggle.get(".recurring");
      var isRecur = toggle.checked == true ? 1 : 0;
      var toPay = $$("input.amount_to_pay").val();
      var paid = $$("input.amount_paid").val();
      var paidDate = ""; var today = Date.parse(new Date($.now()));
      if($("#expense-calendar-modal").val().trim() == ""){
        self.showToast("Please pick date of expense", "center");
        return;
      }
      if(($("#paid-calendar-modal").val().trim() == "") && ($$("input.amount_paid").val() != "0" && $$("input.amount_paid").val().trim != "")){
          self.showToast("Please choose date expense was paid!", "center");
          return;
      }
      if(Number(paid) > 0 && Number(paid) >= Number(toPay)){
            paidDate = Date.parse(new Date($.now()));
      }
      if($("#paid-calendar-modal").val().trim() != ""){
        paidDate = Date.parse($("#paid-calendar-modal").val());
      }
      if(err){
        var obj = {
                name: $$("input.name").val(), 
                amount_to_pay: $$("input.amount_to_pay").val(), 
                amount_paid: $$("input.amount_paid").val(), 
                recurring: isRecur,
                date_paid: paidDate,
                created_date: Date.parse($("#expense-calendar-modal").val()), 
                status:1
              };
            if(self.currentExpense != null){
              obj.id = self.currentExpense;
              var select = self.expenses.find(function(e){ 
                    return e.id == Number(self.currentExpense);
                });
            }
          db.expenses.put(obj).then(function(id) {
                  db.expenses.get(id).then(function(item) {
                    self.showToast("Item saved.", "center");
                    $$("input.name,input.amount_to_pay,input.amount_paid, #expense-calendar-modal, #paid-calendar-modal").val("");
                    self.$app.popup.close('.newExpense', true);
                    self.getData();
                })
              })
          }else{
              self.showToast("Please fill all required fields", "center");
          }
    },
    showToast: function(text, position){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: 2000,
                        }).open();
    },
    setDataTable: function(){
            var self = this;
            if(self.expenses != null && self.expenses.length >= 0){
                var table = $("#expenseTable").DataTable();
                table.clear().destroy();
                table = $('#expenseTable').DataTable( {
                      data: self.expenses,
                      pageLength: 10,
                      columns: [//id,name,amount_to_pay,recurring,amount_paid,date_paid,created_date,status
                          { "data": "id" },
                          { "data": "name" },
                          { "data": "amount_to_pay" },
                          { "data": "recurring" },
                          { "data": "amount_paid" },
                          { "data": "date_paid" },
                          { "data": "created_date" },
                          { "data": "status" }
                      ],
                      columnDefs: [
                        { "searchable": true, "targets": 1 },
                        { "searchable": true, "targets": 2 },
                        {
                          targets: [0],
                          render: function ( data, type, row ) {
                          return data+row.unit;
                            }
                        },
                        {
                          targets: [2,4],
                          searchable:true,
                          render: function ( data, type, row ) {
                              return data.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
                            }
                        },
                        {
                          targets: [3],
                          searchable:true,
                          render: function ( data, type, row ) {
                              if(data == 1){
                                return '<span class="display-none">1</span><label class="checkbox"><input type="checkbox" checked disabled><i class="icon-checkbox"></i></label>'
                              }else{
                                return '<span class="display-none">0</span><label class="checkbox"><input type="checkbox" disabled><i class="icon-checkbox"></i></label>'
                              }
                            }
                        },
                        {
                          targets: [5],
                          searchable:true,
                          render: function ( data, type, row ) {
                                if(data != "" && data != undefined){
                                  var myDate = new Date(data);
                                  myDate = myDate.toLocaleString();
                                  return myDate;
                                }else{
                                  return "";
                                }
                            }
                        },
                        {
                          targets: [6],
                          searchable:true,
                          render: function ( data, type, row ) {
                            if(data != "" && data != undefined){
                                  var myDate = new Date(data);
                                  myDate = myDate.toLocaleString();
                                  return myDate;
                                }else{
                                  return "";
                                }
                            }
                        },
                        {
                            targets: "_all",
                            className: 'dt-body-center dt-head-center'
                        },
                        {
                          targets: [-1],
                          "orderable": false,
                          render: function ( data, type, row ) {
                            var html = '<p class="display-inline-flex margin-vertical-half">';
                            html += '<a class="button button-fill margin-right-half openPopUp" data-id="' + row.id + '">Edit</a>';
                            html += '<a class="button button-fill color-red deleteExpense" data-id="' + row.id + '">';
                            html +=  row.status == 1 ? 'delete' : 'activate';
                            html += '</a></p>';
                            return html;
                            }
                          }
                        ],
                        "createdRow": function (row, data, index) {
                            var info = table.page.info();
                            $('td', row).eq(0).html(index + 1);
                        },
                        "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                            //debugger
                            var oSettings = this.fnSettings();
                            $("td:first", nRow).html(oSettings._iDisplayStart + iDisplayIndex + 1);
                            return nRow;
                        }
                    });
                }

                          $('#expenseTable tbody').off("click").on('click','.button', function () {
                              var data = $(this).attr("data-id");
                              //console.log(data);
                              if($(this).hasClass("openPopUp")){
                                self.openPopUp(data);
                              }
                              if($(this).hasClass("deleteExpense")){
                                self.deleteExpense(data);
                              }
                              //return false;
                          });

                        self.calculateTotalMoneyExpense();
    },
    getData: function(){
      var self = this;
      var checked = 1;
        var toggle = self.$app.toggle.get(".showInactiveExpenses");
      if(toggle != undefined){
        checked = toggle.checked == true ? 0 : 1;
      }
      //console.log(checked);
      var collection = db.expenses.where('status').equals(checked).reverse().toArray(function(arr){
        //var collection = db.ingredients.toArray(function(arr){
        //console.log(arr);
        //console.log("fretched - " + checked);
          self.$setState({
                expenses: arr,
                totalMat:arr.length
              }, function(){
                var table = $("#expenseTable").DataTable();
                self.setDataTable();
              });
      });
    }
  },
  on: {
      pageInit: function(e, page) {
        var self = this;
        //console.log("test inactive init");
        $("#expenseTable").DataTable();
        $$(".showInactiveExpenses").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        var calendarModal = self.$app.calendar.create({
            inputEl: '#expenses-calendar-modal',
            openIn: 'customModal',
            rangePicker: true,
            header: true,
            footer: true
        });
        calendarModal.on("closed", function(){
            //console.log(calendarModal.getValue());
            var days = calendarModal.getValue();
            if(days == undefined){
                return;
            }
            var from = null; var to = null;
            if(days.length == 1){
                from = Date.parse(days[0]);
                days.push(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = Date.parse(date2);
            }
            else if(days.length > 1){
                //var date1 = days[0];
                //date1.setDate(date1.getDate() + 1);
                from = Date.parse(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = Date.parse(date2);
            }else{
                self.getData();
            }
            if(from != null && to != null){
                //console.log(from);
                //console.log(to);
                var checked = 1;

                var collection = db.expenses.where('created_date').between(from, to)
                .filter(function (sale) {
                    return sale.status === 1;
                }).toArray(function(arr){
                    //var collection = db.ingredients.toArray(function(arr){
                    //console.log(arr);
                    self.$setState({
                            expenses: arr,
                            totalMat:arr.length
                        }, function(){
                          self.setDataTable();
                        });
                });
            }
        })        
        self.getData();
      },
      pageReinit: function(e, page) {
        var self = this;
        //console.log("test inactive reinit");
        $$(".showInactiveExpenses").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        //console.log("test inactive reinit 2");
        self.getData();
      }
  }

} 
</script>