<template>
<div class="page" data-name="expenses">
  <div class="navbar">
    <div class="navbar navbar-bg"></div>
    <div class="navbar-inner sliding">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title padding-vertical-half">Expenses</div>
      <div class="right">
        <a href="#" class="link icon-only panel-toggle" data-panel="left">
          <i class="icon f7-icons if-not-md">menu</i>
          <i class="icon material-icons if-md">menu</i>
        </a>
      </div>
    </div>
  </div>

      <!--fab-->
    <div class="fab fab-extended fab-right-bottom">
      <a href="#" @click="openPopUp(null)">
        <i class="icon f7-icons">plus</i>
        <!-- Element with FAB text  -->
        <div class="fab-text">Expense</div>
      </a>
    </div>
    <!--fab-->

  <div class="page-content">

    <div class="block no-margin-vertical no-margin-horizontal no-padding-vertical roundHolder no-padding-horizontal">
      <div id="expenses-list" class="customList">
        <div class="text-align-center customListSub">
          <div class="searchbar searchbar-inline">
            <div class="searchbar-input-wrap">
              <input type="search" placeholder="Search" class="search">
              <i class="searchbar-icon"></i>
              <span class="input-clear-button"></span>
            </div>
          </div>
        </div>

        <div class="no-margin-vertical padding-horizontal-half">
            <div class="">
              <div class="block no-margin-vertical no-padding">
                <div class="row no-gap dash">
        
                  <div class="col-100 medium-33">
                    <div class="card card-outline padding-vertical-half totalExpenses">
                      <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder text-color-white">Total Expenses</div>
                      <div class="card-content text-color-white">{{totalToPay}}</div>
                    </div>
                  </div>
                  
                  <div class="col-100 medium-33">
                    <div class="card card-outline padding-vertical-half">
                      <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Total Amount Paid</div>
                      <div class="card-content">{{totalPaid}}</div>
                    </div>
                  </div>

                  <div class="col-100 medium-33">
                    <div class="card card-outline padding-vertical-half">
                      <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Number of {{js "this.totalMat > 1 ? 'Expenses' : 'Expense'"}}</div>
                      <div class="card-content">{{totalMat}}</div>
                    </div>
                  </div>
        
                  <!--<div class="col-100 medium-33">
                    <div class="card card-outline">
                      <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">(Total Amount Paid minus Total Expenses)</div>
                      <div class="card-content">{{totalDifference}}</div>
                    </div>
                  </div>-->
        
              </div>
            </div>
          </div>
    </div>

    <div class="text-align-center">
      <!--<input class="search" placeholder="search">-->
      <!-- Additional "searchbar-inline" class -->
      

      <div class="margin-vertical-half padding-vertical-half sortTextPar">
        
        <span class="sortText display-none">Sort By:</span>
        <!--<span class="sort" data-sort="name">Name</span>
        <span class="sort" data-sort="cost">Cost</span>-->
      </div>
    </div>

          <div class="row margin-top-half myToolbar">
            <div class="col-50 no-padding-vertical">
              <span class="margin-left-half">You have {{totalMat}} {{js "this.totalMat > 1 ? 'expenses' : 'expense'"}}</span>
            </div>

            <div class="col-33 no-padding-vertical text-align-right display-none">
              <span class="display-inline-flex margin-right-half display-none">
                <span class="item-title item-label float-right">Show Deleted</span>
                <span class="item-after float-right margin-left-half">
                    <label class="toggle toggle-init color-red showInactiveExpenses">
                    <input type="checkbox">
                    <span class="toggle-icon"></span>
                    </label>
                </span>
                </span>
            </div>

            <div class="col-33 no-padding-vertical">
              <div class="block no-margin-vertical filterDateParent">  
                <div class="no-hairlines-md no-margin-bottom margin-top-half">
                    <div class="item-content item-input1">
                        <div class="item-inner bg-color-white specWrap">
                        <div class="item-input-wrap">
                          <input type="text" class="specSearch" placeholder="Date Filter" id="demo-calendar-modal-expense"/>
                          <span class="input-clear-button specClear" @click="resetTable"></span>
                        </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>

          </div>


          <div class="expenses-table data-table margin-vertical-half">
            <table>
                <thead>
                  <tr>
                    <th class="sort" data-sort="name"><i class="icon f7-icons">arrow_up_down</i> Name</th>
                    <th class="sort" data-sort="cost"><i class="icon f7-icons">arrow_up_down</i> Amount to Pay</th>
                    <th>Amount Paid</th>
                    <th class="sort" data-sort="paidAll"><i class="icon f7-icons">arrow_up_down</i> Fully Paid</th>
                    <th>Recurring</th>
                    <th class="sort" data-sort="created_date"><i class="icon f7-icons">arrow_up_down</i> Date of Purchase</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody class="list sortList">
  
                </tbody>
            </table>
          </div>
          <ul class="list sortList margin-vertical-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>
      </div>

  </div>

   <!--pop up add new product-->
   <!--<div class="popup expenseImages popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">View Expense Receipts</div>
            <div class="right">
              <a class="link" @click="closeReceiptImages()"><i class="icon f7-icons">multiply</i>Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
          <div class="block margin-half">
            
            <div>
              <input type="file" name="photos" id="myPhotos2" accept="image/x-png,image/gif,image/jpeg,image/jpg,image/png" @change="checkFiles" multiple>
              <a class="button mainButton margin-vertical-half" @click="uploadImages">Upload Now</A>
            </div>

            

          </div>
        </div>
      </div>
    </div>
  
  </div>-->

  <!--pop up-->
  <div class="popup newExpense popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Add/Edit Expense</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePopUp"><i class="icon f7-icons">multiply</i>Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half expenseForm">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Expense Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="name" placeholder="expense name" required validate/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Amount to be Paid</div>
                      <div class="item-input-wrap">
                        <input type="text" class="amount_to_pay" placeholder="Amount to pay" value="0" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Amount Paid</div>
                      <div class="item-input-wrap">
                        <input type="text" class="amount_paid" placeholder="Amount Paid" value="0" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Date expense got paid</div>
                      <div class="item-input-wrap">
                          <input type="text" placeholder="Date expense got paid" id="paid-calendar-modal"/>
                          <span class="input-clear-button"></span>
                      </div>
                      </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner-1 padding-top-half">
                      <div class="item-title item-label">Recurring Payment</div>
                      <!--<div class="item-after">-->
                        <label class="toggle toggle-init recurring">
                          <input type="checkbox">
                          <span class="toggle-icon"></span>
                        </label>
                      <!--</div>-->
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Date of Expense</div>
                      <div class="item-input-wrap">
                          <input type="text" placeholder="Date of purchase" id="expense-calendar-modal"/>
                          <span class="input-clear-button"></span>
                      </div>
                      </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Upload Receipts (maximum of 5 images and size less than 2MB)</div>
                      <div class="item-input-wrap">
                        <input type="file" name="photos" id="myPhotos" accept="image/x-png,image/gif,image/jpeg,image/jpg,image/png" @change="checkFiles" multiple>
                            
                        <div class="swiper-container demo-swiper margin-top">
                              <div class="swiper-pagination"></div>
                              <div class="swiper-wrapper expenseWrapper">
                
                              </div>
                            </div>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-outline button-raised mainButton" @click='saveData'>Save Expense</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

</div>
</template>
<script>
//import Dom7 from 'dom7';
//import Dexie from 'dexie';
import * as moment from 'moment';

var dbExpenses = null, dbSettings = null, mogulsheetdb = null;
var expenseList = null;
//var $$ = Dom7;
export default {
  data: function () {
      // Must return an object
      return {
        expenses: null,
        totalMat:0,
        currentExpense:null,
        totalToPay: 0,
        totalPaid: 0,
        totalDifference: 0,
        settings: null,
        settingsID: 'settings',
        backendUrl: 'https://posbackend.herokuapp.com/',   //  'http://localhost:3000/'
      }
    },
  methods:{
    b64toBlob: function(dataurl, filename) {
            var arr = dataurl.split(','),
            mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), 
            n = bstr.length, 
            u8arr = new Uint8Array(n);
            
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        
        return new File([u8arr], filename, {type:mime});
    },
    uploadImages: function(){
          var self = this;
            var form_data = new FormData();
            

            var fileUpload = $("#myPhotos").get(0);
            var files = fileUpload.files;
            if(files.length > 0){
               // if there are multiple files , loop through each files
               form_data.append("id", self.currentExpense.id);
              for (var i = 0; i < files.length; i++) {
                form_data.append("receiptsImages", files[i]);
              }
            }else{
              return;
            }
            
            self.$app.preloader.show();
            //return;
            $.when(self.$app.methods.postFormDataAPI("expenses/UploadReceipts", form_data, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                //self.currentExpense.receipts = data;
                self.$app.methods.showToast("Receipts uploaded", "center", true);
                self.getData();
                
            }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
    },
    setupReader: function(file) {
      var self = this;
        var name = file.name;
        var reader = new FileReader();  
        reader.onload = function(e) {  
              var html = "<div class='swiper-slide'>";
              html += "<div class='holderSwiper'><img class='images new' src='" + reader.result + "' data-name='" + name + "'></div>";
              html += "<div><p><a class='button bg-color-red text-color-white deleteImage'>Delete Image</a></p></div></div>";
              $(".expenseWrapper").append(html); 
              self.reInitSwiper();
        }
        reader.readAsDataURL(file);
    },
    checkFiles: function(e) {  
      var self = this;
      var maxLimit = 5;  
      var id = e.target.id;

      let list = new DataTransfer;
      var cut = 0;
      var pres = 0;
      //$(".expenseWrapper").empty(); 
      for(var i = 0; i < $('#' + id)[0].files.length; i++){
          var files = $('#' + id)[0].files[i];
          var size = files.size / 1024 / 1024;
          if((size <= 2) && (i < maxLimit)){
            //self.setupReader(files);
           /* var reader = new FileReader();
            reader.onload = function(){
              var html = "<div class='swiper-slide'>";
              html += "<div class='holderSwiper'><img class='images' src='" + reader.result + "'></div>";
              html += "<div><p><a class='button bg-color-red text-color-white deleteImage'>Delete Image</a></p></div></div>";
              $(".expenseWrapper").append(html); 
            };
            reader.readAsDataURL(files);*/
              //list.items.add(files);
          }else{
              cut++;
          }
      }  
      //document.getElementById(id).files = list.files; 
      var tense = cut == 1 ? " file was " : " files were "
      if(cut > 0) alert(cut + tense + "removed because it's too large or you went above file limits");   
  },
    reInitSwiper: function(){
      var self = this;
      self.$app.swiper.destroy('.swiper-container');
      var swiper = self.$app.swiper.create('.swiper-container', {
        //data-pagination='{"el": ".swiper-pagination"}' data-space-between="10" data-slides-per-view="auto" data-centered-slides="true" 
          speed: 400,
          spaceBetween: 10,
          centeredSlides: true,
          pagination: {"el": ".swiper-pagination"}
      });
    },
    closeReceiptImages: function(){
      var self = this;
      var popup = self.$app.popup.close('.expenseImages', true);
      self.$app.swiper.destroy('.swiper-container');
      $(".expenseWrapper, .swiper-pagination").empty();
      document.getElementById("myPhotos").value = "";
      self.$setState({
        currentExpense:null
      });
      popup.once("closed", function(){
            self.getData();
        });
    },
    deleteImage: function(name, but){
      var self = this;
      $(but).parents(".swiper-slide").eq(0).remove();
      self.reInitSwiper();
      var obj = {}
      obj.name = name;
      obj.id = self.currentExpense.id;
      self.$app.preloader.show();
      $.when(self.$app.methods.postDataAPI("expenses/DeleteImage", obj, true)).then(function( data, textStatus, jqXHR ) {
        self.$app.preloader.hide();
      }).catch((err) => {
        self.$app.preloader.hide();
        self.$app.methods.showToast("An error occurred", "center");
      })
    },
    permdeleteExpense: function(list, id){
        var self = this;
        
        self.$app.dialog.confirm("Are you sure you want to permanently delete this expense?", "Omni", function(){
                mogulsheetdb.get(id).then(function(doc) {
                        // console.log(doc);
                          doc.status = -1
                          return mogulsheetdb.put(doc);
                        }).then(function(){
                self.expenses = self.expenses.filter(function(e){ 
                      return e._id != id;
                  });

                  self.showToast("Expense permanently deleted", "center", true);
                  //console.log(self.ings);
                  self.$setState({
                      expenses:self.expenses,
                      totalMat:self.expenses.length
                  }, function(){
                      self.showToast("Expense permanently deleted!", "center", true);
                      list.remove("id", id);
                      self.setDataTable();
                    self.calculateTotalMoneyExpense();
                  });
             // }
            });
        }, null);
    },
    deleteExpense: function(id){
        var self = this;
        var checked = false;
        var text = "delete"
        /*var toggle = self.$app.toggle.get(".showInactiveExpenses");
        if(toggle != undefined){
            if(toggle.checked){
                text = "activate";
                checked = 1;
            }
        }*/
        self.$app.dialog.confirm("Are you sure you want to " + text + " this expense?", "Omni", function(){
          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("expenses/DeleteActivateExpense?id=" + id + "&stat=" + checked)).then(function( data, textStatus, jqXHR ) {
            self.$app.preloader.hide();
            if(data){
              self.expenses = self.expenses.filter(function(e){ 
                      return e.id != id;
                  });
                  var act = checked == 0 ? "deleted!" : "activated!";
                  self.showToast("Expense " + act, "center", true);
                  //console.log(self.ings);
                  self.$setState({
                      expenses:self.expenses,
                      totalMat:self.expenses.length
                  }, function(){
                      self.showToast("Expense " + text + "d!", "center", true);
                      //list.remove("id", id);
                      self.setDataTable();
                    self.calculateTotalMoneyExpense();
                  });
                }    
            }).catch((data, textStatus, jqXHR) => {
                self.$app.preloader.hide();
                  if(data != null && data.status == 404){
                    self.$app.methods.showToast("Expense not found", "center");
                    return;
                  }
                  self.$app.methods.showToast("An error occurred", "center");
              })
        }, null);
    },
    openPopUp: function(id){
        var self = this;
        
        //popup.once("opened", function(){
          if(id != null || id != undefined){
              var item = self.expenses.find(function(e){ 
                        return e.id == id;
                    });
                    self.$setState({
                      currentExpense:item
                    });
                    $$("input.name").val(item.name);
                    $$("input.amount_to_pay").val(item.amountToPay);
                    $$("input.amount_paid").val(item.amountPaid);
                    var toggle = self.$app.toggle.get(".recurring").checked;
                    if((toggle == true && item.recurring == 0) || (toggle == false && item.recurring == 1)){
                        self.$app.toggle.get(".recurring").toggle();
                    }
                    if(item.createdDate != null && item.createdDate != ""){
                      //var myDate = new Date(item.createdDate);
                      //myDate = myDate.toLocaleString();
                      var myDate = moment(item.createdDate).format('LLL');
                      $("#expense-calendar-modal").val(myDate);
                    }
                    if(item.datePaid != null && item.datePaid != ""){
                      //var myDate = new Date(item.datePaid);
                     // myDate = myDate.toLocaleString();
                      //var myDate = self.$app.methods.formatDate(item.datePaid);
                      var myDate = moment(item.datePaid).format('LLL');
                      $("#paid-calendar-modal").val(myDate);
                    }

                    if(item.receipts != null){
                      var images = item.receipts.split(";");
                      $(".expenseWrapper").empty(); 
                      for(var i = 0; i < images.length; i++){
                        var obj = images[i];
                        //var imgName = Object.keys(obj)[0];
                        //var imgSrc = Object.values(obj)[0];
                        var html = "<div class='swiper-slide'>";
                          html += "<div class='holderSwiper'><div style='margin: auto;'><img class='images' src='" + obj + "'></div>";
                          html += "<div class='display-inline-flex margin-vertical' style='width:100%'><a class='button button-small tealBgButton link external margin-right' target='_blank' href='" + obj + "' download>Download Receipt</a><a class='button button-small deleteImage' data-name='" + obj + "'>Delete Receipt</a></div></div>";
                          html += "</div>";
                          $(".expenseWrapper").append(html); 
                      }
                      $('.expenseWrapper').off("click").on('click','.button', function (e) {
                          var name = $(this).attr("data-name");
                          if($(this).hasClass("deleteImage")){
                            self.deleteImage(name, this);
                          }
                          //return false;
                      });
                      self.reInitSwiper();
                    }
                    
                    var popup = self.$app.popup.open('.popup.newExpense', true);
            } else{
              $("#expense-calendar-modal").val(moment().format('LLL'));
              var popup = self.$app.popup.open('.popup.newExpense', true);
              self.$setState({
                  currentExpense:null
              });
            }
        //})
        
    },
    calculateTotalMoneyExpense: function(){
        var self = this;
        var totalToPay = 0;
        var totalPaid = 0;
        //var totalMoney = 0;
        $.each(self.expenses, function(index,item){
            if(item.amountToPay != 0 && item.amountToPay != ""){
                totalToPay += Number(item.amountToPay);
            }
            if(item.amountPaid != 0 && item.amountPaid != ""){
                totalPaid += Number(item.amountPaid);
            }
            //totalMoney += Number(item.cost);
        })
        var totDiff = totalPaid - totalToPay;
        totDiff = totDiff.toFixed(2);
        var showDiff = (totalPaid - totalToPay);
        self.$setState({
            totalToPay: self.formatMoney(totalToPay),
            totalPaid: self.formatMoney(totalPaid),
            totalDifference: self.formatMoney(showDiff),
        }, function(){
          //self.calculateTotalMoneyExpense();
        });
    },
    resetTable: function(){
        var self = this;
        //console.log("empty");
        self.getData();
    },
    showCalendarPopup: function(){
        var self = this;
        var calendarModal = self.$app.calendar.create({
            inputEl: '#expenses-calendar-modal',
            openIn: 'sheet',
            header: true,
            footer: true
        });
      },
    closePopUp: function(){
        var self = this;
        $("#paid-calendar-modal").next("span").click();
        $("#expense-calendar-modal").next("span").click();
        $$("input.name,input.amount_to_pay,input.amount_paid, #expense-calendar-modal, #paid-calendar-modal").val("");
        self.$app.swiper.destroy('.swiper-container');
        $(".expenseWrapper, .swiper-pagination").empty();
        document.getElementById("myPhotos").value = "";
        var popup = self.$app.popup.close('.newExpense', true);
        popup.once("closed", function(){
          self.getData();
        });
    },
    saveData: function(){
      //var $$ = this.Dom7;
      var self = this;
      var elem = $$("input:required");
      var err = self.$app.input.validateInputs(".expenseForm");
      var toggle = self.$app.toggle.get(".recurring");
      var isRecur = toggle.checked;
      var toPay = $$("input.amount_to_pay").val();
      var paid = $$("input.amount_paid").val();
      var paidDate = ""; var today = Date.parse(new Date($.now()));
      if($("#expense-calendar-modal").val().trim() == ""){
        self.showToast("Please pick date of expense", "center");
        return;
      }
      if(($("#paid-calendar-modal").val().trim() == "") && ($$("input.amount_paid").val() != "0" && $$("input.amount_paid").val().trim != "")){
          self.showToast("Please choose date expense was paid!", "center");
          return;
      }
      if(Number(paid) > 0 && Number(paid) >= Number(toPay)){
            paidDate = moment().format();
      }
      if($("#paid-calendar-modal").val().trim() != ""){
        paidDate = moment($("#paid-calendar-modal").val()).format();
      }
      if(err){
        var obj = {
                name: $$("input.name").val(), 
                amountToPay: $$("input.amount_to_pay").val(), 
                amountPaid: $$("input.amount_paid").val(), 
                recurring: isRecur,
                datePaid: paidDate,
                createdDate: moment($("#expense-calendar-modal").val()).format(),
                status:true
              };
            if(self.currentExpense != null){
              obj.id = self.currentExpense.id;
              if(self.currentExpense.receipts != undefined){
                obj.receipts = self.currentExpense.receipts;
              }
            }
            
            var form_data = new FormData();

              for ( var key in obj ) {
                  form_data.append(key, obj[key]);
              }
            var fileUpload = $("#myPhotos").get(0);
            var files = fileUpload.files;
            if(files.length > 0){
               // if there are multiple files , loop through each files
               var id = self.currentExpense == null ? 0 : self.currentExpense.id;
               form_data.append("id", id);
              for (var i = 0; i < files.length; i++) {
                form_data.append("receiptsImages", files[i]);
              }
            }

            self.$app.preloader.show();
            $.when(self.$app.methods.postFormDataAPI("expenses/SaveExpenseForm", form_data, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data == true){
                    self.showToast("Expense saved.", "center", true);
                    $("#paid-calendar-modal").next("span").click();
                    $("#expense-calendar-modal").next("span").click();
                    $$("input.name,input.amount_to_pay,input.amount_paid, #expense-calendar-modal, #paid-calendar-modal").val("");
                    self.$app.swiper.destroy('.swiper-container');
                    $(".expenseWrapper, .swiper-pagination").empty();
                    document.getElementById("myPhotos").value = "";
                    self.$setState({
                      currentExpense: null
                    })
                  }
              }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
          }else{
              self.showToast("Please fill all required fields", "center");
          }
    },
    showToast: function(text, position, icon = false){
        var self = this;
        self.$app.toast.create({
          icon: icon ? '<i class="f7-icons">checkmark_alt_circle</i>' : '',
          text: text,
          position: position,
          closeTimeout: 2000,
          }).open();
    },
    formatMoney:function(val){             
      var self = this;   
      var ret = self.$app.methods.formatMoney(val);
      return ret;
    },
    setDataTable: function(){
      var self = this;
            $("#expenses-list .list").empty();
            $("#expenses-list .pagination").remove();         
              if(self.expenses != null && self.expenses.length > 0){
                var pagination = "<ul class='pagination padding-left-half margin-vertical-half'><ul>";
                $(pagination).insertAfter($("#expenses-list .list"));

                var isDesktop = self.$app.methods.isDesktop();
                if(isDesktop){
                  $("#expenses-list ul.list").remove();
                  for(var i = 0; i < self.expenses.length; i++){
                    var row = self.expenses[i];
                    var stat = row.status == true ? "display-none" : "";
                    var hidden = row.amountPaid >= row.amountToPay ? "" : "display-none";
                    var paidAll = parseFloat(row.amountPaid) >= parseFloat(row.amountToPay) ? '<span class="badge color-green paid padding-horizontal">Yes</span>' : '<span class="badge color-red paid padding-horizontal">No</span>';
                    var recurr = row.recurring == true ? '<span class="badge color-green paid padding-horizontal">Yes</span>' : 'No';
                    var html = "<tr>";
                        html += '<td class="id" style="display:none;">' + row.id + '</td>';
                        html += "<td class='name'>" + row.name + "</td>";
                        html += "<td class='cost'>" + self.formatMoney(row.amountToPay) + "</td>";
                        html += "<td>" + self.formatMoney(row.amountPaid) + "</td>";
                        html += "<td class='paidAll'>" + paidAll + "</td>";
                        html += "<td>" + recurr + "</td>";
                        html += "<td class='created_date'>" + self.$app.methods.formatDate(row.createdDate) + "</td>";
                        
                        var pops = '<a href="#" data-popover=".expenses-popover-' + i + '" class="popover-open"><i class="f7-icons">ellipsis_vertical</i></a>'
                        pops += '<div class="popover my-popover expenses-popover expenses-popover-' + i + '" data-close-on-escape="true" data-backdrop="false">'; 
                        pops += '<div class="popover-angle"></div><div class="popover-inner padding-half">';

                          pops += '<a class="button popover-close editExpense" data-id="' + row.id + '">View / Edit</a>';
                          //pops += '<a class="button popover-close receiptButton" data-id="' + row.id + '">Add Receipts</a>';
                          pops += '<a class="button popover-close deleteExpense" data-id="' + row.id + '">';
                          pops += row.status == 1 ? 'Delete' : 'Activate';
                          pops += '</a>';
                          /*if(row.status == false){
                            pops += '<a class="button popover-close permDelButton" data-id="' + row.id + '">Delete</a>';
                          }*/

                        pops += '</div></div>';
                        html += "<td>" + pops + "</td>";

                      html += "</tr>";
                      $("#expenses-list tbody.list").append(html);

                  }
                }else{
                  $("#expenses-list .data-table").remove();                  
                  $("#expenses-list").find(".sortTextPar").removeClass("display-none");
                
                $("#expenses-list").find(".sort").remove();//id,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status
                var sorter = '<span class="sort" data-sort="name">Name</span><span class="sort" data-sort="cost">Expense Cost</span>';
                sorter += '<span class="sort" data-sort="paidAll">Fully Paid</span><span class="sort" data-sort="created_date">Created Date</span>';
                $(sorter).insertAfter($(".sortText"));
                    $(".expenses-list").find(".sortText").removeClass("display-none");
                    for(var i = 0; i < self.expenses.length; i++){
                        var row = self.expenses[i];
                        var html = '<li><div class="card myCard"><div class="card-content padding-horizontal-half">';
                        html += '<div class="name cardName">' + row.name + '</div><div class="id display-none">' + row.id + '</div><div class="cost display-none">' + row.amountToPay + '</div>';
                        html += '<div class=""><span>Amount to be paid: </span><span class="valueName">' + self.formatMoney(row.amountToPay) + '</span></div>';
                        html += '<div class=""><span>Amount Paid: </span><span class="valueName">' + self.formatMoney(row.amountPaid) + '</span></div>';
                        var stat = row.status == true ? "display-none" : "";
                        var hidden = row.amountPaid >= row.amountToPay ? "" : "display-none";
                        var paidAll = row.amountPaid >= row.amountToPay ? 1 : 0;
                        var checkbox = row.recurring == true ? '' : 'display-none';
                        html += '<div class="paidAll display-none">' + paidAll + '</div>'
                        html += '<div class="' + checkbox + '"><span>Recurring Payment: </span><span class="badge color-green">Yes</span></div>' + '<div class="display-none created_date">' + row.createdDate + '</div>';
                        html += '<div class="' + hidden + '"><span>Date Fully Paid: </span><span class="valueName">' + self.$app.methods.formatDate(row.datePaid) + '</span></div>';
                        html += '<div class=""><span>Created Date: </span><span class="valueName">' + self.$app.methods.formatDate(row.createdDate) + '</span></div>';
                        html += '<div class="' + stat + '"><span>Status: </span><span class="valueName">Deleted</span></div>';
                        html += '</div><div class="card-footerMine padding-horizontal-half padding-bottom-half"><p class="display-inline-flex no-margin-vertical">';
                        html += '<a class="button button-small editExpense" data-id="' + row.id + '">View / Edit</a>';
                        //html += '<a class="button button-small receiptButton" data-id="' + row.id + '">Receipt</a>';
                        html += '<a class="button button-small deleteExpense" data-id="' + row.id + '">';
                        html +=  row.status == true ? 'Delete' : 'Activate'; 
                        html += '</a>';
                        
                        /*if(row.status == false){
                          html += '<a class="button button-small permDelButton" data-id="' + row.id + '">Delete</a>';
                        }*/

                        html += '</p></div></div>';
                        html += '</li>';
                        $("#expenses-list ul.list").append(html);
                        //return html;
                    }
                }
              
                
                var options = {
                    valueNames: ['id','cost','paidAll','name','created_date'],
                    page: 10,
                    pagination: [{outerWindow:2}]
                };

                $(".sort").off("click").on("click", function(){
                  $("#expenses-list").find(".sort").find(".asc").remove();
                  $("#expenses-list").find(".sort").find(".desc").remove();
                    if($(this).hasClass("asc")){
                      $(this).append("<i class='icon f7-icons asc text-color-red'>arrowtriangle_up_fill</i>");
                    }
                    if($(this).hasClass("desc")){
                      $(this).append("<i class='icon f7-icons desc text-color-red'>arrowtriangle_down_fill</i>");
                    }
                })
              
                  $('#expenses-list, .expenses-popover').off("click").on('click','.button', function () {
                      var data = $(this).attr("data-id");
                      //console.log(data);
                      if($(this).hasClass("editExpense")){
                        self.openPopUp(data);
                      }
                      if($(this).hasClass("deleteExpense")){
                        self.deleteExpense(data);
                      }
                      if($(this).hasClass("permDelButton")){
                        self.permdeleteExpense(data);
                      }
                      if($(this).hasClass("receiptButton")){
                        self.openReceiptImages(data);
                      }
                      //openReceiptImages
                      //return false;
                  });

                  expenseList = new List('expenses-list', options);
                  self.calculateTotalMoneyExpense();
                }else{
                  //var html = "<li><div class='card myCard'><div class='card-content text-align-center'>No result found</div></div></li>";
                  //$("#expenses-list .list").append(html);
                  self.calculateTotalMoneyExpense();
                  if(expenseList != null){
                    expenseList.clear();
                  }
                  
                  
                  $(".sortTextPar").addClass("display-none");
                }
    },
    startPouch: function(){
          var self = this;
          self.getData();
      },
    getData: function(){
    var self = this;
    if(self.$app.data.settings != null){
      self.getDataFetch();
      return;
    }
    
    $.when(self.$app.methods.getDataAPI("business/GetBusinessProfile")).then(function(data){
          if(data != null){
            self.$app.methods.refetchSettings(data);
          }

          self.getDataFetch();
      }).catch(function(err){
        self.getDataFetch();
      });
    
  },
    getDataFetch: function(){
      var self = this;
      self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("expenses/GetExpenses")).then(function( data, textStatus, jqXHR ) {
          self.$app.preloader.hide();
          self.$setState({
                expenses: data,
                totalMat:data.length
              }, function(){
                self.setDataTable();
              });
      }).catch(function(err){
        self.$app.preloader.hide();
              if(err != null && err.status == 404){
                console.log("expenses not found"); 
                return;
              }
              self.$app.methods.showToast("An error occurred", "center");
      });
    }
  },
  on: {
    pageAfterIn: function(e, page) {
        var self = this;
        //trackExpensesPage();
      },
      pageInit: function(e, page) {
        var self = this;
        registerPagination();
        /*$(document).on('click', '.swiper-slide a', function(e) {
           var but = e.target;
           $(but).parents(".swiper-slide").eq(0).remove();
           self.reInitSwiper();
        })*/
        var calendar = self.$app.calendar.create({
                inputEl: '#paid-calendar-modal',
                timePicker: true,
                closeOnSelect: true,
                formatValue: function(values){
                    //console.log(values[0]);
                    var t = moment(values[0]).format('LLL');
                    //console.log(moment(values[0]).format("X"));
                    //console.log(t);
                    return t;
                  },
                  on: {
                    close: function () {
                      //var values = [];
                      //var dat = new Date();
                      //values.push(dat);
                      //calendar.setValue(values)
                    }
                  }
                //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });
              var calendarPurchase = self.$app.calendar.create({
                  inputEl: '#expense-calendar-modal',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    //console.log(values[0]);
                    var t = moment(values[0]).format('LLL');
                    //console.log(moment(values[0]).format("X"));
                    //console.log(t);
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });
        //console.log("test inactive init");
        $$(".showInactiveExpenses").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal-expense',
            openIn: 'customModal',
            rangePicker: true,
            closeOnSelect: true,
            header: true,
            footer: true
        });
        calendarModal.on("closed", function(){
            //console.log(calendarModal.getValue());
            var days = calendarModal.getValue();
            if(days == undefined){
                return;
            }
            var from = null; var to = null;
            if(days.length == 1){
                from = moment(moment(days[0]).format('LLL')).format();
                days.push(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = moment(moment(date2).format('LLL')).format();
            }
            else if(days.length > 1){
                //var date1 = days[0];
                //date1.setDate(date1.getDate() + 1);
                from = moment(moment(days[0]).format('LLL')).format();
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = moment(moment(date2).format('LLL')).format();
            }else{
                self.getData();
            }
            if(from != null && to != null){
                //console.log(from);
                //console.log(to);
                var obj = {};
                obj.fromDate = from;
                obj.toDate = to;
                self.$app.preloader.show();
                $.when(self.$app.methods.postDataAPI("expenses/GetExpensesByDate", obj, true)).then(function( data, textStatus, jqXHR ) {
                    self.$app.preloader.hide();
                    self.$setState({
                            expenses: data,
                            totalMat:data.length
                        }, function(){
                          self.setDataTable();
                        });
                      
                  })
                .catch((err) => {
                  self.$app.preloader.hide();
                  self.showToast("error occured during saving", "center");
                });
            }
        })        
        self.getData();
      }
  }

} 

function registerPagination(){
  $(document).on('click', 'a.page', function() {
    $(".page-current .page-content").eq(0).animate({scrollTop:0 }, "fast");
      });
}

function trackExpensesPage(){
  try{
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
    'event': 'Pageview',
    'pagePath': 'https://www.mogulsheet.com/expenses',
    'pageTitle': 'Expenses' //some arbitrary name for the page/state
    });
  }catch(err){
    
  }
} 

</script>