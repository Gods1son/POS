<template>
<div class="page" data-name="ingredient">
  <div class="navbar">
    <div class="navbar navbar-bg"></div>
    <div class="navbar-inner sliding">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title">Raw Materials</div>
    </div>
  </div>

      <!--fab-->
    <div class="fab fab-extended fab-right-bottom">
      <a href="#" @click="openPopUp(null)">
        <i class="icon f7-icons">plus</i>
        <!-- Element with FAB text  -->
        <div class="fab-text">Raw Material</div>
      </a>
    </div>
    <!--fab-->

  <div class="page-content">
    
    <div class="item-content block-title margin-bottom-half margin-top-half">
        <div class="row padding-vertical">
            <div class="col">
                
            </div>
    
                <div class="col">
                    <span class="item-after float-right margin-left-half">
                        <label class="toggle toggle-init color-red showInactiveIngs">
                        <input type="checkbox">
                        <span class="toggle-icon"></span>
                        </label>
                    </span>
                    <span class="item-title float-right">Show Deleted</span>
                </div>
            </div>

            <div class="row">
            <div class="col">
                You have {{totalMat}} {{js "this.totalMat > 1 ? 'raw materials' : 'raw material'"}}
            </div>
            </div>
    </div>

    <div class="block no-margin-vertical">
    <table id="ingredientTable" class="compact row-border" style="width:100%">
        <thead>
          <tr>
            <th>ID</th>
            <th>
              <div>Name of Material</div>
            </th>
            <th>Unit Size</th>
            <th>Cost</th>
            <th>Unit</th>
            <th>Actions</th>
          </tr>
        </thead>
        
      </table>
    </div>
  </div>

  <!--pop up-->
  <div class="popup newIngredient popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner bg-color-blue text-color-white">
            <div class="title">Add/Edit Raw Material</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link text-color-white" @click="closePopUp"><i class="icon f7-icons">multiply</i>Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half ingForm">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Raw Material Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="name" placeholder="raw material name" required validate/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Unit size</div>
                      <div class="item-input-wrap">
                        <input type="text" class="unit_size" placeholder="Unit size" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Unit measurement e.g. kg, lb, ltr</div>
                      <div class="item-input-wrap">
                        <input type="text" class="unit" placeholder="Unit measurement" required validate/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Cost/Unit size</div>
                      <div class="item-input-wrap">
                        <input type="text" class="cost_per_unit" placeholder="Cost/Unit size" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-fill button-raised color-green" @click='saveData'>Save Raw Material</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

</div>
</template>
<script>
import Dom7 from 'dom7';
import Dexie from 'dexie';
import origdatatable from 'datatables.net';
import datatable from 'datatables.net-dt';

var db = new Dexie("BizExpenseManagerDB");
          db.version(1).stores({
            ingredients: "++id,name,unit_size,unit,cost_per_unit,status,created_date",
            products: "++id,name,cost,status,created_date",
            product_ingredient: "++id,productID,ingredientID,unit_size,cost,status,created_date",
            product_otherMaterials: "++id,productID,name,cost,status,created_date",
            sales: "++id,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses: "++id,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status",

            ingredients_history: "++id,ingID,name,unit_size,unit,cost_per_unit,status,created_date",
            products_history: "++id,prodID,name,cost,status,created_date",
            sales_history: "++id,salesID,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses_history: "++id,expID,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status"
          })

var $$ = Dom7;
export default {
  data: function () {
      // Must return an object
      return {
        ings: null,
        totalMat:0,
        currentIng: null
      }
    },
  methods:{
    fakeAlert: function(){
        var self = this;
        self.$app.dialog.alert("hey");
    },
    openRow: function(id){
      var table = $("#ingredientTable").DataTable();
      var tr = $(".opener-" + id).parents('tr').eq(0);
      var isOdd = $(tr).hasClass("odd") == true ? "odd" : "even";
      if($(tr).attr("data-oldid") == undefined || $(tr).attr("data-oldid") == null){
          $(tr).attr("data-oldid", isOdd);
      }
      
        //var row = table.row( tr );
        var next = $(tr).next("tr").hasClass("specTable");
        if (next ) {
            // This row is already open - close it
            //row.child.hide();
            $(tr).next("tr").remove();
            $(".opener-" + id).text("plus_circle_fill");
            tr.removeClass('shown');
            var color = $(tr).attr("data-oldid");
            if(tr.hasClass(color) == false){
              var cl = color == "odd" ? "even" : "odd";
              tr.removeClass(cl);
            }
            tr.addClass(color);
        }
        else {
            // Open this row
            var data = $(".hidden-" + id).clone(true, true);
            $(data).insertAfter(tr);
            $(data).removeClass("display-none");
            $(data).find(".editButton").on("click", function(){
                var l = $(".specTable.display-none").find(".editButton").length;
                console.log(l);
            });
            //console.log(t);
            //row.child( data.html() ).show();
             $(".opener-" + id).text("minus_circle_fill");
            tr.addClass('shown');
            if(isOdd != "odd"){
              tr.addClass('odd');
              tr.removeClass('even');
            }    
        }

      /*if($(".hidden-" + id).hasClass("display-none")){
        $(".hidden-" + id).removeClass("display-none");
        $(".opener-" + id).text("minus_circle_fill");
      }else{
        $(".hidden-" + id).addClass("display-none");
        $(".opener-" + id).text("plus_circle_fill");
      }*/
    },
    showToast: function(text, position){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: 2000,
                        }).open();
    },
    DeleteItem: function(id){
        var self = this;
        var checked = 0;
        var text = "delete"
        var toggle = self.$app.toggle.get(".showInactiveIngs");
        if(toggle != undefined){
            if(toggle.checked){
                text = "activate";
                checked = 1;
            }
        }
        self.$app.dialog.confirm("Are you sure you want to " + text + "?", function(){
            db.ingredients.update(Number(id), {status: checked}).then(function (updated) {
              if (updated){
                self.ings = self.ings.filter(function(e){ 
                      return e.id != Number(id);
                  });
                  //console.log(self.ings);
                  self.$setState({
                      ings:self.ings,
                      totalMat:self.ings.length
                  }, function(){
                      //var table = $("#ingredientTable").DataTable();
                      var but = $("#ingredientTable").find(".deleteButton[data-id='" + id + "']");
                      var row = $(but).parents("tr").eq(0);
                      self.showToast("Product " + text + "d!", "center");
                      $("#ingredientTable").DataTable().row(row).remove().draw(false);
                  });
              }
            });
        }, null);
    },
    openPopUp: function(id){
        var self = this;
        
        //popup.once("opened", function(){
          if(id != null || id != undefined){
              var item = self.ings.find(function(e){ 
                        return e.id == Number(id);
                    });
                    self.$setState({
                      currentIng:Number(id)
                    });
                    $$("input.name").val(item.name);
                    $$("input.unit_size").val(item.unit_size);
                    $$("input.unit").val(item.unit);
                    $$("input.cost_per_unit").val(item.cost_per_unit);
                    var popup = self.$app.popup.open('.newIngredient', true);
            } else{
              var popup = self.$app.popup.open('.newIngredient', true);
              self.$setState({
                  currentIng:null
              });
            }
        //})
        
    },
    closePopUp: function(){
        var self = this;
        var popup = self.$app.popup.close('.newIngredient', true);
        $$("input.name,input.unit_size,input.unit,input.cost_per_unit").val("");
        popup.once("closed", function(){

        });
    },
    saveData: function(){
      //var $$ = this.Dom7;
      var self = this;
      var elem = $$("input:required");
      var err = self.$app.input.validateInputs(".ingForm");
      if(err){
        var obj = {
                name: $$("input.name").val(), 
                unit_size: $$("input.unit_size").val(), 
                unit: $$("input.unit").val(), 
                cost_per_unit: $$("input.cost_per_unit").val(), 
                status:1
              };
            if(self.currentIng != null){
              obj.id = self.currentIng;
            }
          db.ingredients.put(obj).then(function(id) {
                  db.ingredients.get(id).then(function(item) {
                    //self.$app.dialog.alert("Item saved.");
                    self.showToast("Item saved.", "center");
                    $$("input.name,input.unit_size,input.unit,input.cost_per_unit").val("");
                    self.getData();
                })
              })
          }
    },
    getData: function(){
      var self = this;
      var checked = 1;
      var toggle = self.$app.toggle.get(".showInactiveIngs");
      if(toggle != undefined){
        checked = toggle.checked == true ? 0 : 1;
      }
      //console.log(checked);
      var collection = db.ingredients.where('status').equals(checked).toArray(function(arr){
        //var collection = db.ingredients.toArray(function(arr){
        //console.log(arr);
        //console.log("fretched - " + checked);
          self.$setState({
                ings: arr,
                totalMat:arr.length
              }, function(){
                var table = $("#ingredientTable").DataTable();
                if(self.ings != null && self.ings.length >= 0){
                table.clear().destroy();
                table = $('#ingredientTable').DataTable( {
                      data: self.ings,
                      pageLength: 10,
                      columns: [//id,name,unit_size,unit,cost_per_unit,status,created_date
                          { "data": "id" },
                          { "data": "name" },
                          { "data": "unit_size" },
                          { "data": "cost_per_unit" },
                          { "data": "unit" },
                          { "data": "status" }
                      ],
                      columnDefs: [
                        {
                            "targets": [ 4 ],
                            "visible": false,
                            "searchable": false
                        },
                        {
                            targets: "_all",
                            className: 'dt-body-center dt-head-center'
                        },
                        {
                          targets: [3],
                          "orderable": false,
                          render: function ( data, type, row ) {
                          return data.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
                            }
                        },
                        {
                          targets: [2],
                          "orderable": false,
                          render: function ( data, type, row ) {
                          return data+row.unit;
                            }
                          },
                          {
                          targets: [-1],
                          "orderable": false,
                          render: function ( data, type, row ) {
                            var html = '<p class="display-inline-flex margin-vertical-half">';
                            html += '<a class="button button-fill margin-right-half editButton" data-id="' + row.id + '">Edit</a>';
                            html += '<a class="button button-fill color-red deleteButton" data-id="' + row.id + '">';
                            html +=  row.status == 1 ? 'delete' : 'activate';
                            html += '</a></p>';
                            return html;
                            }
                          }
                        ],
                        "createdRow": function (row, data, index) {
                            var info = table.page.info();
                            $('td', row).eq(0).html(index + 1);
                        },
                        "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                            //debugger
                            var oSettings = this.fnSettings();
                            $("td:first", nRow).html(oSettings._iDisplayStart + iDisplayIndex + 1);
                            return nRow;
                        }
                    });
                }

                          $('#ingredientTable tbody').off("click").on('click','.button', function () {
                              var data = $(this).attr("data-id");
                              //console.log(data);
                              if($(this).hasClass("editButton")){
                                self.openPopUp(data);
                              }
                              if($(this).hasClass("deleteButton")){
                                self.DeleteItem(data);
                              }
                              //return false;
                          });

                      });
              });
            }
          },
  on: {
      pageInit: function(e, page) {
        var self = this;
        $("#ingredientTable").DataTable();
        $$(".showInactiveIngs").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        console.log("test inactive init 2");
        self.getData();
      },
      pageReinit: function(e, page) {
        var self = this;
        //console.log("test inactive reinit");
        $$(".showInactiveIngs").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        //console.log("test inactive reinit 2");
        self.getData();
      }
  }

} 
</script>