<template>
<div class="page" data-name="products">
  <div class="navbar">
    <div class="navbar navbar-bg"></div>
    <div class="navbar-inner sliding">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title padding-vertical-half">Products</div>
      <div class="right">
        <a href="#" class="link icon-only panel-toggle" data-panel="left">
          <i class="icon f7-icons if-not-md">menu</i>
          <i class="icon material-icons if-md">menu</i>
        </a>
      </div>
    </div>
  </div>

  <!--fab-->
  <div class="fab-backdrop"></div>
  <div class="fab fab-extended fab-right-bottom">
    <a href="#">
      <i class="icon f7-icons">plus</i>
      <i class="icon f7-icons">multiply</i>
      <div class="fab-text">Product</div>
    </a>
      
      <div class="fab-buttons fab-buttons-top">
        <a href="#" class="fab-label-button" @click="openPopUp(null)">
          <span><i class="icon f7-icons">plus</i></span>
          <span class="fab-label">Single Product</span>
        </a>
        <a href="#" class="fab-label-button" @click="openPopUpExcel()">
          <span><i class="icon f7-icons">upload_circle</i></span>
          <span class="fab-label">Upload Excel File</span>
        </a>
      </div>
  </div>
  <!--fab-->

    <!--
    <div class="fab fab-extended fab-right-bottom">
      <a href="#" @click="openPopUp(null)">
        <i class="icon f7-icons">plus</i>
        <div class="fab-text">Product</div>
      </a>
    </div>

    <div class="fab fab-extended fab-left-bottom">
      <a href="#" @click="openPopUpExcel()">
        <i class="icon f7-icons">plus</i>
        <div class="fab-text">Upload Excel</div>
      </a>
    </div>
  -->

  <div class="page-content">

    <div class="block no-margin-vertical no-margin-horizontal no-padding-vertical roundHolder no-padding-horizontal">
      <div id="product-list" class="customList">
        <div class="text-align-center">
          <!--<input class="search" placeholder="search">-->
          <!-- Additional "searchbar-inline" class -->
          <div class="searchbar searchbar-inline">
            <div class="searchbar-input-wrap">
              <input type="search" placeholder="Search" class="search">
              <i class="searchbar-icon"></i>
              <span class="input-clear-button"></span>
            </div>
          </div>

          <div class="margin-vertical-half padding-vertical-half sortTextPar">
            <span class="sortText display-none">Sort By:</span>
            <!--<span class="sort" data-sort="name">Name</span>
            <span class="sort" data-sort="cost">Cost</span>-->
          </div>
        </div>

        <div class="row margin-top-half myToolbar">
          <div class="col-100 medium-50 no-padding-vertical text-align-right sellingButtonsTab">
            <!--<span class="display-inline-flex margin-right-half display-none">
              <span class="item-title item-label float-right">Show Deleted</span>
              <span class="item-after float-right margin-left-half display-none">
                  <label class="toggle toggle-init color-red showInactive">
                  <input type="checkbox">
                  <span class="toggle-icon"></span>
                  </label>
              </span>
              </span>-->
          </div>

          <div class="col-100 medium-50 no-padding-vertical text-align-right">
            <span class="margin-horizontal-half">You have {{totalMat}} {{js "this.totalMat > 1 ? 'products' : 'product'"}}</span>
          </div>
        </div>
          <!--<ul class="list sortList margin-vertical-half">
            
          </ul>-->
          <div class="product-table data-table margin-vertical-half">
            <table>
                <thead>
                  <tr>
                    <th class="sort" data-sort="name"><i class="icon f7-icons">arrow_up_down</i> Name</th>
                    <th class="sort" data-sort="cost"><i class="icon f7-icons">arrow_up_down</i> Selling Price</th>
                    <th class="sort" data-sort="in-stock"><i class="icon f7-icons">arrow_up_down</i> Stock</th>
                    <th>Public Views</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody class="list sortList">

                </tbody>
            </table>
          </div>
          <ul class="list sortList margin-vertical-half">
          
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>
      </div>
    </div>
  <!--</div>-->

  <!--pop up add new product-->
  <div class="popup uploadProducts popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Upload Products</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePopUpExcel()"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
          <div class="block margin-half">
            <div class="item-label">* Ensure you don't have duplicate products in Excel and on system.</div>
            <div class="item-label">Expected column names are: <b>name</b>, <b>description</b>, <b>cost_price</b>, <b>selling_price</b>, <b>stock e.g 5</b>, <b>product_category</b>, <b>show_to_public (1 or 0)</b></div>
            <input type="file" id="fileUploadProducts" accept=".xls,.xlsx" />
            <a class="button filePicker" @click="productPicker">Select File</a>
            <a href="#" class="col button button-outline button-raised mainButton margin-top-half" @click='uploadFile'>Save Excel Data</a>
            <div class="errorContent"></div>
          </div>
        </div>
      </div>
    </div>
  
  </div>

  <!--pop up generate link for product-->
  <div class="popup productLink popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Generate Product Link</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closeEditProdLink"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half productLinkForm">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Company Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="compNameLink" placeholder="Company name" required validate/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Company Email Address</div>
                      <div class="item-input-wrap">
                        <input type="email" class="email compEmailLink" placeholder="Company email address"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Company Contact number</div>
                      <div class="item-input-wrap">
                        <input type="text" class="phone compPhoneLink" placeholder="Company contact number"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Product Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="nameLink" placeholder="Product name" required validate/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Product Description</div>
                      <div class="item-input-wrap">
                        <!--<input type="text" class="desc_of_product" placeholder="Description of product"/>
                        <span class="input-clear-button"></span>-->
                        <div class="text-editor desc_of_productLink margin-top-half" data-placeholder="Description of product" 
                          data-buttons='[["bold", "italic", "underline", "strikeThrough"], ["orderedList", "unorderedList"]]'>
                          <div class="text-editor-content" contenteditable></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Selling Price</div>
                      <div class="item-input-wrap">
                        <input type="number" class="selling_priceLink" placeholder="Selling price of product"/>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Other notes</div>
                      <div class="item-input-wrap">
                        <textarea class="other_notesLink" placeholder="Any additional info you wish to add"></textarea>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Upload Images. Max 3</div>
                      <div class="item-input-wrap">
                        <input type="file" name="photos" id="myPhotosProducts" accept="image/x-png,image/gif,image/jpeg,image/jpg,image/png" @change="checkFilesProducts" multiple>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-outline button-raised mainButton" @click='generateLink'>Generate Link</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

    <!--pop up add new product-->
    <div class="popup restockHistory popup-tablet-fullscreen">
      <div class="view">
        <div class="page">
          <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
              <div class="title">Product Restock History</div>
              <div class="right">
                <!-- Link to close popup -->
                <a class="link" @click="closePopUpRestockHistory"><i class="icon f7-icons">multiply</i></a>
              </div>
            </div>
          </div>
          <div class="page-content">
            <div class="block no-margin-vertical no-margin-horizontal no-padding-vertical roundHolder no-padding-horizontal">
              <div id="restock-list" class="customList">
                <div class="text-align-center customListSub">
                  <div class="searchbar searchbar-inline">
                    <div class="searchbar-input-wrap">
                      <input type="search" placeholder="Search" class="search">
                      <i class="searchbar-icon"></i>
                      <span class="input-clear-button"></span>
                    </div>
                  </div>
                </div>

                <div class="text-align-center">
                  <!--<input class="search" placeholder="search">-->
                  <!-- Additional "searchbar-inline" class -->
                  
        
                  <div class="margin-vertical-half padding-vertical-half sortTextPar">
                    
                    <span class="sortText display-none">Sort By:</span>
                    <!--<span class="sort" data-sort="name">Name</span>
                    <span class="sort" data-sort="cost">Cost</span>-->
                  </div>
                </div>

                <div class="restock-table data-table margin-vertical-half">
                  <table>
                      <thead>
                        <tr>
                          <th class="sort" data-sort="name"><i class="icon f7-icons">arrow_up_down</i> Product Name</th>
                          <th>Last Stock</th>
                          <th class="sort" data-sort="cost">New Stock</th>
                          <th>Total Stock</th>
                          <th class="sort" data-sort="restock_date"><i class="icon f7-icons">arrow_up_down</i> Stock Date</th>
                        </tr>
                      </thead>
                      <tbody class="list sortList">
        
                      </tbody>
                  </table>
                </div>

                <ul class="list sortList margin-vertical-half">
            
                </ul>

              </div>
              
            </div>
          </div>
        </div>
      </div>
    
    </div>


  <!--pop up add new product-->
  <div class="popup restockProduct popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Restock Product</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closeRestockProduct"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half restockProductForm">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Product Name:</div>
                      <div class="restockProductName block-title-medium"></div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Current Stock:</div>
                      <div class="currentStock block-title-medium"></div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Restock Quantity</div>
                      <div class="item-input-wrap">
                        <input type="text" class="restock_quantity" placeholder="Quantity of product to restock" @keyup="stockInputRestock" @keypress="onlyDecimal"/>
                        <span class="input-clear-button"></span>
                      </div>

                      <div class="item-title item-label padding-top">
                        <span>Stock is Unlimited</span>
                        <label class="checkbox vertical-align-super padding-left-half">
                          <!-- checkbox input -->
                          <input type="checkbox" class="isUnlimitedRestock" @change="stockInputRestock">
                          <!-- checkbox icon -->
                          <i class="icon-checkbox"></i>
                        </label>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Total Stock:</div>
                      <div class="totalStock block-title-medium"></div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Date of Restocking</div>
                      <div class="item-input-wrap">
                          <input type="text" placeholder="Date of restocking" id="restock-calendar-modal" required validate data-error-message="Select date of purchase please!"/>
                          <span class="input-clear-button"></span>
                      </div>
                      </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-outline button-raised mainButton" @click='restockProductSave'>Restock Product</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

  <!--pop up add new product-->
  <div class="popup newProduct popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Add/Edit Product</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closeEditProdPopUp"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half productForm">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Product Type</div>
                      <div class="item-input-wrap">
                        <select id="productType">
                          <option value="physicalProduct" selected>Physical Product</option>
                          <option value="digitalProduct">Digital Product</option>
                          <option value="service">Service</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Product Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="nameProduct" placeholder="Product name" required validate/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Product Description</div>
                      <div class="item-input-wrap">
                        <!--<input type="text" class="desc_of_product" placeholder="Description of product"/>
                        <span class="input-clear-button"></span>-->
                        <div class="text-editor desc_of_product margin-top-half" data-placeholder="Description of product" 
                          data-buttons='[["bold", "italic", "underline", "strikeThrough"], ["orderedList", "unorderedList"]]'>
                          <div class="text-editor-content" contenteditable></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Product Category</div>
                      <div class="item-input-wrap">
                        <input type="text" class="productCategory" placeholder="Add product into a category"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Cost Price</div>
                      <div class="item-input-wrap">
                        <input type="number" class="cost_price" placeholder="Cost price of product" required step=".01"/>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Selling Price</div>
                      <div class="item-input-wrap">
                        <input type="number" class="selling_price" placeholder="Selling price of product" required step=".01"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Comparable Price (this price will be crossed out beside your selling price, like sale)</div>
                      <div class="item-input-wrap">
                        <input type="number" class="comparable_price" placeholder="Comparable price of product" step=".01"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">In Stock</div>
                      <div class="item-input-wrap">
                        <input type="number" class="stock_quantity" placeholder="Quantity of product in stock" @keyup="stockInput" @keypress="onlyDecimal"/>
                      </div>

                      <div class="item-title item-label padding-top">
                        <span>Stock is Unlimited</span>
                        <label class="checkbox vertical-align-super padding-left-half">
                          <!-- checkbox input -->
                          <input type="checkbox" class="isUnlimited" @change="stockInput">
                          <!-- checkbox icon -->
                          <i class="icon-checkbox"></i>
                        </label>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Low Stock Alert (you will be alerted when stock drops below this number)</div>
                      <div class="item-input-wrap">
                        <input type="number" class="low_stock_alert" placeholder="Low stock alert" @keypress="onlyDecimal"/>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label padding-top">
                        <span>Show to public</span>
                        <label class="checkbox vertical-align-super padding-left-half">
                          <!-- checkbox input -->
                          <input type="checkbox" class="showToPublic">
                          <!-- checkbox icon -->
                          <i class="icon-checkbox"></i>
                        </label>
                      </div>

                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Upload Images (maximum of 5 images, with square aspect ratio and size less than 2MB)</div>
                      <div class="item-input-wrap padding-vertical-half">
                        <input type="file" name="photos" id="productPhotos" accept="image/x-png,image/gif,image/jpeg,image/jpg,image/png" @change="checkFilesPhoto" multiple>
                            
                        <div class="swiper-container demo-swiper margin-top display-none">
                              <div class="swiper-pagination"></div>
                              <div class="swiper-wrapper productsWrapper">
                
                              </div>
                            </div>
                      </div>
                    </div>
                  </div>
                </li>
                <li id="digitalAssetHolder">
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title item-label">Upload Digital Product</div>
                      <div class="item-input-wrap">
                        <input type="file" name="digitalAsset" id="digitalAsset" accept="media_type">
                        <div id="digitalAssetLink"></div>
                      </div>
                    </div>
                  </div>
                </li>
                <!--Add variants-->
                <li id="variantsHolder">
                  <div class="item-content">
                    <div class="item-inner">
                      <!--<button class="button col addVariantsButton">Add Variants</button>-->
                      <div class="item-input-wrap">
                        <div id="variantCreator">
                        <div class="item-title item-label">Add Variants</div>
                        <div class="card myCard">
                          <div class="card-content padding-horizontal padding-vertical attributeRowParent">
                            <div class="row attributeRow">
                              <div class="col-50">
                                <div class="labelName">Attribute</div>
                                <input class="AttributeKey" type="text" placeholder="e.g color" value="">
                              </div>
                              <div class="col-50">
                                <div class="labelName">Values (comma separated)</div>
                                <input class="AttributeValue" type="text" placeholder="e.g red,blue,white" value="">
                              </div>
                            </div>
                            <div class="row margin-top-half">
                              <div class="col-50">
                                <a class="button button-small no-margin-left button-fill color-gray text-color-white" @click="addNewAttribute">Add New Attribute</a>
                              </div>
                              <div class="col-50">
                                <a class="button button-small no-margin-left button-fill color-green text-color-white" @click="createArrayOfArray">Create Variants</a>
                              </div>
                            </div>
                            </div>
                          </div>
                        </div>

                          <div id="allVariantCreatedPar" class="display-none">
                            <div class="item-title item-label">All Variants</div>
                            <div id="allVariantCreated"></div>
                          </div>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-outline button-raised mainButton" @click='saveData'>Save Product</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

    <!--pop up make a sale-->
  <div class="popup sellProduct popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Sell Product</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="resetSalePopUp"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half">
              <ul>
                <li>
                  <div class="row">
                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Product Name</div>
                          <div class="item-input-wrap">
                            <input type="text" class="name_sell" placeholder="Product name" required/>
                            <span class="input-clear-button"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Selling Price</div>
                          <div class="item-input-wrap">
                            <input type="number" class="cost_sell" @keyup="calculateQuantity" placeholder="selling price" required disabled validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>


                  
                </li>
                <li>
                  <div class="row">
                      <div class="col-50">
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title item-label">Quantity</div>
                            <div class="item-input-wrap">
                              <input type="number" class="quantity_sell" @keyup="calculateQuantity" placeholder="Quantity" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-50">
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title item-label">Discount</div>
                            <div class="item-input-wrap">
                              <input type="number" class="discount_sell" @keyup="calculateQuantity" value="0" placeholder="Discount" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                            </div>
                          </div>
                        </div>
                      </div>
                  </div>
                  
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Total Price</div>
                      <div class="item-input-wrap">
                        <input type="number" class="total_sell" @keyup="calculateQuantity2" placeholder="Total Price" disabled required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="row">
                      <div class="col-50">
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title item-label">Taxes in %</div>
                            <div class="item-input-wrap">
                              <input type="number" class="taxes" @keyup="calculateQuantity" placeholder="Taxes in %" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-50">
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title item-label">After Tax Price</div>
                            <div class="item-input-wrap">
                              <input type="text" class="afterTax" placeholder="After Tax Price" disabled/>
                              <span class="input-clear-button"></span>
                            </div>
                          </div>
                        </div>
                      </div>
                  </div>
                  
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Buyer's Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="buyer_sell" id="buyer_sell" placeholder="Buyer's name" required/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="row">
                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="row" style="width:100%;">
                            <div class="col-100 medium-33"><div class="item-title item-label">Amount Paid</div></div>
                            <div class="col-100 medium-66">
                              <a class="button button-small button-outline text-color-white button-green bg-color-green no-margin padding-horizontal-half" @click="recordPaidFully">Paid fully</a>
                            </div>
                          </div>
                          <div class="item-input-wrap">
                            <input type="number" class="amountpaid_sell" placeholder="Amount customer paid" value="0" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">It's an Estimate<i class="icon f7-icons icon-tooltip estimateExplain color-black">info_circle_fill</i></div>
                          <div class="item-input-wrap">
                            <label class="checkbox" style="margin: 10px 0;">
                              <!-- checkbox input -->
                              <input type="checkbox" class="isEstimate">
                              <!-- checkbox icon -->
                              <i class="icon-checkbox"></i>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
                </li>
                <li>
                  <div class="row">
                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Date Buyer Paid</div>
                        <div class="item-input-wrap">
                            <input type="text" placeholder="Date buyer paid" id="paid-calendar-modal-prods"/>
                            <span class="input-clear-button"></span>
                        </div>
                        </div>
                    </div>
                    </div>

                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Date of Purchase</div>
                        <div class="item-input-wrap">
                            <input type="text" placeholder="Date of purchase" id="purchase-calendar-modal" required validate data-error-message="Select date of purchase please!"/>
                            <span class="input-clear-button"></span>
                        </div>
                        </div>
                    </div>
                    </div>
                  </div>
                  
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-outline button-raised mainButton" @click='saveDataSell'>Sell Product</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--pop up make a sale-->

  <!--pop up for add ingredients-->
  <div class="popup ProductIngredients popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Add/Edit Product Raw Materials</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePopUp"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="block margin-top-half margin-bottom-half padding-horizontal-half">
                  <div class="block-title block-title-medium no-margin-bottom">{{productToEdit}}</div>
            </div>

        <div class="list margin-bottom-half margin-top">
          <div class="row justify-content-center">
            <a class="col-50 button tealBgButton" href="#" id="autocomplete-standalone-multiple">
            <div class="item-title item-label text-color-white">Add Raw Materials</div>
          </a>
        </div>
          <!--<ul>
            <li>
              <a class="item-link item-content bg-color-orange myOrange" href="#" id="autocomplete-standalone-multiple">
                <input type="hidden">
                <div class="item-inner">
                  <div class="block-title item-title item-label no-margin text-color-white">Add Raw Materials</div>
                  <div class="item-after"></div>
                </div>
              </a>
            </li>
          </ul>-->
        </div>

        <div id="prodIng-list" class="customList">
          <ul class="list sortList margin-top-half margin-bottom-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>

        <div class="row justify-content-center">
          <a class="col-50 button tealColorButton customcharges" @click="AddNewCost">Add Other Charges</a>
        </div>

        <div id="prodOtherIng-list" class="customList">
          <ul class="list sortList margin-top-half margin-bottom-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>

        <ul class="list sortList margin-top-half margin-bottom-half">
                <div class="bigLabel">
                  <span class="labelName margin-right-half">Profit in Money:</span>
                  <div class="display-inline-flex">
                    <input class="profitvalue" type="text" @keyup="calculateprofit">
                    <!--<div class="profitvalue valueName"></div>-->
                  </div>
                </div>

      </ul>

      <div class="margin-top-half bigLabel margin-horizontal-half">
        <span class="labelName margin-right-half">Cost before profit: </span>
        <div class="display-inline-flex"><div class="totalAmountBeforeProfit">0</div></div>
      </div>
      <div class="margin-top-half bigLabel margin-horizontal-half">
        <span class="labelName margin-right-half">Cost after profit: </span>
        <div class="display-inline-flex"><div class="totalAmount">0</div></div>
      </div>

    
    <div class="row padding-horizontal-half margin-vertical-half">
      <div class="col-100">
        <a class="col button mainButton saveTotalButton" @click="SaveTotal">Save Raw Materials</a>
      </div>
    </div>
        
            
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up for add ingredients-->

  
  <!--pop up for for multiple items-->
  <div class="popup multipleSales popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Multiple Product Sales</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePopUpMultiple"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
            
        <div class="list margin-bottom-half margin-top">
          <div class="row justify-content-center">
            <a class="col-50 button sellMultipleList tealBgButton" href="#" id="autocomplete-standalone-multiple2">
              <div class="item-title text-color-white">Select Products</div></a>
        </div>
        </div>

        <div id="products-list" class="customList">
          <ul class="list sortList margin-top margin-bottom-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>

        <div class="row justify-content-center">
          <a class="col-50 button customcharges tealColorButton" @click="AddNewProduct(null)">Add Other Charges</a>
        </div>

        <div id="productsOther-list" class="customList">
          <ul class="list sortList margin-top-half margin-bottom-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>

        <ul class="list sortList margin-top-half margin-bottom-half">
              <div class="bigLabel">
                <span class="labelName margin-right-half">Taxes in %:</span>
                <div class="display-inline-flex">
                  <input class="taxpercent" type="text" placeholder="0 to 100" @keyup="CalculateTotalProduct" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" value="0">
                </div>
              </div>
      </ul>
      <div class="row padding-horizontal-half display-none">
        <div class="col-100">
        <a class="col button button-outline button-raised mainButton calculateTotalButton" @click="CalculateTotalProduct">Calculate</a>
      </div>
    </div>
        <div class="margin-top-half bigLabel text-align-center margin-horizontal-half">
          <span class="labelName">Price before tax: </span>
          <div class="display-inline-flex margin-left-half"><div class="totalAmountBeforeProfitProduct">0</div></div>
        </div>
        <div class="margin-top-half bigLabel text-align-center margin-horizontal-half">
          <span class="labelName">Price after tax: </span>
          <div class="display-inline-flex margin-left-half"><div class="totalAmountProduct">0</div></div>
        </div>
         
        <ul class="list margin-top-half margin-bottom-half margin-horizontal-half grouped"><li>
        <div class="card myCard">
          <div class="card-content padding-horizontal padding-vertical">
            
            <div class="row">
              <div class="col-50">
                <div class="labelName">Product Combo</div>
              <input class="groupProductNameMultiple" type="text" placeholder="e.g shirt & pants" value="">
            </div>

            <div class="col-50">
              <div class="labelName">Buyer's Name: </div>
              <input class="buyersNameMultiple" id="buyersNameMultiple" type="text" placeholder="Buyer's Name" value="">
            </div>
          </div>


              <div class="row margin-top-half">
                <div class="col-50">
                  <div class="row">
                    <div class="col-100 medium-33 labelName">Amount Paid</div>
                        <div class="col-100 medium-66">
                          <a class="button button-small text-color-white button-green bg-color-green" @click="recordPaidFullyMultiple">Paid fully</a>
                        </div>
                    </div>
                  <input class="amountPaidMultiple" type="text" placeholder="Amount Paid" value="0">
                </div> 

                <div class="col-50">
                    <div class="labelName">This is an estimate<i class="icon f7-icons icon-tooltip estimateExplain color-black">info_circle_fill</i></div>
                    <div>
                      <div class="item-input-wrap" style="position: relative;">
                        <label class="checkbox" style="margin: 10px 0;">
                          <input type="checkbox" class="isEstimateMultiple">
                          <i class="icon-checkbox"></i>
                        </label>
                      </div>
                  </div>
                </div>
            </div>
            
            
            <div class="row margin-top-half">
              <div class="col-50">
                <div class="labelName">Date of Payment: </div>
                <input id="datePaidMultiple" class="text-align-center" type="text" placeholder="Date of Payment" value="0">
              </div>

              <div class="col-50">
                <div class="labelName">Date of Purchase </div>
                <input id="datePurchaseMultiple" class="text-align-center" type="text" placeholder="Date of Purchase" value="0">
              </div>
              
            </div>

          </div>
        </div>
        </li></ul>
                <div class="row padding-horizontal-half margin-bottom-half"><div class="col-100">
                  <a class="col button mainButton margin-bottom-half" @click="saveMultipleProduct">Sell Products</a>
                </div>
              </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up for multiple items-->

</div>
</template>
<script>
//import Dom7 from 'dom7';
//import Dexie from 'dexie';
import * as moment from 'moment';
import * as XLSX from 'xlsx';
import copy from 'copy-to-clipboard';
var selectedUserName = null, selectedUserID = null, myActionSheet = null, mogulsheetdb = null;
var dbProducts = null, dbProdIngs = null, dbProdOthers = null, dbSales = null, dbIngs = null, dbSettings = null, dbClients = null;
var dbRestock = null, dataToUpload = null, eachBatch = 50, uploaded = 0, allImages = undefined, productList = null;
//var $$ = Dom7;
export default {
  data: function () {
      // Must return an object
      return {
        products: null,
        totalMat:0,
        currentProduct: null,
        currentProductLink: null,
        lastLink: null,
        totalMatIngredients:0,
        ings:null,
        allIngs:null,
        productToEdit: null,
        productToEditID: null,
        productIngs:[],
        currentMultipleSale: null,
        selectedProducts:[],
        settings: null,
        settingsID: 'settings',
        clients:null,
        createdVariants:[],
        backendUrl: 'https://posbackend.herokuapp.com/',   //  'http://localhost:3000/'
      }
    },
  methods:{
    calculateprofit: function(){
      var self = this;
        self.CalculateTotal();
    },
    addNewAttribute: function(){
      var row = '<div class="row attributeRow margin-top-half"> \
                              <div class="col-50"> \
                                <input class="AttributeKey" type="text" placeholder="e.g color" value=""> \
                              </div> \
                              <div class="col-50"> \
                                <input class="AttributeValue" type="text" placeholder="e.g red,blue,white" value=""> \
                              </div> \
                            </div>';
        var len = $(".attributeRow").length;
        $(row).insertAfter($(".attributeRow").eq(len - 1));
    },
    renderProductVariant: function(arr){
      var self = this;
      $("#variantCreator").addClass("display-none");
      $("#allVariantCreatedPar").removeClass("display-none");
      $("#allVariantCreated").empty();
      $.each(arr, function(ind, val){
        var text = "";
        $.each(val.variantAttributes, function(ind2, val2){
            text += "<div class='row margin-top-half'><div class='col-100'>";
              text += "<div class='labelName text-color-red'><span class='variantAttributeKey'>" + val2["attribute"] + "</span>: <span class='variantAttributeValue'>" + val2["value"] + "</span></div>";
              text += "</div></div>";
        })
        
      
        var template = '<div class="card myCard eachProductVariant">\
                          <div class="card-content padding-horizontal padding-vertical">\
                            <div class="row">\
                              <input type="hidden" class="variantProductID" value="' + val.id + '"/>\
                              <div class="col-50">\
                                <div class="labelName">Cost Price</div>\
                                <input class="variantCostPrice" type="number" placeholder="Cost Price" value="' + val.costPrice + '" required>\
                              </div>\
                              <div class="col-50">\
                                <div class="labelName">Selling Price</div>\
                                <input class="variantSellingPrice" type="number" placeholder="Selling Price" value="' + val.sellingPrice + '" required>\
                              </div>\
                            </div>\
                            <div class="row margin-top-half">\
                              <div class="col-50">\
                                <div class="labelName">Comparable Price</div>\
                                <input class="variantComparablePrice" type="number" placeholder="Comparable Price" value="' + (val.comparablePrice == null ? "" : val.comparablePrice) + '">\
                              </div>\
                              <div class="col-50">\
                                <div class="labelName">In Stock</div>\
                                <input class="variantInStock" type="number" placeholder="Quantity In Stock" value="' + (val.stock != "Unlimited" ? val.stock : "") + '">\
                              </div>\
                            </div>\
                            <div class="row margin-top-half">\
                              <div class="col-50">\
                                <span class="labelName">Show to public</span>\
                                <input class="showVariantToPublic margin-left-half" type="checkbox">\
                              </div>\
                              <div class="col-50">\
                                <span class="labelName">Stock is Unlimited</span>\
                                <input class="stockUnlimited margin-left-half" type="checkbox">\
                              </div>\
                            </div>';
              
              template += text;
                            
              template += '<div class="row margin-top-half">\
                              <div class="col-50"></div>\
                              <div class="col-50">\
                                <a class="button button-small button-fill color-red margin-horizontal-half text-color-white deleteVariant">Delete Variant</a>\
                              </div>\
                            </div>\
                            </div>\
                          </div>';
          template = $(template);
          if(val.stock == "Unlimited"){
            $(template).find(".stockUnlimited").prop("checked", true);
          }
          if(val.showToPublic == true){
            $(template).find(".showVariantToPublic").prop("checked", true);
          }
          $("#allVariantCreated").append(template);
      });
      //bind events
      $(".deleteVariant").on("click", function(e){
        var deleteParent = $(this).parents(".eachProductVariant").eq(0);
        var idToDelete = parseInt($(this).parents(".eachProductVariant").eq(0).find(".variantProductID").val());
        self.$app.preloader.show();
        $.when(self.$app.methods.getDataAPI("products/DeleteActivateProd?id=" + idToDelete + "&stat=" + false)).then(function( data, textStatus, jqXHR ) {
          self.$app.preloader.hide();
          $(deleteParent).remove();
        }).catch((err) => {
          self.$app.preloader.hide();
          self.$app.methods.showToast("An error occurred", "center");
        });
      });
      //switch btw unlimited and stock
      $(".stockUnlimited").on("change", function(e){
        if($(".stockUnlimited").is(":checked")){
          $(this).parents(".eachProductVariant").eq(0).find(".variantInStock").val("");
        }else{
          if($(this).parents(".eachProductVariant").eq(0).find(".variantInStock").val() == ""){
            $(this).attr("checked", true);
          }
        }
      })
      //in stock press
      $(".variantInStock").on("keyup", function(e){
        if($(this).val() == ""){
          $(this).parents(".eachProductVariant").eq(0).find(".stockUnlimited").attr("checked", true);
        }else{
          $(this).parents(".eachProductVariant").eq(0).find(".stockUnlimited").attr("checked", false);
        }
      })
    },
    createProductVariant: function(arr){
      $("#allVariantCreatedPar").removeClass("display-none");
      $("#allVariantCreated").empty();
      $.each(arr, function(ind, val){
        var text = "";
        for(var obj in val){
          text += "<div class='row margin-top-half'><div class='col-100'>";
            text += "<div class='labelName text-color-red'><span class='variantAttributeKey'>" + obj + "</span>: <span class='variantAttributeValue'>" + val[obj] + "</span></div>";
            text += "</div></div>";
        }
      
        var template = '<div class="card myCard eachProductVariant">\
                          <div class="card-content padding-horizontal padding-vertical">\
                            <div class="row">\
                              <input type="hidden" class="variantProductID" value="0"/>\
                              <div class="col-50">\
                                <div class="labelName">Cost Price</div>\
                                <input class="variantCostPrice" type="number" placeholder="Cost Price" value="" required>\
                              </div>\
                              <div class="col-50">\
                                <div class="labelName">Selling Price</div>\
                                <input class="variantSellingPrice" type="number" placeholder="Selling Price" value="" required>\
                              </div>\
                            </div>\
                            <div class="row margin-top-half">\
                              <div class="col-50">\
                                <div class="labelName">Comparable Price</div>\
                                <input class="variantComparablePrice" type="number" placeholder="Comparable Price" value="">\
                              </div>\
                              <div class="col-50">\
                                <div class="labelName">In Stock</div>\
                                <input class="variantInStock" type="number" placeholder="Quantity In Stock" value="">\
                              </div>\
                            </div>\
                            <div class="row margin-top-half">\
                              <div class="col-50">\
                                <span class="labelName">Show to public</span>\
                                <input class="showVariantToPublic margin-left-half" type="checkbox">\
                              </div>\
                              <div class="col-50">\
                                <span class="labelName">Stock is Unlimited</span>\
                                <input class="stockUnlimited margin-left-half" type="checkbox">\
                              </div>\
                            </div>';
              
              template += text;
                            
              template += '<div class="row margin-top-half">\
                              <div class="col-50"></div>\
                              <div class="col-50">\
                                <a class="button button-small button-fill color-red margin-horizontal-half text-color-white deleteVariant">Delete Variant</a>\
                              </div>\
                            </div>\
                            </div>\
                          </div>';
          $("#allVariantCreated").append(template);
      })
      $(".variantCostPrice").val($(".cost_price").val());
      $(".variantSellingPrice").val($(".selling_price").val());
      $(".variantComparablePrice").val($(".comparable_price").val());
      $(".variantInStock").val($(".stock_quantity").val());
      $(".stockUnlimited").attr("checked", $(".isUnlimited").is(":checked"));
      $(".showVariantToPublic").attr("checked", $(".showToPublic").is(":checked"));
      $(".deleteVariant").on("click", function(e){
        $(this).parents(".eachProductVariant").eq(0).remove();
      });
      //switch btw unlimited and stock
      $(".stockUnlimited").on("change", function(e){
        if($(".stockUnlimited").is(":checked")){
          $(this).parents(".eachProductVariant").eq(0).find(".variantInStock").val("");
        }else{
          if($(this).parents(".eachProductVariant").eq(0).find(".variantInStock").val() == ""){
            $(this).attr("checked", true);
          }
        }
      })
      //in stock press
      $(".variantInStock").on("keyup", function(e){
        if($(this).val() == ""){
          $(this).parents(".eachProductVariant").eq(0).find(".stockUnlimited").attr("checked", true);
        }else{
          $(this).parents(".eachProductVariant").eq(0).find(".stockUnlimited").attr("checked", false);
        }
      })
    },
    getPermutation: function(arrayOfarray, prefix){
      var self = this;
      prefix = prefix || '';
      if (!arrayOfarray.length) {
          return prefix;
      }
    
      var result = arrayOfarray[0].reduce(function (result, value) {
          return result.concat(self.getPermutation(arrayOfarray.slice(1), prefix + value));
      }, []);
      return result;
    },
    createArrayOfArray: function(){
      var self = this;
      var bigData = [];
      var keys = [];
      $.each($(".AttributeKey"), function(ind, val){
        var key = $(val).val().trim();
        var opts = $(".AttributeValue").eq(ind).val().trim();
        if(key != "" && opts != ""){
          var sep = opts.split(",").filter(x => x != "");
          sep = [...new Set(sep)];
          var simps = [];
          keys.push(key);
          for(var i =0; i < sep.length; i++){
            var opt = sep[i].trim() + ";";
            simps.push(opt);
          }
          bigData.push(simps);
        }
      })
      //console.log(bigData);
      if(bigData.length > 0){
        var fullTable = self.getPermutation(bigData);
        //console.log("keys", keys);
        //console.log("table:", fullTable);
        var finalTable = [];
        $.each(fullTable, function(ind, val){
          var allOpts = val.split(";").filter(x => x != "");
          var obj = {};
          $.each(allOpts, function(ind2, val2){
            obj[keys[ind2]] = val2;
          });
          finalTable.push(obj);
        })
        
        //console.log("full variants:", finalTable);
        //createdVariants
        /*self.$setState({
          createdVariants: finalTable
        })*/
        self.createProductVariant(finalTable);
      }
    },
    clearVariantCreator: function(){
      var self = this;
      $(".attributeRow").not(':first').remove();
      $(".AttributeKey, .AttributeValue").val("");
      $("#allVariantCreated").empty();
      $("#allVariantCreatedPar").addClass("display-none");
      //$("#variantCreator").removeClass("display-none");
    },
    uploadImagesProducts: function(){
       var self = this; 
        var data = new FormData();
        for(var i = 0; i < $('#myPhotosProducts')[0].files.length; i++){
            var files = $('#myPhotosProducts')[0].files[i];
            data.append("photos", files);
        }
        self.$app.preloader.show();
            $.ajax({
                url: self.backendUrl + 'uploadImages',
                type: 'post',
                data: data,
                contentType: false,
                processData: false,
                success: function(response){
                    if(response.success){
                        var keys = Object.keys(response.images);
                        var images = [];
                        for(var i = 0; i < keys.length; i++){
                          var obj = {};
                            var key = keys[i];
                            var val = response.images[keys[i]];
                            obj[key] = val;
                            images.push(obj);
                        }

                        if(keys.length > 0){
                          self.$app.preloader.hide();
                          self.generateLink2(images);
                        }
                    }else{
                        self.showToast("An error uploading images", "center");
                        self.$app.preloader.hide();
                    }
                },
                error: function(err){
                    self.showToast("An error uploading images", "center");
                    self.$app.preloader.hide();
                }
            });
    },
    checkFilesProducts: function(e) {  
      var self = this;
      var maxLimit = 3;  
      var id = e.target.id;

      let list = new DataTransfer;
      var cut = 0;
      var pres = 0;
      //$(".expenseWrapper").empty(); 
      for(var i = 0; i < $('#' + id)[0].files.length; i++){
          var files = $('#' + id)[0].files[i];
          var size = files.size / 1024 / 1024;
          if((size <= 2) && (i < maxLimit)){
           /* var reader = new FileReader();
            reader.onload = function(){
              var html = "<div class='swiper-slide'>";
              html += "<div class='holderSwiper'><img class='images' src='" + reader.result + "'></div>";
              html += "<div><p><a class='button bg-color-red text-color-white deleteImage'>Delete Image</a></p></div></div>";
              $(".expenseWrapper").append(html); 
            };
            reader.readAsDataURL(files);*/
              list.items.add(files);
          }else{
              cut++;
          }
      }  
      document.getElementById(id).files = list.files; 
      var tense = cut == 1 ? " file was " : " files were "
      if(cut > 0) alert(cut + tense + "removed because it's too large or you went above file limits");   
  },
    recordPaidFully: function(){
      var tt = $(".afterTax").val();
      $(".amountpaid_sell").val(tt);
    },
    recordPaidFullyMultiple: function(){
      var tt = $(".totalAmountProduct").text();
      $(".amountPaidMultiple").val(tt);
    },
    openPopUpRestockHistory: function(){
      var self = this;
      self.$app.preloader.show();
      $.when(self.$app.methods.getDataAPI("products/GetRestockHistory")).then(function( arr, textStatus, jqXHR ) {
          self.$app.preloader.hide();
          $("#restock-list .list").empty();
          $("#restock-list .pagination").remove();
          if(arr.length > 0){
            var pagination = "<ul class='pagination padding-left-half margin-vertical-half'><ul>";
            $(pagination).insertAfter($("#restock-list .list"));

            var isDesktop = self.$app.methods.isDesktop();
            if(isDesktop){
              $("#restock-list ul.list").remove();
              for(var i = 0; i < arr.length; i++){
                    var row = arr[i];
                    var html = "<tr>";
                      html += '<td class="id" style="display:none;">' + row.id + '</td>';
                      html += "<td class='name'>" + row.productName + "</td>";
                      html += "<td>" + row.lastStock + "</td>";
                      html += "<td>" + row.newStock + "</td>";
                      html += "<td>" + row.totalStock + "</td>";
                      html += "<td class='restock_date'>" + moment(row.restockDate).format("LLL") + "</td>";
                      
                    html += "</tr>";
                    $("#restock-list tbody.list").append(html);
                }
            }else{
              $("#restock-list .data-table").remove();
              $(".restockHistory").find(".sortTextPar, .header_title").removeClass("display-none"); 
              $("#restock-list").find(".sort").remove();
              var sorter = '<span class="sort" data-sort="name">Product Name</span><span class="sort" data-sort="restock_date">Restock date</span>';
              $(sorter).insertAfter($(".restockHistory").find(".sortText"));
              $(".restockHistory").find(".sortText").removeClass("display-none");
              
              for(var i = 0; i < arr.length; i++){
                    var row = arr[i];
                    var html = '<li><div class="card myCard"><div class="card-content padding-horizontal-half">';
                    html += '<div class="name cardName">' + row.productName + '</div>';
                    html += '<div class="name display-none">' + row.productName + '</div>';
                    html += '<div class="display-none restock_date">' + row.restockDate + '</div>';
                    html += '<div class=""><span>Last Stock: </span><span class="">' + row.lastStock + '</span></div>';
                    html += '<div class=""><span>Added Stock: </span><span class=""><b>' + row.newStock + '</b></span></div>';
                    html += '<div class=""><span>Total Stock: </span><span class="">' + row.totalStock + '</span></div>';
                    html += '<div class=""><span>Restock Date: </span><span class="">' + moment(row.restockDate).format("LLL") + '</span></div>';
                    html += '</div></div></li>';
                    //moment.unix(item.created_date).format("LLL");
                    
                    $("#restock-list ul.list").append(html);
                                  //return html;
                }
            }

              var options = {
                  valueNames: ['name','restock_date'],
                  page: 10,
                  pagination: [{outerWindow:2}]
              };

              var restock = new List('restock-list', options);

              $(".restockHistory").find(".sort").off("click").on("click", function(){
                $(".restockHistory").find(".sort").find(".asc").remove();
                $(".restockHistory").find(".sort").find(".desc").remove();
                  if($(this).hasClass("asc")){
                    $(this).append("<i class='icon f7-icons asc text-color-red'>arrowtriangle_up_fill</i>");
                  }
                  if($(this).hasClass("desc")){
                    $(this).append("<i class='icon f7-icons desc text-color-red'>arrowtriangle_down_fill</i>");
                  }
              })          
          }
          
          
        }).catch((err) => {
          self.$app.preloader.hide();
          self.showToast("An error occurred", "center");
        })
      var popup = self.$app.popup.open('.popup.restockHistory', true);
      
    },
    closePopUpRestockHistory: function(){
      var self = this;
      var popup = self.$app.popup.close('.popup.restockHistory', true);
    },
    restockProductSave: function(){
      var self = this;
      var err = self.$app.input.validateInputs(".restockProductForm");
      if(err){
          var stock = $(".restock_quantity").val();
          var unlimited = $(".isUnlimitedRestock").is(":checked");
          if((stock == "" && !unlimited) || (stock != "" && unlimited)){
            self.$app.dialog.alert("Check stock as unlimited or enter stock quantity", "Omni");
            return;
          }
          var finalStock = stock != "" ? stock : "Unlimited";
          var obj = {};
          obj.productId = self.currentProduct.id;
          obj.productName = self.currentProduct.name;
          obj.lastStock = $(".currentStock").text();
          obj.totalStock = $(".totalStock").text();
          obj.newStock = finalStock;
          obj.restockDate = moment($("#restock-calendar-modal").val()).format();
          //save stock
          self.$app.preloader.show();
          $.when(self.$app.methods.postDataAPI("products/SaveProdStockUpdateProd", obj, true)).then(function( data, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                if(data){
                  self.showToast("Restocking Saved", "center", true);
                  self.closeRestockProduct();
                }
              }).catch((data, textStatus, jqXHR) => {
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
        }
    },
    openRestockProduct: function(id){
      var self = this;
      if(id != null || id != undefined){
            var item = self.products.find(function(e){ 
                  return e.id == id;
              });
              self.$setState({
                currentProduct:item
              }, function(){
                $(".restockProductName").text(item.name);
                var unlimited = item.stock == undefined ? "Unlimited" : item.stock
                $(".currentStock, .totalStock").text(unlimited);
                $(".isUnlimitedRestock").prop("checked", true);
                var popup = self.$app.popup.open('.popup.restockProduct', true);
              });
      }else{
        self.$setState({
                currentProduct:null
              });
      }
      
    },
    closeRestockProduct: function(){
      var self = this;
      $(".restock_quantity").val("");
      $(".totalStock").text("");
      $(".isUnlimitedRestock").prop("checked", true);
      $("#restock-calendar-modal").next("span").click();
      self.$setState({
          currentProduct:null
      });
      var popup = self.$app.popup.close('.restockProduct', true);
      self.getData();
    },
    onlyDecimal: function(evt){
      var charCode = (evt.which) ? evt.which : evt.keyCode;
          if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)){
            evt.preventDefault();
          }
    },
    stockInput: function(evt){
      var self = this;
        var val = $(".stock_quantity").val();
        if(val == ""){
          $(".isUnlimited").prop("checked", true);
        }else{
          $(".isUnlimited").prop("checked", false);
        }
    },
    stockInputRestock: function(evt){
      var self = this;
        var val = $(".restock_quantity").val();
        var lastValue = val;
        if(val == ""){
          $(".isUnlimitedRestock").prop("checked", true);
          $(".totalStock").text("Unlimited");
          //lastValue = "";
        }else{
          $(".isUnlimitedRestock").prop("checked", false);
          if($(".currentStock").text() == "Unlimited"){
            $(".totalStock").text(val);
          }else{
            var currStock = parseFloat($(".currentStock").text());
            if(!isNaN(currStock)){
              var newStock = parseFloat(val);
              var tot = currStock + newStock;
              $(".totalStock").text(tot);
            }else{
              $(".totalStock").text(val);
            }
          }
        }
    },
    calculateQuantity: function(){
        var self = this;
        var cost = Number($(".cost_sell").val().trim());
        var quant = Number($(".quantity_sell").val().trim());
        if(self.currentProduct.stock != undefined && self.currentProduct.stock != "undefined" && self.currentProduct.stock != "Unlimited"){
          if(quant > self.currentProduct.stock){
            self.showToast("This quantity is more than you have in stock", "center");
          }
        }
        if(!isNaN(cost) && !isNaN(quant)){
            var total = cost * quant;
            var discount = Number($(".discount_sell").val());
            total = total - discount;
            $(".total_sell").val(total.toFixed(2));
            var taxes = Number($(".taxes").val().trim());
            if(taxes != "" || taxes == 0){
              if(!isNaN(taxes)){
                var taxAmt = (taxes/100) * total;
                var aftCost = total + taxAmt;
                $(".afterTax").val(aftCost.toFixed(2));
              }
            }
        }
    },
    calculateQuantity2: function(){
      var self = this;
      var total = Number($(".total_sell").val());
            var taxes = Number($(".taxes").val().trim());
            if(taxes != "" || taxes == 0){
              if(!isNaN(taxes)){
                var taxAmt = (taxes/100) * total;
                var aftCost = total + taxAmt;
                $(".afterTax").val(aftCost.toFixed(2));
              }
            }else{
              $(".afterTax").val(total.toFixed(2)); 
            }
    },
    CalculateTotal: function(){
      var totalCost = 0;
      $$(".eachCost").forEach(function(curr, i){
        var cost = 0;
        if($$(".eachCost")[i].type == "text"){
            cost = Number($$(".eachCost")[i].value);
        }else{
            cost = Number($$(".eachCost")[i].textContent);
        }
          
          if(!isNaN(cost)){
              totalCost += cost;
          }else{
              $$(".totalAmount").text("please fix error");
              return;
          }
      })
      
        $(".totalAmountBeforeProfit").text(totalCost.toFixed(2));
        var profitvalue = Number($(".profitvalue").eq(0).val());
        totalCost += profitvalue;
        $(".totalAmount").text(totalCost.toFixed(2));
    },
    typingvalue: function(but){
      var self = this;
      var val = $(but).val();
      var costperunit = $(but).attr("data-cost");
      var unit = $(but).attr("data-unit");
      var fig = (Number(costperunit)/Number(unit)) * Number(val);
        var td = $(but).parents("li").eq(0).find(".eachCost").eq(0).text(fig.toFixed(2));
        self.CalculateTotal();
    },
    RemoveItem: function(but){
      var self = this;
      var id = $(but).attr("data-id");
        var select = self.productIngs.filter(function(e){ 
              return e.id != id;
          });
 
          $(but).parents("li").eq(0).remove();
          self.$setState({
                ings:self.ings,
                productIngs:select
            }, function(){
              
              self.CalculateTotal();
            });
    },
    SelectItem: function(select){
      var self = this;
        var cpu = select.costPerUnit == undefined ? 0 : select.costPerUnit;
        var sus = select.select_unit_size == undefined ? 0 : select.select_unit_size; 
        var val2 = select.select_cost != undefined ? select.select_cost : 0;
        var stat = select.status == true ? "display-none" : "";

        
        var html = '<li class="eachCostParent"><div class="card myCard"><div class="card-content padding-horizontal-half"><div class="row">';
        html += '<div class="col-50"><div class="labelName">Name</div><div class="name cardName">' + select.name + '</div>';
        html += '</div><div class="col-50"><div class="labelName">Unit Cost</div><div class="cardName">' + self.formatMoney(cpu) + ' for ' + select.unitSize + select.unit + '</div></div>';
        html += '</div><div class="row margin-top-half"><div class="col-50"><div class="labelName">Quantity To Use</div><div class="row justify-content-start align-items-center">';
        html += '<span class="cardName">' + select.unit + ': </span><input class="margin-horizontal-half costvalue" type="text" placeholder="Enter Quantity" ';
        html += 'data-cost="' + cpu +'" data-unit="' + select.unitSize + '" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" ';
        html +=  'value="' + sus + '">';
        html += '</div></div><div class="col-50"><div class="labelName">Cost of Material</div><div class="cardName eachCost padding-top-half">' + val2 + '</div></div>';
        html += '</div><div class="' + stat + '"><span class="labelName">Status: </span><span class="valueName">Deleted</span></div><div class="row">';
        html += '<div class="col-50"></div><div class="col-50"><a class="button button-small removeCost" data-id="' + select.id + '">Remove Raw Material</a></div>';
        html += '</div></div></div></li>';

        $("#prodIng-list .sortList").append(html);
        $(".removeCost").off("click").on("click", function(){
                  //var id = $(this).attr("data-itemid");
                  self.RemoveItem(this);
                })
                $(".costvalue").off("keyup").on("keyup", function(){
                  //var id = $(this).attr("data-itemid");
                  self.typingvalue(this);
                })
    },
    showToast: function(text, position, icon = false){
        var self = this;
        self.$app.toast.create({
              icon: icon ? '<i class="f7-icons">checkmark_alt_circle</i>' : '',
              text: text,
              position: position,
              closeTimeout: 2000,
          }).open();
    },
    permDeleteItem: function(list, id){
        var self = this;
        
        self.$app.dialog.confirm("Are you sure you want to permanently delete this?", "Omni", function(){
                  mogulsheetdb.get(id).then(function(doc) {
                    doc.status = -1
                    return mogulsheetdb.put(doc);
                  }).then(function(){

                  self.products = self.products.filter(function(e){ 
                      return e.id != id;
                  });
                  self.$setState({
                      products:self.products,
                      totalMat:self.products.length
                  },function(){
                      self.showToast("Product permanently deleted!", "center", true);
                      list.remove("id", id);
                      if(self.products.length == 0){
                        $(".sortTextPar").addClass("display-none");
                        $("#product-list .pagination").remove();
                      }
                  });
              })
          }, null);
    },
    DeleteItem: function(list, id){
        var self = this;
        var checked = false;
        var text = "delete"
        /*var toggle = self.$app.toggle.get(".showInactive");
        if(toggle != undefined){
            if(toggle.checked){
                text = "activate";
                checked = 1;
            }
        }*/
        self.$app.dialog.confirm("Are you sure you want to " + text + "?", "Omni", function(){
          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("products/DeleteActivateProd?id=" + id + "&stat=" + checked)).then(function( data, textStatus, jqXHR ) {
                if(data){
                  self.$app.preloader.hide();
                  self.products = self.products.filter(function(e){ 
                      return e.id != id;
                  });
                  self.$setState({
                      products:self.products,
                      totalMat:self.products.length
                  },function(){
                      self.showToast("Product " + text + "d!", "center", true);
                      list.remove("id", id);
                      if(self.products.length == 0){
                        $(".sortTextPar").addClass("display-none");
                        $("#product-list .pagination").remove();
                      }
                  });
                }  
              }).catch((data, textStatus, jqXHR) => {
                self.$app.preloader.hide();
                  if(data != null && data.status == 404){
                    self.$app.methods.showToast("Product not found", "center");
                    return;
                  }
                  self.$app.methods.showToast("An error occurred", "center");
              })
          }, null);
    },
    CopyLink: function(){
      var self = this;
      var saveLink = "https://mogulsheet.com/landing/page?id=" + self.lastLink.link;
      copy(saveLink);
      self.$app.dialog.alert("Link copied to clipboard", "Omni");
    },
    createActionSheet: function(){
      var self = this;
      myActionSheet = self.$app.actions.create({
          buttons: [
            {
              text: 'Share Product Link',
              label: true,
              bold: true
            },
            {
              text: 'Copy Link',
              color: 'blue',
              onClick: function () {
                self.CopyLink();
              }
            },
            {
              text: 'Edit Product Description',
              color: 'blue',
              onClick: function () {
                self.openPopUpLinkServer(self.lastLink);
              }
            },
            {
              text: 'Cancel',
              color: 'red',
              close: true
            },
          ]
        });
    },
    openPopUpExcel: function(){
      var self = this;
      var popup = self.$app.popup.open('.uploadProducts', true);
    },
    closePopUpExcel: function(){
      var self = this;
      self.resetUploader();
      $(".errorContent").html("");
      var popup = self.$app.popup.close('.uploadProducts', true);
      self.getData();
    },
    fetchVariants: function(id){
      var self = this;
      self.$app.preloader.show();
      $.when(self.$app.methods.getDataAPI("products/GetProductVariants?id=" + id)).then(function( data, textStatus, jqXHR ) {
        self.$app.preloader.hide(); 
        if(data != null && data.length > 0){
          //reuse product variant templates
          //console.log(data);
          self.renderProductVariant(data);
        }
      }).catch((err) => {
        self.$app.preloader.hide(); 
      })
    },
    openPopUp: function(id){
        var self = this;
        var subs = self.$app.methods.checkUserSubscription();
        if(!subs){
          self.$app.methods.showToast("Please subscribe first", "center");
          return;
        }
        $("#variantCreator").addClass("display-none");
        //popup.once("opened", function(){
          if(id != null || id != undefined){
            var item = self.products.find(function(e){ 
                  return e.id == id;
              });
              self.$setState({
                      currentProduct:item
                    });
                    $("input.nameProduct").val(item.name);
                    var textEditor = self.$app.textEditor.get('.desc_of_product');
                    var desc = item.description == null ? "" : item.description;
                    textEditor.setValue(desc);
                    $("input.cost_price").val(item.costPrice);
                    $("input.selling_price").val(item.sellingPrice);
                    if(item.stock == undefined || item.stock == "" || item.stock == "Unlimited"){
                      $(".isUnlimited").prop("checked", true);
                      $(".stock_quantity").val("");
                    }else{
                      $(".isUnlimited").prop("checked", false);
                      $(".stock_quantity").val(item.stock);
                    }
                    if(item.comparablePrice != null){
                      $(".comparable_price").val(item.comparablePrice);
                    }
                    if(item.lowStockAlert != null){
                      $(".low_stock_alert").val(item.lowStockAlert);
                    }
                    //var makePub = $(".showToPublic").is(":checked");
                    //makePub = makePub == null ? true : makePub;
                    $(".showToPublic").prop("checked", item.showToPublic);
                    $(".productCategory").val(item.productCategory == null ? "" : item.productCategory);
                    $("#digitalAssetLink").text(item.assetLink == null ? "" : item.assetLink);
                    $("#productType").val(item.typeOfProduct == null ? "physicalProduct" : item.typeOfProduct).change();
                    if(item.images != null){
                        var images = item.images.split(";");
                        $(".productsWrapper").empty(); 
                        for(var i = 0; i < images.length; i++){
                          var obj = images[i];
                          //var imgName = Object.keys(obj)[0];
                          //var imgSrc = Object.values(obj)[0];
                          var html = "<div class='swiper-slide'>";
                            html += "<div class='holderSwiper'><div style='margin:auto;'><img class='images' src='" + obj + "'></div>";
                            html += "<div class='display-inline-flex margin-vertical' style='width:100%'><a class='button button-small tealBgButton link external margin-right' target='_blank' href='" + obj + "' download>Download Image</a><a class='button button-small deleteImage' data-name='" + obj + "'>Delete Image</a></div></div>";
                            html += "</div>";
                          $(".productsWrapper").append(html); 
                        }
                        $('.productsWrapper').off("click").on('click','.button', function (e) {
                            var name = $(this).attr("data-name");
                            if($(this).hasClass("deleteImage")){
                              self.deleteImage(name, this);
                            }
                            //return false;
                        });
                        self.reInitSwiper();
                    }
                    

                    //$(".stock_quantity, .isUnlimited").prop("disabled", true);
                    var popup = self.$app.popup.open('.popup.newProduct', true);
                    if(item.hasVariant == true){
                      self.fetchVariants(id);
                    }else{
                      $("#variantCreator").removeClass("display-none");
                    }
            } else{
              $("#variantCreator").removeClass("display-none");
              $(".isUnlimited, .showToPublic").prop("checked", true);
              $("input.nameProduct,input.selling_price,.cost_price, .stock_quantity, .productCategory, .comparable_price, .low_stock_alert").val("");
              $("#digitalAssetLink").text("");
              $("#productType").val("physicalProduct").change();
              //$(".stock_quantity, .isUnlimited").prop("disabled", false);
              var popup = self.$app.popup.open('.popup.newProduct', true);
              self.$setState({
                  currentProduct:null
              });
            }
        //})
        
    },
    deleteImage: function(name, but){
      var self = this;
      $(but).parents(".swiper-slide").eq(0).remove();
      self.reInitSwiper();
      var obj = {}
      obj.name = name;
      obj.id = self.currentProduct.id;
      self.$app.preloader.show();
      $.when(self.$app.methods.postDataAPI("products/DeleteImage", obj, true)).then(function( data, textStatus, jqXHR ) {
        self.$app.preloader.hide();
      }).catch((err) => {
        self.$app.preloader.hide();
        self.$app.methods.showToast("An error occurred", "center");
      })
    },
    openPopUpLink: function(id){
        var self = this;
        
        //popup.once("opened", function(){
          if(id != null || id != undefined){
            var item = self.products.find(function(e){ 
                  return e._id == id;
              });
                  self.$setState({
                      currentProductLink:item
                    });
                    if(self.settings != null){
                      if(self.settings.companyName != undefined && self.settings.companyName != null){
                        $(".compNameLink").val(self.settings.companyName);
                      }
                      //compEmailLink
                      if(self.settings.companyEmail != undefined && self.settings.companyEmail != null){
                        $(".compEmailLink").val(self.settings.companyEmail);
                      }
                      if(self.settings.companyPhone != undefined && self.settings.companyPhone != null){
                        $(".compPhoneLink").val(self.settings.companyPhone);
                      }
                    }
                    $$("input.nameLink").val(item.name);
                    var textEditor = self.$app.textEditor.get('.desc_of_productLink');
                    var desc = item.desc == null ? "" : item.desc;
                    textEditor.setValue(desc);
                    $$("input.selling_priceLink").val(item.selling_price);
                    var popup = self.$app.popup.open('.productLink', true);
            } else{
              var popup = self.$app.popup.open('.productLink', true);
              self.$setState({
                  currentProductLink:null
              });
            }
        //})  
    },
    openPopUpLinkServer: function(link){
        var self = this;
        
        //popup.once("opened", function(){
          if(link.id != null || link.id != undefined){
            var item = self.products.find(function(e){ 
                  return e._id == link.id;
              });
                  self.$setState({
                      currentProductLink:item
                    });

              self.$app.preloader.show();
              return(
                
                fetch(self.backendUrl + 'returnPage', {
                  method: 'post',
                  headers: {
                    'Content-type': 'application/json',
                  },
                  body: JSON.stringify({
                    id: link.link
                  }),
                }).then((response) => {
                    return response.json();
                }).then((result) => {
                  allImages = undefined;
                  allImages = result.images;
                  self.$app.preloader.hide();
                  var emailComp = result.comp_email == undefined ? self.settings.companyEmail : result.comp_email;
                  var phoneComp = result.comp_phone == undefined ? self.settings.companyPhone : result.comp_phone;
                  emailComp = emailComp == undefined ? "" : emailComp;
                  phoneComp = phoneComp == undefined ? "" : phoneComp;
                  $(".compNameLink").val(result.comp_name);
                  $(".compEmailLink").val(emailComp);
                  $(".compPhoneLink").val(phoneComp);
                  $$("input.nameLink").val(result.product_name);
                    var textEditor = self.$app.textEditor.get('.desc_of_productLink');
                    var desc = result.product_description == null ? "" : result.product_description;
                    textEditor.setValue(desc);
                    $$("input.selling_priceLink").val(result.product_raw_selling_price);
                    $(".other_notesLink").val(result.other_notes);
                    var popup = self.$app.popup.open('.productLink', true);
                }).catch(() => {
                  self.$app.preloader.hide();
                  self.showToast("An error occured", "center");
                })
              )
            } else{
              var popup = self.$app.popup.open('.productLink', true);
              self.$setState({
                  currentProductLink:null
              });
            }
        //})  
    },
    closeEditProdLink: function(){
      var self = this;
      $(".nameLink, .selling_priceLink, .other_notesLink, .compNameLink, .compEmailLink, .compPhoneLink").val("");
      var textEditor = self.$app.textEditor.get('.desc_of_productLink');
      textEditor.setValue("");
      document.getElementById("myPhotosProducts").value = "";
      self.$setState({
          currentProductLink:null
      });
      var popup = self.$app.popup.close('.productLink', true);
    },
    generateLink: function(){
      var self = this;
      if($('#myPhotosProducts')[0].files.length < 1){
        self.generateLink2(null);
      }else{
        self.uploadImagesProducts();
      }
    },
    generateLink2: function(images){
      var self = this;
      var err = self.$app.input.validateInputs(".productLinkForm");
      var doc = {};
      if(err){
        doc.comp_name = $(".compNameLink").val();
        doc.product_name = $(".nameLink").val();
        var comp_email = $(".compEmailLink").val();
        doc.comp_email = comp_email;
        var comp_phone = $(".compPhoneLink").val();
        doc.comp_phone = comp_phone;
        var textEditor = self.$app.textEditor.get('.desc_of_productLink');
        var desc = textEditor.getValue();
        doc.product_description = desc;
        doc.other_notes = $(".other_notesLink").val();
        var salePrice = $(".selling_priceLink").val();
        var sp = self.formatMoney(salePrice);
        doc.product_selling_price = sp;
        doc.product_raw_selling_price = salePrice;
        
        if(self.currentProductLink.product_link_id != undefined){
          doc._id = self.currentProductLink.product_link_id;
          if(images != null){
            if(allImages == undefined){
              doc.images = images;
            }else{
              doc.images = allImages.concat(images);
              allImages = doc.images;
            }
            
          }
        }else{
          if(images != null){
            doc.images = images;
          }
        }
      

        if(self.settings != undefined){
        if((self.settings.companyEmail != comp_email) || (self.settings.companyPhone != comp_phone)){
            var docset = self.settings;
            docset.companyEmail = comp_email;
            docset.companyPhone = comp_phone;
            self.$setState({
                  settings: docset
              })
            mogulsheetdb.put(docset).then((retDoc) => {
              
            }).catch(() => {})
        }
      }

        self.$app.preloader.show();
        return(
          fetch(self.backendUrl + 'addNewPage', {
                  method: 'post',
                  headers: {
                    'Content-type': 'application/json',
                  },
                  body: JSON.stringify(doc),
                }).then((response) => {
                    return response.json();
                }).then((result) => {
                  self.$app.preloader.hide();
                  if(result._id != null || result.id != null){
                    var resultID = result._id == undefined ? result.id : result._id;
                    mogulsheetdb.get(self.currentProductLink._id).then(function(doc2) {
                      doc2.product_link_id = resultID;
                       mogulsheetdb.put(doc2).then(() => {
                         var newLink = {};
                         newLink.link = doc2.product_link_id;
                         newLink.id = self.currentProductLink._id;
                         self.$setState({
                           lastLink: newLink
                         }, function(){
                           self.closeEditProdLink();
                           Promise.resolve(self.getData()).then(() => {
                            self.CopyLink();
                            //self.$app.dialog.alert(self.lastLink.link);
                          }); 
                           
                         })
                       });
                    })
                  }
                }).catch(() => {
                    self.$app.preloader.hide();
                })
        )

      }
    },
    openPopUpSellProduct: function(id){
        var self = this;
        
        //popup.once("opened", function(){
          if(id != null || id != undefined){
            var item = self.products.find(function(e){ 
                  return e.id == id;
              });
              self.$setState({
                  currentProduct: item
              });

                $$("input.name_sell").val(item.name);
                $$("input.cost_sell").val(item.sellingPrice);
                var quantity = item.quantity == null ? 1 : item.quantity;
                var total = item.totalPrice == null ? item.sellingPrice : item.totalPrice;
                //var taxes = localStorage.getItem("taxes");
                var taxes = self.$app.data.settings == null ? 0 : self.$app.data.settings.taxes;
                var taxesAmt = taxes == undefined ? 0 : taxes;
                taxesAmt = Number(taxesAmt);
                total = Number(total);
                var afterTax = (((taxesAmt/100) * total) + total);
                $(".quantity_sell").val(quantity);
                $(".taxes").val(taxesAmt);
                $(".afterTax").val(afterTax.toFixed(2));
                $(".total_sell").val(total.toFixed(2));
                $("#paid-calendar-modal-prods").val(moment().format('LLL'));
                $("#purchase-calendar-modal").val(moment().format('LLL'));
                var popup = self.$app.popup.open('.popup.sellProduct', true);
            } else{
              var taxes = self.$app.data.settings == null ? 0 : self.$app.data.settings.taxes;
              var taxesAmt = taxes == undefined ? 0 : taxes;
              $(".quantity_sell").val("1");
              $(".taxes").val(taxesAmt);
              $("#paid-calendar-modal-prods").val(moment().format('LLL'));
              $("#purchase-calendar-modal").val(moment().format('LLL'));
              var popup = self.$app.popup.open('.popup.sellProduct', true);
              self.$setState({
                  currentProduct:null
              });
            }
        //})
        
    },
    SelectItemMultipleProducts: function(select){//name,cost,status,created_date
      var self = this;
      var name = select.productName == null ? "" : select.productName;
      if(name == ""){
        name = select.name == null ? "" : select.name;
      }
      var discount = select.discount == null ? "0" : select.discount;
      var cost = select.sellingPrice == null ? "" : select.sellingPrice;
      var quantity = select.quantity == null ? 1 : select.quantity;
      var totalPrice = select.totalPrice == null ? "" : select.totalPrice; 
        var html = '<li class="eachSaleParent eachProduct margin-vertical"><div class="card myCard"><div class="card-content padding-horizontal padding-vertical">';
          html += '<div class="row"><div class="col-50"><div class="labelName">Product Name </div><input class="productName" type="text" placeholder="Product Name" value="';
          html +=  name + '"></div>';
          html += '<div class="col-50"><div class="labelName">Product Price</div><input class="productCost" type="text" placeholder="Product Price" value="' + cost + '" disabled></div>';
          html += '</div>';

          html += '<input type="hidden" class="productID" value="' + select.id + '">';
          html += '<input type="hidden" class="hiddenQuantity" value="' + select.stock + '">';
          html += '<div class="row margin-top-half"><div class="col-50"><div class="labelName">Quantity</div><input class="productQuantity" type="text" placeholder="Product Quantity" value="' + quantity + '"></div>';
          html += '<div class="col-50"><div class="labelName">Discount</div><input class="discount" type="text" placeholder="Discount" value="' + discount + '"></div>';
          html += '</div>';

          html += '<div class="row margin-top-half"><div class="col-50"><div class="labelName">Total Price: </div><input class="totalproductprice" type="text" placeholder="Total Price" value="';
          html +=  totalPrice + '" disabled></div>';
          html += '<div class="col-50"><div>&nbsp</div><a class="button button-small removeProduct margin-top-half margin-horizontal-half" data-id="' + select.id + '">Remove Product</a></div>';
          html += '</div>';
        html += '</div></div></li>';
        $("#products-list .sortList").append(html);
        $(".eachSaleParent .removeProduct").off("click").on("click", function(){
                  var id = $(this).attr("data-id");
                  $(this).parents(".eachSaleParent").eq(0).remove();
                  Promise.resolve(self.RemoveItemProduct(id)).then(() => {
                    self.CalculateTotalProduct();
                  });  
                })
                $(".eachSaleParent input").off("keyup").on("keyup", function(){
                self.CalculateTotalProduct();
            })
                
    },
    RemoveItemProduct: function(id){
      var self = this;
      
        var select = self.selectedProducts.filter(function(e){ 
              return e.id != id;
          });
 
          //$(but).parents("li").eq(0).remove();
          self.$setState({
                ings:self.ings,
                selectedProducts:select
            }, function(){
              
              //self.CalculateTotal();
            });
    },
    getClients: function(){
        var self = this;
        $.when(self.$app.methods.getDataAPI("clients/GetClients")).then(function( data, textStatus, jqXHR ) {
          self.$setState({
                clients: data
              })
        });
    },
    openPopUpMultiple:function(){
      var self = this;
      self.$setState({
        currentMultipleSale: null
      })
      //self.getProducts();
      var selectedValues = null;
            var autocompleteStandaloneMultiple = self.$app.autocomplete.create({
              openIn: 'popup', //open in page
              openerEl: '#autocomplete-standalone-multiple2', //link that opens autocomplete
              multiple: true, //allow multiple values
              navbarColorTheme: 'col bg-color-white text-color-black',
              preloader: true, //enable preloader
              valueProperty: 'id', //object's "value" property name
              textProperty: 'name_price', //object's "text" property name
              popupCloseLinkText: 'Done',
              requestSourceOnOpen:true,
              source: function (query, render) {
                var autocomplete = this;
                autocomplete.preloaderShow();
                var results = self.products.filter(x => x.status == 1); //.map(a => a.name);
                //autocomplete.preloaderHide();
                //render(results);
                if (query.length === 0) {
                  $.each(results, function(ind, val){
                      val["name_price"] = val["name"] + "\t" + " - " + self.formatMoney(val["sellingPrice"]);
                  })
                  autocomplete.preloaderHide();
                  render(results);
                  return;
                }
                
                if (query.length > 0) {
                  var newResult = [];
                  // Find matched items
                  for (var i = 0; i < results.length; i++) {
                    if (results[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
                        results[i].name_price = results[i].name + "\t" + " - " + self.formatMoney(results[i].sellingPrice);
                        newResult.push(results[i]);
                      }
                  }
                  // Render items by passing array with result items
                  autocomplete.preloaderHide();
                  render(newResult);
                }
              },
              on: {
                change: function (value) {
                  
                 var itemText = [], inputValue = [];
                 selectedValues = value;
                },
                closed: function(){
                  if(selectedValues == null || selectedValues.length == 0){
                    return;
                  }
                  for(var i = 0; i < selectedValues.length; i++){

                    var found = self.selectedProducts.filter(x => x.id == selectedValues[i].id).length;
                    if(found < 1){
                      self.selectedProducts.push(selectedValues[i]);
                      self.SelectItemMultipleProducts(selectedValues[i]);
                    }
                  }

                  selectedValues = null;
                  //autocomplete.destroy();
                  self.CalculateTotalProduct();
                }
              }
        });
        
        var popup = self.$app.popup.open('.popup.multipleSales', true);
        var taxes = self.$app.data.settings == null ? 0 : self.$app.data.settings.taxes;
        var taxesAmt = taxes == undefined ? 0 : taxes;
        $(".taxpercent").val(taxesAmt);
        $(".multipleSales:visible").find("#datePaidMultiple").val(moment().format('LLL'));
        $(".multipleSales:visible").find("#datePurchaseMultiple").val(moment().format('LLL'));
        //self.CalculateTotalProduct();
        
    },
    openPopUpIngredients: function(id){
        var self = this;
        
        //popup.once("opened", function(){
            self.getDataIngredients(id); //get all ingredients
            var selectedValues = null;
            var autocompleteStandaloneMultiple = self.$app.autocomplete.create({
              openIn: 'popup', //open in page
              openerEl: '#autocomplete-standalone-multiple', //link that opens autocomplete
              multiple: true, //allow multiple values
              navbarColorTheme: 'col bg-color-white text-color-black',
              preloader: true, //enable preloader
              valueProperty: 'id', //object's "value" property name
              textProperty: 'name_price', //object's "text" property name
              popupCloseLinkText: 'Done',
              requestSourceOnOpen:true,
              source: function (query, render) {
                var autocomplete = this;
                autocomplete.preloaderShow();
                var results = self.ings; //.map(a => a.name);
                
                //render(results);
                if (query.length === 0) {
                  $.each(results, function(ind, val){
                      val["name_price"] = val["name"] + "\t" + " - " + self.formatMoney(val["costPerUnit"]) + " for " + val["unitSize"] + val["unit"];
                  })
                  autocomplete.preloaderHide();
                  render(results);
                  return;
                }
                if (query.length > 0) {
                  var newResult = [];
                  // Find matched items
                  for (var i = 0; i < results.length; i++) {
                    if (results[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
                        results[i].name_price = results[i].name + "\t" + " - " + self.formatMoney(results[i].costPerUnit) + " for " + results[i].unitSize + results[i].unit;
                        newResult.push(results[i]);
                      }
                  }
                  // Render items by passing array with result items
                  autocomplete.preloaderHide();
                  render(newResult);
                }
              },
              on: {
                change: function (value) {
                  
                 selectedValues = value;
                 
                },
                closed: function(){
                  if(selectedValues == null || selectedValues.length == 0){
                    return;
                  }
                  for(var i = 0; i < selectedValues.length; i++){
                    var found = self.productIngs.filter(x => x.id == selectedValues[i].id).length;
                    if(found < 1){
                      self.productIngs.push(selectedValues[i]);
                      self.SelectItem(selectedValues[i]);
                    }
                  }
                  var deleted = self.productIngs.filter(function(x) {  // return elements in previousArray matching...
                      return !selectedValues.includes(x);  // "this element doesn't exist in currentArray"
                  })
                  for(var i = 0; i < deleted.length; i++){
                    $(".eachCostParent .removeCost[data-id='" + deleted[i].id + "']").click();
                  }
                }
              }
        });
            var savearray = [];
            var profit = 0;
            if(id != null || id != undefined){
                //get main ingredient
                self.$app.preloader.show();
                $.when(self.$app.methods.getDataAPI("products/GetProductIngs?id=" + id)).then(function( arrBig, textStatus, jqXHR ) {
                  self.$app.preloader.hide();
                  if(arrBig.prodIngs != null){
                    var arr = arrBig.prodIngs;
                    $.each(arr, function( key, value ) {
   
                      var each = self.ings.find(x => x.id == value.ingredientId);
                      if(each != undefined){
                        each.select_unit_size = value.unitSize;
                        each.select_cost = value.cost;
                        savearray.push(each);
                      }
                    })

                    self.$setState({
                      productIngs:savearray
                      //ings: self.ings
                    }, function(){
                      for(var i = 0; i < savearray.length; i++){
                        if(savearray[i] != undefined) self.SelectItem(savearray[i]);
                      }
                      self.CalculateTotal();
                    });
                  }

                  if(arrBig.prodIngsOthers != null){
                    var arr = arrBig.prodIngsOthers;
                    $.each(arr, function( key, value ) {
                    if(value.name != "***Profit***"){
                      var html = '<li class="extraCostRow"><div class="card myCard"><div class="card-content padding-horizontal-half"><div class="row">';
                        html += '<div class="col-50"><div class="labelName">Name</div><input class="extraName" type="text" placeholder="e.g transport fare" value="';
                        html +=  value.name + '"></div>';
                        html += '<div class="col-50"><span class="labelName">Cost</span><input class="eachCost" type="text" placeholder="Enter Cost" value="';
                        html += value.cost + '"></div>';
                        html += '</div>';
                        html += '<div class="row margin-top-half"><div class="col-50"></div><div class="col-50">';
                          html += '<a class="button button-small removeRow">Remove Charge</a>';
                        html += '</div></div></div>';
                        html += '</li>';
                        $("#prodOtherIng-list .sortList").append(html);
                      
                      $(".removeRow").on("click", function(e){
                          $(this).parents("li").eq(0).remove();
                          self.CalculateTotal();
                      })
                      $(".extraCostRow").find(".eachCost").on("keyup", function(e){
                          self.CalculateTotal();
                          //$(".calculateTotalButton").eq(0).click();
                      })
                    }else{
                            $(".profitvalue").val(value.cost);
                            profit = value.cost;
                        }
                    })
                  }

                  var prd = self.products.find(x => x.id == id);
                    var costPrice = Number(prd.costPrice);
                    var sellingPrice = Number(prd.sellingPrice);
                    $(".totalAmountBeforeProfit").text(costPrice.toFixed(2));
                    $(".totalAmount").text(sellingPrice.toFixed(2));
                    //var cent = (100 * profit)/(finalPrice - profit);
                    //$(".profitpercent").val(cent.toFixed(2));
                    //self.CalculateTotal();
                    var popup = self.$app.popup.open('.ProductIngredients', true);

                }).catch((err) => {
                  self.$app.preloader.hide();
                  self.$app.methods.showToast("An error occurred", "center");
                })
            } 
            /*else{
              self.$setState({
                  currentProduct:null
              });
            }*/
        //})
        
    },
    saveMultipleProduct: function(){
        var self = this;
        var error = false;
        var bigData = [];
        
      //validation
      var grpName = $(".groupProductNameMultiple").val().trim();
        var buyername = $(".buyersNameMultiple").val().trim();
        var amountPaid = Number($(".amountPaidMultiple").val().trim());
        var taxes = Number($(".taxpercent").val().trim());
        if(isNaN(taxes)){
          error = true;
          $(".taxpercent").parents("ul").eq(0).addClass("bg-color-red");
        }else{
          $(".taxpercent").parents("ul").eq(0).removeClass("bg-color-red");
        }

        if(buyername == "" || isNaN(amountPaid)){
            $(".buyersNameMultiple").parents("li").eq(0).addClass("bg-color-red");
            error = true;
        }else{
          $(".buyersNameMultiple").parents("li").eq(0).removeClass("bg-color-red");
        }

        var beforeTaxes = Number($(".totalAmountBeforeProfitProduct").text());
          var afterTaxes = Number($(".totalAmountProduct").text());
          var fullyPaid = false;
      var isPaidDate = null;
      if(amountPaid >= afterTaxes){
        fullyPaid = true;
      }else{
        fullyPaid = false;
      }
      isPaidDate = moment($(".multipleSales:visible").find("#datePaidMultiple").val()).format();//  Date.parse($("#paid-calendar-modal-prods").val());
      var isEstimate = $(".isEstimateMultiple").prop("checked");
        $(".eachProduct").each(function(i, curr){
        var productID = null;
        var productName = $(curr).find(".productName").eq(0).val().trim();
        if($(curr).find(".productID").length > 0){
          productID = parseInt($(curr).find(".productID").eq(0).val());
        }
        
        var price = Number($(curr).find(".productCost").eq(0).val().trim());
        var quant = Number($(curr).find(".productQuantity").eq(0).val().trim());
        var totalPric = Number($(curr).find(".totalproductprice").eq(0).val().trim());
        var discount = Number($(curr).find(".discount").eq(0).val().trim());
        
        if(isNaN(price) || isNaN(quant) || productName == "" || isNaN(discount)){
            $(curr).addClass("bg-color-red");
            error = true;
        }else{
          $(curr).removeClass("bg-color-red");
          // saving logic
          var isParent = $(curr).hasClass("eachSaleParent") == true;
          var tax = (taxes/100) * totalPric;
          var costPlusTax = totalPric + tax;
          var obj = {
                productName: productName,
                productId: productID,
                //buyer_name: buyername,
                sellingPrice: price,
                discount: discount,
                isEstimate: isEstimate,
                taxes: taxes,
                parentID: 0,
                clientID: 0,
                isParent: isParent,
                afterTaxPrice: costPlusTax,
                quantity: quant,
                totalPrice: totalPric,
                amountPaid:  0,
                isPaid: fullyPaid,
                datePaid: isPaidDate,
                createdDate: moment($("#datePurchaseMultiple").val()).format(), //Date.parse($("#purchase-calendar-modal").val()),
                status:true
              };
            bigData.push(obj)
        }
      })

        // validation final
        if(error){
          self.showToast("Error is found in the forms!", "center", false);
        }else{
            // save into db
            
            var theBuyerID = "";
            var theBuyerName = "";
            if(buyername == selectedUserName){
              theBuyerName = selectedUserName;
              theBuyerID = selectedUserID;
              self.saveProcessedMultiplePayment(grpName, theBuyerName,theBuyerID,isEstimate,taxes,afterTaxes,beforeTaxes,amountPaid,fullyPaid,isPaidDate,bigData);
            }else{
              var objNew = {
                  name: buyername,
                  status:true
              }//saveClient
              $.when(self.$app.methods.postDataAPI("clients/SaveClient", objNew, true)).then(function( userid, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(userid != null){
                  self.showToast("New User Created.", "center", true);
                  self.saveProcessedMultiplePayment(grpName, buyername,userid,isEstimate,taxes,afterTaxes,beforeTaxes,amountPaid,fullyPaid,isPaidDate,bigData);
                }
              });
            }

           
          }
    },
    saveProcessedMultiplePayment: function(grpName1,buyername1,theBuyerID1,isEstimate1,taxes1,afterTaxes1,beforeTaxes1,amountPaid1,fullyPaid1,isPaidDate1,sbigData){
      var self = this;
      grpName1 = grpName1 == "" ? buyername1 + " group purchase" : grpName1;
          
          var objMaster = {
              productName: grpName1,  
              //buyer_name: buyername1,
              clientId: theBuyerID1,
              sellingPrice: beforeTaxes1,
              discount: 0,
              isEstimate: isEstimate1,
              taxes: taxes1,
              parentID: 0,
              isParent:true,
              afterTaxPrice: afterTaxes1,
              quantity: 1,
              totalPrice: beforeTaxes1,
              amountPaid:  amountPaid1,
              isPaid: fullyPaid1,
              datePaid: isPaidDate1,
              createdDate: moment($("#datePurchaseMultiple").val()).format(), //Date.parse($("#purchase-calendar-modal").val()),
              status:true
            };
            var deleted = "";
            /*if(self.currentMultipleSale != null){
              objMaster.id = self.currentMultipleSale;
            }*/

            var objSaveAll = {};
            objSaveAll.parent = objMaster;
            objSaveAll.children = sbigData;

            self.$app.preloader.show();
            $.when(self.$app.methods.postDataAPI("sales/SaveSalesList", objSaveAll, true)).then(function( dataid, textStatus, jqXHR ) {
              self.$app.preloader.hide();
              self.showToast("Product sale saved", "center", true);
              self.closePopUpMultiple();

            }).catch((err) => {
              self.$app.preloader.hide();
              self.showToast("An error occurred", "center");
            })

            /*$.when(self.$app.methods.postDataAPI("sales/SaveSalesMaster", objMaster, true)).then(function( dataid, textStatus, jqXHR ) {
              sbigData.forEach((element, index) => {
                    sbigData[index].parentID = dataid;
                    sbigData[index].clientId = theBuyerID1;
                    //deleted = res.id; 
                  });
                  var method = "";
                if(self.currentMultipleSale != null){
                  method = "SaveSalesListDeleteFirst";
                }else{
                  method = "SaveSalesList";  
                }
                //save all
                $.when(self.$app.methods.postDataAPI("sales/" + method, sbigData, true)).then(function( dataid, textStatus, jqXHR ) {
                  self.showToast("Product sale saved", "center", true);
                  self.closePopUpMultiple();
                }).catch(err => {
                // Transaction aborted. NOT WITHIN ZONE!
                //console.error (e);
                  self.showToast(err, "center");
                });
            }).catch(err => {
                // Transaction aborted. NOT WITHIN ZONE!
                //console.error (e);
                  self.showToast(err, "center");
            });*/

            //saving clean data
    },
    /*subtractStockMultiple: function(bigData){
      var self = this;
      var prods = bigData.filter(x => x.productID_saleID != "0");
      var prodsID = prods.map(x => x.productID_saleID);
      mogulsheetdb.find({
              selector: {
                _id: { $in: prodsID },
                productID: {$gt: 0},
                status: {$eq: 1}
              },
              sort: [{'_id': 'desc'}]
            }).then((arr) => {
              var ar = arr.docs;
              var saveBigData = [];
              $.each(ar, function(ind, dat){
                if(dat.stock != undefined && dat.stock != "undefined" && dat.stock != "Unlimited"){
                      var floatStock = parseFloat(dat.stock);
                      if(!isNaN(floatStock)){
                        var quantitySold = prods.find(x => x.productID_saleID == dat._id).quantity;
                        var remain = floatStock - quantitySold;
                        if(!isNaN(remain)){
                          dat.stock = remain;
                          saveBigData.push(dat);
                        }
                      }
                  }
              })
              if(saveBigData.length > 0){
                mogulsheetdb.bulkDocs(saveBigData);
              }
            })
    },*/
    AddNewProduct: function(select){
      var self = this;
      var name = select == null ? "" : select.productName;
      var cost = select == null ? "" : select.sellingPrice;
      var discount = select == null ? "0" : select.discount;
      var quantity = select == null ? 1 : select.quantity;
      var totalPrice = select == null ? "" : select.totalPrice;
        //var cost = select.cost == undefined ? 0 : select.cost; 
        var html = '<li class="eachSaleParentOther eachProduct margin-vertical"><div class="card myCard"><div class="card-content padding-horizontal padding-vertical">';
          html += '<div class="row"><div class="col-50"><div class="labelName">Name</div><input class="productName" type="text" placeholder="e.g delivery" value="';
          html +=  name + '"></div><div class="col-50"><div class="labelName">Amount</div><input class="productCost" type="text" placeholder="Amount" value="' + cost + '"></div></div>';
          html += '<div class="row margin-top-half"><div class="col-50"></div><div class="col-50"><a class="button button-small removeProduct margin-horizontal-half">Remove Charge</a></div></div>';
          html += '<input type="hidden" class="discount" value="' + discount + '"><input type="hidden" class="productQuantity" value="' + quantity + '"><input type="hidden" class="totalproductprice" value="'+ totalPrice + '">';
          html += "</div></div></li>"; //closing

        $("#productsOther-list .sortList").append(html);
        $(".eachSaleParentOther .removeProduct").off("click").on("click", function(){
                  //var id = $(this).attr("data-itemid");
                  $(this).parents(".eachSaleParentOther").eq(0).remove();
                  self.CalculateTotalProduct();
                })
            $(".eachSaleParentOther input").off("keyup").on("keyup", function(){
                self.CalculateTotalProduct();
            })
    },
    CalculateTotalProduct: function(){
      var self = this;
      var totalCost = 0;
      $(".eachProduct:visible").each(function(i, curr){
        var price = Number($(curr).find(".productCost").eq(0).val().trim());
        var quant = Number($(curr).find(".productQuantity").eq(0).val().trim());
        var discount = Number($(curr).find(".discount").eq(0).val().trim());
        var hiddenQuant = Number($(curr).find(".hiddenQuantity").eq(0).val());
        if(!isNaN(hiddenQuant)){
          if(quant > hiddenQuant){
            self.showToast("The quantity you entered is more than you have in stock", "center", false);
          }
        }
        //$(curr).find(".totalproductprice")
        if(!isNaN(price) && !isNaN(quant)){
            var total = price * quant;
            total = total - discount;
            totalCost += total;
            $(curr).find(".totalproductprice").eq(0).val(total.toFixed(2));
        }
      })
      
      var tax = Number($(".multipleSales").find(".taxpercent").eq(0).val());
      if(!isNaN(tax) || tax == 0){
        $(".totalAmountBeforeProfitProduct").text(totalCost.toFixed(2));
          var taxAmt = ((tax/100) * totalCost);
          var afterTax = totalCost + taxAmt;
          $(".totalAmountProduct").text(afterTax.toFixed(2));
      }else{
        $(".totalAmountBeforeProfitProduct").text(totalCost.toFixed(2));
      }
    },
    closePopUpMultiple:function(){
      var self = this;
      selectedUserID = null;
      selectedUserName = null;
        var popup = self.$app.popup.close('.multipleSales', true);
        popup.once("closed", function(){
          $(".multipleSales .sortList li").remove();
          $(".buyersNameMultiple").parents("li").eq(0).removeClass("bg-color-red");
          $(".totalAmountBeforeProfitProduct, .totalAmountProduct").text("0");
          $(".amountPaidMultiple, .buyersNameMultiple, .groupProductNameMultiple").val("");
          $("#datePaidMultiple").next("span").click();
          $("#datePurchaseMultiple").next("span").click();
          //$("#datePaidMultiple").val(moment().format('LLL'));
          //$("#datePurchaseMultiple").val(moment().format('LLL'));
          self.$app.autocomplete.destroy("#autocomplete-standalone-multiple2");
            self.$setState({
                selectedProducts:[]
              });
            self.getData();
        });
    },
    closeEditProdPopUp: function(){
      var self = this;
      $$("input.name,input.selling_price,.cost_price, .stock_quantity, .productCategory, .comparable_price, .low_stock_alert").val("");
      $(".isUnlimited, .showToPublic").prop("checked", true);
      var textEditor = self.$app.textEditor.get('.desc_of_product');
      textEditor.setValue("");
      self.$app.swiper.destroy('.swiper-container');
      $(".swiper-container").addClass("display-none");
      $(".productsWrapper, .swiper-pagination").empty();
      document.getElementById("productPhotos").value = "";
      document.getElementById("digitalAsset").value = "";
      $("#digitalAssetLink").text("");
      self.clearVariantCreator();
      var popup = self.$app.popup.close('.newProduct', true);
      popup.once("closed", function(){
            self.getData();
        });
    },
    closePopUp: function(){
        var self = this;
        var popup = self.$app.popup.close('.ProductIngredients', true);
        $(".extraCostRow, .eachCostParent").remove();
            //$(".profitpercent").val("0");
            $(".totalAmount,.totalAmountBeforeProfit").text("");
            $(".profitvalue").val("0");
            self.$app.autocomplete.destroy("#autocomplete-standalone-multiple");
            //self.CalculateTotal();
        popup.once("closed", function(){
            self.$setState({
                  productIngs:null
              });
            self.getData();
        });
    },
    verifyVariants: function(){
      var self = this;
      if($(".eachProductVariant").length > 0){
        var correct = true;
        $.each($(".eachProductVariant"), function(ind, val){

            $.each($(val).find("input:required"), function(ind2, val2){
              if($(val2).val() == ""){
                correct = false;
              }
            });
        });
        return correct;
      }
      return true;
    },
    saveData: function(){
      //var $$ = this.Dom7;
      var self = this;
      var elem = $$("input:required");
      var noErr = self.$app.input.validateInputs(".productForm");
      var hasVariant = false;
      if($(".eachProductVariant").length > 0){
        hasVariant = true;
        var variantCorrect = self.verifyVariants();
        if(!variantCorrect){
          self.$app.dialog.alert("Required information from variants are not filled", "Omni");
          return;
        }
      }
      
      if(noErr){
        var stock = $(".stock_quantity").val();
        var unlimited = $(".isUnlimited").is(":checked");
        var makePub = $(".showToPublic").is(":checked");
        if((stock == "" && !unlimited) || (stock != "" && unlimited)){
          self.$app.dialog.alert("Check stock as unlimited or enter stock quantity", "Omni");
          return;
        }
        var finalStock = stock != "" ? stock : "Unlimited";
        var textEditor = self.$app.textEditor.get('.desc_of_product');
        var desc = textEditor.value;
        var comparable_price = $("input.comparable_price").val();
        if(comparable_price == "" || comparable_price == 0){
          comparable_price = null;
        };

        var low_stock = $("input.low_stock_alert").val();
        if(low_stock == "" || low_stock == 0 || unlimited == true){
          low_stock = null;
        };

        //add stocking to dbRestocking
        var saveStock = {};
        
        var obj = {
                name: $(".nameProduct").val(),  
                description: desc,
                stock: finalStock,
                costPrice: $("input.cost_price").val(),
                sellingPrice: $$("input.selling_price").val(), 
                status:true,
                showToPublic: makePub,
                typeOfProduct: $("#productType").val(),
                productCategory: $(".productCategory").val(),
                HasVariant: hasVariant
              };

              if(low_stock != null){
                obj.LowStockAlert = low_stock;
              }
              if(comparable_price != null){
                obj.ComparablePrice = comparable_price;
              }

            if(self.currentProduct != null){
              obj.id = self.currentProduct.id;
              saveStock.lastStock = self.currentProduct.stock == undefined ? "Unlimited" : self.currentProduct.stock;
              saveStock.totalStock = finalStock;
              saveStock.productId = self.currentProduct.id;
              if(saveStock.lastStock != "Unlimited" && finalStock != "Unlimited"){
                var stockFloat = parseFloat(saveStock.lastStock);
                var finalFloat = parseFloat(finalStock);
                saveStock.newStock = finalFloat - stockFloat;
              }else{
                saveStock.newStock = finalStock;
              }
              /*if(self.currentProduct.product_link_id != undefined){
                obj.product_link_id = self.currentProduct.product_link_id;
              }*/
              
            }else{
              //new stock
              /*obj._id = moment().format("X");
              obj.productID = obj._id;*/
              saveStock.lastStock = 0;
              saveStock.newStock = finalStock;
              saveStock.totalStock = finalStock;
            }
            saveStock.restockDate = moment().format();
            
            //saveStock.created_date = moment().format("X");
            
            
            var bigSave = {};
            bigSave.product = obj;
            if((self.currentProduct == null) || (self.currentProduct.stock != finalStock)){
                    //save stock
                bigSave.restock = saveStock;
            }

            var form_data = new FormData();
              //add prod
              for ( var key in obj ) {
                  form_data.append(key, obj[key]);
              }
              //add restock
              for ( var key in saveStock ) {
                  form_data.append(key, saveStock[key]);
              }
              //add image
              var fileUpload = $("#productPhotos").get(0);
              var files = fileUpload.files;
              if(files.length > 0){
                // if there are multiple files , loop through each files
                //var id = self.currentExpense == null ? 0 : self.currentExpense.id;
                //form_data.append("id", id);
                for (var i = 0; i < files.length; i++) {
                  form_data.append("imagesUpload", files[i]);
                }
              }
            //console.log("product form_data", form_data);

            //check if it is digital and it is uploaded
            if($("#productType").val() == "digitalProduct"){
              if(self.currentProduct == null && $("#digitalAsset").get(0).files.length == 0){
                self.showToast("Please upload digital product", "center");
                return false;
              }

              if(self.currentProduct != null && self.currentProduct.assetLink == null && $("#digitalAsset").get(0).files.length == 0){
                self.showToast("Please upload digital product", "center");
                return false;
              }

              //add asset 
              var fileAssetUpload = $("#digitalAsset").get(0);
              var assetfiles = fileAssetUpload.files;
              if(assetfiles.length > 0){
                // if there are multiple files , loop through each files
                //var id = self.currentExpense == null ? 0 : self.currentExpense.id;
                //form_data.append("id", id);
                for (var i = 0; i < assetfiles.length; i++) {
                  form_data.append("assetUpload", assetfiles[i]);
                }
              }
            }
            

            self.$app.preloader.show();
            $.when(self.$app.methods.postFormDataAPI("products/SaveProdForm", form_data, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data != null){
                    //self.$app.dialog.alert("Item saved.");
                    if($(".eachProductVariant").length > 0){
                      //save variants
                      self.saveVariants(data);
                    }else{
                      self.showToast("Product saved.", "center", true);
                      self.resetSaveProductFields();
                    }
                    
                  
                } 
              }).catch((data, textStatus, jqXHR) => {
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
          }
    },
    saveVariants: function(parent){
      var self = this;
      var totalObjs = [];
      $.each($(".eachProductVariant"), function(ind, val){
        var obj = Object.assign({}, parent);
        obj.id = parseInt($(val).find(".variantProductID").val());
        obj.parentId = parent.id;
        obj.costPrice = $(val).find(".variantCostPrice").val();
        obj.sellingPrice = $(val).find(".variantSellingPrice").val();
        obj.comparablePrice = $(val).find(".variantComparablePrice").val();
        obj.stock = $(val).find(".stockUnlimited").is(":checked") ? "Unlimited" : $(val).find(".variantInStock").val();
        obj.showToPublic = $(val).find(".showVariantToPublic").is(":checked");
        obj.variantAttributes = [];
        obj.hasVariant = false;
        //find attr
        if(obj.id == 0){
          //only add atrributes for newly created
            $.each($(val).find(".variantAttributeKey"), function(ind2, attr){
              var attribute = {};
              attribute.attribute = $(attr).text();
              attribute.value = $(val).find(".variantAttributeValue").eq(ind2).text();
              attribute.productId = parent.id;
              attribute.businessId = obj.businessId;
              obj.variantAttributes.push(attribute);
          });
        }
        
        //push variant into array
        totalObjs.push(obj);
      })
      if(totalObjs.length > 0){
        self.$app.preloader.show();
        $.when(self.$app.methods.postDataAPI("products/SaveProdVariants", totalObjs, true)).then(function( data, textStatus, jqXHR ) {
          //alert("saved");
          self.$app.preloader.hide();
          self.showToast("Product saved.", "center", true);
          self.resetSaveProductFields();
        }).catch((data, textStatus, jqXHR) => {
                //console.log("stock error", data);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
      }
    },
    resetSaveProductFields: function(){
      var self = this;
      $("input.nameProduct,input.selling_price,.cost_price, .stock_quantity, .productCategory, .comparable_price, .low_stock_alert").val("");
                    $(".isUnlimited, .showToPublic").prop("checked", true);
                    $("#digitalAssetLink").text("");
                    var textEditor = self.$app.textEditor.get('.desc_of_product');
                    textEditor.setValue("");
                    self.$app.swiper.destroy('.swiper-container');
                    $(".swiper-container").addClass("display-none");
                    $(".productsWrapper, .swiper-pagination").empty();
                    document.getElementById("productPhotos").value = "";
                    document.getElementById("digitalAsset").value = "";
                    self.clearVariantCreator();
                    self.$setState({
                      currentProduct:null
                  });
    },
    saveStockAfterProd: function(obj){
      var self = this;
      $.when(self.$app.methods.postDataAPI("products/SaveProdStock", obj, true)).then(function( data, textStatus, jqXHR ) {
                if(data){
                      //self.$app.dialog.alert("Item saved.");
                      //self.showToast("Client saved.", "center", true);
                      //$(".clientname,.email,.address,.phone,.otherNotes, #client_bday").val("");
                      //self.getData();
                }
              }).catch((data, textStatus, jqXHR) => {
                console.log("stock error", data);
                //self.$app.preloader.hide();
                //self.$app.methods.showToast("An error occurred", "center");
            })
    },
    checkFilesPhoto: function(e) {  
      var self = this;
      var maxLimit = 5;  
      var id = e.target.id;

      let list = new DataTransfer;
      var cut = 0;
      var pres = 0;
      //$(".expenseWrapper").empty(); 
      for(var i = 0; i < $('#' + id)[0].files.length; i++){
          var files = $('#' + id)[0].files[i];
          var size = files.size / 1024 / 1024;
          if((size <= 2) && (i < maxLimit)){
            //self.setupReader(files);
           /* var reader = new FileReader();
            reader.onload = function(){
              var html = "<div class='swiper-slide'>";
              html += "<div class='holderSwiper'><img class='images' src='" + reader.result + "'></div>";
              html += "<div><p><a class='button bg-color-red text-color-white deleteImage'>Delete Image</a></p></div></div>";
              $(".expenseWrapper").append(html); 
            };
            reader.readAsDataURL(files);*/
              //list.items.add(files);
          }else{
              cut++;
          }
      }  
      //document.getElementById(id).files = list.files; 
      var tense = cut == 1 ? " file was " : " files were "
      if(cut > 0) alert(cut + tense + "removed because it's too large or you went above file limits");   
  },
    reInitSwiper: function(){
      var self = this;
      self.$app.swiper.destroy('.swiper-container');
      var swiper = self.$app.swiper.create('.swiper-container', {
        //data-pagination='{"el": ".swiper-pagination"}' data-space-between="10" data-slides-per-view="auto" data-centered-slides="true" 
          speed: 400,
          spaceBetween: 10,
          centeredSlides: true,
          pagination: {"el": ".swiper-pagination"}
      });
      $(".swiper-container").removeClass("display-none");
    },
    resetSalePopUp: function(){
      var self = this;
      self.$setState({
          currentProduct: null
      });
      $("#paid-calendar-modal-prods").next("span").click();
      $("#purchase-calendar-modal").next("span").click();
      $(".discount_sell").val(0);
      $$("input.buyer_sell, input.amountpaid_sell, #purchase-calendar-modal, #paid-calendar-modal-prods, .quantity_sell, .total_sell").val("");
      var popup = self.$app.popup.close('.sellProduct', true);
      selectedUserName = null;
      selectedUserID = null;
    },
    saveDataSell: function(){
      //var $$ = this.Dom7;
      var self = this;
      var checked = 0;
      //var toggle = self.$app.toggle.get(".paid_sell");
      var isPaidDate = null;
      /*if(toggle != undefined){
        checked = toggle.checked == true ? 1 : 0;
      }*/
      var isEstimate = $(".isEstimate").prop("checked");
      if($("#purchase-calendar-modal").val().trim() == ""){
        self.showToast("Please pick date of purchase", "center", false);
        return;
      }
      if($(".name_sell").val().trim() == ""){
        self.showToast("Please enter product name", "center", false);
        return;
      }
      if($(".cost_sell").val().trim() == ""){
        self.showToast("Please enter selling price", "center", false);
        return;
      }
      if($(".buyer_sell").val().trim() == ""){
        self.showToast("Please enter buyer's name", "center", false);
        return;
      }
      if(($("#paid-calendar-modal-prods").val().trim() == "") && ($$("input.amountpaid_sell").val() != "0" && $$("input.amountpaid_sell").val().trim() != "")){
          self.showToast("Please choose date buyer paid!", "center", false);
          return;
      }
      if(($$("input.amountpaid_sell").val() == "0" || $$("input.amountpaid_sell").val().trim() == "") && isEstimate == false){
          self.$app.dialog.confirm("Do you want to record the purchase without a payment made?", "Omni", function(){
            $$("input.amountpaid_sell").val(0);  
            self.processPayment();
          })
      }else{
        self.processPayment();
      }
    },
    processPayment: function(){
      var self = this;
      var cp = $$("input.afterTax").val();
      var sp = $$("input.amountpaid_sell").val();
      var fullyPaid = false;
      var isPaidDate = null;
      if(Number(sp) >= Number(cp)){
        fullyPaid = true;
      }else{
        fullyPaid = false;
      }
      isPaidDate = moment($("#paid-calendar-modal-prods").val()).format();//  Date.parse($("#paid-calendar-modal").val());
      var isEstimate = $(".isEstimate").prop("checked"); 
      var chosenUser = $("input.buyer_sell").val();
      var theBuyerID = "";
      var theBuyerName = "";
      
      if(chosenUser == selectedUserName){
        theBuyerID = selectedUserID;
        theBuyerName = selectedUserName;
        self.saveProcessedPayement(theBuyerName, theBuyerID, isEstimate, fullyPaid, isPaidDate);
      }else{
        var obj = {
                name: chosenUser
            }
            $.when(self.$app.methods.postDataAPI("clients/SaveClient", obj, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data != null){
                  self.showToast("New User Created.", "center", true);
                    self.saveProcessedPayement(chosenUser, data, isEstimate, fullyPaid, isPaidDate);
                }
            });
        }
      
    },
    saveProcessedPayement: function(theBuyerName, theBuyerID, isEstimate, fullyPaid, isPaidDate){
      var self = this;
      var productId = 0;
      
      var quantitySold = $("input.quantity_sell").val();
      var obj = {
                productName: $$("input.name_sell").val(),  
                //buyer_name: theBuyerName,
                clientId: theBuyerID,
                sellingPrice: $$("input.cost_sell").val(),
                taxes: $$("input.taxes").val(),
                parentId: 0,
                isParent:false,
                isEstimate: isEstimate,
                discount: $(".discount_sell").val(),
                afterTaxPrice: $$("input.afterTax").val(),
                quantity: quantitySold,
                totalPrice: $$("input.total_sell").val(),
                amountPaid:  $$("input.amountpaid_sell").val(),
                isPaid: fullyPaid,
                datePaid: isPaidDate,
                createdDate: moment($("#purchase-calendar-modal").val()).format(), //Date.parse($("#purchase-calendar-modal").val()),
                status:true,
              };
              if($("input.name_sell").val() == self.currentProduct.name){
                obj.productId = self.currentProduct.id;
              }

              self.$app.preloader.show();
              //console.log("sale", obj);
            $.when(self.$app.methods.postDataAPI("sales/SaveSales", obj, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data != null){
                  self.showToast("Product sale saved!","center", true);
                  $("#paid-calendar-modal-prods").next("span").click();
                  $("#purchase-calendar-modal").next("span").click();
                  $$("input.buyer_sell, input.amountpaid_sell, #purchase-calendar-modal, #paid-calendar-modal-prods, .quantity_sell, .total_sell, .discount_sell").val("");
                  $(".isEstimate").prop("checked", false);
                  selectedUserName = null;
                  selectedUserID = null;
                  var popup = self.$app.popup.close('.sellProduct', true);
                  popup.once("closed", function(){
                      self.getData();
                  });
                }
              }).catch((data, textStatus, jqXHR) => {
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
    },
    formatMoney:function(val){  
      var self = this;   
      var ret = self.$app.methods.formatMoney(val);
      return ret;
    },
    getData: function(){
      var self = this;
      if(self.$app.data.settings != null){
        self.getDataFetch();
        return;
      }

      $.when(self.$app.methods.getDataAPI("business/GetBusinessProfile")).then(function(data){
          if(data != null){
            self.$app.methods.refetchSettings(data);
          }

          self.getDataFetch();
      }).catch(function(err){
        self.getDataFetch();
      });
      
    },
    getDataFetch: function(){
      var self = this;
      var checked = true;
      /*var toggle = self.$app.toggle.get(".showInactive");
      console.log("toggle prods", toggle);
      if(toggle != undefined){
        checked = toggle.checked == true ? 0 : 1;
      }*/
      self.$app.preloader.show();
      $.when(self.$app.methods.getDataAPI("products/GetProducts")).then(function( arr, textStatus, jqXHR ) {
          self.$app.preloader.hide();
          self.$setState({
                products: arr,
                totalMat:arr.length
              }, function(){
                $("#product-list .list").empty();
                $("#product-list .pagination, .viewRestockHistoryParent, .productActions").remove();
                //$(".sellMultiple, .sellMultParent").remove();
                //var desktop = true;
                      if(arr != null && arr.length > 0){
                        var pagination = "<ul class='pagination padding-left-half margin-vertical-half'><ul>";
                        $(pagination).insertAfter($("#product-list .list"));
                        
                        var mult = "<div class='row productActions justify-content-start'><a class='button sellMultiple margin-right-half button-round'>Sell Multiple Products</a>";
                        mult += "<a class='button viewRestockHistory button-round margin-right-half'>Restock History</a></div>";
                          //
                        var isDesktop = self.$app.methods.isDesktop();
                        //console.log("Product Screen", isDesktop);
                        if(isDesktop){
                          //$("#product-list .data-table").show();
                          //$(mult).insertBefore($("#product-list table"));
                          $(".sellingButtonsTab").append(mult);
                        }else{
                         // $("#product-list .data-table").hide();
                          //$(mult).insertBefore($("#product-list ul.list"));
                          $(".sellingButtonsTab").append(mult);
                        }
                        
                        $(".sellMultiple").off("click").on("click", function(){
                          self.openPopUpMultiple();
                        })
                        $(".viewRestockHistory").off("click").on("click", function(){
                          self.openPopUpRestockHistory();
                        })

                        
                        if(isDesktop){
                          $("#product-list ul.list").remove();

                          for(var i = 0; i < arr.length; i++){
                            var row = arr[i];
                            var prodname = row.name;
                            if(row.parentId == null && row.hasVariant == true){
                              prodname = "<b>" + prodname + "</b>";
                            }
                              var html = "<tr>";
                                html += '<td class="id" style="display:none;">' + row.id + '</td>';
                                html += "<td class='name'>" + prodname + "</td>";
                                //html += "<td>" + (row.description != undefined && row.description != "" ? row.description : "--")+ "</td>";
                                html += "<td class='cost'>" + self.formatMoney(row.sellingPrice) + "</td>";
                                var stock = "Unlimited";
                                var stockCount = 9999999;
                                if(row.stock != undefined){
                                  stock = row.stock;
                                  stockCount = parseFloat(row.stock);
                                }
                                html += "<td class='in-stock'>" + stock + "</td>";
                                html += "<td class='publicViews'>" + row.views + "</td>";
                                
                                var pops = '<a href="#" data-popover=".products-popover-' + i + '" class="popover-open"><i class="f7-icons">ellipsis_vertical</i></a>'
                                pops += '<div class="popover my-popover products-popover products-popover-' + i + '" data-close-on-escape="true" data-backdrop="false">'; 
                                pops += '<div class="popover-angle"></div><div class="popover-inner padding-half">';
                                
                                  //var page_link = row.product_link_id == undefined ? null : row.product_link_id;

                                  pops += '<a class="button popover-close sellProduct" data-id="' + row.id + '">Sell</a>';
                                  if(row.parentId == null) pops += '<a class="button popover-close editProduct" data-id="' + row.id + '">Edit</a>';
                                  pops += '<a class="button popover-close restockProduct" data-id="' + row.id + '">Restock</a>';
                                  if(row.parentId == null) pops += '<a class="button popover-close addIngredients" data-id="' + row.id + '">Raw Materials</a>';
                                  pops += '<a class="button popover-close linkProduct" data-busid="' + row.businessId + '" data-id="' + row.slug + '">Share Link</a>';
                                  pops += '<a class="button popover-close deleteProduct" data-id="' + row.id + '">';
                                  pops += row.status == true ? 'Delete' : 'Activate';
                                  pops += '</a>';
                                  /*if(row.status == false){
                                    pops += '<a class="button popover-close permDelButton" data-id="' + row.id + '">Delete</a>';
                                  }*/

                                pops += '</div></div>';
                                html += "<td>" + pops + "</td>";
                              html += "</tr>";
                              $("#product-list tbody.list").append(html);
                          }
                        }else{
                          $("#product-list .data-table").remove();
                          $(".sortTextPar").removeClass("display-none");
                          $("#product-list").find(".sortText").removeClass("display-none");
                          $("#product-list").find(".sort").not("th").remove();
                          var sorter = '<span class="sort" data-sort="name">Name</span><span class="sort" data-sort="cost">Cost</span><span class="sort" data-sort="in-stock">In Stock</span>';
                          $(sorter).insertAfter($("#product-list").find(".sortText"));

                        for(var i = 0; i < arr.length; i++){
                            var row = arr[i];
                            var prodname = row.name;
                            if(row.parentId == null && row.hasVariant == true){
                              prodname = "<b>" + prodname + "</b>";
                            }
                            var html = '<li><div class="card myCard"><div class="card-content padding-horizontal-half">';
                            html += '<div class="name cardName">' + prodname + '</div><div class="id display-none">' + row.id + '</div><div class="cost display-none">' + row.selling_price + '</div>';
                            /*if(row.description != null && row.description != ""){
                              html += '<div class=""><span>Description: </span><span class="">' + row.description + '</span></div>';
                            }*/
                            html += '<div class=""><span>Selling Price: </span><span class="valueName">' + self.formatMoney(row.sellingPrice) + '</span></div>';
                            var stat = row.status == true ? "display-none" : "";
                            var stock = "Unlimited";
                            var stockCount = 9999999;
                            if(row.stock != undefined){
                              stock = row.stock;
                              stockCount = parseFloat(row.stock);
                            }
                            html += '<div class="in-stock display-none">' + stockCount + '</div>';
                            html += '<div class=""><span>In Stock: </span><span class="">' + stock + '</span></div>';
                            html += '<div class=""><span>Public views: </span><span class="">' + row.views + '</span></div>';
                            html += '<div class="' + stat + '"><span>Status: </span><span class="valueName">Deleted</span></div>';
                            html += '</div><div class="card-footerMine padding-horizontal-half padding-bottom-half"><p class="display-inline-flex no-margin-vertical">';
                            //var page_link = row.product_link_id == undefined ? null : row.product_link_id;
                            html += '<a class="button button-small sellProduct" data-id="' + row.id + '">Sell</a>';
                            if(row.parentId == null) html += '<a class="button button-small editProduct" data-id="' + row.id + '">Edit</a>';
                            html += '<a class="button button-small restockProduct" data-id="' + row.id + '">Restock</a>';
                            if(row.parentId == null) html += '<a class="button button-small addIngredients" data-id="' + row.id + '">Raw Materials</a>';
                            html += '<a class="button button-small linkProduct" data-busid="' + row.businessId + '" data-id="' + row.slug + '">Share Link</a>';
                            html += '<a class="button button-small deleteProduct" data-id="' + row.id + '">';
                            html +=  row.status == true ? 'Delete' : 'Activate';
                            html += '</a>';
                            /*if(row.status == false){
                              html += '<a class="button button-small permDelButton" data-id="' + row.id + '">Delete</a>';
                            }*/
                            html += '</p></div></div></li>';
                            $("#product-list ul.list").append(html);
                            //return html;
                        }
                      }
                        var options = {
                            valueNames: ['id','cost','name', 'in-stock'],
                            page: 10,
                            pagination: [{outerWindow:2}]
                        };

                        //var productList = new List('product-list', options);

                        $(".sort").off("click").on("click", function(){
                          $(".sort").find(".asc").remove();
                          $(".sort").find(".desc").remove();
                            if($(this).hasClass("asc")){
                              $(this).append("<i class='icon f7-icons asc text-color-red'>arrowtriangle_up_fill</i>");
                            }
                            if($(this).hasClass("desc")){
                              $(this).append("<i class='icon f7-icons desc text-color-red'>arrowtriangle_down_fill</i>");
                            }
                        })
                      
                          $('#product-list, .products-popover').off("click").on('click','.button', function () {
                              var data = $(this).attr("data-id");
                              if($(this).hasClass("sellProduct")){
                                self.openPopUpSellProduct(data);
                              }
                              if($(this).hasClass("restockProduct")){
                                self.openRestockProduct(data); //done
                              }
                              if($(this).hasClass("editProduct")){
                                self.openPopUp(data); //done
                              }
                              if($(this).hasClass("addIngredients")){
                                self.openPopUpIngredients(data);
                              }
                              if($(this).hasClass("deleteProduct")){
                                self.DeleteItem(productList, data); //done
                              }
                              if($(this).hasClass("permDelButton")){
                                self.permDeleteItem(productList, data);
                              }
                              if($(this).hasClass("linkProduct")){
                                var bid = $(this).attr("data-busid");
                                self.shareableLink(bid, data);
                              }
                              
                              //return false;
                          });

                          productList = new List('product-list', options);

                        }else{
                          $(".sortTextPar").addClass("display-none");
                        }
                });
          }).catch(function(err){
            self.$app.preloader.hide();
          });
    },
    shareableLink: function(bid, prodID){
      var self = this;
      //console.log(self.$app.data.settings);
      var share = self.$app.data.siteUrl + "shop/" + self.$app.data.settings.businessUrl + "/" + prodID;
      copy(share);
      self.$app.dialog.alert("Link copied to clipboard", "Omni");
      /*
      if(link == null || link == "null"){
        self.openPopUpLink(prodID);
      }else{
        var dat = {};
        dat.link = link;
        dat.id = prodID;
        self.$setState({
          lastLink:dat
        }, function(){
          myActionSheet.open();
        })
      }
      */
    },
    getDataIngredients: function(idOfProd){
      var self = this;
      var checked = true;
      self.$app.preloader.show();
      $.when(self.$app.methods.getDataAPI("ingredients/GetAllIngredients?status=" + checked)).then(function( data, textStatus, jqXHR ) {
        self.$app.preloader.hide(); 
        self.$setState({
                ings: data,
                totalMatIngredients:data.length,
                productIngs:[],
                productToEdit: self.products.find(x => x.id == idOfProd).name,
                productToEditID: self.products.find(x => x.id == idOfProd).id
              });
      }).catch((err) => {
        self.$app.preloader.hide(); 
      })
    },
    uploadFileBatches: function(){
      var self = this;
      var dataLength = dataToUpload.length;
      var smallUpload = null;
      if(dataLength > uploaded){
        var pick = dataLength - uploaded;
        var picking = pick >= eachBatch ? eachBatch : pick;
        smallUpload = dataToUpload.slice(uploaded, picking + uploaded); 
        //upload small amount

        self.$app.preloader.show();
          $.when(self.$app.methods.postDataAPI("products/SaveProdList", smallUpload, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                //console.log("when data ings save ", data); // JSON data parsed by `data.json()` call
                if(data == true){
                  uploaded += picking;
                  setTimeout(self.uploadFileBatches(), 1000);
                }
                
            })
          .catch((err) => {
            self.$app.preloader.hide();
            self.showToast("error occured during saving", "center");
          })
      }else{
        self.$app.preloader.hide();
        self.showToast(uploaded + " records were saved", "center", true);
        dataToUpload = null;
        uploaded = 0;
        return;
      } 
    },
    productPicker: async function(){
      var self = this;
      try{
        const file = await chooser.getFile();
        var url = file.dataURI;
        fetch(url)
          .then((response) => {
              return response.blob();
            })
            .then((result) => {
              selectedFile = result;
              self.uploadFile();
            })
      }catch(err){
        alert(err);
      }
      
    },
    uploadFile: function(){
      var self = this;
      $(".errorContent").html("");
      if (selectedFile) {
        try{
        self.$app.preloader.show();
          var fileReader = new FileReader();
          fileReader.onload = function(event) {
            var data = event.target.result;

            var workbook = XLSX.read(data, {
              type: "binary"
            });

            var sheet = workbook.SheetNames[0];
            var toSave = [];
            var rejected = [];
            var totalLength = 0;
            var errors = "";
            var rowObject = XLSX.utils.sheet_to_row_object_array(
                workbook.Sheets[sheet]
              );
              totalLength = rowObject.length;
              $.each(rowObject, function(ind, val){
                var obj = {};
                if(val.name != undefined && val.name.trim() != ""){
                  obj.name = val.name;

                  if(val.description != undefined){
                    obj.description = val.description;
                  }else{
                    obj.description = "";
                  }

                  if(val.cost_price != undefined){
                    obj.costPrice = val.cost_price;
                  }else{
                    obj.costPrice = "";
                  }

                  if(val.product_category != undefined){
                    obj.productCategory = val.product_category;
                  }

                  //show_to_public
                  if(val.show_to_public != undefined){
                    obj.showToPublic = val.show_to_public == 1 ? true : false;
                  }else{
                    obj.showToPublic = true;
                  }

                  if(val.selling_price != undefined){
                    obj.sellingPrice = val.selling_price;
                  }else{
                    obj.sellingPrice = 0;
                  }

                  if(val.stock != undefined){
                    obj.stock = val.stock;
                  }

                  obj.status = true;
                  //obj.created_date = moment().format("X");
                  toSave.push(obj);
                }else{
                  rejected.push(val);
                  errors += JSON.stringify(val) + "<br>";
                }
                
              })

              if(toSave.length > 0){
                dataToUpload = toSave;
                self.uploadFileBatches();

                }else if(toSave.length == totalLength){
                  self.showToast("No record was saved", "center");
                }

                if(rejected.length > 0){
                  var html = rejected.length + " rows were not saved. <br> Please ensure product name is not blank and the header of the product names column is called <b>name</b>. <br> Please delete the rows that were saved from your excel file to prevent duplicate records.<br>";
                  html += "Unsaved rows are: <br>" + errors;
                  $(".errorContent").html(html);
                }else if(rejected.length == totalLength){
                  self.showToast("No error was found", "center");
                }
              self.$app.preloader.hide();
              self.resetUploader();
          };
          fileReader.readAsBinaryString(selectedFile);
        }catch(err){
          self.showToast("error occured during saving", "center");
          self.$app.preloader.hide();
        }
      }
    },
    resetUploader: function(){
      var self = this;
        selectedFile = null;
        //$(".errorContent").html("");
        document.getElementById("fileUploadProducts").value = "";
    },
    AddNewCost: function(e){
      var self = this;

        var html = '<li class="extraCostRow"><div class="card myCard"><div class="card-content padding-horizontal-half"><div class="row">';
        html += '<div class="col-50"><div class="labelName">Name</div><input class="extraName" type="text" placeholder="e.g transport fare" value="';
        html +=  '' + '"></div>';
        html += '<input type="hidden" class="productID" value="0">';
        html += '<div class="col-50"><span class="labelName">Cost</span><input class="eachCost" type="text" placeholder="Enter Cost" value="';
        html += '' + '"></div>';
        html += '</div>';
        html += '<div class="row margin-top-half"><div class="col-50"></div><div class="col-50">';
          html += '<a class="button button-small removeRow">Remove Charge</a>';
        html += '</div></div></div>';
        html += '</li>';
        $("#prodOtherIng-list .sortList").append(html);
      
      $(".removeRow").on("click", function(e){
          $(this).parents("li").eq(0).remove();
          self.CalculateTotal();
      })
      $(".extraCostRow").find(".eachCost").on("keyup", function(e){
          self.CalculateTotal();
          //$(".calculateTotalButton").eq(0).click();
      })
    },
    startPouch: function(){
          var self = this;
          
          self.getData();
          //self.getClients();
          try{
            if(chooser != undefined){
              $("#fileUploadProducts").addClass("display-none");
            }
          }catch(err){
            $(".filePicker").addClass("display-none");
          }        
        },
    SaveTotal: function(){
      var self = this;
      var allCost = [];
      var allExtraCost = [];
      var passed = true;
      if($(".extraCostRow").length == 0 && $(".eachCostParent").length == 0){
          self.$app.dialog.alert("Please choose raw materials to save!", "Omni");
          return false;
      }
      $(".eachCostParent").each(function(index,item){
          var cost = $(item).find(".eachCost").eq(0).text();
          var val = $(item).find(".costvalue").eq(0).val();
          var ingID = $(item).find(".removeCost").eq(0).attr("data-id");
          if((cost == "" || cost == "0") || (val == "")){
              self.$app.dialog.alert("Please fill all fields or remove unused selected raw materials", "Omni");
              passed = false;
              return false;
          }else{
            var obj = {};
            obj.ingredientId = ingID;
            obj.unitSize = Number(val);
            obj.cost = Number(cost);
            obj.status = true;
            obj.createdDate = moment().format();
            obj.productId = self.productToEditID;
            allCost.push(obj);
          }
      })

      if(passed){
          $(".extraCostRow").each(function(index,item){
              var extraname = $(item).find(".extraName").val().trim();
              var extracost = $(item).find(".eachCost").val().trim();
              if(extraname == "" || extracost == ""){
                  self.$app.dialog.alert("Please fill all fields or remove unused for custom charges", "Omni");
                  passed = false;
                  return false;
              }else{
                var obj = {};
                obj.productId = self.productToEditID;
                obj.name = extraname;
                obj.cost = Number(extracost);
                obj.status = true;
                obj.createdDate = moment().format();
                allExtraCost.push(obj);
              }
          })
      }
          if(passed){
                var obj = {};
                obj.productId = self.productToEditID;
                obj.name = "***Profit***";
                obj.cost = Number($(".profitvalue").val());
                obj.status = true;
                obj.createdDate = moment().format();
                allExtraCost.push(obj);
          }
          //record in db
          if(passed){
                var total1 = Number($(".totalAmountBeforeProfit").text());
                var total2 = Number($(".totalAmount").text());
                //save all data
                var finalObj = {};
                finalObj.ings = allCost;
                finalObj.ingsOthers = allExtraCost;
                finalObj.costPrice = total1;
                finalObj.sellingPrice = total2;
                finalObj.productId = self.productToEditID;
                self.$app.preloader.show();
                $.when(self.$app.methods.postDataAPI("products/SaveAllProductIngredients", finalObj, true)).then(function( data, textStatus, jqXHR ) {
                    self.$app.preloader.hide();
                      //console.log("when data ings save ", data); // JSON data parsed by `data.json()` call
                      if(data == true){
                        self.showToast("Saved successfully", "center", true);
                      }
                      
                  })
                .catch((err) => {
                  self.$app.preloader.hide();
                  self.showToast("error occured during saving", "center");
                });
                         
          }
                
          
      }

  },
  on: {
    pageAfterIn: function(e, page) {
        var self = this;
        self.getClients();
        //trackProductsPage();
      },
      pageInit: function(e, page) {
        var self = this;
        registerUpload();

        $("#productType").on("change", function(){
          $("#digitalAssetHolder").addClass("display-none");
          if($("#productType").val() == "digitalProduct"){
            $("#digitalAssetHolder").removeClass("display-none");
          }
        })

        self.createActionSheet();
        var iconTooltip = self.$app.tooltip.create({
          targetEl: '.estimateExplain',
          text: '<b>Check if this is just an estimate,</b><br><b>no purchase is being made yet.</b>',
        });
        var autocompleteDropdownBuyer = self.$app.autocomplete.create({
          inputEl: '#buyer_sell',//buyersNameMultiple
          openIn: 'dropdown',
          preloader: true,
          valueProperty: 'id', //object's "value" property name
          textProperty: 'name', //object's "text" property name
          source: function (query, render) {
            var results = self.clients.filter(x => x.status == true); //come back later
            var newResult = [];
            // Find matched items
            for (var i = 0; i < self.clients.length; i++) {
              if (results[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0) newResult.push(results[i]);
            }
            // Render items by passing array with result items
            render(newResult);
          },
          on: {
                change: function (value) {
                  if(value.length > 0){
                  value = value[0];
                  $("#buyer_sell").val(value.name);
                  selectedUserName = value.name;
                  selectedUserID = value.id;
                  }
                }
              }
        });
        var autocompleteDropdownMultipleBuyer = self.$app.autocomplete.create({
          inputEl: '#buyersNameMultiple',//buyersNameMultiple
          openIn: 'dropdown',
          valueProperty: 'id', //object's "value" property name
          textProperty: 'name', //object's "text" property name
          source: function (query, render) {
            var results = self.clients.filter(x => x.status == 1); //come back later
            var newResult = [];
            // Find matched items
            for (var i = 0; i < self.clients.length; i++) {
              if (results[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0) newResult.push(results[i]);
            }
            // Render items by passing array with result items
            render(newResult);
          },
          on: {
                change: function (value) {
                  if(value.length > 0){
                  value = value[0];
                  $("#buyersNameMultiple").val(value.name);
                  selectedUserName = value.name;
                  selectedUserID = value.id;
                  }
                }
              }
        });
        var autocompleteDropdownProductCategory = self.$app.autocomplete.create({
          inputEl: '.productCategory',//buyersNameMultiple
          openIn: 'dropdown',
         // preloader: true,
          expandInput: true,
          source: function (query, render) {
            var results = self.products.filter(x => x.productCategory != null).map(x => x.productCategory); //come back later
            results = [...new Set(results)];
            var newResult = [];
            // Find matched items
            for (var i = 0; i < results.length; i++) {
              if (results[i].toLowerCase().indexOf(query.toLowerCase()) >= 0) newResult.push(results[i]);
            }
            // Render items by passing array with result items
            render(newResult);
          },
          on: {
                change: function (value) {
                  if(value.length > 0){
                  value = value[0];
                  $(".productCategory").val(value);
                  }
                }
              }
        });
        var calendar1 = self.$app.calendar.create({
                  inputEl: '#datePaidMultiple',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });

              var calendar2 = self.$app.calendar.create({
                  inputEl: '#datePurchaseMultiple',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });
        var calendar = self.$app.calendar.create({
                  inputEl: '#paid-calendar-modal-prods',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });

              var calendarPurchase = self.$app.calendar.create({
                  inputEl: '#purchase-calendar-modal',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: 'YYYY-MM-DD HH:MM'
                  //dateFormat: { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' }
              });

              var calendarRestock = self.$app.calendar.create({
                  inputEl: '#restock-calendar-modal',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: 'YYYY-MM-DD HH:MM'
                  //dateFormat: { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' }
              });

              var textEditorCustomButtons = self.$app.textEditor.create({
                  el: '.desc_of_product',
                  buttons: [["bold", "italic", "underline", 'h1', 'h2', 'h3', 'orderedList', 'unorderedList']],
                  on: {
                    buttonClick: function (editor, button) {
                        var act = $('button[data-button="' + button + '"]').hasClass("active");
                        if(act){
                          $('button[data-button="' + button + '"]').removeClass("active");
                        }else{
                          $('button[data-button="' + button + '"]').addClass("active");
                        }
                      }
                    }
                });

                var textEditorCustomButtonsLink = self.$app.textEditor.create({
                  el: '.desc_of_productLink',
                  buttons: [["bold", "italic", "underline", 'h1', 'h2', 'h3', 'orderedList', 'unorderedList']],
                  on: {
                    buttonClick: function (editor, button) {
                        var act = $('button[data-button="' + button + '"]').hasClass("active");
                        if(act){
                          $('button[data-button="' + button + '"]').removeClass("active");
                        }else{
                          $('button[data-button="' + button + '"]').addClass("active");
                        }
                      }
                    }
                });
        $$(".showInactive").on("change", function(){
            self.getData();
        })
        self.startPouch();
      }
  }

} 

var selectedFile = null;
function registerUpload(){
  //document.getElementById("fileUploadProducts").addEventListener("change", handleFile);
  document
      .getElementById("fileUploadProducts")
      .addEventListener("change", function(event) {
        selectedFile = event.target.files[0];
      });

      $(document).on('click', 'a.page', function() {
        $(".page-current .page-content").eq(0).animate({scrollTop:0 }, "fast");
      });
}


function trackProductsPage(){
  try{
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
    'event': 'Pageview',
    'pagePath': 'https://www.mogulsheet.com/products',
    'pageTitle': 'Products' //some arbitrary name for the page/state
    });
  }catch(err){

  }
}
</script>