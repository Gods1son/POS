<template>
<div class="page" data-name="sales">
  <div class="navbar">
    <div class="navbar navbar-bg"></div>
    <div class="navbar-inner sliding">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title">Sales</div>
    </div>
  </div>

      <!--fab-->
    <!--<div class="fab fab-extended fab-right-bottom">
      <a href="#" @click="openPopUp(null)">
        <i class="icon f7-icons">plus</i>
        
        <div class="fab-text">Raw Material</div>
      </a>
    </div>-->
    <!--fab-->

  <div class="page-content">
    
    <div class="item-content block-title margin-bottom-half margin-top-half">
        <div class="row padding-vertical">
            <div class="col">
                
            </div>
            <div class="col">
                    <span class="item-after float-right margin-left-half">
                        <label class="toggle toggle-init color-red showInactiveSales">
                        <input type="checkbox">
                        <span class="toggle-icon"></span>
                        </label>
                    </span>
                    <span class="item-title float-right">Show Deleted</span>
                </div>
        </div>

        <div class="row">
            <div class="col">
                You have {{totalMat}} {{js "this.totalMat > 1 ? 'sales' : 'sales'"}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                Total amount of sales: {{money totalMoney}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                Total amount received: {{money totalPaid}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                Sales not fully paid: {{totalUnpaid}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                (Amount received - Total sales): {{money totalDifference}}
            </div>
        </div>
    </div>
    <!--<div class="row">
            <div class="col">-->
                
                <div class="list no-hairlines-md no-margin-bottom margin-top-half">
                <ul>
                    <li>
                    <div class="item-content item-input">
                        <div class="item-inner">
                        <div class="item-input-wrap">
                            <input type="text" placeholder="Filter sales by date" readonly="readonly" id="demo-calendar-modal"/>
                            <span class="input-clear-button" @click="resetTable"></span>
                        </div>
                        </div>
                    </div>
                    </li>
                </ul>
                </div>
            <!--</div>
        </div>-->

    <div class="card data-table">
      <table id="salesTable">
        <thead>
          <tr>
            <th class="label-cell">ID</th>
            <th class="input-cell">
                <div class="table-head-label">Product Name</div>
            <div class="list no-hairlines-md">
                <ul>
                    <li class="item-content item-input no-padding">
                        <div class="item-inner no-padding-right">
                            <div class="item-input-wrap">
                            <form data-search-container=".search-content-list" data-search-item="tr" data-search-in=".searchRow" class="searchbar searchbar-inline searchbar-init">   
                                <input type="search" placeholder="Filter" class="no-padding">
                                <!--<span class="input-clear-button"></span>-->
                            </form>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            </th>
            <th class="input-cell">
              <span class="table-head-label">Buyer's Name</span>
              <div class="list no-hairlines-md">
                <ul>
                    <li class="item-content item-input no-padding">
                        <div class="item-inner no-padding-right">
                            <div class="item-input-wrap">
                            <form data-search-container=".search-content-list" data-search-item="tr" data-search-in=".searchRow" class="searchbar searchbar-inline searchbar-init">   
                                <input type="search" placeholder="Filter" class="no-padding">
                                <!--<span class="input-clear-button"></span>-->
                            </form>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            </th>
            <th class="numerical-cell">Cost</th>
            <th class="label-cell">Is Paid</th>
            <th class="numerical-cell">Amount paid</th>
            <th class="label-cell">Date Paid</th>
            <th class="label-cell">Purchase Made</th>
            <th class="label-cell"></th>
          </tr>
        </thead>
        <tbody class="search-content-list">
          {{#each sales}}
            <tr>
              <td class="label-cell">{{js "@index + 1"}}</td>
              <td class="label-cell searchRow">{{product_name}}</td>
              <td class="label-cell searchRow">{{buyer_name}}</td>
              <td class="numeric-cell">{{money cost}}</td>
              <td class="label-cell">
                    <!-- Toggle element -->
                    <label class="toggle toggle-init product-{{id}}">
                    <!-- Toggle input -->
                    <input type="checkbox" {{js "this.amountPaid >= this.cost ? 'checked' : ''"}} {{js "this.amountPaid >= this.cost ? 'disabled' : ''"}} @change="userpaid({{id}},{{cost}})">
                    <!-- Toggle icon -->
                    <span class="toggle-icon"></span>
                    </label>
                  </td>
              <td class="numeric-cell">{{money amountPaid}}</td>
              <td class="label-cell"><span class={{js "this.amountPaid < this.cost ? 'display-none' : ''"}}>{{convertDate date_paid}}</span></td>
              <td class="label-cell">{{convertDate created_date}}</td>
              <td>
                  <p class="display-inline-flex">
                    <a class="button button-fill margin-right-half" @click="openPopUpUpdateSellProduct({{id}})">Edit</a>
                    <a class="button button-fill color-red" @click="deleteSale({{id}})">
                        {{js "this.status == 1 ? 'delete' : 'activate'"}}
                    </a>
                  </p>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
      <div class="data-table-footer">
        <div class="data-table-rows-select">
          Per page:
          <div class="input input-dropdown">
            <select>
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="all">All</option>
            </select>
          </div>
        </div>
        <div class="data-table-pagination">
          <span class="data-table-pagination-label">1-5 of 10</span>
          <a href="#" class="link disabled">
            <i class="icon icon-prev color-gray"></i>
          </a>
          <a href="#" class="link">
            <i class="icon icon-next color-gray"></i>
          </a>
        </div>
      </div>
    </div>

  </div>

    <!--pop up-->
  <div class="popup newSales popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Edit Product Sale</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closeUpdatePopUp">Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Product Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="name_sell" placeholder="Product name" disabled="true"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Cost of product</div>
                      <div class="item-input-wrap">
                        <input type="text" class="cost_sell" placeholder="Cost of product" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Buyer Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="buyer_sell" placeholder="Buyer name"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Amount Paid</div>
                      <div class="item-input-wrap">
                        <input type="text" class="amountpaid_sell" placeholder="Amount paid" value="0" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner-1">
                      <span class="item-title">Payment made</span>
                      <!--<div class="item-after">-->
                        <label class="toggle toggle-init paid_sell margin-left-half">
                          <input type="checkbox">
                          <span class="toggle-icon"></span>
                        </label>
                      <!--</div>-->
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-fill color-green" @click='updateDataSell'>Update Product Sale</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

</div>
</template>
<script>
import Dom7 from 'dom7';
import Dexie from 'dexie';

var db = new Dexie("BizExpenseManagerDB");
          db.version(1).stores({
            ingredients: "++id,name,unit_size,unit,cost_per_unit,status,created_date",
            products: "++id,name,cost,status,created_date",
            product_ingredient: "++id,productID,ingredientID,unit_size,cost,status,created_date",
            product_otherMaterials: "++id,productID,name,cost,status,created_date",
            sales: "++id,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses: "++id,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status",

            ingredients_history: "++id,ingID,name,unit_size,unit,cost_per_unit,status,created_date",
            products_history: "++id,prodID,name,cost,status,created_date",
            sales_history: "++id,salesID,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses_history: "++id,expID,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status"
          })

var $$ = Dom7;
export default {
  data: function () {
      // Must return an object
      return {
        sales: null,
        totalMat:0,
        totalMoney: 0,
        totalPaid: 0,
        totalUnpaid: 0,
        totalDifference: 0,
        currentSale:null
      }
    },
  methods:{
    userpaid: function(id,cost){
        var self = this;
        if(self.$app.toggle.get(".product-" + id).checked){
            self.$app.dialog.prompt("How much did the buyer pay?", function(value){
                var val = Number(value);
                if(isNaN(val)){
                    self.$app.dialog.alert("Please enter valid amount");
                    return;
                }else{
                    if(val == "0"){
                        self.$app.dialog.alert("Please enter amount greater than 0");
                        self.$app.toggle.get(".product-" + id).toggle();
                        return;
                    }
                    var newDate = Date.parse(new Date($.now()));
                    //self.$app.dialog.alert(val + " " + id);
                    var fullyPaid = 0;
                    if(Number(val) >= Number(cost)){
                        fullyPaid = 1;
                    }
                    db.sales.update(Number(id), {amountPaid: Number(val), isPaid: fullyPaid, date_paid:newDate}).then(function (updated) {
                        if (updated){
                        self.sales.forEach(function(item, i) { 
                            if (item.id == Number(id)){
                                    self.sales[i].isPaid = fullyPaid;
                                    self.sales[i].amountPaid = Number(val);
                                    self.sales[i].date_paid = newDate;
                                }  
                        });
                        self.showToast("Payment updated!", "center");
                        if(fullyPaid == 0){
                            self.$app.toggle.get(".product-" + id).toggle();
                        }
                        //console.log(self.ings);
                        self.$setState({
                            sales:self.sales
                        }, function(){
                            self.calculateTotalMoney();
                        });
                        }else{
                            self.showToast("An error occured, please try again", "center");
                            //self.$app.dialog.alert("An error occured, please try again");
                        }
                    });
                }
            }, function(){
                self.$app.toggle.get(".product-" + id).toggle();
            });
        }
    },
    deleteSale: function(id){
        var self = this;
        var checked = 0;
        var text = "delete"
        var toggle = self.$app.toggle.get(".showInactiveSales");
        if(toggle != undefined){
            if(toggle.checked){
                text = "activate";
                checked = 1;
            }
        }
        self.$app.dialog.confirm("Are you sure you want to " + text + " this sale?", function(){
            db.sales.update(Number(id), {status: checked}).then(function (updated) {
                if (updated){
                self.sales = self.sales.filter(function(e){ 
                      return e.id != Number(id);
                  });
                  var act = checked == 0 ? "deleted!" : "activated!";
                  self.showToast("Sale " + act, "center");
                  //console.log(self.ings);
                  self.$setState({
                      sales:self.sales
                  }, function(){
                      self.calculateTotalMoney();
                  });
                }else{
                    self.showToast("An error occured, please try again", "center");
                    //self.$app.dialog.alert("An error occured, please try again");
                }
            });
        });
    },
    showToast: function(text, position){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: 2000,
                        }).open();
    },
    closeUpdatePopUp: function(){
        var self = this;
        $$("input.buyer_sell, input.amountpaid_sell").val("");
        var popup = self.$app.popup.close('.newSales', true);
    },
    updateDataSell: function(){
        var self = this;
        if(self.currentSale == null){
            return;
        }
      //var $$ = this.Dom7;
      var self = this;
      var checked = 0;
      var toggle = self.$app.toggle.get(".paid_sell");
      var isPaidDate = null;
      if(toggle != undefined){
        checked = toggle.checked == true ? 1 : 0;
      }
      if(checked == 1){
         isPaidDate = Date.parse(new Date($.now()));
      }
      if((checked == 1) && ($$("input.amountpaid_sell").val() == "0" || $$("input.amountpaid_sell").val().trim == "")){
          self.$app.dialog.alert("Please enter how much buyer paid or uncheck payment made toggle!");
          return;
      }
      if((checked == 0) && ($$("input.amountpaid_sell").val() != "0" && $$("input.amountpaid_sell").val().trim != "")){
          self.$app.dialog.alert("Please check payment made toggle!");
          return;
      }
      var cp = $$("input.cost_sell").val();
      var sp = $$("input.amountpaid_sell").val();
      var fullyPaid = 0;
      if(Number(sp) >= Number(cp)){
        fullyPaid = 1;
      }
        var obj = {
                id: Number(self.currentSale),
                product_name: $$("input.name_sell").val(),  
                buyer_name: $$("input.buyer_sell").val(),
                cost: $$("input.cost_sell").val(),
                amountPaid: $$("input.amountpaid_sell").val(),
                isPaid: fullyPaid,
                date_paid: isPaidDate,
                created_date: Date.parse(new Date($.now())),
                status:1
              };
            //console.log(obj);
            //self.$app.dialog.alert(JSON.stringify(obj));
            /*if(self.currentProduct != null){
              obj.id = self.currentProduct;
            }*/
            db.sales.put(obj).then(function(){
                  self.$app.dialog.alert("Record saved!", function(){
                    $$("input.buyer_sell, input.amountpaid_sell").val("");
                    self.$app.popup.close('.newSales', true);
                    self.getData();
                    self.$setState({
                            currentSale: null
                        });
                  });
                  
              }).catch(function (error) {
                  //console.log(error);
                 self.$app.dialog.alert("An error occurred!");
              })
    },
    openPopUpUpdateSellProduct: function(id){
        if(id == null){
            return;
        }
        var self = this;
        var toggle = self.$app.toggle.get(".paid_sell");
        if(toggle != undefined){
            if(toggle.checked){
                toggle.toggle();
            }
        }
        //popup.once("opened", function(){
          if(id != null || id != undefined){
            var item = self.sales.find(function(e){ 
                  return e.id == Number(id);
              });
                $$("input.name_sell").val(item.product_name);
                $$("input.buyer_sell").val(item.buyer_name);
                $$("input.cost_sell").val(item.cost);
                $$("input.amountpaid_sell").val(item.amountPaid);
                var popup = self.$app.popup.open('.newSales', true);
                self.$setState({
                    currentSale: Number(id)
                });
            }else{
                self.$setState({
                    currentSale: null
                });
            }
        //})
        
    },
    calculateTotalMoney: function(){
        var self = this;
        var totalPaid = 0;
        var totalUnpaid = 0;
        var totalMoney = 0;
        $.each(self.sales, function(index,item){
            if(item.amountPaid != 0 && item.amountPaid != ""){
                totalPaid += Number(item.amountPaid);
            }
            if(item.amountPaid < item.cost){
                totalUnpaid += 1;
            }
            totalMoney += Number(item.cost);
        })
        self.$setState({
            totalMoney: totalMoney,
            totalPaid: totalPaid,
            totalUnpaid: totalUnpaid,
            totalDifference: (totalPaid - totalMoney),
            totalMat: self.sales.length
        });
    },
    resetTable: function(){
        var self = this;
        console.log("empty");
        self.getData();
    },
    showCalendarPopup: function(){
        var self = this;
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal',
            openIn: 'sheet',
            header: true,
            footer: true
        });
      },
    openPopUp: function(id){
        var self = this
        
    },
    closePopUp: function(){
        var self = this;
        var popup = self.$app.popup.close('.showCalendar', true);
        popup.once("closed", function(){

        });
    },
    getData: function(){
      var self = this;
      var checked = 1;
        var toggle = self.$app.toggle.get(".showInactiveSales");
      if(toggle != undefined){
        checked = toggle.checked == true ? 0 : 1;
      }

      var collection = db.sales.where('status').equals(checked).toArray(function(arr){
        //var collection = db.ingredients.toArray(function(arr){
        //console.log(arr);
          self.$setState({
                sales: arr,
                totalMat:arr.length
              }, function(){
                  self.calculateTotalMoney();
              });
      });
    }
  },
  on: {
      pageInit: function(e, page) {
        var self = this;
        $$(".showInactiveSales").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal',
            openIn: 'customModal',
            rangePicker: true,
            header: true,
            footer: true
        });
        calendarModal.on("closed", function(){
            //console.log(calendarModal.getValue());
            var days = calendarModal.getValue();
            if(days == undefined){
                return;
            }
            var from = null; var to = null;
            if(days.length == 1){
                from = Date.parse(days[0]);
                days.push(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = Date.parse(date2);
            }
            else if(days.length > 1){
                //var date1 = days[0];
                //date1.setDate(date1.getDate() + 1);
                from = Date.parse(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = Date.parse(date2);
            }else{
                self.getData();
            }
            if(from != null && to != null){
                //console.log(from);
                //console.log(to);
                var checked = 1;
                var collection = db.sales.where('created_date').between(from, to)
                .filter(function (sale) {
                    return sale.status === 1;
                }).toArray(function(arr){
                    //var collection = db.ingredients.toArray(function(arr){
                    //console.log(arr);
                    self.$setState({
                            sales: arr,
                            totalMat:arr.length
                        }, function(){
                            self.calculateTotalMoney();
                        });
                });
            }
        })        
        self.getData();
      },
      pageReinit: function(e, page) {
        var self = this;
        $$(".showInactiveSales").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        self.getData();
      }
  }

} 
</script>