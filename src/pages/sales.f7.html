<template>
<div class="page" data-name="sales">
  <div class="navbar">
    <div class="navbar navbar-bg"></div>
    <div class="navbar-inner sliding">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title padding-vertical-half">Sales/Estimates</div>
      <div class="right">
        <a href="#" class="link icon-only panel-toggle" data-panel="left">
          <i class="icon f7-icons if-not-md">menu</i>
          <i class="icon material-icons if-md">menu</i>
        </a>
      </div>
    </div>
  </div>


      <!--fab-->
      <div class="fab-backdrop"></div>
    <div class="fab fab-extended fab-right-bottom">
      <!--<a href="#">
        <i class="icon f7-icons">plus</i>
        <i class="icon f7-icons">multiply</i>
        <div class="fab-text">Sell</div>
      </a>-->
        
        <div class="fab-buttons fab-buttons-top">
          <a href="#" class="fab-label-button" @click="openPopUpUpdateSellProduct(null)">
            <span><i class="icon f7-icons">plus</i></span>
            <span class="fab-label">Single Product</span>
          </a>
          <a href="#" class="fab-label-button" @click="openPopUpMultiple">
            <span><i class="icon f7-icons">plus</i></span>
            <span class="fab-label">Multiple Products</span>
          </a>
        </div>
    </div>
    <!--fab-->

  <div class="page-content">
  <div class="block no-margin-vertical no-margin-horizontal no-padding-vertical roundHolder no-padding-horizontal">
      <div id="sales-list" class="customList">
          <div class="text-align-center customListSub">
            <div class="searchbar searchbar-inline">
              <div class="searchbar-input-wrap">
                <input type="search" placeholder="Search" class="search">
                <i class="searchbar-icon"></i>
                <span class="input-clear-button"></span>
              </div>
            </div>
          </div>

          <div class="no-margin-vertical padding-horizontal-half">
                <div class="">
                  <div class="block no-margin-vertical no-padding">
                    <div class="row no-gap dash">

                        <!--<div class="col-50 medium-50 small-50 xsmall-100">
                          <div class="card card-outline">
                            <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Sales Not Fully Paid</div>
                            <div class="card-content">{{totalUnpaid}}</div>
                          </div>
                        </div>-->
              
                        <div class="col-100 medium-33">
                          <div class="card card-outline padding-vertical-half totalSales">
                            <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder text-color-white">Total Amount of Sales</div>
                            <div class="card-content text-color-white">{{totalMoney}}</div>
                          </div>
                        </div>
              
                        <div class="col-100 medium-33">
                          <div class="card card-outline padding-vertical-half">
                            <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Total Amount Received</div>
                            <div class="card-content">{{totalPaid}}</div>
                          </div>
                        </div>

                        
                        <div class="col-100 medium-33">
                          <div class="card card-outline padding-vertical-half">
                            <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Number of {{js "this.totalMat > 1 ? 'Sales' : 'Sale'"}}</div>
                            <div class="card-content">{{totalMat}}</div>
                          </div>
                        </div>
              
                        <!--<div class="col-100 medium-66">
                          <div class="card card-outline">
                            <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">(Amount Received minus Total sales)</div>
                            <div class="card-content">{{money totalDifference}}</div>
                          </div>
                        </div>-->
              
                    </div>
                  </div>
                </div>
          </div>

          <div class="text-align-center">
            <!--<input class="search" placeholder="search">-->
            <!-- Additional "searchbar-inline" class -->
            
  
            <div class="margin-vertical-half padding-vertical-half sortTextPar">
              
              <span class="sortText display-none">Sort By:</span>
              <!--<span class="sort" data-sort="name">Name</span>
              <span class="sort" data-sort="cost">Cost</span>-->
            </div>
          </div>

          <div class="row margin-top-half myToolbar">
            <div class="col-33 no-padding-vertical">
              <span class="display-inline-flex">
              <!--<span class="margin-left-half">You have {{totalMat}} {{js "this.totalMat > 1 ? 'sales' : 'sale'"}}</span>-->
                <span class="margin-horizontal-half">Show</span>
                <span><a class="button button-small button-raised switchEstimate" data-estimate="0" @click="switchEstimate">Estimates</a></span>
             </span>
            </div>

            <div class="col-33 no-padding-vertical text-align-right">
              <span class="display-inline-flex margin-right-half display-none">
                <span class="item-title float-right">Show Deleted</span>
                <span class="item-after float-right margin-left-half">
                    <label class="toggle toggle-init color-red showInactiveSales">
                    <input type="checkbox">
                    <span class="toggle-icon"></span>
                    </label>
                </span>
                </span>
            </div>

            <div class="col-33 no-padding-vertical">
              <div class="block no-margin-vertical filterDateParent">  
                <div class="no-hairlines-md no-margin-bottom margin-top-half">
                    <div class="item-content item-input1">
                        <div class="item-inner bg-color-white specWrap">
                        <div class="item-input-wrap">
                            <input type="text" class="specSearch" placeholder="filter sales by date" id="demo-calendar-modal"/>
                            <span class="input-clear-button specClear" @click="resetTable"></span>
                        </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>

          </div>
          <div class="block header_title text-align-center no-margin-vertical block-title-medium margin-top display-none"></div>
          
          <div class="sales-table data-table margin-vertical-half">
            <table>
                <thead>
                  <tr>
                    <th class="sort" data-sort="name"><i class="icon f7-icons">arrow_up_down</i> Product Name</th>
                    <th>Buyer's Name</th>
                    <th>Quantity</th>
                    <th class="sort" data-sort="cost"><i class="icon f7-icons">arrow_up_down</i> Total Cost</th>
                    <th>Amount Paid</th>
                    <th class="sort" data-sort="isPaid"><i class="icon f7-icons">arrow_up_down</i> Fully Paid</th>
                    <th class="sort" data-sort="created_date"><i class="icon f7-icons">arrow_up_down</i> Date of Purchase</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody class="list sortList">
  
                </tbody>
            </table>
          </div>
          
          <ul class="list sortList margin-vertical-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>
      </div>
    
  </div>

    <!--pop up-->
  <div class="popup newSales popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Add/Edit Product Sale</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closeUpdatePopUp"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half">
              <ul>
                <li>
                  <div class="row">
                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">Product Name</div>
                          <div class="item-input-wrap">
                            <input type="hidden" id="productID_sell">
                            <input type="text" id="name_sell_sales" class="name_sell_sales" placeholder="Product name" required/>
                            <span class="input-clear-button"></span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">Selling Price</div>
                          <div class="item-input-wrap">
                            <input type="number" class="cost_sell_sales" @keyup="calculateQuantity" placeholder="selling price" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                  </div>

                </li>

                <li>
                  <div class="row">
                      <div class="col-50">
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title">Quantity</div>
                            <div class="item-input-wrap">
                              <input type="hidden" class="hiddenQuantitySingle">
                              <input type="number" class="quantity_sell_sales" @keyup="calculateQuantity" placeholder="Quantity" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-50">
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title">Discount</div>
                            <div class="item-input-wrap">
                              <input type="number" class="discount_sell_sales" @keyup="calculateQuantity" value="0" placeholder="Discount" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                            </div>
                          </div>
                        </div>
                      </div>
                  </div>
                </li>
                
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Total Price</div>
                      <div class="item-input-wrap">
                        <input type="number" class="total_sell_sales" @keyup="calculateQuantity2" placeholder="Total Price" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="row">
                      <div class="col-50">
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title">Taxes in %</div>
                            <div class="item-input-wrap">
                              <input type="number" class="taxes-sales" @keyup="calculateQuantity" placeholder="Taxes in %" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-50">
                        <div class="item-content item-input">
                          <div class="item-inner">
                            <div class="item-title">After Tax Price</div>
                            <div class="item-input-wrap">
                              <input type="text" class="afterTax_sales" placeholder="After Tax Price"/>
                              <span class="input-clear-button"></span>
                            </div>
                          </div>
                        </div>
                      </div>
                  </div>
                  
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Buyer's Name</div>
                      <div class="item-input-wrap">
                        <input type="text" id="buyer_sell_sales" class="buyer_sell_sales" placeholder="Buyer name" required/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="row">
                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title" style="width: 100%;">
                            <span>Amount Paid</span>
                            <p class="display-inline-flex" style="float: right;margin: 0;">
                                <a class="button button-small button-outline text-color-white button-green bg-color-green no-margin padding-horizontal-half" @click="recordPaidFullySales">Paid fully</a>
                              </p>
                          </div>
                          <div class="item-input-wrap">
                            <input type="number" class="amountpaid_sell_sales" placeholder="Amount customer paid" value="0" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">This is an Estimate<i class="icon f7-icons icon-tooltip estimateExplain color-black">info_circle_fill</i></div>
                          <div class="item-input-wrap">
                            <label class="checkbox">
                              <!-- checkbox input -->
                              <input type="checkbox" class="isEstimateSales">
                              <!-- checkbox icon -->
                              <i class="icon-checkbox"></i>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
                </li>
                <li>
                  <div class="row">
                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">Date Buyer Paid</div>
                        <div class="item-input-wrap">
                            <input type="text" placeholder="Date buyer paid" id="paid-calendar-modal-sales"/>
                            <span class="input-clear-button"></span>
                        </div>
                        </div>
                    </div>
                    </div>

                    <div class="col-50">
                      <div class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">Date of Purchase</div>
                        <div class="item-input-wrap">
                            <input type="text" placeholder="Date of purchase" id="purchase-calendar-modal-sales" required validate data-error-message="Select date of purchase please!"/>
                            <span class="input-clear-button"></span>
                        </div>
                        </div>
                    </div>
                    </div>
                  </div>
                  
                </li>
                
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-outline button-raised mainButton" @click='updateDataSell'>Save Product Sale</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

  <!--pop up add new product-->
  <div class="popup viewInvoice popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Preview Invoice</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePreviewInvoice()"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
          <div class="no-padding-left margin-vertical-half" style="height: 100%;">
            <p class="display-flex justify-content-center padding-horizontal">
              <a class="button button-small mainButton margin-right-half shareLinkButton" @click="shareInvoiceLink">Share Invoice Link</a>
              <a class="button button-small mainButton downloadInvoiceButton" @click="showPDF">Download Invoice</a>
            </p>
            
              <div id="showInvoice">

                <!--header-->
                <div class="padding-horizontal-half padding-vertical border-bottom">
                  <div class="row padding-vertical">
                      <div class="col-100 medium-50">
                          <div class="display-flex">
                                <img src="/static/icons/favicon.png" class="brandLogoReceipt" />
                              <div class="display-flex flex-direction-column">
                                  <h2 class="margin-left-half no-margin-bottom brandNameReciept">

                                  </h2>
                                      <div class="margin-left-half text-muted taglineReceipt"></div>
                              </div>
                          </div>
                      </div>
                      <div class="col-100 medium-50 text-align-right">
                          <div id="addressLabel" class="margin-top text-muted small">
      
                          </div>
                      </div>
                  </div>
              </div>
              <!--header-->

              <!--details section-->
              <div class="container-fluid">
                <div class="row margin-top invoiceHeader">
                    <div class="col-100 medium-40 no-padding-left">
                        <div class="text-muted">BILL TO</div>
                        <div id="buyerName"></div>
                    </div>
    
                    <div class="col-100 medium-60 mt-3 mt-md-0 text-md-right docDetails px-0 px-md-3">
    
                    </div>
                </div>
    
                <!--<div class="d-none downloadButton">
                    <button class="btn btn-success" onclick="downloadPDF()">Download</button>
                </div>-->
    
            </div>
            <!--details section-->

            <!--Table-->
            <div class="container-fluid padding-vertical no-padding-horizontal">
              <table id="invoiceTable" class="width-100">
                  <thead class="bg-main-color text-color-white">
                      <tr>
                          <th>Name</th>
                          <th>Quantity</th>
                          <th class="hideOnMobile">Rate</th>
                          <th class="hideOnMobile">Discount</th>
                          <th>Amount</th>
                      </tr>
                  </thead>
                  <tbody>
                  </tbody>
              </table>
  
  
              <div class="display-flex justify-content-end">
                  <table id="invoiceTableSum">
                      <tbody>
                      </tbody>
                  </table>
              </div>
  
  
              <div id="signatureHolder">
  
              </div>
          </div>
          <!--Table-->

              </div>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--pop up-->

  <!--pop up for for multiple items-->
  <div class="popup multipleSales_sales popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Multiple Product Sales</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePopUpMultiple"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">

        <div class="list margin-bottom-half margin-top">
          <div class="row justify-content-center">
            <a class="col-50 button tealBgButton" href="#" id="autocomplete-standalone-multiple-sales">
              <div class="item-title text-color-white">Select Products</div></a>
        </div>
        </div>

        <div id="products-list-sales" class="customList">
          <ul class="list sortList margin-top-half margin-bottom-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>

        <div class="row justify-content-center">
          <a class="col-50 button customcharges tealColorButton" @click="AddNewProduct(null)">Add Other Charges</a>
        </div>

        <div id="productsOther-list-sales" class="customList">
          <ul class="list sortList margin-top-half margin-bottom-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>

        <ul class="list sortList margin-top-half margin-bottom-half">
          <div class="bigLabel">
            <span class="labelName margin-right-half">Taxes in %:</span>
            <div class="display-inline-flex">
              <input class="taxpercent-sales" type="text" placeholder="0 to 100" @keyup="CalculateTotalProduct" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" value="0">
            </div>
          </div>

      </ul>
      <div class="row padding-horizontal-half display-none"><div class="col-100">
        <a class="col button button-outline button-raised mainButton calculateTotalButton" @click="CalculateTotalProduct">Calculate</a>
      </div>
    </div>
        <div class="margin-top-half bigLabel margin-horizontal-half">
          <span class="labelName margin-right-half">Price before tax: </span>
          <div class="display-inline-flex"><div class="totalAmountBeforeProfitProduct-sales">0</div></div>
        </div>
        <div class="margin-top-half bigLabel margin-horizontal-half">
          <span class="labelName margin-right-half">Price after tax: </span>
          <div class="display-inline-flex"><div class="totalAmountProduct-sales">0</div></div>
        </div>
         
        <ul class="list margin-top-half margin-bottom-half margin-horizontal-half grouped"><li>
        <div class="card myCard">
          <div class="card-content padding-horizontal padding-vertical">

            <div class="row">
              <div class="col-50">
                <div class="labelName">Product Combo</div>
              <input class="groupProductNameMultiple_sales" type="text" placeholder="e.g shirt & pants" value="">
            </div>

            <div class="col-50">
              <div class="labelName">Buyer's Name: </div>
              <input class="buyersNameMultiple_sales" id="buyersNameMultiple_sales" type="text" placeholder="Buyer's Name" value="">
            </div>
          </div>

              <div class="row margin-top-half">
                <div class="col-50">
                  <div class="row">
                    <div class="col-33 labelName">Amount Paid</div>
                        <div class="col-66">
                          <a class="button button-small text-color-white button-green bg-color-green" @click="recordPaidFullyMultipleSales">Paid fully</a>
                        </div>
                    </div>
                  <input class="amountPaidMultiple-sales" type="text" placeholder="Amount Paid" value="0">
                </div> 

                <div class="col-50">
                    <div class="labelName">This is an estimate<i class="icon f7-icons icon-tooltip estimateExplain color-black">info_circle_fill</i></div>
                    <div>
                      <div class="item-input-wrap" style="position: relative;">
                        <label class="checkbox" style="position: absolute;bottom: 4px;">
                          <input type="checkbox" class="isEstimateMultipleSales">
                          <i class="icon-checkbox"></i>
                        </label>
                      </div>
                  </div>
                </div>
            </div>

            <div class="row margin-top-half">
              <div class="col-50">
                <div class="labelName">Date of Payment: </div>
                <input id="datePaidMultiple_sales" class="text-align-center" type="text" placeholder="Date of Payment" value="0">
              </div>

              <div class="col-50">
                <div class="labelName">Date of Purchase </div>
                <input id="datePurchaseMultiple_sales" class="text-align-center" type="text" placeholder="Date of Purchase" value="0">
              </div>
              
            </div>

          </div>
        </div>
        </li></ul>
                <div class="row padding-horizontal-half margin-bottom-half"><div class="col-100">
                  <a class="col button mainButton margin-bottom-half" @click="saveMultipleProductSales">Save/Update Product Sale</a>
                </div>
              </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up for multiple items-->

</div>
</template>
<script>
//import Dom7 from 'dom7';
//import Dexie from 'dexie';
import * as moment from 'moment';
import copy from 'copy-to-clipboard';
//import * as rasterizeHTML from 'rasterizehtml';
import html2pdf from 'html2pdf.js';
var selectedUserName = null, selectedUserID = null, mogulsheetdb = null;
  var dbProducts = null, dbProdIngs = null, dbProdOthers = null, dbSales = null, dbIngs = null, dbSettings = null, dbClients = null, dbSettingsImages = null;
var salesList = null;
export default {
  data: function () {
      // Must return an object
      return {
        sales: null,
        totalMat:0,
        totalMoney: 0,
        totalPaid: 0,
        totalUnpaid: 0,
        totalDifference: 0,
        currentSale:null,
        products:null,
        sellToAnotherUser:null,
        currentMultipleSale: null,
        selectedOldProducts: [],
        selectedProducts:[],
        settings: null,
        settingsID: 'settings',
        clients:null,
        signature: null,
        logo: null,
        invoiceHtml:null,
        invoiceItem: null
      }
    },
  methods:{
    recordPaidFullySales: function(){
      var tt = $(".afterTax_sales").val();
      $(".amountpaid_sell_sales").val(tt);
    },
    recordPaidFullyMultipleSales: function(){
      var tt = $(".totalAmountProduct-sales").text();
      $(".amountPaidMultiple-sales").val(tt);
    },
    closePreviewInvoice: function(){
      var self = this;
      self.$setState({
          invoiceHtml: null,
          invoiceItem: null
      });

      var popup = self.$app.popup.close('.viewInvoice', true);
    },
    openPreviewInvoice: function(doc){
      var self = this;
      var popup = self.$app.popup.open('.viewInvoice', true);
      self.formatPDF(doc.parent, doc.children);
    },
    switchEstimate: function(){
      var self = this;
      var data = $(".switchEstimate").attr("data-estimate");
      if(data == "0"){
        $(".switchEstimate").text("Sales");
        $(".switchEstimate").attr("data-estimate", "1");
        $(".header_title").text("Estimates");
      }
      if(data == "1"){
        $(".switchEstimate").text("Estimates");
        $(".switchEstimate").attr("data-estimate", "0");
        $(".header_title").text("Sales");
      }
      self.getData();
    },
    userpaid: function(id,cost){
        var self = this;
        if(self.$app.toggle.get(".product-" + id).checked){
            self.$app.dialog.prompt("How much did the buyer pay?", function(value){
                var val = Number(value);
                if(isNaN(val)){
                    self.$app.dialog.alert("Please enter valid amount", "Omni");
                    return;
                }else{
                    if(val == "0"){
                        self.$app.dialog.alert("Please enter amount greater than 0", "Omni");
                        self.$app.toggle.get(".product-" + id).toggle();
                        return;
                    }
                    var newDate = Date.parse(new Date($.now()));
                    //self.$app.dialog.alert(val + " " + id);
                    var fullyPaid = 0;
                    if(Number(val) >= Number(cost)){
                        fullyPaid = 1;
                    }else{
                        fullyPaid = 0;
                        newDate = null;
                    }
                    db.sales.update(Number(id), {amountPaid: Number(val), isPaid: fullyPaid, date_paid:newDate}).then(function (updated) {
                        if (updated){
                        self.sales.forEach(function(item, i) { 
                            if (item.id == Number(id)){
                                    self.sales[i].isPaid = fullyPaid;
                                    self.sales[i].amountPaid = Number(val);
                                    self.sales[i].date_paid = newDate;
                                }  
                        });
                        self.showToast("Payment updated!", "center", true);
                        if(fullyPaid == 0){
                            self.$app.toggle.get(".product-" + id).toggle();
                        }

                        self.$setState({
                            sales:self.sales
                        }, function(){
                            self.calculateTotalMoney();
                        });
                        }else{
                            self.showToast("An error occured, please try again", "center");
                            //self.$app.dialog.alert("An error occured, please try again");
                        }
                    });
                }
            }, function(){
                self.$app.toggle.get(".product-" + id).toggle();
            });
        }
    },
    CalculateTotalProduct: function(){
      var self = this;
      var totalCost = 0;
      $(".eachProduct_sales").each(function(i, curr){
        var price = Number($(curr).find(".productCost_sales").eq(0).val().trim());
        var quant = Number($(curr).find(".productQuantity_sales").eq(0).val().trim());
        var discount = Number($(curr).find(".discount").eq(0).val().trim());
        var hiddenQuant = Number($(curr).find(".hiddenQuantity").eq(0).val());
        if(!isNaN(hiddenQuant)){
          if(quant > hiddenQuant){
            self.showToast("The quantity you entered is more than you have in stock", "center");
          }
        }
        //$(curr).find(".totalproductprice-sales")
        if(!isNaN(price) && !isNaN(quant)){
            var total = price * quant;
            total = total - discount;
            totalCost += total;
            $(curr).find(".totalproductprice-sales").eq(0).val(total.toFixed(2));
        }
      })
      
      var tax = Number($(".multipleSales_sales").find(".taxpercent-sales").eq(0).val());
      if(!isNaN(tax) || tax == 0){
        $(".totalAmountBeforeProfitProduct-sales").text(totalCost.toFixed(2));
          var taxAmt = ((tax/100) * totalCost);
          var afterTax = totalCost + taxAmt;
          $(".totalAmountProduct-sales").text(afterTax.toFixed(2));
      }else{
        $(".totalAmountBeforeProfitProduct-sales").text(totalCost.toFixed(2));
      }
    },
    calculateprofit: function(){

    },
    saveMultipleProductSales: function(){
        var self = this;
        var error = false;
        var bigData = [];
        
      //validation
      var grpName = $(".groupProductNameMultiple_sales").val().trim();
        var buyername = $(".buyersNameMultiple_sales").val().trim();
        var amountPaid = Number($(".multipleSales_sales:visible").find(".amountPaidMultiple-sales").val().trim());
        var taxes = Number($(".multipleSales_sales:visible").find(".taxpercent-sales").val().trim());
        if(isNaN(taxes)){
          error = true;
          $(".multipleSales_sales:visible").find(".taxpercent-sales").parents("ul").eq(0).addClass("bg-color-red");
        }else{
          $(".multipleSales_sales:visible").find(".taxpercent-sales").parents("ul").eq(0).removeClass("bg-color-red");
        }

        if(buyername == "" || isNaN(amountPaid)){
            $(".buyersNameMultiple_sales").parents("li").eq(0).addClass("bg-color-red");
            error = true;
        }else{
          $(".buyersNameMultiple_sales").parents("li").eq(0).removeClass("bg-color-red");
        }

        var beforeTaxes = Number($(".multipleSales_sales:visible").find(".totalAmountBeforeProfitProduct-sales").text());
          var afterTaxes = Number($(".multipleSales_sales:visible").find(".totalAmountProduct-sales").text());
          var fullyPaid = false;
      var isPaidDate = null;
      if(amountPaid >= afterTaxes){
        fullyPaid = true;
      }else{
        fullyPaid = false;
      }
      isPaidDate = moment($(".multipleSales_sales:visible").find("#datePaidMultiple_sales").val()).format();//  Date.parse($("#paid-calendar-modal-sales").val());
      var isEstimate = $(".multipleSales_sales:visible").find(".isEstimateMultipleSales").prop("checked");
        $(".eachProduct_sales").each(function(i, curr){
          var productID = null;
        var productName = $(curr).find(".productName").eq(0).val().trim();
        if($(curr).find(".productID").length > 0){
          productID = parseInt($(curr).find(".productID").eq(0).val());
        }
        var price = Number($(curr).find(".productCost_sales").eq(0).val().trim());
        var quant = Number($(curr).find(".productQuantity_sales").eq(0).val().trim());
        var totalPric = Number($(curr).find(".totalproductprice-sales").eq(0).val().trim());
        var discount = Number($(curr).find(".discount").eq(0).val().trim());

        if(isNaN(price) || isNaN(quant) || productName == ""){
            $(curr).addClass("bg-color-red");
            error = true;
        }else{
          $(curr).removeClass("bg-color-red");
          // saving logic
          var isParent = $(curr).hasClass("eachSaleParent_sales") == true;
          var tax = (taxes/100) * totalPric;
          var costPlusTax = totalPric + tax;
          var obj = {
                productName: productName,  
                productId: productID,
                //buyer_name: buyername,
                sellingPrice: price,
                discount: discount,
                isEstimate: isEstimate,
                taxes: taxes,
                parentID: 0,
                isParent: isParent,
                afterTaxPrice: costPlusTax,
                quantity: quant,
                totalPrice: totalPric,
                amountPaid:  0,
                isPaid: fullyPaid,
                datePaid: isPaidDate,
                createdDate: moment($(".multipleSales_sales").find("#datePurchaseMultiple_sales").val()).format(), //Date.parse($("#purchase-calendar-modal-sales").val()),
                status:true
              };
            bigData.push(obj)
        }
      })

        // validation final
        if(error){
          self.showToast("Error is found in the forms!", "center");
        }else{
          // save into db
          var chosenUser = buyername;
          var theBuyerID = null;
          var theBuyerName = null;
          //new buyer
            if(self.currentMultipleSale == null || self.sellToAnotherUser != null){
              //selected name from dropdown
              if(chosenUser == selectedUserName){
              theBuyerID = selectedUserID;
              theBuyerName = selectedUserName;
              self.saveProcessedMultiplePayment(grpName,buyername,theBuyerID,isEstimate,taxes,afterTaxes,beforeTaxes,amountPaid,fullyPaid,isPaidDate,bigData);
            }else{
              //new user new sale
              var obj = {
                name: chosenUser
            }
                $.when(self.$app.methods.postDataAPI("clients/SaveClient", obj, true)).then(function( data, textStatus, jqXHR ) {
                  self.$app.preloader.hide();
                    if(data != null){
                      self.showToast("New User Created.", "center", true);
                      self.saveProcessedMultiplePayment(grpName,chosenUser,data,isEstimate,taxes,afterTaxes,beforeTaxes,amountPaid,fullyPaid,isPaidDate,bigData);
                    }
                });
              }
          }else{
            //editing old sale
            if(selectedUserName != null && selectedUserID != null && selectedUserName == chosenUser){
              self.saveProcessedMultiplePayment(grpName,selectedUserName,selectedUserID,isEstimate,taxes,afterTaxes,beforeTaxes,amountPaid,fullyPaid,isPaidDate,bigData);
            }else{
              var buyerid = self.currentMultipleSale.clientId == undefined ? null : self.currentMultipleSale.clientId;
              self.saveProcessedMultiplePayment(grpName,chosenUser,buyerid,isEstimate,taxes,afterTaxes,beforeTaxes,amountPaid,fullyPaid,isPaidDate,bigData);
            }
          }

              //saving clean data
        }
    },
    saveProcessedMultiplePayment: function(grpName1,buyername1,theBuyerID1,isEstimate1,taxes1,afterTaxes1,beforeTaxes1,amountPaid1,fullyPaid1,isPaidDate1,sbigData){
      var self = this;
      grpName1 = grpName1 == "" ? buyername1 + " group purchase" : grpName1;
          
          var objMaster = {
              productName: grpName1,  
              //buyer_name: buyername1,
              clientId: theBuyerID1,
              sellingPrice: beforeTaxes1,
              discount: 0,
              isEstimate: isEstimate1,
              taxes: taxes1,
              parentID: 0,
              isParent:true,
              afterTaxPrice: afterTaxes1,
              quantity: 1,
              totalPrice: beforeTaxes1,
              amountPaid:  amountPaid1,
              isPaid: fullyPaid1,
              datePaid: isPaidDate1,
              createdDate: moment($(".multipleSales_sales:visible").find("#datePurchaseMultiple_sales").val()).format(), //Date.parse($("#purchase-calendar-modal-sales").val()),
              status:true
            };
            var deleted = "";
            if(self.currentMultipleSale != null && self.sellToAnotherUser == null){
                objMaster.id = self.currentMultipleSale.id;
              }
            //db.transaction('rw', db.sales, () => {
              self.$app.preloader.show();
              var objToSave = {};
              objToSave.oldParent = self.currentMultipleSale;
              objToSave.parent = objMaster;
              objToSave.children = sbigData;

              $.when(self.$app.methods.postDataAPI("sales/SaveSalesListDeleteFirst", objToSave, true)).then(function( dataid, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                self.showToast("Product sale updated", "center", true);
                      self.closePopUpMultiple();
                      return;
              }).catch((err) => {
                self.$app.preloader.hide();
                self.showToast("An error occurred", "center");
              })


              /*$.when(self.$app.methods.postDataAPI("sales/SaveSalesMaster", objMaster, true)).then(function( dataid, textStatus, jqXHR ) {
                    sbigData.forEach((element, index) => {
                      sbigData[index].parentID = dataid;
                      sbigData[index].clientId = theBuyerID1; 
                  });

                if(self.currentMultipleSale != null){
                  var toSaveObj = {};
                  toSaveObj.parent = self.currentMultipleSale;
                  toSaveObj.children = sbigData;
                  var method = "SaveSalesListDeleteFirst";
                  $.when(self.$app.methods.postDataAPI("sales/" + method, toSaveObj, true)).then(function( dataid, textStatus, jqXHR ) {
                      self.showToast("Product sale updated", "center", true);
                      self.closePopUpMultiple();
                      return;
                      //self.closePopUpMultiple();
                    }).catch(err => {
                    // Transaction aborted. NOT WITHIN ZONE!
                    //console.error (e);
                      self.showToast("An error occurred", "center");
                  });

                  self.showToast("Product sale updated", "center", true);
                  self.closePopUpMultiple();


                  //remove from here
                  mogulsheetdb.find({
                      selector: {
                        $and: [
                            { status: {$eq: 1} },
                            {parentID: {$eq: deleted}},
                            {_id: {$gte: null}},
                            {saleID: {$gt: 0}},
                        ]
                      }
                    }).then(function(ar){
                      var arr = ar.docs;
                            arr.forEach((element, index) => {
                            arr[index].status = 0;  
                            arr[index]._deleted = true;
                        });
                        mogulsheetdb.bulkDocs(arr).then(function(){
                          mogulsheetdb.bulkDocs(sbigData).then((saved) => {

                          }).catch((err) => {
                            console.log("big save error", err);
                          })

                          //change estimate to sales
                          if((self.currentMultipleSale.isEstimate == 1 && isEstimate1 == 0) || (self.sellToAnotherUser == 1)){
                            var oldMastering = [];
                            self.findDifferenceMultiple(oldMastering, sbigData);
                          }

                          //change sales to estimates
                          if(self.currentMultipleSale.isEstimate == 0 && isEstimate1 == 1){
                            var newMastering = [];
                            self.findDifferenceMultiple(self.selectedOldProducts, newMastering);
                          }

                          //if they are not both estimates
                          if(self.currentMultipleSale.isEstimate == 0 && isEstimate1 == 0){
                            self.findDifferenceMultiple(self.selectedOldProducts, sbigData);
                          }
                          
                        })
                    })
                    //remove to here
                }
                
                //remove from
                else{
                    mogulsheetdb.bulkDocs(sbigData).then(function(lastKey) {

                        if(isEstimate1 == 0){
                            self.subtractStockMultiple(sbigData);
                          }
                  }).catch((err) => {
                    console.log("error multiple save", err);
                  })
                }
                //self.showToast("Saved successfully", "center", true);
                //self.closePopUpMultiple();
                //self.$app.popup.close('.multipleSales_sales', true);
                //remove to here
                  
              }).catch(err => {
                // Transaction aborted. NOT WITHIN ZONE!
                //console.error (e);
                  self.$app.preloader.hide();
                  self.showToast("An error occurred", "center");
               });*/

            //saving clean data
    },
    subtractStockMultiple: function(bigData){
      var self = this;
      var prods = bigData.filter(x => x.productID_saleID != "0");
      var prodsID = prods.map(x => x.productID_saleID);
      mogulsheetdb.find({
              selector: {
                _id: { $in: prodsID },
                productID: {$gt: 0},
                status: {$gt: 0}
              },
              sort: [{'_id': 'desc'}]
            }).then((arr) => {
              var ar = arr.docs;
              var saveBigData = [];
              $.each(ar, function(ind, dat){
                if(dat.stock != undefined && dat.stock != "undefined" && dat.stock != "Unlimited"){
                      var floatStock = parseFloat(dat.stock);
                      if(!isNaN(floatStock)){
                        var quantitySold = prods.find(x => x.productID_saleID == dat._id).quantity;
                        var remain = floatStock - quantitySold;
                        if(!isNaN(remain)){
                          dat.stock = remain;
                          saveBigData.push(dat);
                        }
                      }
                  }
              })
              if(saveBigData.length > 0){
                mogulsheetdb.bulkDocs(saveBigData);
              }
            })
    },
    AddNewProduct: function(select){
      var self = this;
      var name = select == null ? "" : select.productName;
      var cost = select == null ? "" : select.sellingPrice;
      var quantity = select == null ? 1 : select.quantity;
      var totalPrice = select == null ? "" : select.totalPrice;
      var discount = select == null ? "0" : select.discount;
        //var cost = select.cost == undefined ? 0 : select.cost; 
       /* var html = '<li class="eachSaleParentOther_sales eachProduct_sales"><div class="card myCard"><div class="card-content padding-horizontal-half">';
          html += '<div><span class="labelName">Product Name: </span><div class="display-inline-flex"><input class="productName" type="text" placeholder="Product Name" value="';
          html +=  name + '"></div></div>';
          html += '<div class="row"><div class="col-50"><div class="item-content item-input no-padding-left"><div class="item-inner no-padding-right"><div class="labelName">Product Cost</div>';
          html += '<div class="item-input-wrap"><input class="productCost_sales" type="text" placeholder="Product Cost" value="' + cost + '">';
          html +=  '<span class="input-clear-button"></span></div></div></div></div>';
          html += '<div class="col-50"><div class="item-content item-input no-padding-left"><div class="item-inner no-padding-right"><div class="labelName">Quantity</div>';
          html += '<div class="item-input-wrap"><input class="productQuantity_sales" type="text" placeholder="Product Quantity" value="' + quantity + '">';
          html +=  '<span class="input-clear-button"></span></div></div></div></div></div>';
          html += '<div><span class="labelName">Discount: </span><div class="display-inline-flex"><input class="discount" type="text" placeholder="Discount" value="';
          html +=  discount + '"></div></div>';
          html += '<div><span class="labelName">Total Price: </span><div class="display-inline-flex"><input class="totalproductprice-sales" type="text" placeholder="Total Price" value="';
          html += totalPrice + '"></div></div>';
        html += '</div><div class="card-footerMine padding-horizontal-half padding-bottom-half"><p class="display-inline-flex no-margin-vertical">';
          html += '<a class="button button-small button-raised removeProduct">Delete</a>';
        html += '</p></div></div>'
        html += '</li>';*/

        var html = '<li class="eachSaleParentOther_sales eachProduct_sales margin-vertical"><div class="card myCard"><div class="card-content padding-horizontal padding-vertical">';
          html += '<div class="row"><div class="col-50"><div class="labelName">Name</div><input class="productName" type="text" placeholder="e.g delivery" value="';
          html +=  name + '"></div><div class="col-50"><div class="labelName">Amount</div><input class="productCost_sales" type="text" placeholder="Amount" value="' + cost + '"></div></div>';
          html += '<div class="row margin-top-half"><div class="col-50"></div><div class="col-50"><a class="button button-small removeProduct">Remove Charge</a></div></div>';
          html += '<input type="hidden" class="discount" value="' + discount + '"><input type="hidden" class="productQuantity_sales" value="' + quantity + '"><input type="hidden" class="totalproductprice-sales" value="'+ totalPrice + '">';
          html += "</div></div></li>"; 

        $("#productsOther-list-sales .sortList").append(html);
        $(".eachSaleParentOther_sales .removeProduct").off("click").on("click", function(){
                  //var id = $(this).attr("data-itemid");
                  $(this).parents(".eachSaleParentOther_sales").eq(0).remove();
                  self.CalculateTotalProduct();
                })
            $(".eachSaleParentOther_sales input").off("keyup").on("keyup", function(){
                self.CalculateTotalProduct();
            })
    },
    SaveTotalProduct: function(){
    
    },
    calculateQuantity: function(){
      var self = this;
      var cost = Number($(".cost_sell_sales").val().trim());
        var quant = Number($(".quantity_sell_sales").val().trim());
        var hiddenQuant = Number($(".hiddenQuantitySingle").val().trim());
        if(!isNaN(hiddenQuant)){
          if(quant > hiddenQuant){
            self.showToast("The quantity you entered is more than you have in stock", "center");
          }
        }
        if(!isNaN(cost) && !isNaN(quant)){
            var total = cost * quant;
            var discount = Number($(".discount_sell_sales").val());
            total = total - discount;
            $(".total_sell_sales").val(total.toFixed(2));
            var taxes = Number($(".taxes-sales").val().trim());
            if(taxes != "" || taxes == 0){
              if(!isNaN(taxes)){
                var taxAmt = (taxes/100) * total;
                var aftCost = total + taxAmt;
                $(".afterTax_sales").val(aftCost.toFixed(2));
              }
            }
        }
    },
    calculateQuantity2: function(){
      var self = this;
      var total = Number($(".total_sell_sales").val());
            var taxes = Number($(".taxes-sales").val().trim());
            
            if(taxes != "" || taxes == 0){
              if(!isNaN(taxes)){
                var taxAmt = (taxes/100) * total;
                var aftCost = total + taxAmt;
                $(".afterTax_sales").val(aftCost.toFixed(2));
              }
            }else{
              $(".afterTax_sales").val(total.toFixed(2)); 
            }
    },
    moneyFormat: function(val){
      var self = this;           
      var sym = self.settings == null ? "" : self.settings.currency;
      sym = sym == undefined ? "" : sym;
      if(val < 0){
        var rev = 0 - val;
        var val2 = val + rev + rev;
        val = val2;
        sym = "-" + sym;
      }
      var ret = sym + val.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
      return ret;
    },
    formatPDF: function(sales, children){//product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date
      var self = this;
      $(".shareLinkButton").attr("data-id", sales.id);
      var settings = self.$app.data.settings;
      var Companyname = settings == null ? "" : settings.name;
      var Comaddress = (settings != null && settings.address != null) ? settings.address.split("\n").join("<br>") : "";
      var buyer = sales.clientName;
      var productName = sales.productName;
      var curr = settings == null ? "" : settings.currency;
      var quant = sales.quantity == null ? 1 : sales.quantity;
      var discount = sales.discount == null ? 0 : sales.discount;
      discount = discount;
      var cost = sales.sellingPrice;
      var totalPrice = sales.totalPrice;
      //var totalPrice = self.moneyFormat(tPrice);
      var totalPaid = sales.amountPaid;
      var afterTax = sales.afterTaxPrice == null ? totalPrice : sales.afterTaxPrice;
      var outstanding = (Number(afterTax) - Number(sales.amountPaid));
      var taxAmount = sales.afterTaxPrice - sales.totalPrice;
      var tax = sales.taxes == null ? 0 : sales.taxes;
      var purchaseDate = moment(sales.createdDate).format("LLL");
      var paymentDate =  (sales.datePaid == "" || sales.datePaid == null) ? "" : moment(sales.datePaid).format("LLL");
      var today = moment().format("LLL");
      var isEstimate = sales.isEstimate;
      var totalDiscount = 0;
      var invoiceLabel = isEstimate == true ? "Estimate" : (sales.isPaid ? "Receipt" : "Invoice");
      $(".downloadInvoiceButton").text("Download " + invoiceLabel);
      //var invoiceLabel = isEstimate == true ? "Estimate" : "Invoice";

      /*new pdf*/


      var logo = "";
        if(settings != null && settings.logo != null){
          var logoLink = settings.logo;
          $(".brandLogoReceipt").attr("src", logoLink);
        }

        $(".brandNameReciept").text(Companyname);
        $("#addressLabel").html(Comaddress);
        $("#invoiceLabel").text(invoiceLabel.toUpperCase());
        $("#addressLabel").html(Comaddress);
        $("#buyerName").text(buyer);
        $(".taglineReceipt").text(settings?.tagline);

        var docDetails = "<div>";
        docDetails += "<div class='eachLine'><div class='margin-right'><h2 class='text-color-green receiptLabel no-margin-top margin-bottom-half'>" + invoiceLabel + "</h2></div ><div></div></div>";
        docDetails += "<div class='eachLine'><div class='invoiceLabel margin-right'>" + invoiceLabel + " No" + "</div><div>" + sales.id + "</div></div>";
        docDetails += "<div class='eachLine'><div class='invoiceLabel margin-right'>" + invoiceLabel + " Date" + "</div><div>" + purchaseDate + "</div></div>";
        if (sales.isEstimate == false) {
            docDetails += "<div class='eachLine'><div class='invoiceLabel margin-right'>" + "Payment Date" + "</div><div>" + paymentDate + "</div></div>";
            docDetails += "<div class='eachLine'><div class='invoiceLabel margin-right' style='font-size:1.1em'>Amount Due</div><div style='font-size:1.1em'>" + self.formatMoney(outstanding) + "</div></div>";
        }
        docDetails += "</div>";
        $(".docDetails").html(docDetails);

      //try{
        //if(pdf != undefined){
              var html = "";

              if(children.length > 0){
                  for(var i = 0; i < children.length; i++){
                    var each = children[i];
                    html += '<tr><td>' + each.productName + '</td><td>' + each.quantity + '</td>';
                    html += '<td class="hideOnMobile">' + self.formatMoney(each.sellingPrice) + '</td>';
                    html += '<td class="hideOnMobile">' + self.formatMoney(each.discount) + '</td>';
                    html += '<td>' + self.formatMoney(each.totalPrice) + '</td></tr>';
                    totalDiscount += Number(each.discount);
                  }
              }else{
                  html += '<tr><td>' + productName + '</td><td>' + quant + '</td>';
                  html += '<td class="hideOnMobile">' + self.formatMoney(cost) + '</td>';
                  html += '<td class="hideOnMobile">' + self.formatMoney(discount) + '</td>';
                  html += '<td>' + self.formatMoney(totalPrice) + '</td></tr>';
                  totalDiscount += Number(discount);
              }

              $("#invoiceTable tbody").html(html);
            
            
            html = "";
            
            /*if(tax != 0 || afterTax != totalPrice){
              html += '<tr><td><span style="font-weight:600">Price Before Tax: </span></td><td><span>' + self.formatMoney(totalPrice) + '</span></td></tr>';
              html += '<tr><td><span style="font-weight:600">Tax: </span></td><td><span>' + tax + '%</span></td></tr>';
              html += '<tr><td><span style="font-weight:600">Price After Tax: </span></td><td><span>' + self.formatMoney(afterTax) + '</span></td></tr>';
            }else{
              html += '<tr><td><span style="font-weight:600">Total Price: </span></td><td><span>' + self.formatMoney(totalPrice) + '</span></td></tr>';
            }*/

            if (tax != 0 || afterTax != totalPrice) {
                html += '<tr><td><span class="">Subtotal</span></td><td class="totalRight"><span>' + self.formatMoney(totalPrice) + '</span></td></tr>';
                html += '<tr><td><span class="">Discount</span></td><td class="totalRight"><span class="">' + self.formatMoney(totalDiscount) + '</span></td></tr>';
                html += '<tr><td><span class="text-muted">Tax ' + tax + '%</span></td><td class="totalRight"><span class="text-muted">' + self.formatMoney(taxAmount) + '</span></td></tr>';
                html += '<tr class="text-color-green"><td><span>Total </span></td><td class="totalRight"><span class="font-weight-bold">' + self.formatMoney(afterTax) + '</span></td></tr>';
            } else {
                html += '<tr class="text-color-green"><td><span>Total </span></td><td class="totalRight"><span class="font-weight-bold">' + self.formatMoney(afterTax) + '</span></td></tr>';
            }

            if (sales.amountPaid != null) {
                html += '<tr><td><span class="">Paid</span></td><td class="totalRight"><span class="">' + self.formatMoney(sales.amountPaid) + '</span></td></tr>';
            }
            
            /*if(sales.isEstimate == false){
              html += '<tr><td><span style="font-weight:600">Amount Paid: </span></td><td><span>' + self.moneyFormat(totalPaid) + '</span></td></tr>';
              html += '<tr><td><span style="font-weight:600">Outstanding: </span></td><td><span>' + self.moneyFormat(outstanding) + '</span></td></tr>';
              html += '<tr><td><span style="font-weight:600"">Purchase Date: </span></td><td><span>' + purchaseDate + '</span></td></tr>';
              html += '<tr><td><span style="font-weight:600"">Payment Date: </span></td><td><span>' + paymentDate + '</span></td></tr>';
            }*/

            $("#invoiceTableSum tbody").html(html);
            var widthAbove = $("#invoiceTable thead th").eq($("#invoiceTable thead th").length - 2).outerWidth();
            $("#invoiceTableSum tbody td").eq(0).css("width", widthAbove + "px");
            var widthAbove2 = $("#invoiceTable thead th").eq($("#invoiceTable thead th").length - 1).outerWidth();
            $("#invoiceTableSum tbody td").eq(1).css("width", widthAbove2 + "px");
            
            
            
            
            var tagline = "";
            /*if(self.$app.settings != null){
              if(settings != null && settings.tagline != null && settings.tagline != undefined && settings.tagline != ""){
                var lines = settings.tagline.split("\n");
                tagline += "<div style='margin-bottom:5px; margin-top:5px;font-weight:500;font-size:0.8em;'>";
                for(var v = 0; v < lines.length; v++){
                  tagline += "<div>" + lines[v] + "</div>";
                }
                tagline += "</div>";
                //tagline = "<div><span>" + self.settings.tagline.split("\n").join("<br>") + "</span></div>";
              }else{
                tagline = "<div><span style='margin-bottom:5px; margin-top:5px;font-weight:500;font-size:0.8em;'>Thank you!</span></div>";
              }
            }else{
              tagline = "<div><span style='margin-bottom:5px; margin-top:5px;font-weight:500;font-size:0.8em;'>Thank you!</span></div>";
            }*/
            //var tagline = self.settings.tagline == "" ? "<h3 style='margin-bottom:5px; margin-top:5px;'>Thank you!</h3>" : "<h4 style='margin-bottom:5px; margin-top:5px;'>" + self.settings.tagline.split("\n").join("<br>") + "</h4>";
            var signature = "";
            if(settings != null && settings.signature != null){
              var signatureLink = settings.signature;
              signature = "<img src='" + signatureLink + "' style='max-width:100px'/>";
            }

            var mainColor = "#673ab7";
            if(settings != null && settings.primaryColor != null){
              mainColor = settings.primaryColor;
            }
            $("#invoiceTable thead").css("background", mainColor);
            $(".brandNameReciept").css("color", mainColor);

            html = "";
            html += '<div class="margin-top">' + tagline + signature + '<h6 class="my-2">' + today + '</h6></div>';
            
            //html += '<div style="text-align:left;clear:both;border-top: 1px solid darkgray;border-bottom: 1px solid darkgray;">' + tagline  + signature + '<h5 style="margin-bottom:5px; margin-top:5px;">' + today + '</h5></div>';
            html += '</div>';
            if(settings != null && settings.termsConditions != undefined && settings.termsConditions != ""){
              html += "<div style='text-align:center;margin-top:10px;'>";
              html += "<div>Terms and Conditions</div>";
              html += "<div>" + settings.termsConditions + "</div>";
              html += "</div>";
            }

            $("#signatureHolder").html(html);
            $(".downloadButton").removeClass("d-none");
      
    },
    permDeleteSale: function(list, id){
        var self = this;
        
        self.$app.dialog.confirm("Are you sure you want to permanently delete this sale?", "Omni", function(){
              mogulsheetdb.get(id).then(function(doc) {
                    doc.status = -1
                    return mogulsheetdb.put(doc);
                  }).then(function(){
                self.sales = self.sales.filter(function(e){ 
                      return e._id != id;
                  });

                  mogulsheetdb.find({
                    selector: {
                      parentID: {$eq: id},
                      saleID: {$gt: 0},
                      status: {$gte: null},
                      _id: {$gte: null}
                    }
                  }).then(function(ar){
                    var arr = ar.docs;
                          arr.forEach((element, index) => {
                          arr[index].status = -1;
                      });
                      mogulsheetdb.bulkDocs(arr).then(function(){
                        //dbSales.bulkDocs(bigData);
                      })
                    })
                  self.showToast("Sale permanently deleted", "center", true);
                  self.$setState({
                      sales:self.sales
                  }, function(){
                      self.showToast("Sale permanently deleted!", "center", true);
                      list.remove("id", id);
                      self.setDataTable();
                      self.calculateTotalMoney();
                  });
            }).catch(function(){
              self.showToast("An error occured, please try again", "center");
            })
        });
    },
    deleteSale: function(list, id){
        var self = this;
        var checked = false;
        var text = "delete";
        /*var oldSale = null, newSale = null;
        var toggle = self.$app.toggle.get(".showInactiveSales");
        if(toggle != undefined){
            if(toggle.checked){
                text = "activate";
                checked = 1;
            }
        }*/
        self.$app.dialog.confirm("Are you sure you want to " + text + " this sale?", function(){
          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("sales/DeleteSales?id=" + id)).then(function( data, textStatus, jqXHR ) {
            self.$app.preloader.hide();
            if(data != null){
              self.sales = self.sales.filter(function(e){ 
                      return e.id != id;
                  });
                  self.$setState({
                      sales:self.sales
                  }, function(){
                      self.showToast("Sale " + "deleted!", "center", true);
                      list.remove("id", id);
                      self.setDataTable();
                      self.calculateTotalMoney();
                  });
            }
          
          }).catch((err) => {
            self.$app.preloader.hide();
            self.showToast("An error occurred", "center");
          })
          
          
         /* mogulsheetdb.get(id).then(function(doc) {
                    oldSale = $.extend(true, {}, doc);
                    doc.status = checked;
                    newSale = $.extend(true, {}, doc);
                    return mogulsheetdb.put(doc);
                  }).then(function(){
                if(oldSale.isParent == undefined || oldSale.isParent == 0){
                  
                  if(oldSale.productID_saleID != 0 && oldSale.productID_saleID != undefined){
                        var prodArr = [];
                        
                        prodArr.push(oldSale.productID_saleID);
                        self.findDifferenceInSales(prodArr, oldSale, newSale);
                      }
                }
                
                var oppCheck = checked == 1 ? 0 : 1;
                mogulsheetdb.find({
                    selector: {
                      $and: [
                        { status: {$eq: oppCheck}},
                        {parentID: {$eq: id}},
                        {saleID: {$gt: 0}},
                        {_id: {$gte: null}}
                      ]
                    }
                  }).then(function(ar){
                    var arr = ar.docs;
                          arr.forEach((element, index) => {
                          arr[index].status = checked;
                      });
                      mogulsheetdb.bulkDocs(arr).then(function(){
                        //dbSales.bulkDocs(bigData);
                        //is deleted
                        var oldMaster = null, newMaster = null;
                        if(checked == 0){
                          oldMaster = arr;
                          newMaster = [];
                        }else if(checked == 1){
                          newMaster = arr;
                          oldMaster = [];
                        }
                        if(oldMaster != null && newMaster != null){
                          self.findDifferenceMultiple(oldMaster, newMaster);
                        }
                      })
                    }).catch((err) => {
                      
                    })

                self.sales = self.sales.filter(function(e){ 
                      return e.id != id;
                  });
                  var act = checked == 0 ? "deleted!" : "activated!";
                  self.showToast("Sale " + act, "center", true);
                  self.$setState({
                      sales:self.sales
                  }, function(){
                      self.showToast("Sale " + text + "d!", "center", true);
                      list.remove("id", id);
                      self.setDataTable();
                      self.calculateTotalMoney();
                  });
            }).catch(function(){
              self.showToast("An error occured, please try again", "center");
            })*/
        });
    },
    showToast: function(text, position, icon = false){
        var self = this;
        self.$app.toast.create({
          icon: icon ? '<i class="f7-icons">checkmark_alt_circle</i>' : '',
          text: text,
          position: position,
          closeTimeout: 2000,
          }).open();
    },
    closeUpdatePopUp: function(){
        var self = this;
        $("#paid-calendar-modal-sales").next("span").click();
        $("#purchase-calendar-modal-sales").next("span").click();
        $$("input.buyer_sell_sales, input.amountpaid_sell_sales, .hiddenQuantitySingle, .quantity_sell_sales, .total_sell_sales, #productID_sell").val("");
        var popup = self.$app.popup.close('.newSales', true);
    },
    updateDataSell: function(){
        var self = this;
        /*if(self.currentSale == null){
            return;
        }*/
      //var $$ = this.Dom7;
      var self = this;
      var checked = 0;
      var isPaidDate = null;
      var isEstimate = $(".isEstimateSales").prop("checked");
      if($("#purchase-calendar-modal-sales").val().trim() == ""){
        self.showToast("Please pick date of purchase", "center");
        return;
      }
      if($(".name_sell_sales").val().trim() == ""){
        self.showToast("Please enter product name", "center");
        return;
      }
      if($(".buyer_sell_sales").val().trim() == ""){
        self.showToast("Please enter buyer's name", "center");
        return;
      }
      if($(".cost_sell_sales").val().trim() == ""){
        self.showToast("Please enter selling price", "center");
        return;
      }
      if(($("#paid-calendar-modal-sales").val().trim() == "") && ($$("input.amountpaid_sell_sales").val() != "0" && $$("input.amountpaid_sell_sales").val().trim() != "")){
          self.showToast("Please choose date buyer paid!", "center");
          return;
      }
      if(($$("input.amountpaid_sell_sales").val() == "0" || $$("input.amountpaid_sell_sales").val().trim() == "") && isEstimate == false){
          self.$app.dialog.confirm("Do you want to record the purchase without a payment made?", "Omni", function(){
            $$("input.amountpaid_sell_sales").val(0);
            self.processPaymentUpdate();
          })
      }else{
        self.processPaymentUpdate();
      }
        //self.processPaymentUpdate();
      
    },
    processPaymentUpdate: function(){
      var self = this;
      var cp = $$("input.afterTax_sales").val();
      var sp = $$("input.amountpaid_sell_sales").val();
      var fullyPaid = 0;
      if(Number(sp) >= Number(cp)){
        fullyPaid = true;
      }else{
          fullyPaid = false;
      }
      var isPaidDate = moment($("#paid-calendar-modal-sales").val()).format();
      var isEstimate = $(".isEstimateSales").prop("checked");
      var taxes = $$("input.taxes-sales").val();
      taxes = taxes.trim() == "" ? 0 : Number(taxes.trim());
      var chosenUser = $$("input.buyer_sell_sales").val();
      var theBuyerID = null;
      var theBuyerName = null;
      //new buyer
        if(self.currentSale == null){
          //selected name from dropdown
          if(chosenUser == selectedUserName){
          theBuyerID = selectedUserID;
          theBuyerName = selectedUserName;
          self.saveProcessedPayement(theBuyerID, theBuyerName, taxes, isEstimate, fullyPaid, isPaidDate);
        }else{
          //new user new sale
          var obj = {
                name: chosenUser
            }
            $.when(self.$app.methods.postDataAPI("clients/SaveClient", obj, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data != null){
                  self.showToast("New User Created.", "center", true);
                    self.saveProcessedPayement(data, chosenUser, taxes, isEstimate, fullyPaid, isPaidDate);
                }
            });
          }
      }else{
        //editing old sale
        if(selectedUserName != null && selectedUserID != null && selectedUserName == chosenUser){
          self.saveProcessedPayement(selectedUserID, selectedUserName, taxes, isEstimate, fullyPaid, isPaidDate);
        }else{
          var buyerid = self.currentSale.clientId == undefined ? null : self.currentSale.clientId;
          self.saveProcessedPayement(buyerid, chosenUser, taxes, isEstimate, fullyPaid, isPaidDate);
        }
      }

       
    },
    saveProcessedPayement: function(theBuyerid, theBuyername, taxes, isEstimate, fullyPaid, isPaidDate){
      var self = this;
      var productId = $("#productID_sell").val();
      var quantitySold = $$("input.quantity_sell_sales").val();
      var obj = {
                //id: Number(self.currentSale.id),
                productName: $$("input.name_sell_sales").val(),  
                //buyer_name: theBuyername,
                clientId: theBuyerid,
                sellingPrice: $$("input.cost_sell_sales").val(),
                taxes: taxes,
                parentID: 0,
                isParent:false,
                productId: productId,
                isEstimate: isEstimate,
                discount: $(".discount_sell_sales").val(),
                afterTaxPrice: $$("input.afterTax_sales").val(),
                quantity: quantitySold,
                totalPrice: $$("input.total_sell_sales").val(),
                amountPaid: $$("input.amountpaid_sell_sales").val(),
                isPaid: fullyPaid,
                datePaid: isPaidDate,
                createdDate: moment($("#purchase-calendar-modal-sales").val()).format(),
                status:true
              };
              if(self.currentSale != null){
                obj.id = self.currentSale.id;
              }

              self.$app.preloader.show();
              //console.log("sale", obj);
            $.when(self.$app.methods.postDataAPI("sales/UpdateSales", obj, true)).then(function( data, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                self.showToast("Product sale updated!", "center", true);
                    $("#paid-calendar-modal-sales").next("span").click();
                    $("#purchase-calendar-modal-sales").next("span").click();
                    $$("input.buyer_sell_sales, input.amountpaid_sell_sales, .hiddenQuantitySingle, #purchase-calendar-modal-sales, #paid-calendar-modal-sales, .quantity_sell_sales, .total_sell_sales, .discount_sell_sales").val("");
                    
                    selectedUserID = null;
                    selectedUserName = null;
                    self.$setState({
                            currentSale: null
                        });
                    var popup = self.$app.popup.close('.newSales', true);
                    popup.once("closed", function(){
                      self.getData();
                  });

            }).catch((err) => {
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })

            /*mogulsheetdb.put(obj).then(function(){
                    self.showToast("Record saved!", "center", true);
                    $("#paid-calendar-modal-sales").next("span").click();
                    $("#purchase-calendar-modal-sales").next("span").click();
                    $$("input.buyer_sell_sales, input.amountpaid_sell_sales, .hiddenQuantitySingle, #purchase-calendar-modal-sales, #paid-calendar-modal-sales, .quantity_sell_sales, .total_sell_sales, .discount_sell_sales").val("");
                    self.$app.popup.close('.newSales', true);
                    selectedUserID = null;
                    selectedUserName = null;

                    //reduce stock for edit sales
                    if(productId != 0 && self.currentSale != null){
                      var prodArr = [];
                      prodArr.push(productId);
                      self.findDifferenceInSales(prodArr, self.currentSale, obj);
                    }


                    //reduce stock for new sale
                    if(productId != 0 && isEstimate == 0 && self.currentSale == null){
                    mogulsheetdb.get(productId).then((dat) => {
                      if(dat.stock != undefined && dat.stock != "undefined" && dat.stock != "Unlimited"){
                        var floatStock = parseFloat(dat.stock);
                        if(!isNaN(floatStock)){
                          var remain = floatStock - Number(quantitySold);
                          if(!isNaN(remain)){
                            dat.stock = remain;
                            return mogulsheetdb.put(dat).then((dt) => {
                              //self.getData();
                            })
                          }
                        }
                      }
                    }).catch((err) => {

                    })
                  }


                    self.getData();
                    self.$setState({
                            currentSale: null
                        });
                 // });
                  
              }).catch(function (error) {
                 self.$app.dialog.alert("An error occurred!", "Omni");
              })*/
    },
    shareInvoiceLink: function(){
      var self = this;
      var item = $(".shareLinkButton").eq(0).attr("data-id");
      var share = self.$app.data.siteUrl + "Invoice/" + self.$app.data.settings.businessUrl + "/" + item;
      copy(share);
      self.$app.dialog.alert("Link copied to clipboard", "Omni");
    },
    showPDF: function(){
      var self = this;
      self.$app.preloader.show();
      var element = document.getElementById("showInvoice");
          var opt = {
            margin:[0,0,0,0],
            filename: "document.pdf",
            html2canvas: { scale: 1, useCORS: true },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
            useCORS: true
          };
          
          // New Promise-based usage:
          html2pdf().set(opt).from(element).save().then(function(){
            self.$app.preloader.hide();
          }).catch(function(){
            self.$app.preloader.hide();
          });
    },
    invoice: function(id){
      var self = this;
      //self.$app.preloader.show();
      //self.loadImages();
      /*var item = self.sales.find(function(e){ 
                  return e.id == id;
              });*/
              var children = [];
              //if(item.isParent == true){
                self.$app.preloader.show();
                $.when(self.$app.methods.getDataAPI("sales/GetSaleByID?id=" + id)).then(function( doc, textStatus, jqXHR ) {
                    self.$app.preloader.hide();
                    //self.formatPDF(doc.parent, doc.children);
                    /*self.$setState({
                        invoiceHtml:html,
                        invoiceItem:doc.parent
                    });*/
                    /*var $iframe = $('#showInvoice');
                    $iframe.ready(function() {
                        $iframe.contents().find("html").html(html);
                    });*/
                    //load data into popup

                    //load data into popup
                    
                      self.openPreviewInvoice(doc);
                    //self.showPDF(html, item);
                }).catch((err) => {
                  self.$app.preloader.hide();
                  self.showToast("An error occurred", "center");
                })
              
    },
    findDifferenceMultiple: function(oldMaster, newMaster){
      var self = this;
      var saveBigdata = [];
      //check from old file
      $.each(oldMaster, ((ind, val) => {
        if(val.productID_saleID != undefined && val.productID_saleID != 0){
          var findInNew = newMaster.find(x => x.productID_saleID == val.productID_saleID);
          if(findInNew != null && findInNew != undefined){
            var left = parseFloat(findInNew.quantity) - parseFloat(val.quantity);
            var obj = {};
            obj._id = val.productID_saleID;
            obj.stock = left;
            saveBigdata.push(obj);
          }else{
            var obj = {};
            obj._id = val.productID_saleID;
            obj.stock = 0 - parseFloat(val.quantity);
            saveBigdata.push(obj);
          }
        }
      }))

      //check from new file
      $.each(newMaster, ((ind, val) => {
        if(val.productID_saleID != undefined && val.productID_saleID != 0){
          var findInSaved = saveBigdata.find(x => x._id == val.productID_saleID);
          if(findInSaved == null || findInSaved == undefined){
            //var left = parseFloat(findInNew.quantity) - parseFloat(val.quantity);
            var obj = {};
            obj._id = val.productID_saleID;
            obj.stock = parseFloat(val.quantity);
            saveBigdata.push(obj);
          }
        }
      }))

      //product ids
      var checkAllProducts = saveBigdata.map(x => x._id);
      var finalSaving = [];
      //adjust products
      mogulsheetdb.find({
          selector: {
            _id: { $in: checkAllProducts },
            productID: {$gt: 0},
            status: {$gt: 0}
          },
          sort: [{'_id': 'desc'}]
        }).then((arr) => {
          //adjust from db
          var ar = arr.docs;
          $.each(ar, function(ind, dat){
                if(dat.stock != undefined && dat.stock != "undefined" && dat.stock != "Unlimited"){
                  var finding = saveBigdata.find(x => x._id == dat._id);
                  if(finding != null){
                    var sub = finding.stock;
                    var left = parseFloat(dat.stock) - sub;
                    if(!isNaN(left)){
                      dat.stock = left;
                      finalSaving.push(dat);
                    }
                    
                  }
                }
            })
            if(finalSaving.length > 0){
              mogulsheetdb.bulkDocs(finalSaving).then((dat) => {

              }).catch((err) => {
                console.log("save err", err);
              })
            }
        })
    },
    findDifferenceInSales: function(prodIDs, oldProd, newProd){
      var self = this;
      mogulsheetdb.find({
          selector: {
            _id: { $in: prodIDs },
            productID: {$gt: 0},
            status: {$gt: 0}
          },
          sort: [{'_id': 'desc'}]
        }).then((arr) => {
          var ar = arr.docs;
          var saveBigData = [];
          $.each(ar, function(ind, dat){
                if(dat.stock != undefined && dat.stock != "undefined" && dat.stock != "Unlimited"){
                  //it was an estimate
                    if((oldProd.isEstimate != newProd.isEstimate)){
                        var left = 0;
                        if(oldProd.isEstimate == 1 && newProd.isEstimate == 0){
                          left = parseFloat(dat.stock) - parseFloat(newProd.quantity);
                          dat.stock = left;
                        }else if(oldProd.isEstimate == 0 && newProd.isEstimate == 1){
                          left = parseFloat(dat.stock) + parseFloat(oldProd.quantity);
                          dat.stock = left;
                        }
                        saveBigData.push(dat);
                        
                        //the quantity has changed
                    }else if(parseFloat(oldProd.quantity) != parseFloat(newProd.quantity)){
                        var left = parseFloat(newProd.quantity) - parseFloat(oldProd.quantity);
                        dat.stock = parseFloat(dat.stock) - left;
                        saveBigData.push(dat);

                        //deleted or activated
                    }else if(oldProd.status != newProd.status){
                      if(oldProd.status == 1 && newProd.status == 0){
                        var left = parseFloat(oldProd.quantity);
                        var subt = parseFloat(dat.stock) + left;
                        console.log("diff", left, subt);
                        if(!isNaN(subt)){
                          dat.stock = subt;
                          saveBigData.push(dat);
                        }
                      }else if(oldProd.status == 0 && newProd.status == 1){
                        var left = parseFloat(oldProd.quantity);
                        var subt = parseFloat(dat.stock) - left;
                        if(!isNaN(subt)){
                          dat.stock = subt;
                          saveBigData.push(dat);
                        }
                      }

                    }

                  }
              })
              if(saveBigData.length > 0){
                mogulsheetdb.bulkDocs(saveBigData).then((dat) => {
                }).catch((err) => {
                  console.log("save error", err);
                })
              }

        })
    },
    openPopUpUpdateSellProduct: function(id){
        /*if(id == null){
            return;
        }*/
        var self = this;
        $(".hiddenQuantitySingle").val("");
        //popup.once("opened", function(){
          if(id != null || id != undefined){
            var item = self.sales.find(function(e){ 
                  return e.id == id;
              });
                $$("input.name_sell_sales").val(item.productName);
                $$("input.buyer_sell_sales").val(item.clientName);
                $$("input.cost_sell_sales").val(item.sellingPrice);
                var productID = item.productId;
                $("#productID_sell").val(productID);
                if(productID != ""){
                  $.when(self.$app.methods.getDataAPI("products/GetProductByID?id=" + productID)).then(function( dats, textStatus, jqXHR ) {
                    if(dats.stock != undefined){
                      $(".hiddenQuantitySingle").val(dats.stock);
                    }
                  })
                }
                var quantity = item.quantity == null ? 1 : item.quantity;
                  var total = item.totalPrice;
                  var taxes = item.taxes;
                  var taxesAmt = taxes == undefined ? 0 : taxes;
                  taxesAmt = Number(taxesAmt);
                  total = Number(total);
                  var discount = item.discount == null ? 0 : item.discount;
                  var afterTax = item.afterTaxPrice == undefined ? total : item.afterTaxPrice;
                  $(".quantity_sell_sales").val(quantity);
                  $(".taxes-sales").val(taxesAmt);
                  $(".afterTax_sales").val(afterTax);
                  $(".discount_sell_sales").val(discount);
                  $(".total_sell_sales").val(total.toFixed(2));
                  if(item.isEstimate != undefined && item.isEstimate != null){
                    var est = item.isEstimate;
                    $(".isEstimateSales").prop("checked", est);
                  }else{
                    $(".isEstimateSales").prop("checked", false);
                  }
                $$("input.amountpaid_sell_sales").val(item.amountPaid);
                if(item.createdDate != ""){
                  var myDate = moment(item.createdDate).format("LLL");
                  $("#purchase-calendar-modal-sales").val(myDate);
                }
                if(item.datePaid != ""){
                  var myDate = moment(item.datePaid).format("LLL");
                  $("#paid-calendar-modal-sales").val(myDate);
                }
                var popup = self.$app.popup.open('.newSales', true);
                self.$setState({
                    currentSale: item
                });
            }else{
                $$("input.name_sell_sales").val("");
                $$("input.buyer_sell_sales").val("");
                $$("input.cost_sell_sales").val("");
                $("#productID_sell").val("");
                var taxes = self.$app.settings == null ? 0 : self.$app.settings.taxes;
                var taxesAmt = taxes == undefined ? 0 : taxes;
                $(".quantity_sell_sales").val("1");
                $(".discount_sell_sales").val(0);
                $(".taxes-sales").val(taxesAmt);
                $(".afterTax_sales").val("0");
                $$("input.amountpaid_sell_sales").val(0);
                $("#paid-calendar-modal-sales").val(moment().format('LLL'));
                $("#purchase-calendar-modal-sales").val(moment().format('LLL'));
                var popup = self.$app.popup.open('.newSales', true);
                self.$setState({
                    currentSale: null
                });
            }
        //})
        
    },
    calculateTotalMoney: function(){
        var self = this;
        var totalPaid = 0;
        var totalUnpaid = 0;
        var totalMoney = 0;
        $.each(self.sales, function(index,item){
            if(item.amountPaid != 0 && item.amountPaid != ""){
                totalPaid += Number(item.amountPaid);
            }
            if(Number(item.amountPaid) < Number(item.afterTaxPrice)){
                totalUnpaid += 1;
            }
            var totalP = item.afterTaxPrice == null ? item.totalPrice : item.afterTaxPrice;
            if(!isNaN(totalP)){
              totalMoney += Number(totalP);
            }
            
        })
        var diff = totalPaid - totalMoney;
        totalMoney = self.formatMoney(totalMoney);
        totalPaid = self.formatMoney(totalPaid);
        diff = self.formatMoney(diff);
        self.$setState({
            totalMoney: totalMoney,
            totalPaid: totalPaid,
            totalUnpaid: totalUnpaid,
            totalDifference: diff,
            totalMat: self.sales.length
        });
    },
    resetTable: function(){
        var self = this;
        self.getData();
    },
    showCalendarPopup: function(){
        var self = this;
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal',
            openIn: 'sheet',
            header: true,
            footer: true
        });
      },
    openPopUp: function(id){
        var self = this
        
    },
    closePopUp: function(){
        var self = this;
        var popup = self.$app.popup.close('.showCalendar', true);
        popup.once("closed", function(){

        });
    },
    getClients: function(){
        var self = this;
        $.when(self.$app.methods.getDataAPI("clients/GetClients")).then(function( arr, textStatus, jqXHR ) {
          self.$setState({
                clients: arr
              })
        })
    },
    getProducts: function(){
        var self = this;
        $.when(self.$app.methods.getDataAPI("products/GetProducts")).then(function( arr, textStatus, jqXHR ) {
          self.$setState({
                products: arr
              })
        })
    },
    editMultiplePopUp: function(id){
        var self = this;
        self.openPopUpMultiple();
        var currChosen = null;

        self.$app.preloader.show();
        $.when(self.$app.methods.getDataAPI("sales/GetSaleByID?id=" + id)).then(function( doc, textStatus, jqXHR ) {
          self.$app.preloader.hide();
          var arr = doc.parent;
            var taxesAmt = arr.taxes;
            currChosen = arr;
            $(".groupProductNameMultiple_sales").val(arr.productName);
            if(self.sellToAnotherUser == null){
              $(".buyersNameMultiple_sales").val(arr.clientName);
              $(".amountPaidMultiple-sales ").val(arr.amountPaid);
              $(".multipleSales_sales:visible").find("#datePaidMultiple_sales").val(moment(arr.datePaid).format("LLL"));
              $(".multipleSales_sales:visible").find("#datePurchaseMultiple_sales").val(moment(arr.createdDate).format("LLL"));
              if(arr.isEstimate != null && arr.isEstimate != undefined){
                var est = arr.isEstimate;
                $(".isEstimateMultipleSales").prop("checked", est);
              }else{
                $(".isEstimateMultipleSales").prop("checked", false);
              }
            }else{
              $(".buyersNameMultiple_sales").val("");
              $(".amountPaidMultiple-sales ").val(0);
              $(".multipleSales_sales:visible").find("#datePaidMultiple_sales").val(moment().format("LLL"));
              $(".multipleSales_sales:visible").find("#datePurchaseMultiple_sales").val(moment().format("LLL"));
              $(".isEstimateMultipleSales").prop("checked", false);
            }
            $(".taxpercent-sales").val(taxesAmt);

            //children
            var child = doc.children;
            self.selectedOldProducts = [];
            self.$setState({
            currentMultipleSale: currChosen,
            selectedProducts: child
          }, function(){
              for(var i = 0; i < child.length; i++){
                if(child[i].isParent == true){
                  child[i].id = child[i].productID;
                  self.selectedOldProducts.push(child[i]);
                  self.SelectItemMultipleProducts(child[i]);
                }
                if(child[i].isParent == false){
                  self.AddNewProduct(child[i]);
                }
              }

              self.CalculateTotalProduct();
          })
        }).catch((err) => {
          self.$app.preloader.hide();
            self.showToast("error occured during saving", "center");
        })
    },
    openPopUpMultiple:function(){
      var self = this;
      self.$setState({
        currentMultipleSale: null
      })
      //self.getProducts();
      var selectedValues = null;
            var autocompleteStandaloneMultiple = self.$app.autocomplete.create({
              openIn: 'popup', //open in page
              openerEl: '#autocomplete-standalone-multiple-sales', //link that opens autocomplete
              multiple: true, //allow multiple values
              navbarColorTheme: 'col bg-color-white text-color-black',
              preloader: true, //enable preloader
              valueProperty: 'id', //object's "value" property name
              textProperty: 'name_price', //object's "text" property name
              popupCloseLinkText: 'Done',
              requestSourceOnOpen:true,
              source: function (query, render) {
                var autocomplete = this;
                autocomplete.preloaderShow();
                var results = self.products; //.map(a => a.name);
                //autocomplete.preloaderHide();
                var newResult = results;
                //render(results);
                if (query.length === 0) {
                  $.each(results, function(ind, val){
                      val["name_price"] = val["name"] + "\t" + " - " + self.formatMoney(val["sellingPrice"]);
                  })
                  autocomplete.preloaderHide();
                  render(results);
                  return;
                }
                
                if (query.length > 0) {
                  newResult = [];
                  // Find matched items
                  for (var i = 0; i < results.length; i++) {
                    if (results[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
                        results[i].name_price = results[i].name + "\t" + " - " + self.formatMoney(results[i].sellingPrice);
                        newResult.push(results[i]);
                      }
                  }
                  // Render items by passing array with result items
                  autocomplete.preloaderHide();
                  render(newResult);
                }
                render(newResult);
              },
              on: {
                change: function (value) {
                  
                 var itemText = [], inputValue = [];
                 selectedValues = value;
                },
                closed: function(){
                  if(selectedValues == null || selectedValues.length == 0){
                    return;
                  }
                  for(var i = 0; i < selectedValues.length; i++){

                    var found = self.selectedProducts.filter(x => x.id == selectedValues[i].id).length;
                    if(found < 1){
                      self.selectedProducts.push(selectedValues[i]);
                      self.SelectItemMultipleProducts(selectedValues[i]);
                    }
                  }

                  selectedValues = null;
                  //autocomplete.destroy();
                  self.CalculateTotalProduct();
                }
              }
        });
        var popup = self.$app.popup.open('.multipleSales_sales', true);
        var taxes = self.$app.data.settings == null ? 0 : self.$app.data.settings.taxes;
        var taxesAmt = taxes == undefined ? 0 : taxes;
        $(".taxpercent-sales").val(taxesAmt);
        $(".multipleSales_sales:visible").find("#datePaidMultiple_sales").val(moment().format('LLL'));
        $(".multipleSales_sales:visible").find("#datePurchaseMultiple_sales").val(moment().format('LLL'));
        //self.CalculateTotalProduct();
        
    },
    SelectItemMultipleProducts: function(select){//name,cost,status,created_date
      var self = this;
      var prod = self.products.find(x => x.id == select.productId);
      var stock = "Unlimited";
      if(prod != null){
        stock = prod.stock;
      }
      var name = select.productName == null ? "" : select.productName;
      if(name == ""){
        name = select.name == null ? "" : select.name;
      }
      var cost = select.sellingPrice == null ? "" : select.sellingPrice;
      var quantity = select.quantity == null ? 1 : select.quantity;
      var discount = select.discount == null ? 0 : select.discount;
      var chosenID = select.id;
      //var discount = 0;
      var totalPrice = select.totalPrice == null ? "" : select.totalPrice; 
       /* var html = '<li class="eachSaleParent_sales eachProduct_sales"><div class="card myCard"><div class="card-content padding-horizontal-half">';
          html += '<div><span class="labelName">Product Name: </span><div class="display-inline-flex"><input class="productName" type="text" placeholder="Product Name" value="';
          html +=  name + '"></div></div>';
          html += '<input type="hidden" class="productID" value="' + chosenID + '">';
          html += '<input type="hidden" class="hiddenQuantity" value="' + select.stock + '">';
          html += '<div class="row"><div class="col-50"><div class="item-content item-input no-padding-left"><div class="item-inner no-padding-right"><div class="labelName">Product Cost</div>';
          html += '<div class="item-input-wrap"><input class="productCost_sales" type="text" placeholder="Product Cost" value="' + cost + '">';
          html +=  '<span class="input-clear-button"></span></div></div></div></div>';
          html += '<div class="col-50"><div class="item-content item-input no-padding-left"><div class="item-inner no-padding-right"><div class="labelName">Quantity</div>';
          html += '<div class="item-input-wrap"><input class="productQuantity_sales" type="text" placeholder="Product Quantity" value="' + quantity + '">';
          html +=  '<span class="input-clear-button"></span></div></div></div></div></div>';
          html += '<div><span class="labelName">Discount: </span><div class="display-inline-flex"><input class="discount" type="text" placeholder="Discount" value="';
          html +=  discount + '"></div></div>';
          html += '<div><span class="labelName">Total Price: </span><div class="display-inline-flex"><input class="totalproductprice-sales" type="text" placeholder="Total Price" value="';
          html +=  totalPrice + '"></div></div>';
        html += '</div><div class="card-footerMine padding-horizontal-half padding-bottom-half"><p class="display-inline-flex no-margin-vertical">';
          html += '<a class="button button-small button-raised removeProduct" data-id="' + select._id + '">Delete</a>';
        html += '</p></div></div>'
        html += '</li>';*/


        var html = '<li class="eachSaleParent_sales eachProduct_sales margin-vertical"><div class="card myCard"><div class="card-content padding-horizontal padding-vertical">';
          html += '<div class="row"><div class="col-50"><div class="labelName">Product Name </div><input class="productName" type="text" placeholder="Product Name" value="';
          html +=  name + '"></div>';
          html += '<div class="col-50"><div class="labelName">Product Price</div><input class="productCost_sales" type="text" placeholder="Product Price" value="' + cost + '"></div>';
          html += '</div>';
          html += '<input type="hidden" class="productID" value="' + select.productId + '">';
          html += '<input type="hidden" class="hiddenQuantity" value="' + stock + '">';
          html += '<div class="row margin-top-half"><div class="col-50"><div class="labelName">Quantity</div><input class="productQuantity_sales" type="text" placeholder="Product Quantity" value="' + quantity + '"></div>';
          html += '<div class="col-50"><div class="labelName">Discount</div><input class="discount" type="text" placeholder="Discount" value="' + discount + '"></div>';
          html += '</div>';

          html += '<div class="row margin-top-half"><div class="col-50"><div class="labelName">Total Price: </div><input class="totalproductprice-sales" type="text" placeholder="Total Price" value="';
          html +=  totalPrice + '" disabled></div>';
          html += '<div class="col-50"><div>&nbsp</div><a class="button button-small removeProduct margin-top-half" data-id="' + select.id + '">Remove Product</a></div>';
          html += '</div>';
        html += '</div></div></li>';

        $("#products-list-sales .sortList").append(html);
        $(".eachSaleParent_sales .removeProduct").off("click").on("click", function(){
                  var id = $(this).attr("data-id");
                  $(this).parents(".eachSaleParent_sales").eq(0).remove();
                  Promise.resolve(self.RemoveItemProduct(id)).then(() => {
                    self.CalculateTotalProduct();
                  }); 
                })
                $(".eachSaleParent_sales input").off("keyup").on("keyup", function(){
                self.CalculateTotalProduct();
            })
                
    },
    RemoveItemProduct: function(id){
      var self = this;

        var select = self.selectedProducts.filter(function(e){ 
              return e.id != id;
          });
 
          //$(but).parents("li").eq(0).remove();
          self.$setState({
                //ings:self.ings,
                selectedProducts:select
            }, function(){

            });
    },
    closePopUpMultiple:function(){
      var self = this;
        var popup = self.$app.popup.close('.multipleSales_sales', true);
        popup.once("closed", function(){
          $(".multipleSales_sales .sortList li").remove();
          $(".buyersNameMultiple_sales").parents("li").eq(0).removeClass("bg-color-red");
          $(".totalAmountBeforeProfitProduct-sales, .totalAmountProduct-sales").text("0");
          $(".amountPaidMultiple-sales, .buyersNameMultiple_sales, .groupProductNameMultiple_sales").val("");
          $(".multipleSales_sales:visible").find("#datePaidMultiple_sales").next("span").click();
          $(".multipleSales_sales:visible").find("#datePurchaseMultiple_sales").next("span").click();
          selectedUserName = null;
          selectedUserID = null;
          //$("#datePaidMultiple_sales").val(moment().format('LLL'));
          //$("#datePurchaseMultiple_sales").val(moment().format('LLL'));
          self.$app.autocomplete.destroy("#autocomplete-standalone-multiple-sales");
            self.$setState({
                selectedProducts:[],
                sellToAnotherUser:null
              });
            self.getData();
        });
    },
    setDataTable: function(){
            var self = this;
            $("#sales-list .list").empty();//id,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status
            $("#sales-list .pagination").remove();         
            if(self.sales != null && self.sales.length > 0){

              var pagination = "<ul class='pagination padding-left-half margin-vertical-half'><ul>";
              $(pagination).insertAfter($("#sales-list .list"));

              var isDesktop = self.$app.methods.isDesktop();
              if(isDesktop){
                $("#sales-list ul.list").remove();

                  for(var i = 0; i < self.sales.length; i++){
                    var row = self.sales[i];
                        var isParent = row.isParent == null ? false : row.isParent;
                        var sellToOther = "";
                            if(isParent == true){
                              sellToOther = '<a class="button popover-close sellToOthers" data-id="' + row.id + '" data-isparent="' + isParent + '">Sell To Others</a>';
                            }
                        var quantity = row.quantity == null ? 1 : row.quantity;
                        var taxes = row.taxes == null ? 0 : row.taxes;
                        var total = row.totalPrice == null ? row.sellingPrice : row.totalPrice;
                        var afterTax = row.afterTaxPrice == null ? total : row.afterTaxPrice;
                        var type = row.isEstimate == true ? "Estimate" : (row.isPaid ? "Receipt" : "Invoice");
                        var paidInFull = row.isPaid == true ? '<span class="badge color-green paid padding-horizontal">Yes</span>' : '<span class="badge color-red paid padding-horizontal">No</span>';
                    var html = "<tr>";
                        html += '<td class="id" style="display:none;">' + row.id + '</td>';
                        html += "<td class='name'>" + row.productName + "</td>";
                        html += "<td>" + row.clientName + "</td>";
                        html += "<td>" + quantity + "</td>";
                        html += "<td><div class='cost display-none'>" + afterTax + "</div>" + self.formatMoney(afterTax) + "</td>";
                        html += "<td>" + self.formatMoney(row.amountPaid) + "</td>";
                        html += "<td class='isPaid'>" + paidInFull + "</td>";
                        html += "<td class='created_date'>" + moment(row.createdDate).format("LLL") + "</td>";
                        var pops = '<a href="#" data-popover=".sales-popover-' + i + '" class="popover-open"><i class="f7-icons">ellipsis_vertical</i></a>'
                                pops += '<div class="popover my-popover sales-popover sales-popover-' + i + '" data-close-on-escape="true" data-backdrop="false">'; 
                                pops += '<div class="popover-angle"></div><div class="popover-inner padding-half">';
                                  pops += '<a class="button popover-close invoice" data-id="' + row.id + '">' + type + '</a>';
                                  pops += sellToOther;
                                  pops += '<a class="button popover-close editSale" data-id="' + row.id + '" data-isparent="' + isParent + '">View / Edit</a>';
                                  pops += '<a class="button popover-close deleteSale" data-id="' + row.id + '">';
                                  pops += row.status == true ? 'Delete' : 'Activate';
                                  pops += '</a>';
                                  /*if(row.status == 0){
                                    pops += '<a class="button popover-close permDelButton" data-id="' + row._id + '">Delete</a>';
                                  }*/

                                pops += '</div></div>';
                                html += "<td>" + pops + "</td>";

                      html += "</tr>";
                      $("#sales-list tbody.list").append(html);
                  }

              }else{
                $("#sales-list .data-table").remove();

                $("#sales-list").find(".sortTextPar, .header_title").removeClass("display-none");
                        
                        $("#sales-list").find(".sort").remove();
                        var sorter = '<span class="sort" data-sort="name">Name</span><span class="sort" data-sort="cost">Cost</span>';
                        sorter += '<span class="sort" data-sort="isPaid">Fully Paid</span><span class="sort" data-sort="created_date">Purchase Date</span>';
                        $(sorter).insertAfter($(".sortText"));
                        $(".sortText").removeClass("display-none");
                        for(var i = 0; i < self.sales.length; i++){
                            var row = self.sales[i];
                            var isParent = row.isParent == null ? true : row.isParent;
                            var sellToOther = "";
                            if(isParent == true){
                              sellToOther = '<a class="button button-small button-raised sellToOthers" data-id="' + row.id + '" data-isparent="' + isParent + '">Sell To Others</a>';
                            }
                            var quantity = row.quantity == null ? 1 : row.quantity;
                            var taxes = row.taxes == null ? 0 : row.taxes;
                            var total = row.totalPrice == null ? row.cost : row.totalPrice;
                            var afterTax = row.afterTaxPrice == null ? total : row.afterTaxPrice;
                            var type = row.isEstimate == true ? "Estimate" : (row.isPaid ? "Receipt" : "Invoice");
                            var html = '<li><div class="card myCard"><div class="card-content padding-horizontal-half">';
                            html += '<div class="name cardName">' + row.productName + '</div><div class="id display-none">' + row.id + '</div><div class="cost display-none">' + afterTax + '</div>';
                            html += '<div class=""><span>Buyer\'s name: </span><span class="valueName buyer">' + row.clientName + '</span></div><div class="isPaid display-none">' + row.isPaid + '</div>';
                            html += '<div class="display-none"><span>Product Price: </span><span class="valueName">' + self.formatMoney(row.sellingPrice) + '</span></div>';

                            html += '<div class=""><span>Quantity: </span><span class="valueName">' + quantity + '</span></div>';
                            
                            if(row.discount != null && row.discount != 0){
                              html += '<div class=""><span>Discount: </span><span class="valueName">' + self.formatMoney(row.discount) + '</span></div>';
                            }
                            /*if(row.isEstimate != null && row.isEstimate != undefined && row.isEstimate > 0){
                              html += '<div class=""><span class="labelName">Estimate: </span><span class="valueName">' + row.isEstimate + '</span></div>';
                            }*/
                            if(taxes != 0 || total != afterTax){
                              html += '<div class="display-none"><span class="labelName">Tax: </span><span class="valueName">' + taxes + '%</span></div>';
                              html += '<div class=""><span>After Tax Price: </span><span class="valueName">' + self.formatMoney(afterTax) + '</span></div>';
                            }else{
                              html += '<div class=""><span>Total Price: </span><span class="valueName">' + self.formatMoney(total) + '</span></div>';
                            }
                            html += '<div class=""><span>Amount Paid: </span><span class="valueName">' + self.formatMoney(row.amountPaid) + '</span></div>';
                            var stat = row.status == true ? "display-none" : "";
                            var hidden =  "display-none";//row.isPaid == 1 ? "" : "display-none";
                            var checkbox = row.isPaid == true ? '<span class="badge color-green paid padding-horizontal">Yes</span>' : '<span class="badge color-red paid padding-horizontal">No</span>';
                            //var checkbox = row.isPaid == 1 ? '<i class="icon f7-icons text-color-green paid">checkmark_circle_fill</i>' : '<i class="icon f7-icons text-color-red paid">multiply_circle_fill</i>';
                            html += '<div class=""><span>Fully Paid: </span>' + checkbox + '</div>' + '<div class="display-none created_date">' + row.createdDate + '</div>';
                            html += '<div class="' + hidden + '"><span class="labelName">Date Fully Paid: </span><span class="valueName">' + moment(row.datePaid).format("LLL") + '</span></div>';
                            html += '<div class="display-none"><span class="labelName">Purchase Date: </span><span class="valueName">' + moment(row.createdDate).format("LLL") + '</span></div>';
                            html += '<div class="' + stat + '"><span class="labelName">Status: </span><span class="valueName">Deleted</span></div>';
                            html += '</div><div class="card-footerMine padding-horizontal-half padding-bottom-half"><p class="display-inline-flex no-margin-vertical">';
                            html += '<a class="button invoice button-small" data-id="' + row.id + '">' + type +'</a>';
                            html += sellToOther;
                            html += '<a class="button button-small editSale" data-id="' + row.id + '" data-isparent="' + isParent + '">View / Edit</a>';
                            html += '<a class="button button-small deleteSale" data-id="' + row.id + '">';
                            html +=  row.status == true ? 'Delete' : 'Activate'; 
                            html += '</a>';
                            /*if(row.status == 0){
                              html += '<a class="button button-small permDelButton" data-id="' + row._id + '">Delete</a>';
                            }*/
                            html += '</p></div></div>';
                            html += '</li>';
                            $("#sales-list .list").append(html);
                            //return html;
                        }
              }

                        
                        var options = {
                            valueNames: ['id','isPaid','buyer','created_date','cost','name'],
                            page: 10,
                            pagination: [{outerWindow:2}]
                        };

                        salesList = new List('sales-list', options);

                        $(".sort").off("click").on("click", function(){
                          $("#sales-list").find(".sort").find(".asc").remove();
                          $("#sales-list").find(".sort").find(".desc").remove();
                            if($(this).hasClass("asc")){
                              $(this).append("<i class='icon f7-icons asc text-color-red'>arrowtriangle_up_fill</i>");
                            }
                            if($(this).hasClass("desc")){
                              $(this).append("<i class='icon f7-icons desc text-color-red'>arrowtriangle_down_fill</i>");
                            }
                        })
                      
                          $('#sales-list, .sales-popover').off("click").on('click','.button', function () {
                              var data = $(this).attr("data-id");
                              
                              if($(this).hasClass("editSale")){
                                var isAParent = $(this).attr("data-isparent");
                                if(isAParent == "false"){
                                  self.openPopUpUpdateSellProduct(data);
                                }
                                if(isAParent == "true"){
                                  self.editMultiplePopUp(data);
                                }
                              }
                              if($(this).hasClass("invoice")){
                                self.invoice(data);
                              }
                              if($(this).hasClass("deleteSale")){
                                self.deleteSale(sales, data);
                              }
                              /*if($(this).hasClass("permDelButton")){
                                self.permDeleteSale(sales, data);
                              }*/
                              if($(this).hasClass("sellToOthers")){
                                self.$setState({
                                  sellToAnotherUser:1
                                }, function(){
                                  self.editMultiplePopUp(data);
                                });
                                
                                
                              }
                              //return false;
                          });
                          self.calculateTotalMoney();
                        }else{
                          //var html = "<li><div class='card myCard'><div class='card-content text-align-center'>No result found</div></div></li>";
                          //$("#sales-list .list").append(html);
                          self.calculateTotalMoney();
                        
                          salesList.clear();

                          $(".sortTextPar, .header_title").addClass("display-none");
                        }
    },
    formatMoney:function(val){             
      var self = this;   
      var ret = self.$app.methods.formatMoney(val);
      return ret;
    },
    startPouch: function(){
          var self = this;
          self.getData();
          self.getProducts();
          self.getClients();
          
        },
    loadImageLogo: function(item, arr){
      var self = this;
        dbSettingsImages.get('logoImage', {attachments: true}).then(function (blobOrBuffer) {
            // handle result
            self.loadImageSignature(item, arr, blobOrBuffer);
          }).catch(function (err) {
            self.loadImageSignature(item, arr, null);
          });       
    },
    loadImageSignature: function(item, arr, logoImage){
      var self = this;
        dbSettingsImages.get('signatureImage', {attachments: true}).then(function(signImage) {
          var html = self.formatPDF(item, arr, logoImage, signImage);
          self.$setState({
              invoiceHtml:html,
              invoiceItem:item
          });
          var $iframe = $('#showInvoice');
          $iframe.ready(function() {
              $iframe.contents().find("html").html(html);
          });
            self.openPreviewInvoice();
            self.$app.preloader.hide();
          //self.showPDF(html, item);    
            }).catch(function (err) {
              var html = self.formatPDF(item, arr, logoImage, null);
              self.$setState({
                  invoiceHtml:html,
                  invoiceItem:item
              });
              var $iframe = $('#showInvoice');
          $iframe.ready(function() {
              $iframe.contents().find("html").html(html);
          });
              self.openPreviewInvoice();
              self.$app.preloader.hide();
              //self.showPDF(html, item);
          });        
    },
    getData: function(){
      var self = this;
      var data = $(".switchEstimate").attr("data-estimate");
      var sales_estimate = Number(data);
      var getEstimate = sales_estimate == 1 ? true : false;

      self.$app.preloader.show();
      $.when(self.$app.methods.getDataAPI("sales/GetSales?isEstimate=" + getEstimate)).then(function( arr, textStatus, jqXHR ) {
          self.$app.preloader.hide();
              self.$setState({
                    sales: arr,
                    totalMat:arr.length
                  }, function(){
                    self.setDataTable();
                  });
            }).catch(function(err){
              self.$app.preloader.hide();
              self.showToast("An error has occurred", "center");
            });
      },
      preparePage: function(){
        var self = this;
        var iconTooltip = self.$app.tooltip.create({
          targetEl: '.estimateExplain',
          text: '<b>Check if this is just an estimate,</b><br><b>no purchase is being made yet.</b>',
        });
        var autocompleteDropdownAll = self.$app.autocomplete.create({
          inputEl: '#name_sell_sales',
          openIn: 'dropdown',
          valueProperty: 'id', //object's "value" property name
          textProperty: 'name_price', //object's "text" property name
          source: function (query, render) {
            var autocomplete = this;
            autocomplete.preloaderShow();
            var results = self.products.filter(x => x.status == 1);
            var newResult = [];
            // Find matched items
            for (var i = 0; i < self.products.length; i++) {
              if (results[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
                results[i].name_price = results[i].name + "\t" + " - " + self.formatMoney(results[i].selling_price);
                newResult.push(results[i]);
              }
            }
            // Render items by passing array with result items
            autocomplete.preloaderHide();
            render(newResult);
          },
          on: {
                change: function (value) {
                  if(value.length > 0){
                  value = value[0];
                  $("#name_sell_sales").val(value.name);
                  $(".cost_sell_sales").val(value.selling_price);
                  $("#productID_sell").val(value._id);
                  var availableStock = value.stock == undefined ? "Unlimited" : value.stock;
                  $(".hiddenQuantitySingle").val(availableStock);
                  var quant = Number($(".quantity_sell_sales").val());
                    if(!isNaN(quant) || quant == 0){
                      var q = quant == 0 ? 1 : quant;
                      var tp = Number(value.selling_price) * q;
                      //tp = tp - discount;
                      $(".total_sell_sales").val(tp.toFixed(2));
                      self.calculateQuantity();
                    }
                  }
                }
              }
        });
        var autocompleteDropdownBuyer = self.$app.autocomplete.create({
          inputEl: '#buyer_sell_sales',//buyersNameMultiple_sales
          openIn: 'dropdown',
          valueProperty: 'id', //object's "value" property name
          textProperty: 'name', //object's "text" property name
          source: function (query, render) {
            var results = self.clients;
            var newResult = [];
            // Find matched items
            for (var i = 0; i < self.clients.length; i++) {
              if (results[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0) newResult.push(results[i]);
            }
            // Render items by passing array with result items
            render(newResult);
          },
          on: {
                change: function (value) {
                  if(value.length > 0){
                  value = value[0];
                  $("#buyer_sell_sales").val(value.name);
                  selectedUserName = value.name;
                  selectedUserID = value.id;
                  }
                }
              }
        });
        var autocompleteDropdownMultipleBuyer = self.$app.autocomplete.create({
          inputEl: '#buyersNameMultiple_sales',//buyersNameMultiple_sales
          openIn: 'dropdown',
          valueProperty: 'id', //object's "value" property name
          textProperty: 'name', //object's "text" property name
          source: function (query, render) {
            var results = self.clients;
            var newResult = [];
            // Find matched items
            for (var i = 0; i < self.clients.length; i++) {
              if (results[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0) newResult.push(results[i]);
            }
            // Render items by passing array with result items
            render(newResult);
          },
          on: {
                change: function (value) {
                  if(value.length > 0){
                  value = value[0];
                  $("#buyersNameMultiple_sales").val(value.name);
                  selectedUserName = value.name;
                  selectedUserID = value.id;
                  }
                }
              }
        });
        var calendar1 = self.$app.calendar.create({
                  inputEl: '#datePaidMultiple_sales',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });

              var calendar2 = self.$app.calendar.create({
                  inputEl: '#datePurchaseMultiple_sales',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });

        var calendar = self.$app.calendar.create({
                  inputEl: '#paid-calendar-modal-sales',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });

              var calendarPurchase = self.$app.calendar.create({
                  inputEl: '#purchase-calendar-modal-sales',
                  timePicker: true,
                  closeOnSelect: true,
                  formatValue: function(values){
                    var t = moment(values[0]).format('LLL');
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });
        $$(".showInactiveSales").on("change", function(){
            self.getData();
        })
        
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal',
            openIn: 'customModal',
            rangePicker: true,
            closeOnSelect: true,
            header: true,
            footer: true
        });
        calendarModal.on("closed", function(){
            var days = calendarModal.getValue();
            if(days == undefined){
                return;
            }
            var from = null; var to = null;
            if(days.length == 1){
                from = Date.parse(days[0]);
                from = moment(moment(days[0]).format('LLL')).format();
                days.push(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = Date.parse(date2);
                to = moment(moment(date2).format('LLL')).format();
            }
            else if(days.length > 1){
                //var date1 = days[0];
                //date1.setDate(date1.getDate() + 1);
                from = moment(moment(days[0]).format('LLL')).format();
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = moment(moment(date2).format('LLL')).format();
            }else{
                self.getData();
            }
            if(from != null && to != null){
                  var data = $(".switchEstimate").attr("data-estimate");
                  var sales_estimate = Number(data);
                  var getEstimate = sales_estimate == 1 ? true : false;

                  var obj = {}
                  obj.isEstimate = getEstimate;
                  obj.fromDate = from;
                  obj.toDate = to;

                  self.$app.preloader.show();
                $.when(self.$app.methods.postDataAPI("sales/GetSalesByDate", obj, true)).then(function( arr, textStatus, jqXHR ) {
                  self.$app.preloader.hide();
                    self.$setState({
                            sales: arr,
                            totalMat:arr.length
                        }, function(){
                            self.setDataTable();
                        });
                });
            }
        }) 
      }

  },
  on: {
    pageAfterIn: function(e, page) {
        var self = this;
        //console.log("re-enter");
        //self.preparePage();
        //trackSalesPage();
      },
      pageInit: function(e, page) {
        var self = this;
        self.preparePage();
        //self.getProducts();
        registerPagination();
               
        //self.getData();
        self.startPouch();
      }
  }

} 

function registerPagination(){
  $(document).on('click', 'a.page', function() {
    $(".page-current .page-content").eq(0).animate({scrollTop:0 }, "fast");
      });
}

function trackSalesPage(){
  try{
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
    'event': 'Pageview',
    'pagePath': 'https://www.mogulsheet.com/sales',
    'pageTitle': 'Sales/Estimates' //some arbitrary name for the page/state
    });
  }catch(err){
    
  }
}
</script>