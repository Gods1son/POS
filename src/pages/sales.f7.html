<template>
<div class="page" data-name="sales">
  <div class="navbar">
    <div class="navbar navbar-bg"></div>
    <div class="navbar-inner sliding">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title">Sales</div>
    </div>
  </div>

      <!--fab-->
    <div class="fab fab-extended fab-right-bottom">
      <a href="#" @click="openPopUpUpdateSellProduct(null)">
        <i class="icon f7-icons">plus</i>
        <div class="fab-text">Sale</div>
      </a>
    </div>
    <!--fab-->

  <div class="page-content">
    
    <div class="item-content block-title no-margin-bottom margin-top-half text-align-center">
      <div class="row no-padding-vertical">
              <div class="col padding-vertical-half">
                <span class="roundBox display-inline-flex">
                  <span class="item-title float-right">Show Deleted</span>
                  <span class="item-after float-right margin-left-half">
                      <label class="toggle toggle-init color-red showInactiveSales">
                      <input type="checkbox">
                      <span class="toggle-icon"></span>
                      </label>
                  </span>
                </span>  
              </div>
          </div>

          
  </div>
  <div class="list accordion-list no-margin-vertical">
    <ul>
      <li class="accordion-item myOrange">
        <a href="#" class="item-content item-link text-color-blue">
          <div class="item-inner">
            <div class="item-title dashText">Dashboard</div>
          </div></a>
        <div class="accordion-item-content">
          <div class="block no-margin-vertical no-padding-vertical padding-bottom-half">
            <div class="row no-gap dash">
      
                <div class="col-50 medium-33 small-50 xsmall-100">
                  <div class="card card-outline">
                    <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Total {{js "this.totalMat > 1 ? 'Sales' : 'Sale'"}}</div>
                    <div class="card-content">{{totalMat}}</div>
                  </div>
                </div>
      
                <div class="col-50 medium-33 small-50 xsmall-100">
                  <div class="card card-outline">
                    <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Total Amount of Sales</div>
                    <div class="card-content">{{money totalMoney}}</div>
                  </div>
                </div>
      
                <div class="col-50 medium-33 small-50 xsmall-100">
                  <div class="card card-outline">
                    <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Total Amount Received</div>
                    <div class="card-content">{{money totalPaid}}</div>
                  </div>
                </div>
      
                <div class="col-50 medium-33 small-50 xsmall-100">
                  <div class="card card-outline">
                    <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">Sales Not Fully Paid</div>
                    <div class="card-content">{{totalUnpaid}}</div>
                  </div>
                </div>
      
                <div class="col-100">
                  <div class="card card-outline">
                    <div class="block-title no-padding-vertical text-align-left no-margin ruleUnder">(Amount Received minus Total sales)</div>
                    <div class="card-content">{{money totalDifference}}</div>
                  </div>
                </div>
      
            </div>
          </div>
        </div>
      </li>
      </ul>
  </div>
  <div class="block no-margin-vertical no-margin-horizontal padding-vertical-half roundHolder no-padding-horizontal">
      <div id="sales-list" class="customList">
          <div class="text-align-center customListSub"><input class="search" placeholder="search">
            <div class="margin-vertical-half padding-vertical-half sortTextPar">
              <span class="sortText display-none">Sort By:</span>
              
            </div>
          </div>

          <div class="block no-margin-vertical">  
            <div class="no-hairlines-md no-margin-bottom margin-top-half">
                <div class="item-content item-input1">
                    <div class="item-inner bg-color-white specWrap">
                    <div class="item-input-wrap">
                        <input type="text" class="specSearch" placeholder="Filter sales by date" id="demo-calendar-modal"/>
                        <span class="input-clear-button specClear" @click="resetTable"></span>
                    </div>
                    </div>
                </div>
            </div>
          </div>

          <ul class="list sortList margin-top-half">
            
          </ul>
          <!--<ul class="pagination"></ul>-->
        </div>
      </div>
    
  </div>

    <!--pop up-->
  <div class="popup newSales popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner bg-color-blue text-color-white">
            <div class="title">Edit Product Sale</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link text-color-white" @click="closeUpdatePopUp"><i class="icon f7-icons">multiply</i>Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Product Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="name_sell" placeholder="Product name"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Selling Price</div>
                      <div class="item-input-wrap">
                        <input type="text" class="cost_sell" @keyup="calculateQuantity" placeholder="Cost of product" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Quantity</div>
                      <div class="item-input-wrap">
                        <input type="text" class="quantity_sell" @keyup="calculateQuantity" placeholder="Quantity" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Total Price</div>
                      <div class="item-input-wrap">
                        <input type="text" class="total_sell" placeholder="Total Price" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Buyer's Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="buyer_sell" placeholder="Buyer name"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Amount Paid</div>
                      <div class="item-input-wrap">
                        <input type="text" class="amountpaid_sell" placeholder="Amount paid" value="0" required validate pattern="[0-9]+(\.[0-9][0-9]?)?" data-error-message="Only numbers and decimals please!"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Date Buyer Paid</div>
                      <div class="item-input-wrap">
                          <input type="text" placeholder="Date buyer paid" id="paid-calendar-modal"/>
                          <span class="input-clear-button"></span>
                      </div>
                      </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Date of Purchase</div>
                      <div class="item-input-wrap">
                          <input type="text" placeholder="Date of purchase" id="purchase-calendar-modal" required validate data-error-message="Select date of purchase please!"/>
                          <span class="input-clear-button"></span>
                      </div>
                      </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-fill button-raised color-green" @click='updateDataSell'>Save Product Sale</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

</div>
</template>
<script>
//import Dom7 from 'dom7';
import Dexie from 'dexie';
import * as moment from 'moment';
var db = new Dexie("BizExpenseManagerDB");
          db.version(2).stores({
            ingredients: "++id,name,unit_size,unit,cost_per_unit,status,created_date",
            products: "++id,name,cost,status,created_date",
            product_ingredient: "++id,productID,ingredientID,unit_size,cost,status,created_date",
            product_otherMaterials: "++id,productID,name,cost,status,created_date",
            sales: "++id,product_name,buyer_name,cost,quantity,total_price,amountPaid,isPaid,date_paid,created_date,status",
            expenses: "++id,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status",

            ingredients_history: "++id,ingID,name,unit_size,unit,cost_per_unit,status,created_date",
            products_history: "++id,prodID,name,cost,status,created_date",
            sales_history: "++id,salesID,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status",
            expenses_history: "++id,expID,name,amount_to_pay,amount_paid,date_paid,created_date,recurring,status"
          })

//var $$ = Dom7;
export default {
  data: function () {
      // Must return an object
      return {
        sales: null,
        totalMat:0,
        totalMoney: 0,
        totalPaid: 0,
        totalUnpaid: 0,
        totalDifference: 0,
        currentSale:null
      }
    },
  methods:{
    userpaid: function(id,cost){
        var self = this;
        if(self.$app.toggle.get(".product-" + id).checked){
            self.$app.dialog.prompt("How much did the buyer pay?", function(value){
                var val = Number(value);
                if(isNaN(val)){
                    self.$app.dialog.alert("Please enter valid amount");
                    return;
                }else{
                    if(val == "0"){
                        self.$app.dialog.alert("Please enter amount greater than 0");
                        self.$app.toggle.get(".product-" + id).toggle();
                        return;
                    }
                    var newDate = Date.parse(new Date($.now()));
                    //self.$app.dialog.alert(val + " " + id);
                    var fullyPaid = 0;
                    if(Number(val) >= Number(cost)){
                        fullyPaid = 1;
                    }else{
                        fullyPaid = 0;
                        newDate = null;
                    }
                    db.sales.update(Number(id), {amountPaid: Number(val), isPaid: fullyPaid, date_paid:newDate}).then(function (updated) {
                        if (updated){
                        self.sales.forEach(function(item, i) { 
                            if (item.id == Number(id)){
                                    self.sales[i].isPaid = fullyPaid;
                                    self.sales[i].amountPaid = Number(val);
                                    self.sales[i].date_paid = newDate;
                                }  
                        });
                        self.showToast("Payment updated!", "center");
                        if(fullyPaid == 0){
                            self.$app.toggle.get(".product-" + id).toggle();
                        }
                        //console.log(self.ings);
                        self.$setState({
                            sales:self.sales
                        }, function(){
                            self.calculateTotalMoney();
                        });
                        }else{
                            self.showToast("An error occured, please try again", "center");
                            //self.$app.dialog.alert("An error occured, please try again");
                        }
                    });
                }
            }, function(){
                self.$app.toggle.get(".product-" + id).toggle();
            });
        }
    },
    calculateQuantity: function(){
        var cost = Number($(".cost_sell").val());
        var quant = Number($(".quantity_sell").val());
        if(!isNaN(cost) && !isNaN(quant)){
            var total = cost * quant;
            $(".total_sell").val(total);
        }
    },
    moneyFormat: function(val){
      var sym = localStorage.getItem("currency", val);
      sym = sym == undefined ? "" : sym;
      if(val < 0){
        var rev = 0 - val;
        var val2 = val + rev + rev;
        val = val2;
        sym = "-" + sym;
      }
      var ret = sym + val.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
      return ret;
    },
    formatPDF: function(sales){//product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date
      var self = this;
      var Companyname = localStorage.getItem("companyName") != undefined ? localStorage.getItem("companyName") : "";
      var Comaddress = localStorage.getItem("companyAddress") != undefined ? localStorage.getItem("companyAddress").split("\n").join("<br>") : "";
      var buyer = sales.buyer_name;
      var productName = sales.product_name;
      var curr = localStorage.getItem("currency") != undefined ? localStorage.getItem("currency") : "";
      var quant = sales.quantity == null ? 1 : sales.quantity;
      var cost = self.moneyFormat(sales.cost);
      var tPrice = sales.total_price == null ? sales.cost : sales.total_price;
      var totalPrice = self.moneyFormat(tPrice);
      var totalPaid = self.moneyFormat(sales.amountPaid);
      var outstanding = self.moneyFormat((Number(tPrice) - Number(sales.amountPaid)));
      var purchaseDate = moment.unix(sales.created_date).format("LLL");
      var paymentDate =  sales.date_paid == "" ? "" : moment.unix(sales.date_paid).format("LLL");
      var today = moment().format("LLL");
       var html = '<html><div style="text-align:right; border-bottom:1px solid black;">';
        html += '<h2 style="margin-bottom:5px; margin-top:5px;">' + Companyname + '</h2><div>' + Comaddress + '</div></div>';
        html += '<div style="text-align:left; border-bottom:1px solid black;"><h4 style="margin-bottom:5px; margin-top:5px;">Invoice No: 00' + sales.id.toString() + '</h4><h4 style="margin-bottom:5px; margin-top:5px;">Invoice To:</h4>';
        html += '<h3 style="margin-bottom:5px; margin-top:5px;">' + buyer + '</h3></div>';
        html += '<table><thead><tr><th style="width: 70vw;text-align: left;">Product Name</th>';
        html += '<th style="width: 10vw;text-align: center;">Quantity</th><th style="width: 20vw;text-align: right;">Price</th>';
        html += '</tr></thead><tbody><tr><td>' + productName + '</td><td style="text-align:center">' + quant + '</td>';
        html += '<td style="text-align: right;">' + cost + '</td></tr></tbody></table>';
        html += '<div style="text-align:right; border-top:1px solid black;"><div><span>Total Price: </span><span style="font-size:1.2em;">' + totalPrice + '</span></div>';
        html += '<div><span>Amount Paid: </span><span style="font-size:1.2em;">' + totalPaid + '</span></div>';
        html += '<div><span>Outstanding: </span><span style="font-size:1.2em;">' + outstanding + '</span></div>';
        html += '<div><span">Purchase Date: </span><span style="font-size:1.2em;">' + purchaseDate + '</span></div>';
        html += '<div><span">Payment Date: </span><span style="font-size:1.2em;">' + paymentDate + '</span></div></div>';
        html += '<div style="text-align:left;"><h3 style="margin-bottom:5px; margin-top:5px;">Thank you!</h3><h5 style="margin-bottom:5px; margin-top:5px;">' + today + '</h5></div><hr></html>';
        return html;
    },
    deleteSale: function(list, id){
        var self = this;
        var checked = 0;
        var text = "delete"
        var toggle = self.$app.toggle.get(".showInactiveSales");
        if(toggle != undefined){
            if(toggle.checked){
                text = "activate";
                checked = 1;
            }
        }
        self.$app.dialog.confirm("Are you sure you want to " + text + " this sale?", function(){
            db.sales.update(Number(id), {status: checked}).then(function (updated) {
                if (updated){
                self.sales = self.sales.filter(function(e){ 
                      return e.id != Number(id);
                  });
                  var act = checked == 0 ? "deleted!" : "activated!";
                  self.showToast("Sale " + act, "center");
                  //console.log(self.ings);
                  self.$setState({
                      sales:self.sales
                  }, function(){
                      //var but = $("#salesTable").find(".deleteSale[data-id='" + id + "']");
                      //var row = $(but).parents("tr").eq(0);
                      self.showToast("Sale " + text + "d!", "center");
                      list.remove("id", id);
                      self.calculateTotalMoney();
                  });
                }else{
                    self.showToast("An error occured, please try again", "center");
                    //self.$app.dialog.alert("An error occured, please try again");
                }
            });
        });
    },
    showToast: function(text, position){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: 2000,
                        }).open();
    },
    closeUpdatePopUp: function(){
        var self = this;
        $$("input.buyer_sell, input.amountpaid_sell, .quantity_sell, .total_sell").val("");
        var popup = self.$app.popup.close('.newSales', true);
    },
    updateDataSell: function(){
        var self = this;
        /*if(self.currentSale == null){
            return;
        }*/
      //var $$ = this.Dom7;
      var self = this;
      var checked = 0;
      var isPaidDate = null;
      if($("#purchase-calendar-modal").val().trim() == ""){
        self.showToast("Please pick date of purchase", "center");
        return;
      }
      if(($("#paid-calendar-modal").val().trim() == "") && ($$("input.amountpaid_sell").val() != "0" && $$("input.amountpaid_sell").val().trim != "")){
          self.showToast("Please choose date buyer paid!", "center");
          return;
      }
      if(($("#paid-calendar-modal").val().trim() == "") && ($$("input.amountpaid_sell").val() == "0" || $$("input.amountpaid_sell").val().trim == "")){
          self.$app.dialog.confirm("Do you want to record the purchase without a payment made?", function(){
              self.processPaymentUpdate();
          })
      }
        self.processPaymentUpdate();
      
    },
    processPaymentUpdate: function(){
      var self = this;
      var cp = $$("input.total_sell").val();
      var sp = $$("input.amountpaid_sell").val();
      var fullyPaid = 0;
      if(Number(sp) >= Number(cp)){
        fullyPaid = 1;
      }else{
          fullyPaid = 0;
      }
      var isPaidDate = moment($("#paid-calendar-modal").val()).format("X");
        var obj = {
                //id: Number(self.currentSale),
                product_name: $$("input.name_sell").val(),  
                buyer_name: $$("input.buyer_sell").val(),
                cost: $$("input.cost_sell").val(),
                quantity: $$("input.quantity_sell").val(),
                total_price: $$("input.total_sell").val(),
                amountPaid: $$("input.amountpaid_sell").val(),
                isPaid: fullyPaid,
                date_paid: isPaidDate,
                created_date: moment($("#purchase-calendar-modal").val()).format("X"),
                status:1
              };
              if(self.currentSale != null){
                obj.id = Number(self.currentSale);
              }
            db.sales.put(obj).then(function(){
                    self.showToast("Record saved!", "center");
                    $$("input.buyer_sell, input.amountpaid_sell, #purchase-calendar-modal, #paid-calendar-modal, .quantity_sell, .total_sell").val("");
                    self.$app.popup.close('.newSales', true);
                    self.getData();
                    self.$setState({
                            currentSale: null
                        });
                 // });
                  
              }).catch(function (error) {
                  //console.log(error);
                 self.$app.dialog.alert("An error occurred!");
              })
    },
    invoice: function(id){
      var self = this;
      var item = self.sales.find(function(e){ 
                  return e.id == Number(id);
              });
      var html = self.formatPDF(item);
      var options = {
                documentSize: 'A4',
                type: 'share',
                fileName: item.buyer_name + "- 00" + item.id + '.pdf'
              }
      try{
      if(pdf != undefined){
        pdf.fromData( html, options)
          .then((stats)=> self.showToast(stats, "center"))   // ok..., ok if it was able to handle the file to the OS.  
          .catch((err)=> self.showToast(err, "center"))
      }else{
        var w = window.open();
        $(w.document.body).html(html);
      }
    }catch(err){
        var w = window.open();
        $(w.document.body).html(html);
    }
      //console.log(html);
    },
    openPopUpUpdateSellProduct: function(id){
        /*if(id == null){
            return;
        }*/
        var self = this;
        var calendar = self.$app.calendar.create({
                  inputEl: '#paid-calendar-modal',
                  timePicker: true,
                  formatValue: function(values){
                    //console.log(values[0]);
                    var t = moment(values[0]).format('LLL');
                    //console.log(moment(values[0]).format("X"));
                    //console.log(t);
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });

              var calendarPurchase = self.$app.calendar.create({
                  inputEl: '#purchase-calendar-modal',
                  timePicker: true,
                  formatValue: function(values){
                    //console.log(values[0]);
                    var t = moment(values[0]).format('LLL');
                    //console.log(moment(values[0]).format("X"));
                    //console.log(t);
                    return t;
                  }
                  //dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' }
              });
        //popup.once("opened", function(){
          if(id != null || id != undefined){
            var item = self.sales.find(function(e){ 
                  return e.id == Number(id);
              });
                $$("input.name_sell").val(item.product_name);
                $$("input.buyer_sell").val(item.buyer_name);
                $$("input.cost_sell").val(item.cost);
                var quantity = item.quantity == null ? 1 : item.quantity;
                  var total = item.total_price == null ? item.cost : item.total_price;
                  $(".quantity_sell").val(quantity);
                  $(".total_sell").val(total);
                $$("input.amountpaid_sell").val(item.amountPaid);
                if(item.created_date != ""){
                  var myDate = new Date(item.created_date);
                  //myDate = myDate.toLocaleString();
                  //myDate = moment(item.created_date);
                  myDate = moment.unix(item.created_date).format("LLL");
                  $("#purchase-calendar-modal").val(myDate);
                }
                if(item.date_paid != ""){
                  var myDate = new Date(item.date_paid);
                  //myDate = myDate.toLocaleString();
                  myDate = moment.unix(item.date_paid).format("LLL");
                  $("#paid-calendar-modal").val(myDate);
                }
                var popup = self.$app.popup.open('.newSales', true);
                self.$setState({
                    currentSale: Number(id)
                });
            }else{
                $$("input.name_sell").val("");
                $$("input.buyer_sell").val("");
                $$("input.cost_sell").val("");
                $(".quantity_sell").val("1");
                $$("input.amountpaid_sell").val("");
                $("#paid-calendar-modal").val(moment().format('LLL'));
                $("#purchase-calendar-modal").val(moment().format('LLL'));
                var popup = self.$app.popup.open('.newSales', true);
                self.$setState({
                    currentSale: null
                });
            }
        //})
        
    },
    calculateTotalMoney: function(){
        var self = this;
        var totalPaid = 0;
        var totalUnpaid = 0;
        var totalMoney = 0;
        $.each(self.sales, function(index,item){
            if(item.amountPaid != 0 && item.amountPaid != ""){
                totalPaid += Number(item.amountPaid);
            }
            if(item.amountPaid < item.cost){
                totalUnpaid += 1;
            }
            totalMoney += Number(item.cost);
        })
        self.$setState({
            totalMoney: totalMoney,
            totalPaid: totalPaid,
            totalUnpaid: totalUnpaid,
            totalDifference: (totalPaid - totalMoney),
            totalMat: self.sales.length
        });
    },
    resetTable: function(){
        var self = this;
        console.log("empty");
        self.getData();
    },
    showCalendarPopup: function(){
        var self = this;
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal',
            openIn: 'sheet',
            header: true,
            footer: true
        });
      },
    openPopUp: function(id){
        var self = this
        
    },
    closePopUp: function(){
        var self = this;
        var popup = self.$app.popup.close('.showCalendar', true);
        popup.once("closed", function(){

        });
    },
    setDataTable: function(){
            var self = this;
            $("#sales-list .list").empty();//id,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status
                      if(self.sales != null && self.sales.length > 0){
                        $(".customListSub").removeClass("display-none");
                        $(".sort").remove();
                        var sorter = '<span class="sort" data-sort="name">Name</span><span class="sort" data-sort="cost">Cost</span>';
                        sorter += '<span class="sort" data-sort="isPaid">Fully Paid</span><span class="sort" data-sort="created_date">Purchase Date</span>';
                        $(sorter).insertAfter($(".sortText"));
                        $(".sortText").removeClass("display-none");
                        for(var i = 0; i < self.sales.length; i++){
                            var row = self.sales[i];
                            var quantity = row.quantity == null ? 1 : row.quantity;
                            var total = row.total_price == null ? row.cost : row.total_price;
                            var html = '<li><div class="card myCard"><div class="card-content padding-horizontal-half">';
                            html += '<div class="name cardName">' + row.product_name + '</div><div class="id display-none">' + row.id + '</div><div class="cost display-none">' + row.cost + '</div>';
                            html += '<div class=""><span class="labelName">Buyer\'s name: </span><span class="valueName buyer">' + row.buyer_name + '</span></div><div class="isPaid display-none">' + row.isPaid + '</div>';
                            html += '<div class=""><span class="labelName">Product Cost: </span><span class="valueName">' + self.formatMoney(row.cost) + '</span></div>';

                            html += '<div class=""><span class="labelName">Quantity: </span><span class="valueName">' + quantity + '</span></div>';
                            html += '<div class=""><span class="labelName">Total Cost: </span><span class="valueName">' + self.formatMoney(total) + '</span></div>';

                            html += '<div class=""><span class="labelName">Amount Paid: </span><span class="valueName">' + self.formatMoney(row.amountPaid) + '</span></div>';
                            var stat = row.status == 1 ? "display-none" : "";
                            var hidden = row.isPaid == 1 ? "" : "display-none";
                            var checkbox = row.isPaid == 1 ? '<i class="icon f7-icons text-color-green paid">checkmark_circle_fill</i>' : '<i class="icon f7-icons text-color-red paid">multiply_circle_fill</i>';
                            html += '<div class=""><span class="labelName">Fully Paid: </span>' + checkbox + '</div>' + '<div class="display-none created_date">' + row.created_date + '</div>';
                            html += '<div class="' + hidden + '"><span class="labelName">Date Fully Paid: </span><span class="valueName">' + moment.unix(row.date_paid).format("LLL") + '</span></div>';
                            html += '<div class=""><span class="labelName">Purchase Date: </span><span class="valueName">' + moment.unix(row.created_date).format("LLL") + '</span></div>';
                            html += '<div class="' + stat + '"><span class="labelName">Status: </span><span class="valueName text-color-red">Deleted</span></div>';
                            html += '</div><div class="card-footer padding-horizontal-half"><p class="display-inline-flex no-margin-vertical">';
                            html += '<a class="button button-raised button-small button-fill margin-right-half invoice color-green" data-id="' + row.id + '">Invoice</a>';
                            html += '<a class="button button-raised button-small button-fill margin-right-half editSale" data-id="' + row.id + '">Edit</a>';
                            html += '<a class="button button-raised button-small button-fill color-red deleteSale" data-id="' + row.id + '">';
                            html +=  row.status == 1 ? 'Delete' : 'Activate'; 
                            html += '</a></p></div></div>'
                            html += '</li>';
                            $("#sales-list .list").append(html);
                            //return html;
                        }
                        var options = {
                            valueNames: ['id','isPaid','buyer','created_date','cost','name'],
                            //page: 3,
                            //pagination: true
                        };

                        var sales = new List('sales-list', options);

                        $(".sort").off("click").on("click", function(){
                          $(".sort").find(".asc").remove();
                          $(".sort").find(".desc").remove();
                            if($(this).hasClass("asc")){
                              $(this).append("<i class='icon f7-icons asc text-color-red'>arrowtriangle_up_fill</i>");
                            }
                            if($(this).hasClass("desc")){
                              $(this).append("<i class='icon f7-icons desc text-color-red'>arrowtriangle_down_fill</i>");
                            }
                        })
                      
                          $('#sales-list').off("click").on('click','.button', function () {
                              var data = $(this).attr("data-id");
                              //console.log(data);
                              if($(this).hasClass("editSale")){
                                self.openPopUpUpdateSellProduct(data);
                              }
                              if($(this).hasClass("invoice")){
                                self.invoice(data);
                              }
                              if($(this).hasClass("deleteSale")){
                                self.deleteSale(sales, data);
                              }
                              //return false;
                          });
                          self.calculateTotalMoney();
                        }else{
                          var html = "<li><div class='card myCard'><div class='card-content text-align-center'>No result found</div></div></li>";
                          $("#sales-list .list").append(html);
                          $(".customListSub").addClass("display-none");
                        }
    },
    formatMoney:function(val){             
      var sym = localStorage.getItem("currency", val);
      sym = sym == undefined ? "" : sym;
      if(val < 0){
        var rev = 0 - val;
        var val2 = val + rev + rev;
        val = val2;
        sym = "-" + sym;
      }
      var ret = sym + val.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
      return ret;
    },
    getData: function(){
      var self = this;
      var checked = 1;
        var toggle = self.$app.toggle.get(".showInactiveSales");
      if(toggle != undefined){
        checked = toggle.checked == true ? 0 : 1;
      }

      var collection = db.sales.where('status').equals(checked).reverse().toArray(function(arr){
        //var collection = db.ingredients.toArray(function(arr){
        //console.log(arr);
          self.$setState({
                sales: arr,
                totalMat:arr.length
              }, function(){
                self.setDataTable();
              });
        });
      }
  },
  on: {
      pageInit: function(e, page) {
        var self = this;
        $$(".showInactiveSales").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal',
            openIn: 'customModal',
            rangePicker: true,
            header: true,
            footer: true
        });
        calendarModal.on("closed", function(){
            //console.log(calendarModal.getValue());
            var days = calendarModal.getValue();
            if(days == undefined){
                return;
            }
            var from = null; var to = null;
            if(days.length == 1){
                from = Date.parse(days[0]);
                //console.log(moment(days[0]).format('LLL'));
                from = moment(moment(days[0]).format('LLL')).format("X");
                days.push(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = Date.parse(date2);
                //console.log(moment(date2).format('LLL'));
                to = moment(moment(date2).format('LLL')).format("X");
            }
            else if(days.length > 1){
                //var date1 = days[0];
                //date1.setDate(date1.getDate() + 1);
                from = moment(moment(days[0]).format('LLL')).format("X");
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = moment(moment(date2).format('LLL')).format("X");
            }else{
                self.getData();
            }
            if(from != null && to != null){
                //console.log(from);
                //console.log(to);
                var checked = 1;
                var collection = db.sales.where('created_date').between(from, to)
                .filter(function (sale) {
                    return sale.status === 1;
                }).toArray(function(arr){
                    //var collection = db.ingredients.toArray(function(arr){
                    //console.log(arr);
                    self.$setState({
                            sales: arr,
                            totalMat:arr.length
                        }, function(){
                            self.setDataTable();
                        });
                });
            }
        })        
        self.getData();
      },
      pageReinit: function(e, page) {
        var self = this;
        $$(".showInactiveSales").on("change", function(){
          //console.log("inactive change");
            self.getData();
        })
        self.getData();
      }
  }

} 
</script>