<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title padding-vertical-half">Reports</div>
        <div class="right">
          <a href="#" class="link icon-only panel-toggle" data-panel="left">
            <i class="icon f7-icons if-not-md">menu</i>
            <i class="icon material-icons if-md">menu</i>
          </a>
        </div>
      </div>
    </div>
    <div class="page-content scrollable">
      <div class="block-title margin-half">Select from below:</div>
      <div class="block no-margin-vertical padding-horizontal-half">  
        <div class="no-hairlines-md no-margin-bottom margin-top-half">
            <div class="item-content item-input1">
                <div class="item-inner bg-color-white specWrap">
                <div class="item-input-wrap">
                    <input type="text" class="specSearch" placeholder="Filter reports by date" id="demo-calendar-modal"/>
                    <span class="input-clear-button specClear" @click="resetTable"></span>
                </div>
                </div>
            </div>
        </div>
      </div>
      <div class="block no-margin"> 
        <p class="display-inline-flex margin-vertical-half">
          <a class="button button-outline" @click="getProductSales">Product Sales</a>
        </p>
      </div>
      <div>
        <canvas id="myChart" width="400" height="400"></canvas>
        <div id="allTables" class="text-align-center padding-horizontal-half"></div>
      </div>
      
    </div>
  </div>
</template>
<script>
  import * as moment from 'moment';
  import Chart from 'chart.js';
  /*Chart.plugins.register({
  afterDraw: function(chartInstance) {
    if (chartInstance.config.options.showDatapoints) {
      var helpers = Chart.helpers;
      var ctx = chartInstance.chart.ctx;
      var fontColor = helpers.getValueOrDefault(chartInstance.config.options.showDatapoints.fontColor, chartInstance.config.options.defaultFontColor);

      // render the value of the chart above the bar
      ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, 'normal', Chart.defaults.global.defaultFontFamily);
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.fillStyle = fontColor;

      chartInstance.data.datasets.forEach(function (dataset) {
        for (var i = 0; i < dataset.data.length; i++) {
          var model = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._model;
          var scaleMax = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._yScale.maxHeight;
          var yPos = (scaleMax - model.y) / scaleMax >= 0.93 ? model.y + 20 : model.y - 5;
          ctx.fillText(dataset.data[i].y, model.x, yPos + 35);
        }
      });
    }
  }
});*/
  var db = null, dbSales = null, dbExpenses = null, myProductSalesChart = null;
  export default {
    // Lifecycle Hooks
    // Component Data
    data: function () {
      // Must return an object
      return {
        
      }
    },
    // Component Methods
    methods: {
      showToast: function(text, position){
        var self = this;
        self.$app.toast.create({
                        text: text,
                        position: position,
                        closeTimeout: 2000,
                        }).open();
    },
    startPouch: function(){
          var self = this;
          //db = null;
          try{//id,name,unit_size,unit,cost_per_unit,status,created_date
            if(pdf != undefined){
                db = new PouchDB('clients.db', { adapter: 'cordova-sqlite' });
                dbSales = new PouchDB('sales.db', { adapter: 'cordova-sqlite' });
                dbExpenses = new PouchDB('expenses.db', { adapter: 'cordova-sqlite' });
                dbExpenses.createIndex({
                  index: {
                    fields: ['created_date', 'name', 'status']
                  }
                })
                dbSales.createIndex({
                  index: {
                    fields: ['created_date','parentID', 'product_name', 'isParent', 'buyer_name', 'status']
                  }
                })
                db.createIndex({
                  index: {
                    fields: ['name', 'created_date']
                  }
                }).then(function (result) {
                  //self.getData();
                })
              }
          }catch(err){
            db = new PouchDB('clients.db');
            dbSales = new PouchDB('sales.db');
            dbExpenses = new PouchDB('expenses.db');
                dbExpenses.createIndex({
                  index: {
                    fields: ['created_date', 'name', 'status']
                  }
                })
            dbSales.createIndex({
                  index: {
                    fields: ['created_date','parentID', 'product_name', 'isParent', 'buyer_name', 'status']
                  }
                })
            db.createIndex({
                  index: {
                    fields: ['name', 'created_date']
                  }
                }).then(function (result) {
                  //self.getData();
                })
          }
        },
      getparentChildren: function(arr){
        var self = this;
        $("#allTables").empty();
        //console.log(arr);
        var parents = arr.filter(v => v.isParent == 1).map(b => b._id);
        dbSales.find({
              selector: {
                $and: [
                  { status: {$eq: 1} },
                  {parentID: {$in: parents}},
                  //{ $or: [{parentID: { $in: parents }, _id:{$in: parents} }]},
                  {created_date: {$gt: true}}
                ]
              },
              sort: [{'_id': 'desc'}]
            }).then(function(ar){
              var arr2 = ar.docs;
              var allParName = [];
              $.each(parents, function(ind, elem){
                
                  var parName = arr.find(x => x._id === elem);
                  var children = arr2.filter(x => x.parentID === elem).map(x => x);
                  if(allParName.indexOf(parName.product_name) < 0){
                  allParName.push(parName.product_name);
                  //console.log(children);
                  var html = "<table class='eachProduct card myCard'><thead><tr><th colspan=6>" + parName.product_name + " - " + self.formatMoney(parName.afterTax) + "</th></tr></thead>";
                  html += "<tbody><tr><td>Product Name</td><td>Cost</td><td>Quantity</td><td>Total Cost</td><td>Tax in %</td><td>After Tax Cost</td></tr>";
                    $.each(children, function(ind2, elem2){
                      html += "<tr><td>" + elem2.product_name + "</td><td>" + self.formatMoney(elem2.cost) + "</td><td>" + elem2.quantity;
                      html += "</td><td>" + self.formatMoney(elem2.total_price) + "</td><td>" + elem2.tax + "</td><td>" + self.formatMoney(elem2.afterTax) + "</td></tr>";
                    })
                  html += "</tbody></table>";
                  $("#allTables").append(html);
                  } 
              })
              //console.log(arr2);
            });
        //console.log(parents);
      },
      resetTable: function(){
        var self = this;
        self.getProductSales();
      },
      getProductSales: function(){
        var self = this;
        dbSales.find({
              selector: {
                $and: [
                  { status: {$eq: 1} },
                  { parentID: { $lt: 1 } },
                  {created_date: {$gt: true}}
                ]
              },
              sort: [{'_id': 'desc'}]
            }).then(function(ar){
              var arr = ar.docs;
              if(arr != null && arr.length > 0){
                      self.showProductSales(arr);
                    }
            });
      },
      showProductSales: function(arr){
        var self = this;
        var dataBar = [];
              var dataLinePaid = [];
              var dataLineTotal = [];
              self.getparentChildren(arr);
              $.each(arr, function(ind, elem){
                var pres = dataBar.find(v => v.x === elem.product_name);
                if(pres == undefined){
                  var b = {};
                  var a = {};
                  var c = {};
                  a.x = elem.product_name;
                  a.y = 1;
                  b.x = elem.product_name;
                  b.y = Number(elem.afterTax);
                  c.x = elem.product_name;
                  c.y = Number(elem.amountPaid);
                  dataBar.push(a);
                  dataLineTotal.push(b);
                  dataLinePaid.push(c);
                }else{
                  var curr = pres.y;
                  curr++;
                  var presTotal = dataLineTotal.find(v => v.x === elem.product_name).y;
                  var presPaid = dataLinePaid.find(v => v.x === elem.product_name).y;
                  var t = Number(elem.afterTax);
                  var p = Number(elem.amountPaid);
                  var fintotal = presTotal + t;
                  var finPaid = presPaid + p;
                  var objIndexBar = dataBar.findIndex((obj => obj.x === elem.product_name));
                  dataBar[objIndexBar].y = curr;
                  var objIndexTotal = dataLineTotal.findIndex((obj => obj.x === elem.product_name));
                  dataLineTotal[objIndexTotal].y = fintotal;
                  var objIndexPaid = dataLinePaid.findIndex((obj => obj.x === elem.product_name));
                  dataLinePaid[objIndexPaid].y = finPaid;
                }
              })
              var ctx = document.getElementById('myChart');
              if(myProductSalesChart != null){
                myProductSalesChart.destroy();
              }
              myProductSalesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        datasets: [{
                            label: 'Product Sales Count',
                            borderColor: "darkseagreen",
                            backgroundColor: "darkseagreen",
                            data: dataBar,
                            yAxisID: 'y-axis-1',
                            maxBarThickness: 30,
                            // this dataset is drawn below
                            order: 3
                        }, {
                          label: 'Amount Received',
                          borderColor: "red",
                          backgroundColor: "red",
                          fill: false,
                            data: dataLinePaid,
                            yAxisID: 'y-axis-2',
                            type: 'line',
                            // this dataset is drawn on top
                            order: 1
                        }, {
                          label: 'Total Sales Amount',
                          borderColor: "blue",
                          backgroundColor: "blue",
                          fill: false,
                            data: dataLineTotal,
                            type: 'line',
                            yAxisID: 'y-axis-2',
                            // this dataset is drawn on top
                            order: 2
                        }],
                        labels: dataBar.map(v => v.x)
                    },
                    options: {
                      responsive: true,
                      hoverMode: 'index',
                      stacked: false,
                      showDatapoints: true,
                      title: {
                        display: true,
                        text: 'Product Sales Count, Amount Received and Total Sales Amount'
                      },
                      scales: {
                        yAxes: [{
                          type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                          display: true,
                          position: 'left',
                          id: 'y-axis-1',
                          ticks: {
                                beginAtZero: true,
                                stepSize: 1,
                                precision: 1
                            }
                        }, {
                          type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                          display: true,
                          position: 'right',
                          id: 'y-axis-2',
                          ticks:{
                            display: true
                          },
                          // grid line settings
                          gridLines: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                          },
                        }],
                      }
                    }
                });
      },
      openAlert: function () {
        var self = this;
        self.$app.dialog.alert('Hello World');
      },
      formatMoney: function(val){
        var cur = localStorage.getItem("currency");
        var curr = cur == undefined ? "" : cur;
        return curr + val.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");;
      },
    },
    // Page Events
    on: {
      pageInit: function(e, page) {
        var self = this;
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal',
            openIn: 'customModal',
            rangePicker: true,
            header: true,
            footer: true
        });
        calendarModal.on("closed", function(){
            //console.log(calendarModal.getValue());
            var days = calendarModal.getValue();
            if(days == undefined){
                return;
            }
            var from = null; var to = null;
            if(days.length == 1){
                from = Date.parse(days[0]);
                //console.log(moment(days[0]).format('LLL'));
                from = moment(moment(days[0]).format('LLL')).format("X");
                days.push(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = Date.parse(date2);
                //console.log(moment(date2).format('LLL'));
                to = moment(moment(date2).format('LLL')).format("X");
            }
            else if(days.length > 1){
                //var date1 = days[0];
                //date1.setDate(date1.getDate() + 1);
                from = moment(moment(days[0]).format('LLL')).format("X");
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = moment(moment(date2).format('LLL')).format("X");
            }else{
              self.getProductSales();
            }
            if(from != null && to != null){
                //console.log(from);
                //console.log(to);
                var checked = 1;

                dbSales.find({
                    selector: {
                      $and: [
                         {status: {$eq: checked}},
                         {created_date: { $gt: from }},
                         {created_date: { $lt: to }},
                         {parentID: { $lt: 1 } }
                      ]
                    },
                    sort: [{'_id': 'desc'}]
                  }).then(function(ar){
                    //var collection = db.ingredients.toArray(function(arr){
                    //console.log(arr);
                    var arr = ar.docs;
                    if(arr != null && arr.length > 0){
                      self.showProductSales(arr);
                    }
                    
                });
            }
        })  
        self.startPouch();
        //console.log('pageInit', page);
      },
      pageAfterIn: function(e, page) {
        //console.log('pageAfterIn', page);
      }
    }
  }
</script>
