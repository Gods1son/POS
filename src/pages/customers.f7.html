<template>
<div class="page" data-name="customers">
  <div class="navbar">
    <div class="navbar navbar-bg"></div>
    <div class="navbar-inner sliding">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          <span class="if-not-md">Back</span>
        </a>
      </div>
      <div class="title padding-vertical-half">Customers</div>
      <div class="right">
        <a href="#" class="link icon-only panel-toggle" data-panel="left">
          <i class="icon f7-icons if-not-md">menu</i>
          <i class="icon material-icons if-md">menu</i>
        </a>
      </div>
    </div>
  </div>

  <!--fab-->
  <div class="fab-backdrop"></div>
  <div class="fab fab-extended fab-right-bottom">
    <a href="#">
      <i class="icon f7-icons">plus</i>
      <i class="icon f7-icons">multiply</i>
      <div class="fab-text">Customer</div>
    </a>
      
      <div class="fab-buttons fab-buttons-top">
        <a href="#" class="fab-label-button" @click="openPopUp(null)">
          <span><i class="icon f7-icons">plus</i></span>
          <span class="fab-label">Single Customer</span>
        </a>
        <a href="#" class="fab-label-button" @click="openPopUpExcel()">
          <span><i class="icon f7-icons">upload_circle</i></span>
          <span class="fab-label">Upload Excel File</span>
        </a>
      </div>
  </div>
  <!--fab-->

    <!--
    <div class="fab fab-extended fab-right-bottom">
      <a href="#" @click="openPopUp(null)">
        <i class="icon f7-icons">plus</i>
        <div class="fab-text">Client</div>
      </a>
    </div>
  -->

  <div class="page-content">
    <div class="block no-margin-vertical no-margin-horizontal no-padding-vertical roundHolder no-padding-horizontal">
      <div id="clients-list" class="customList">
        <div class="text-align-center">
          <!--<input class="search" placeholder="search">-->
          <!-- Additional "searchbar-inline" class -->
          <div class="searchbar searchbar-inline">
            <div class="searchbar-input-wrap">
              <input type="search" placeholder="Search" class="search">
              <i class="searchbar-icon"></i>
              <span class="input-clear-button"></span>
            </div>
          </div>
          <div class="margin-vertical-half padding-vertical-half sortTextPar">
            <span class="sortText display-none">Sort By:</span>
            <!--<span class="sort" data-sort="name">Name</span>
            <span class="sort" data-sort="cost">Cost</span>-->
          </div>
        </div>
        <div class="row margin-top-half myToolbar">
          <div class="col-50 no-padding-vertical">
              <span class="margin-left-half">You have {{totalMat}} {{js "this.totalMat > 1 ? 'customers' : 'customer'"}}</span>
          </div>
          <div class="col-50 no-padding-vertical text-align-right">
            <span class="display-inline-flex margin-right-half display-none">
              <span class="item-title float-right">Show Deleted</span>
              <span class="item-after float-right margin-left-half">
                  <label class="toggle toggle-init color-red showInactiveClients">
                  <input type="checkbox">
                  <span class="toggle-icon"></span>
                  </label>
              </span>
              </span>
          </div>
        </div>
        <div class="clients-table data-table margin-vertical-half">
          <table>
              <thead>
                <tr>
                  <th class="sort" data-sort="name"><i class="icon f7-icons">arrow_up_down</i> Name</th>
                  <th>Contact No.</th>
                  <th>Email</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody class="list sortList">

              </tbody>
          </table>
        </div>
        <ul class="list sortList margin-vertical-half">
          
        </ul>
        <!--<ul class="pagination"></ul>-->
      </div>
    </div>
  </div>

  <!--pop up add new product-->
  <div class="popup uploadClients popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Upload Customers</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePopUpExcel()"><i class="icon f7-icons">multiply</i>Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
          <div class="block margin-half">
            <div class="item-label">* Ensure you don't have duplicate customers in Excel and on system.</div>
            <div class="item-label">Expected column names are: <b>name</b>, <b>email</b>, <b>phone</b>, <b>address</b>, <b>other_notes</b></div>
            <input type="file" id="fileUploadClients" accept=".xls,.xlsx" />
            <a class="button filePicker" @click="clientPicker">Select File</a>
            <a href="#" class="col button button-outline button-raised mainButton margin-top-half" @click='uploadFile'>Save Excel Data</a>
            <div class="errorContent"></div>
          </div>
        </div>
      </div>
    </div>
  
  </div>

   <!--pop up-->
   <div class="popup clientSales popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Customer Purchases</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePopUpSales"><i class="icon f7-icons">multiply</i></a>
            </div>
          </div>
        </div>
        <div class="page-content">
          <div id="clientSales-list" class="customList">
            <div class="text-align-center customListSub">
              <div class="searchbar searchbar-inline">
                <div class="searchbar-input-wrap">
                  <input type="search" placeholder="Search" class="search">
                  <i class="searchbar-icon"></i>
                  <span class="input-clear-button"></span>
                </div>
              </div>
            </div>
            <div id="clientName" class="bigLabel"></div>
            <div id="clientID" class="display-none"></div>
            <div class="text-align-center">
              <!--<input class="search" placeholder="search">-->
              <!-- Additional "searchbar-inline" class -->
              
    
              <div class="margin-vertical-half padding-vertical-half sortTextPar">
                
                <span class="sortText display-none">Sort By:</span>
                <!--<span class="sort" data-sort="name">Name</span>
                <span class="sort" data-sort="cost">Cost</span>-->
              </div>
            </div>
  
            <!--<div class="block no-margin-vertical padding-horizontal-half">  
              <div class="no-hairlines-md no-margin-bottom margin-top-half">
                  <div class="item-content item-input1">
                      <div class="item-inner bg-color-white specWrap">
                      <div class="item-input-wrap">
                          <input type="text" class="specSearch" placeholder="Filter purchases by date" id="demo-calendar-modal-clients"/>
                          <span class="input-clear-button specClear" @click="resetTable"></span>
                      </div>
                      </div>
                  </div>
              </div>
            </div>-->
            <div class="row margin-top-half myToolbar">
              <div class="col-50 no-padding-vertical">
                <span class="margin-left-half">Customer made {{totalMatUser}} {{js "this.totalMatUser > 1 ? 'purchases' : 'purchase'"}}</span>
              </div>

              <!--<div class="col-33 no-padding-vertical text-align-right">
                <span class="display-inline-flex margin-right-half display-none">
                  <span class="item-title float-right">Show Deleted</span>
                  <span class="item-after float-right margin-left-half">
                      <label class="toggle toggle-init color-red showInactiveClientPurchases">
                      <input type="checkbox">
                      <span class="toggle-icon"></span>
                      </label>
                  </span>
                  </span>
              </div>-->

              <div class="col-50 no-padding-vertical">
                <div class="block no-margin-vertical filterDateParent">  
                  <div class="no-hairlines-md no-margin-bottom margin-top-half">
                      <div class="item-content item-input1">
                          <div class="item-inner bg-color-white specWrap">
                          <div class="item-input-wrap">
                            <input type="text" class="specSearch" placeholder="Filter by date" id="demo-calendar-modal-clients"/>
                            <span class="input-clear-button specClear" @click="resetTable"></span>
                          </div>
                          </div>
                      </div>
                  </div>
                </div>
              </div>

              
            </div>
            <div class="clientPurchases-table data-table margin-vertical-half">
              <table>
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th class="sort" data-sort="name"><i class="icon f7-icons">arrow_up_down</i> Product Name</th>
                      <th>Quantity</th>
                      <th class="sort" data-sort="cost"><i class="icon f7-icons">arrow_up_down</i> Total Cost</th>
                      <th>Amount Paid</th>
                      <th class="sort" data-sort="isPaid"><i class="icon f7-icons">arrow_up_down</i> Fully Paid</th>
                      <th class="sort" data-sort="created_date"><i class="icon f7-icons">arrow_up_down</i> Date of Purchase</th>
                    </tr>
                  </thead>
                  <tbody class="list sortList">
    
                  </tbody>
              </table>
            </div>
            <ul class="list sortList margin-vertical-half">
              
            </ul>
            <!--<ul class="pagination"></ul>-->
          </div>
          
        </div>
      </div>
    </div>
  
  </div>

  <!--pop up-->
  <div class="popup newClient popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Add/Edit Customer</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closePopUp"><i class="icon f7-icons">multiply</i>Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
            <div class="list no-hairlines-md margin-top-half margin-bottom-half clientForm">
              <ul>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Customer Name</div>
                      <div class="item-input-wrap">
                        <input type="text" class="clientname" placeholder="Customer name" required validate/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Email Address</div>
                      <div class="item-input-wrap">
                        <input type="email" class="email settingsInput" placeholder="Customer email address"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Contact number</div>
                      <div class="item-input-wrap">
                        <input type="text" class="phone" placeholder="Customer number"/>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Address</div>
                      <div class="item-input-wrap">
                        <textarea class="address settingsInput" placeholder="Customer Address"></textarea>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Customer's Birthday</div>
                      <div class="item-input-wrap">
                        <input type="text" placeholder="Customer's birth date" readonly="readonly" id="client_bday" class="client_bday"/>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title">Other Notes</div>
                      <div class="item-input-wrap">
                        <textarea class="otherNotes settingsInput" placeholder="other information about customer"></textarea>
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="item-content">
                    <div class="item-inner">
                      <a href="#" class="col button button-outline button-raised mainButton" @click='saveData'>Save Customer</a>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
  
  </div>
  <!--Pop -up-->

</div>
</template>
<script>
import * as moment from 'moment';
import * as XLSX from 'xlsx';
var db = null, dbSales = null, dbSettings = null, calendarBday = null, mogulsheetdb = null;
var dataToUpload = null, eachBatch = 50, uploaded = 0;
export default {
  test: 5,
  data: function () {
      // Must return an object
      return {
        clients: null,
        totalMat:0,
        currentClient: null,
        totalMatUser: 0,
        settingsID: 'settings',
        settings: null
      }
    },
  methods:{
    testBack: function(){
      var self= this;
      self.$router.back();
    },
    showToast: function(text, position, icon = false){
        var self = this;
        self.$app.toast.create({
          icon: icon ? '<i class="f7-icons">checkmark_alt_circle</i>' : '',
          text: text,
          position: position,
          closeTimeout: 2000,
          }).open();
    },
    startPage: function(){
          var self = this;
          self.getData();
          try{
            if(chooser != undefined){
              $("#fileUploadClients").addClass("display-none");
            }
          }catch(err){
            $(".filePicker").addClass("display-none");
          }
          
        },
    formatMoney:function(val){             
      var self = this;   
      var ret = self.$app.methods.formatMoney(val);
      return ret;
    },
    permDeleteItem: function(list, id){
        var self = this;
        
        self.$app.dialog.confirm("Are you sure you want to permanently delete this?", "Omni", function(){
                  
                  mogulsheetdb.get(id).then(function(doc) {
                    doc.status = -1
                    return mogulsheetdb.put(doc);
                  }).then(function(){
                    self.clients = self.clients.filter(function(e){ 
                      return e._id != id;
                  });
                  self.$setState({
                      clients:self.clients,
                      totalMat:self.clients.length
                  }, function(){
                      self.showToast("Customer permanently deleted!", "center", true);
                      list.remove("id", id);
                      if(self.clients.length == 0){
                        $(".sortTextPar").addClass("display-none");
                        $("#clients-list .pagination").remove();
                      }
                  });
                })
                
            }, null);
        //}, null);
    },
    DeleteItem: function(list, id){
        var self = this;
        var checked = false;
        var text = "delete"
        /*var toggle = self.$app.toggle.get(".showInactiveClients");
        if(toggle != undefined){
            if(toggle.checked){
                text = "activate";
                checked = 1;
            }
        }*/
        self.$app.dialog.confirm("Are you sure you want to " + text + "?", "Omni", function(){
          self.$app.preloader.show();
          $.when(self.$app.methods.getDataAPI("clients/DeleteActivateClient?id=" + id + "&stat=" + checked)).then(function( data, textStatus, jqXHR ) {
                self.$app.preloader.hide();
                    if(data){
                      self.clients = self.clients.filter(function(e){ 
                          return e.id != id;
                      });

                      self.$setState({
                          clients:self.clients,
                          totalMat:self.clients.length
                      }, function(){
                          self.showToast("Customer " + text + "d!", "center", true);
                          list.remove("id", id);
                          if(self.clients.length == 0){
                            $(".sortTextPar").addClass("display-none");
                            $("#clients-list .pagination").remove();
                          }
                      });
                    }
                }).catch((data, textStatus, jqXHR) => {
                self.$app.preloader.hide();
                  if(data != null && data.status == 404){
                    self.$app.methods.showToast("Customer not found", "center");
                    return;
                  }
                  self.$app.methods.showToast("An error occurred", "center");
              })
                
            }, null);
        //}, null);
    },
    resetTable: function(){
        var self = this;

        var id = $("#clientID").text();
        var name = $("#clientName").text();
        self.openPopUpClientSales(id, name);
    },
    openPopUpClientSales: function(id, name){
      var self = this;
      $("#clientID").text(id);
      $("#clientName").text(name);

      var checked = true;
      /*var toggle = self.$app.toggle.get(".showInactiveClientPurchases");
      if(toggle != undefined){
        checked = toggle.checked == true ? 0 : 1;
      }*/
      self.$app.preloader.show();
      $.when(self.$app.methods.getDataAPI("clients/GetClientPurchases?clientid=" + id)).then(function( data, textStatus, jqXHR ) {
        self.$app.preloader.hide();
          self.$setState({
                totalMatUser:data.length
              }, function(){
                self.setDataTablePurchases(data);
              });
        }).catch((data, textStatus, jqXHR) => {
            self.$app.preloader.hide();
              if(data != null && data.status == 404){
                console.log("Customer not found"); 
                return;
              }
              self.$app.methods.showToast("An error occurred", "center");
          })
      //var popup = self.$app.popup.open('.clientSales', true);
    },
    setDataTablePurchases: function(arr){
      var self = this;
            $("#clientSales-list .list").empty();//id,product_name,buyer_name,cost,amountPaid,isPaid,date_paid,created_date,status
            $("#clientSales-list .pagination").remove();         
            if(arr != null && arr.length > 0){
              var pagination = "<ul class='pagination padding-left-half margin-vertical-half'><ul>";
                            $(pagination).insertAfter($("#clientSales-list .list"));
                        var isDesktop = self.$app.methods.isDesktop();
                        if(isDesktop){
                          $("#clientSales-list ul.list").remove();

                          for(var i = 0; i < arr.length; i++){
                            var row = arr[i];
                                var isParent = row.isParent == null ? 0 : row.isParent;
                                var quantity = row.quantity == null ? 1 : row.quantity;
                                var taxes = row.taxes == null ? 0 : row.taxes;
                                var total = row.totalPrice == null ? row.sellingPrice : row.totalPrice;
                                var afterTax = row.afterTaxPrice == null ? total : row.afterTaxPrice;
                                var type = row.isEstimate == 1 ? "Estimate" : "Invoice";
                                var paidInFull = row.isPaid == 1 ? '<span class="badge color-green paid padding-horizontal">Yes</span>' : '<span class="badge color-red paid padding-horizontal">No</span>';
                            var html = "<tr>";
                                html += '<td class="id" style="display:none;">' + row.id + '</td>';
                                html += "<td>" + type + "</td>";
                                html += "<td class='name'>" + row.productName + "</td>";
                                html += "<td>" + quantity + "</td>";
                                html += "<td class='cost'>" + self.formatMoney(afterTax) + "</td>";
                                html += "<td>" + self.formatMoney(row.amountPaid) + "</td>";
                                html += "<td class='isPaid'>" + paidInFull + "</td>";
                                html += "<td class='created_date'>" + moment(row.createdDate).format("LLL") + "</td>";
                                
                              html += "</tr>";
                              $("#clientSales-list tbody.list").append(html);
                          }
                              
                        }else{
                          $("#clientSales-list .data-table").remove();
                            $(".clientSales").find(".sortTextPar").removeClass("display-none");
                            
                            $(".clientSales").find(".sort").remove();
                            var sorter = '<span class="sort" data-sort="name">Name</span><span class="sort" data-sort="cost">Cost</span>';
                            sorter += '<span class="sort" data-sort="isPaid">Fully Paid</span><span class="sort" data-sort="created_date">Purchase Date</span>';
                            $(sorter).insertAfter($(".clientSales").find(".sortText"));
                            $(".clientSales").find(".sortText").removeClass("display-none");
                            for(var i = 0; i < arr.length; i++){
                                var row = arr[i];
                                var isParent = row.isParent == null ? 0 : row.isParent;
                                var sellToOther = "";
                                
                                var quantity = row.quantity == null ? 1 : row.quantity;
                                var taxes = row.taxes == null ? 0 : row.taxes;
                                var total = row.totalPrice == null ? row.sellingPrice : row.totalPrice;
                                var afterTax = row.afterTaxPrice == null ? total : row.afterTaxPrice;
                                var html = '<li><div class="card myCard"><div class="card-content padding-horizontal-half">';
                                html += '<div class="name cardName">' + row.productName + '</div><div class="id display-none">' + row.id + '</div><div class="cost display-none">' + row.sellingPrice + '</div>';
                              //html += '<div class=""><span class="labelName">Buyer\'s name: </span><span class="valueName buyer">' + row.buyer_name + '</span></div><div class="isPaid display-none">' + row.isPaid + '</div>';
                              var type = row.isEstimate == 1 ? "Estimate" : "Invoice";
                                html += '<div class=""><span class="labelName">Type: </span><span class="valueName valueBold">' + type + '</span></div>';  
                              html += '<div class=""><span class="labelName">Product Cost: </span><span class="valueName">' + self.formatMoney(row.sellingPrice) + '</span></div>';

                                html += '<div class=""><span class="labelName">Quantity: </span><span class="valueName">' + quantity + '</span></div>';
                                if(row.discount != null && row.discount != 0){
                                  html += '<div class=""><span class="labelName">Discount: </span><span class="valueName">' + self.formatMoney(row.discount) + '</span></div>';
                                }
                                html += '<div class=""><span class="labelName">Total Cost: </span><span class="valueName">' + self.formatMoney(total) + '</span></div>';
                                if(taxes > 0){
                                  html += '<div class=""><span class="labelName">Tax: </span><span class="valueName">' + taxes + '%</span></div>';
                                  html += '<div class=""><span class="labelName">After Tax Cost: </span><span class="valueName">' + self.formatMoney(afterTaxPrice) + '</span></div>';
                                }
                                html += '<div class=""><span class="labelName">Amount Paid: </span><span class="valueName">' + self.formatMoney(row.amountPaid) + '</span></div>';
                                var stat = row.status == true ? "display-none" : "";
                                var hidden = row.isPaid == true ? "" : "display-none";
                                var checkbox = row.isPaid == true ? '<span class="badge color-green paid padding-horizontal">Yes</span>' : '<span class="badge color-red paid padding-horizontal">No</span>';
                                //var checkbox = row.isPaid == 1 ? '<i class="icon f7-icons text-color-green paid">checkmark_circle_fill</i>' : '<i class="icon f7-icons text-color-red paid">multiply_circle_fill</i>';
                                html += '<div class=""><span class="labelName">Fully Paid: </span>' + checkbox + '</div>' + '<div class="display-none created_date">' + row.createdDate + '</div>';
                                html += '<div class="' + hidden + '"><span class="labelName">Date Fully Paid: </span><span class="valueName">' + moment(row.datePaid).format("LLL") + '</span></div>';
                                html += '<div class=""><span class="labelName">Purchase Date: </span><span class="valueName">' + moment(row.createdDate).format("LLL") + '</span></div>';
                                html += '<div class="' + stat + '"><span class="labelName">Status: </span><span class="valueName">Deleted</span></div>';
                                html += '</div>'; 
                                html += '</div>'
                                html += '</li>';
                                $("#clientSales-list ul.list").append(html);
                                //return html;
                            }
                        }

                        
                        var options = {
                            valueNames: ['id','isPaid','buyer','created_date','cost','name'],
                            page: 10,
                            pagination: [{outerWindow:2}],
                        };

                        var sales = new List('clientSales-list', options);

                        $(".clientSales").find(".sort").off("click").on("click", function(){
                          $(".clientSales").find(".sort").find(".asc").remove();
                          $(".clientSales").find(".sort").find(".desc").remove();
                            if($(this).hasClass("asc")){
                              $(this).append("<i class='icon f7-icons asc text-color-red'>arrowtriangle_up_fill</i>");
                            }
                            if($(this).hasClass("desc")){
                              $(this).append("<i class='icon f7-icons desc text-color-red'>arrowtriangle_down_fill</i>");
                            }
                        })
                        }else{
                          //var html = "<li><div class='card myCard'><div class='card-content text-align-center'>No result found</div></div></li>";
                          //$("#sales-list .list").append(html);
                          var options = {
                            valueNames: ['id','isPaid','buyer','created_date','cost','name'],
                            page: 10,
                        };

                        var sales = new List('clientSales-list', options);
                          
                          $(".clientSales").find(".sortTextPar").addClass("display-none");
                        }
                        var popup = self.$app.popup.open('.popup.clientSales', true);
    },
    openPopUpExcel: function(){
      var self = this;
      var popup = self.$app.popup.open('.uploadClients', true);
    },
    closePopUpExcel: function(){
      var self = this;
      self.resetUploader();
      $(".errorContent").html("");
      var popup = self.$app.popup.close('.uploadClients', true);
      self.getData();
    },
    uploadFileBatches: function(){
      var self = this;
      var dataLength = dataToUpload.length;
      var smallUpload = null;
      if(dataLength > uploaded){
        var pick = dataLength - uploaded;
        var picking = pick >= eachBatch ? eachBatch : pick;
        smallUpload = dataToUpload.slice(uploaded, picking + uploaded); 
        //upload small amount

        self.$app.preloader.show();
          $.when(self.$app.methods.postDataAPI("clients/SaveClientsList", smallUpload, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                //console.log("when data ings save ", data); // JSON data parsed by `data.json()` call
                if(data == true){
                  uploaded += picking;
                  setTimeout(self.uploadFileBatches(), 1000);
                }
                
            })
          .catch((err) => {
            self.$app.preloader.hide();
            self.showToast("error occured during saving", "center");
          })
      }else{
        self.$app.preloader.hide();
        self.showToast(uploaded + " records were saved", "center", true);
        dataToUpload = null;
        uploaded = 0;
        return;
      } 
    },
    clientPicker: async function(){
      var self = this;
      try{
        const file = await chooser.getFile();
        var url = file.dataURI;
        fetch(url)
          .then((response) => {
              return response.blob();
            })
            .then((result) => {
              selectedFile = result;
              self.uploadFile();
            })
      }catch(err){
        alert(err);
      }
      
    },
    uploadFile: function(){
      var self = this;
      $(".errorContent").html("");
      if (selectedFile) {
        try{
        self.$app.preloader.show();
          var fileReader = new FileReader();
          fileReader.onload = function(event) {
            var data = event.target.result;
            var workbook = XLSX.read(data, {
              type: "binary"
            });

            var sheet = workbook.SheetNames[0];
            var toSave = [];
            var rejected = [];
            var totalLength = 0;
            var errors = "";
            var rowObject = XLSX.utils.sheet_to_row_object_array(
                workbook.Sheets[sheet]
              );
              totalLength = rowObject.length;

              $.each(rowObject, function(ind, val){
                var obj = {};
                if(val.name != undefined && val.name.trim() != ""){
                  obj.name = val.name;

                  if(val.email != undefined){
                    obj.email = val.email;
                  }else{
                    obj.email = "";
                  }

                  if(val.address != undefined){
                    obj.address = val.address;
                  }else{
                    obj.address = "";
                  }

                  if(val.phone != undefined){
                    obj.phone = val.phone;
                  }else{
                    obj.phone = "";
                  }

                  if(val.other_notes != undefined){
                    obj.otherNotes = val.other_notes;
                  }else{
                    obj.otherNotes = "";
                  }

                  toSave.push(obj);
                }else{
                  rejected.push(val);
                  errors += JSON.stringify(val) + "<br>";
                }
                
              })

              if(toSave.length > 0){
                dataToUpload = toSave;
                self.uploadFileBatches();
                

                }else if(toSave.length == totalLength){
                  self.showToast("No record was saved", "center");
                }

                if(rejected.length > 0){
                  var html = rejected.length + " rows were not saved. <br> Please ensure customer's name is not blank and the header of the product names column is called <b>name</b>. <br> Please delete the rows that were saved from your excel file to prevent duplicate records.<br>";
                  html += "Unsaved rows are: <br>" + errors;
                  $(".errorContent").html(html);

                }else if(rejected.length == totalLength){
                  self.showToast("No error was found", "center");
                }
              self.$app.preloader.hide();
              self.resetUploader();
          };
          fileReader.readAsBinaryString(selectedFile);
        }catch(err){
          self.showToast(err + " error occured during saving", "center");
          self.$app.preloader.hide();
        }
      }
    },
    resetUploader: function(){
      var self = this;
        selectedFile = null;
        //$(".errorContent").html("");
        document.getElementById("fileUploadClients").value = "";
    },
    openPopUp: function(id){
        var self = this;
        
        //popup.once("opened", function(){
          if(id != null || id != undefined){
              var item = self.clients.find(function(e){ 
                        return e.id == id;
                    });
                    self.$setState({
                      currentClient: item
                    });
                    
                    $(".clientForm .clientname").val(item.name);
                    $(".clientForm .email").val(item.email);
                    $(".clientForm .address").val(item.address);
                    $(".clientForm .phone").val(item.phone);
                    var n = item.otherNotes == undefined ? "" : item.otherNotes;
                    $(".clientForm .otherNotes").val(n);
                    $(".clientForm #client_bday").val();
                    if(item.birthday != null && item.birthday != 0 && item.birthday != ""){
                      $("#client_bday").val(moment(item.bday).format("MMMM DD"));
                      self.updateCalendar();
                    }else{
                      
                      var arr = [];
                      arr.push(new Date());
                      calendarBday.setValue(arr);
                      $(".clientForm #client_bday").val("");
                    }
                    
                    var popup = self.$app.popup.open('.popup.newClient', true);
            } else{
              var popup = self.$app.popup.open('.popup.newClient', true);
              self.$setState({
                  currentClient:null
              });
            }
        //})
        
    },
    closePopUp: function(){
        var self = this;
        var popup = self.$app.popup.close('.newClient', true);
        $(".clientname,.email,.address,.phone,#client_bday,.otherNotes").val("");
        popup.once("closed", function(){
            self.getData();
        });
    },
    closePopUpSales: function(){
        var self = this;
        var popup = self.$app.popup.close('.clientSales', true);
        popup.once("closed", function(){

        });
    },
    saveData: function(){
      //var $$ = this.Dom7;
      var self = this;
      var elem = $$("input:required");
      var bday = null;
      if($("#client_bday").val() != ""){
        bday = moment($(".clientForm #client_bday").val()).format();
      }
      
      var err = self.$app.input.validateInputs(".clientForm");
      if(err){
        var obj = {
                name: $(".clientForm .clientname").val().trim(), 
                email: $(".clientForm .email").val().trim(), 
                address: $(".clientForm .address").val().trim(), 
                phone: $(".clientForm .phone").val().trim(), 
                otherNotes: $(".clientForm .otherNotes").val().trim(), 
                birthday: bday
              };
            if(self.currentClient != null){
              obj.id = self.currentClient.id;
            }

            self.$app.preloader.show();
            $.when(self.$app.methods.postDataAPI("clients/SaveClient", obj, true)).then(function( data, textStatus, jqXHR ) {
              self.$app.preloader.hide();
                if(data != null){
                      //self.$app.dialog.alert("Item saved.");
                      self.showToast("Client saved.", "center", true);
                      $(".clientname,.email,.address,.phone,.otherNotes, #client_bday").val("");
                      //self.getData();
                }
              }).catch((data, textStatus, jqXHR) => {
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
          }
    },
    updateCalendar: function(){
      var self = this;
      //var calendarDefault = self.$app.calendar.get($$("#client_bday"));
          var arr = [];
          var dt = $("#client_bday").val() == "" ? new Date() : new Date($("#client_bday").val());
          //var dt = new Date($("#client_bday").val());
          arr.push(dt);
          //arr.push(new Date());
          calendarBday.setValue(arr);
          //calendarDefault.update()
    },
    getData: function(){
      var self = this;
      var checked = true;
      /*var toggle = self.$app.toggle.get(".showInactiveClients");
      if(toggle != undefined){
        checked = toggle.checked == true ? 0 : 1;
      }*/
      self.$app.preloader.show();
      $.when(self.$app.methods.getDataAPI("clients/GetClients")).then(function( data, textStatus, jqXHR ) {
          self.$app.preloader.hide();
          self.$setState({
                clients: data,
                totalMat:data.length
              }, function(){
                      $("#clients-list .list").empty();
                      $("#clients-list .pagination").remove();
                      //$(".sort").removeClass("asc").removeClass("desc");
                      if(self.clients != null && self.clients.length > 0){
                        
                        var pagination = "<ul class='pagination padding-left-half margin-vertical-half'><ul>";
                        $(pagination).insertAfter($("#clients-list .list"));

                        var isDesktop = self.$app.methods.isDesktop();
                        if(isDesktop){
                          $("#clients-list .data-table").show();
                          $("#clients-list ul.list").remove();
                          for(var i = 0; i < self.clients.length; i++){
                            var row = self.clients[i];
                              var html = "<tr>";
                                html += '<td class="id" style="display:none;">' + row.id + '</td>';
                                html += "<td class='name'>" + row.name + "</td>";
                                html += "<td>" + ((row.phone != "" && row.phone != undefined) ? '<a class="external" target="_system" href="tel:' + row.phone + '"><span class="in-link">' + row.phone + '</span></a>' : "--") + "</td>";
                                html += "<td>" + ((row.email != "" && row.email != undefined) ? '<a class="external" target="_system" href="mailto:' + row.email + '"><span class="in-link">' + row.email + '</span></a>' : "--") + "</td>";
                                
                                var pops = '<a href="#" data-popover=".clients-popover-' + i + '" class="popover-open"><i class="f7-icons">ellipsis_vertical</i></a>'
                                pops += '<div class="popover my-popover clients-popover clients-popover-' + i + '" data-close-on-escape="true" data-backdrop="false">'; 
                                pops += '<div class="popover-angle"></div><div class="popover-inner padding-half">';
                                
                                  //var page_link = row.product_link_id == undefined ? null : row.product_link_id;

                                  pops += '<a class="button popover-close editButton" data-id="' + row.id + '">Edit</a>';
                                  pops += '<a class="button popover-close viewPurchases" data-id="' + row.id + '" data-name="' + row.name + '">View Purchases</a>';
                            
                                  pops += '<a class="button popover-close deleteButton" data-id="' + row.id + '">';
                                  pops += row.status == true ? 'Delete' : 'Activate';
                                  pops += '</a>';
                                  if(row.status == false){
                                    pops += '<a class="button popover-close permDelButton" data-id="' + row.id + '">Delete</a>';
                                  }

                                pops += '</div></div>';
                                html += "<td>" + pops + "</td>";
                              html += "</tr>";
                              $("#clients-list tbody.list").append(html);
                          }
                        }else{
                                $("#clients-list").find(".sortTextPar").removeClass("display-none");
                              $("#clients-list").find(".sort").remove();
                              var sorter = '<span class="sort" data-sort="name">Name</span>';
                              $(sorter).insertAfter($("#clients-list").find(".sortText"));
                              $("#clients-list").find(".sortText").removeClass("display-none");
                              $("#clients-list .data-table").remove();
                              for(var i = 0; i < self.clients.length; i++){
                                var row = self.clients[i];
                                //var letter = row.name.split("")[0];
                                //var nameChip = '<div class="chip bg-color-blue text-color-white" style="font-weight:600;margin-right:5px;"><div class="chip-label">' + letter + '</div></div>';
                                var html = '<li><div class="card myCard"><div class="card-content padding-horizontal-half">';
                                html += '<div class="name cardName">'  + row.name + '</div><div class="id display-none">' + row.id + '</div>';
                                if(row.phone != "" && row.phone != undefined){
                                  html += '<div class=""><span>Contact number: </span><span class="valueName"><a class="external" target="_system" href="tel:' + row.phone + '"><i class="icon f7-icons phone">phone</i><span class="in-link">' + row.phone + '</span></a></span></div>';
                                }
                                if(row.email != "" && row.email != undefined){
                                  html += '<div class=""><span>Email: </span><span class="valueName"><a class="external" target="_system" href="mailto:' + row.email + '"><i class="icon f7-icons envelope">envelope</i><span class="in-link">' + row.email + '</span></a></span></div>';
                                }
                                if(row.address != "" && row.address != undefined){
                                  html += '<div class="display-flex"><div>Address: </div><div class="valueName margin-left-half">' + row.address.split("\n").join("<br>") + '</div></div>';
                                }

                                if(row.birthday != null && row.birthday != 0 && row.birthday != undefined){
                                  html += '<div class="display-flex"><div>Birthday: </div><div class="valueName margin-left-half">' + moment(row.birthday).format("MMMM Do") + '</div></div>';
                                }

                                if(row.otherNotes != "" && row.otherNotes != undefined){
                                  html += '<div class="display-flex"><div>Notes: </div><div class="valueName margin-left-half">' + row.otherNotes.split("\n").join("<br>")  + '</div></div>';
                                }

                                
                                var stat = row.status == true ? "display-none" : "";
                                //html += '<div class=""><span class="labelName">Cost: </span><span class="valueName">' + self.formatMoney(row.cost_per_unit) + '</span></div>';
                                html += '<div class="' + stat + '"><span class="labelName">Status: </span><span class="valueName">Deleted</span></div>';
                                html += '</div><div class="card-footerMine padding-horizontal-half padding-bottom-half"><p class="display-inline-flex no-margin-vertical">';
                                html += '<a class="button button-small button-raised editButton" data-id="' + row.id + '">Edit</a>';
                                html += '<a class="button button-small button-raised viewPurchases" data-id="' + row.id + '" data-name="' + row.name + '">View Purchases</a>';
                                html += '<a class="button button-small button-raised deleteButton" data-id="' + row.id + '">';
                                html +=  row.status == 1 ? 'Delete' : 'Activate'; 
                                html += '</a>';
                                if(row.status == false){
                                  html += '<a class="button button-small button-raised permDelButton" data-id="' + row.id + '">Delete</a>';
                                }
                                html += '</p></div></div>';
                                html += '</li>';
                                $("#clients-list ul.list").append(html);
                                //return html;
                            }
                        }
                        
                        var options = {
                            valueNames: ['id','name'],
                            page: 10,
                            pagination: [{outerWindow:2}]
                        };

                        var clientsList = new List('clients-list', options);

                        $("#clients-list").find(".sort").off("click").on("click", function(){
                          $("#clients-list").find(".sort").find(".asc").remove();
                          $("#clients-list").find(".sort").find(".desc").remove();
                            if($(this).hasClass("asc")){
                              $(this).append("<i class='icon f7-icons asc text-color-red'>arrowtriangle_up_fill</i>");
                            }
                            if($(this).hasClass("desc")){
                              $(this).append("<i class='icon f7-icons desc text-color-red'>arrowtriangle_down_fill</i>");
                            }
                        })
                        //materialList.reIndex();
                          $('#clients-list, .clients-popover').off("click").on('click','.button', function () {
                              var data = $(this).attr("data-id");
                              var name = $(this).attr("data-name");
                              if($(this).hasClass("editButton")){
                                self.openPopUp(data);
                              }
                              if($(this).hasClass("viewPurchases")){
                                self.openPopUpClientSales(data, name);
                              }
                              if($(this).hasClass("deleteButton")){
                                self.DeleteItem(clientsList, data);
                              }
                              if($(this).hasClass("permDelButton")){
                                self.permDeleteItem(clientsList, data);
                              }
                              //return false;
                          });
                        }else{
                          $("#clients-list").find(".sortTextPar").addClass("display-none");
                        }
                      });
              }).catch(function(err){
                self.$app.preloader.hide();
                self.showToast(err, "center");
              });
            }
          },
  on: {
    pageAfterIn: function(e, page) {
        var self = this;
        //trackClientsPage();
      },
      pageInit: function(e, page) {
        var self = this;
        registerUpload();
        $$(".showInactiveClients").on("change", function(){

            self.getData();
        })
        $(".showInactiveClientPurchases").on("change", function(){

          var name = $("#clientName").text();
          var id = $("#clientID").text();
            self.openPopUpClientSales(id, name);
            
        })
        calendarBday = self.$app.calendar.create({
          inputEl: '#client_bday',
          closeOnSelect: true,
          yearSelector: false,
          dateFormat: { month: 'long', day: '2-digit'}
        });
        
        
        var calendarModal = self.$app.calendar.create({
            inputEl: '#demo-calendar-modal-clients',
            openIn: 'customModal',
            rangePicker: true,
            header: true,
            footer: true,
            closeOnSelect: true
        });
        calendarModal.on("closed", function(){

            var days = calendarModal.getValue();
            if(days == undefined){
                return;
            }
            var from = null; var to = null;
            if(days.length == 1){
                from = Date.parse(days[0]);

                from = moment(moment(days[0]).format('LLL')).format();
                days.push(days[0]);
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = Date.parse(date2);

                to = moment(moment(date2).format('LLL')).format();
            }
            else if(days.length > 1){
                //var date1 = days[0];
                //date1.setDate(date1.getDate() + 1);
                from = moment(moment(days[0]).format('LLL')).format();
                var date2 = days[1];
                date2.setDate(date2.getDate() + 1);
                to = moment(moment(date2).format('LLL')).format();
            }else{
              var name = $("#clientName").text();
              var id = $("#clientID").text();
              self.openPopUpClientSales(id, name);
            }
            if(from != null && to != null){
                var checked = true;
                /*var toggle = self.$app.toggle.get(".showInactiveClientPurchases");
                if(toggle != undefined){
                  checked = toggle.checked == true ? 0 : 1;
                }*/

                  var id = $("#clientID").text();
                  var obj = {};
                obj.fromDate = from;
                obj.toDate = to;
                obj.clientID = parseInt(id);
                self.$app.preloader.show();
                $.when(self.$app.methods.postDataAPI("clients/GetClientPurchasesByDate", obj, true)).then(function( data, textStatus, jqXHR ) {
                    self.$app.preloader.hide();
                    self.$setState({
                            totalMatUser:data.length
                        }, function(){
                          var name = $("#clientName").text();
                          self.setDataTablePurchases(data);
                        });
                }).catch((data, textStatus, jqXHR) => {
                console.log(data, textStatus, jqXHR);
                self.$app.preloader.hide();
                self.$app.methods.showToast("An error occurred", "center");
            })
            }
        })  
        self.startPage();
      },
      pageReinit: function(e, page) {
        var self = this;
        $$(".showInactiveClients").on("change", function(){
            self.getData();
        })
        self.getData();
      }
  }

} 

var selectedFile = null;
function registerUpload(){
  //document.getElementById("fileUploadClients").addEventListener("change", handleFile);
  document
      .getElementById("fileUploadClients")
      .addEventListener("change", function(event) {
        selectedFile = event.target.files[0];
        //console.log(selectedFile);
      });

      $(document).on('click', 'a.page', function() {
        $(".page-current .page-content").eq(0).animate({scrollTop:0 }, "fast");
      });
}

function trackClientsPage(){
  try{
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
    'event': 'Pageview',
    'pagePath': 'https://www.mogulsheet.com/clients',
    'pageTitle': 'Clients' //some arbitrary name for the page/state
    });
  }catch(err){
    
  }
}
</script>