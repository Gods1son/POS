<template>
    <div class="page" data-name="sync">
      <div class="navbar">
        <div class="navbar navbar-bg"></div>
        <div class="navbar-inner sliding">
          <div class="left">
            <a href="#" class="link back">
              <i class="icon icon-back"></i>
              <span class="if-not-md">Back</span>
            </a>
          </div>
          <div class="title padding-vertical-half">Sync</div>
          <div class="right">
            <a href="#" class="link icon-only panel-toggle" data-panel="left">
              <i class="icon f7-icons if-not-md">menu</i>
              <i class="icon material-icons if-md">menu</i>
            </a>
          </div>
        </div>
      </div>

       <!--pop up add new product-->
  <div class="popup subscriptionPage popup-tablet-fullscreen">
    <div class="view">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Subscription</div>
            <div class="right">
              <!-- Link to close popup -->
              <a class="link" @click="closeSubscribe()"><i class="icon f7-icons">multiply</i>Close</a>
            </div>
          </div>
        </div>
        <div class="page-content">
          <div class="block margin-half">
            <body>
              <div class="subscriptionStatus text-align-center block margin-half"></div>
              <form id="subscription-form">
                <div class="form-row">
                  <div class="margin-vertical-half">
                    <label for="card-element" class="block-title">Credit or debit card - <b>$5 CAD / Month</b></label>
                  </div>
                  
                  <div id="card-element" class="MyCardElement">
                    <!-- A Stripe Element will be inserted here. -->
                  </div>
              
                  <!-- Used to display form errors. -->
                  <div id="card-errors" role="alert"></div>
                </div>
                <button class="button button-outline button-raised margin-half mainButton paySubs" type="submit">Pay Subscription</button>
                <a class="button button-outline button-raised margin-half color-red display-none cancelSub" @click="cancelSubscription">Cancel Subscription</a>
              </form>
            </body>
          </div>
        </div>
      </div>
    </div>
  
  </div>

  <!--pop up-->

    
      <div class="page-content">
        <div class="signParent">
            <form id="signIn">
                <div class="text-align-center block-title-medium margin-vertical-half">Sign In</div>
                <div class="list no-margin-vertical">
                    
                  <ul>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Email</div>
                        <div class="item-input-wrap signingInput">
                          <input id="emailSign" type="email" name="email" placeholder="Enter Email">
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                    <!--<li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">Username</div>
                          <div class="item-input-wrap signingInput">
                            <input id="usernameSign" type="email" name="email" placeholder="Enter Username">
                            <span class="input-clear-button"></span>
                          </div>
                        </div>
                      </li>-->
                    <li class="item-content item-input">
                      <div class="item-inner no-padding-vertical">
                        <div class="row" style="width: 100%;">
                            <div class="col-50 item-title">Password</div>
                            <div class="col-50 text-align-right text-color-blue text-small" id="showPwdSignIn" @click="showPasswordSignIn()">Show Password</div>
                          </div>
                        <div class="item-input-wrap signingInput">
                          <input id="passwordSign" type="password" name="password" placeholder="Password">
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
                <div class="">
                    <a href="#" class="button button-fill button-outline button-raised margin color-green margin-vertical-half" @click="loginMethodClick()">Log In</a>
                    <a href="#" class="button button-outline button-raised margin button-green margin-vertical-half" @click="showSignUp()">Sign Up</a>
                </div>
                
              </form>

              <div class="display-none syncParentClick">
                <a class="button button-outline button-raised margin-half mainButton planButton" @click="openSubscribe()">Subscription Plan</a>
                  <a class="button button-outline button-raised margin-half button-green syncButton display-none" @click="syncData()">Sync Data With Cloud</a>
                  <a class="button button-outline button-raised margin-half button-fill color-red" @click="logOut()">Log Out</a>
                </div>

             <!--<div class=""><a class="button button-outline button-raised margin button-green" @click="savetest()">Get User</a></div>-->
              
              <form id="signUp" class="display-none">
                <div class="text-align-center block-title-medium margin-vertical-half">Sign Up</div>
                <div class="list no-margin-vertical">
                  <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">Email</div>
                          <div class="item-input-wrap signingInput">
                            <input id="email" type="email" name="email" placeholder="Email">
                            <span class="input-clear-button"></span>
                          </div>
                        </div>
                      </li>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Username</div>
                        <div class="item-input-wrap signingInput">
                          <input id="username" type="text" name="username" placeholder="Username">
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="row" style="width: 100%;">
                          <div class="col-50 item-title">Password</div>
                          <div class="col-50 text-align-right text-color-blue text-small" id="showPwdSignUp" @click="showPasswordSignUp()">Show Password</div>
                        </div>
                        <div class="item-input-wrap signingInput">
                          <input id="password" type="password" name="password" placeholder="Password">
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
                <div class="">
                    <a href="#" class="button button-fill button-outline button-raised margin color-green margin-vertical-half" @click="signUpMethod()">Create Account</a>
                    <a href="#" class="button button-outline button-raised margin button-green margin-vertical-half" @click="showSignIn()">Sign In</a>
                </div>
                
              </form>
            
        </div>
      </div>
    
     
    
    </div>
    </template>
    

    <script>
    //import * as moment from 'moment';
    var dbProducts = null, dbProdIngs = null, dbProdOthers = null, dbSales = null, dbIngs = null, dbRestock = null; 
    var dbSettings = null, dbClients = null, dbExpenses = null, dbAccount = null, failedSync = [];
    var mogulsheetdb;
    var stripe = Stripe('pk_test_51HF82MJnQa72fmbdN8n7SQ1gAJvWYNr9ymOusemg6yAl7YYT9pieujhdx9AAuJ3XPUVfJUg1rgzubCQHjKVMjiMp00L0IhDVPh');
    //import Cloudant from '@cloudant/cloudant';
    //var Cloudant = require('@cloudant/cloudant');
    //moment().format("X")  new Date().getTime()
    export default {
      test: 5,
      data: function () {
          // Must return an object
          return {
            username: null,
            email:null,
            password: null,
            apiKey: "", 
            apiPwd: "",  
            personalApiKey: "",
            personalApiPwd: "",
            personalApiExpires: null,
            cloudURL: "https://fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix.cloudant.com/",
            opts: { live: false, retry: false },
            syncRetries: 0,
            stripeNotActive: true,
            settings: null,
            subscriptionID: null,
            priceId: '',
            settingsID: 'settings',
            backendUrl: 'https://posbackend.herokuapp.com/' //  'https://mogulend.herokuapp.com/'  'http://localhost:3000/'
          }
        },
      methods:{
        openSubscribe: function(){
          var self = this;
          if(self.settings == null){
              mogulsheetdb.get("settings").then(function(doc) {
              self.$setState({
                  settings: doc
                }, function(){
                  if(self.settings.stripeCustomerId == undefined || self.settings.stripeCustomerId == null){
                    self.createStripeCustomer(true);
                  }else{
                    self.createPaymentElement();
                    var popup = self.$app.popup.open('.subscriptionPage', true);
                  }
                  
                  //self.registerStripeSubmit();
                })
              }).catch(() => {
                
              })
          }else{
            if(self.settings.stripeCustomerId == undefined || self.settings.stripeCustomerId == null){
                    self.createStripeCustomer(true);
                  }else{
                    self.createPaymentElement();
                    var popup = self.$app.popup.open('.subscriptionPage', true);
                  }
            //self.registerStripeSubmit();
          }
        },
        registerStripeSubmit: function(card){
          var self = this;
          var form = document.getElementById('subscription-form');
          form.addEventListener('submit', function (ev) {
            ev.preventDefault();
            self.$app.preloader.show();
            // If a previous payment was attempted, get the latest invoice
            var latestInvoicePaymentIntentStatus = localStorage.getItem(
              'latestInvoicePaymentIntentStatus'
            );
            if (latestInvoicePaymentIntentStatus === 'requires_payment_method') {
              var invoiceId = localStorage.getItem('latestInvoiceId');
              var isPaymentRetry = true;
              // create new payment method & retry payment on invoice with new payment method
              self.createPaymentMethod({
                card,
                isPaymentRetry,
                invoiceId,
              });
            } else {
              // create new payment method & create subscription
              self.createPaymentMethod({ card });
            }
          });
        },
        createPaymentMethod: function({ card, isPaymentRetry, invoiceId }){
          var self = this;
          var billingName = $('#name').val();
          billingName = billingName == "" ? self.settings.email : billingName;
          stripe.createPaymentMethod({
              type: 'card',
              card: card,
              billing_details: {
                name: billingName,
              },
            })
            .then((result) => {
              console.log(result);
              if (result.error) {
                displayError(result);
              } else {
                if (isPaymentRetry) {
                  // Update the payment method and retry invoice payment
                  self.retryInvoiceWithNewPaymentMethod({
                    customerId: self.settings.stripeCustomerId,
                    paymentMethodId: result.paymentMethod.id,
                    invoiceId: invoiceId,
                    priceId: self.priceId,
                  });
                } else {
                  // Create the subscription
                  self.createSubscription({
                    customerId: self.settings.stripeCustomerId,
                    paymentMethodId: result.paymentMethod.id,
                    priceId: self.priceId,
                  });
                }
              }
            });
        },
        checkSubscription2: function(){
          var self = this;
          if(self.subscriptionID != null){
            $(".syncButton").removeClass("display-none");
            $(".paySubs").addClass("display-none");
            $(".subscriptionStatus").html("Subscription Status" + '<span class="margin-left-half badge color-green">Active</span>');
            $(".cancelSub").removeClass("display-none");
            return;
          }
          self.$app.preloader.show();
          return (
                fetch(self.backendUrl + 'check-subscription', {
                  method: 'post',
                  headers: {
                    'Content-type': 'application/json',
                  },
                  body: JSON.stringify({
                    customer: self.settings.stripeCustomerId
                  }),
                })
                  .then((response) => {
                    return response.json();
                  })
                  // If the card is declined, display an error to the user.
                  .then((result) => {
                    self.$app.preloader.hide();
                    if (result.error) {
                      // The card had an error when trying to attach it to a customer.
                      throw result;
                    }
                    if(result.length > 0){
                      if(result[0].status == "active"){
                        self.$setState({
                          subscriptionID: result[0].id
                        });
                        $(".syncButton").removeClass("display-none");
                        $(".paySubs").addClass("display-none");
                        $(".subscriptionStatus").html("Subscription Status" + '<span class="margin-left-half badge color-green">Active</span>');
                        $(".cancelSub").removeClass("display-none");
                      }
                    }else{
                      $(".syncButton, .cancelSub").addClass("display-none");
                      $(".paySubs").removeClass("display-none");
                      $(".subscriptionStatus").html("Subscription Status" + '<span class="margin-left-half badge color-red">Inactive</span>');
                    }
                    return result;
                  }).catch(() => {
                    self.$app.preloader.hide();
                  })
          )
        },
        cancelSubscription: function(){
          var self = this;
          self.$app.dialog.confirm("Once you unsubscribe, you have to re-enroll again. Do you want to proceed to unsubscribe?", "Mogul Sheet",
          function(){
            self.cancelSubscriptionFinal();
          }, null)
          
        },
        cancelSubscriptionFinal: function(){
          var self = this;
          return fetch(self.backendUrl + 'cancel-subscription', {
            method: 'post',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              subscriptionId: self.subscriptionID,
            }),
          })
            .then(response => {
              return response.json();
            })
            .then(cancelSubscriptionResponse => {
              console.log("cancel sub", cancelSubscriptionResponse);
              self.$app.dialog.alert("Subscription has been cancelled. We are sad to see you go. We hope to see you again", function(){
                $(".syncButton, .cancelSub").addClass("display-none");
                $(".subscriptionStatus").html("Subscription Status" + '<span class="margin-left-half badge color-red">Inactive</span>');
                self.$setState({
                    subscriptionID: null
                  });
              })
              // Display to the user that the subscription has been cancelled.
            });
        },
        checkSubscription: function(){
          var self = this;
          if(self.stripeNotActive){
            $(".syncButton").removeClass("display-none");
            $(".planButton").addClass("display-none");
            return;
          }
          if(self.settings == null || self.settings.stripeCustomerId == null){
            mogulsheetdb.get("settings").then(function(doc) {
              self.$setState({
                  settings: doc
                }, function(){
                  if(self.settings.stripeCustomerId == undefined || self.settings.stripeCustomerId == null){
                    self.createStripeCustomer();
                  }else{
                    self.checkSubscription2();
                  }
                  
                  //self.registerStripeSubmit();
                })
              }).catch(() => {
                self.createStripeCustomer();
              })
          }else{
            self.checkSubscription2();
          }
          
        },
        createSubscription: function ({ customerId, paymentMethodId, priceId }) {
          var self = this;
          return (
            fetch(self.backendUrl + 'create-subscription', {
              method: 'post',
              headers: {
                'Content-type': 'application/json',
              },
              body: JSON.stringify({
                customerId: customerId,
                paymentMethodId: paymentMethodId,
                priceId: self.priceId,
              }),
            })
              .then((response) => {
                console.log(response);
                return response.json();
              })
              // If the card is declined, display an error to the user.
              .then((result) => {
                if (result.error) {
                  // The card had an error when trying to attach it to a customer.
                  throw result;
                }
                return result;
              })
              // Normalize the result to contain the object returned by Stripe.
              // Add the additional details we need.
              .then((result) => {
                return {
                  paymentMethodId: paymentMethodId,
                  priceId: self.priceId,
                  subscription: result,
                };
              })
              // Some payment methods require a customer to be on session
              // to complete the payment process. Check the status of the
              // payment intent to handle these actions.
              .then(self.handlePaymentThatRequiresCustomerAction)
              // If attaching this card to a Customer object succeeds,
              // but attempts to charge the customer fail, you
              // get a requires_payment_method error.
              .then(self.handleRequiresPaymentMethod)
              // No more actions required. Provision your service for the user.
              .then(self.onSubscriptionComplete)
              .catch((error) => {
                // An error has happened. Display the failure to the user here.
                // We utilize the HTML element we created.
                self.$app.preloader.hide();
                showCardError(error);
              })
          );
        },
        onSubscriptionComplete: function (result) {
          var self = this;
          // Payment was successful.
          if (result.subscription.status === 'active') {
            if(result.subscription.latest_invoice.payment_intent.status == "succeeded"){
              self.$app.preloader.hide();
              self.$setState({
                      subscriptionID: result.subscription.id
                    }, function(){
                      $(".syncButton").removeClass("display-none");
                        $(".subscriptionStatus").html("Subscription Status" + '<span class="margin-left-half badge color-green">Active</span>');
                        $(".cancelSub").removeClass("display-none");
                    });
              self.$app.dialog.alert("Your subscription was successful", function(){
                  self.closeSubscribe();
              })
            }
            //console.log("subscription successful", result);
            // Change your UI to show a success message to your customer.
            // Call your backend to grant access to your service based on
            // `result.subscription.items.data[0].price.product` the customer subscribed to.
          }
        },
        handlePaymentThatRequiresCustomerAction: function ({subscription,invoice,priceId,paymentMethodId,isRetry,}) {
          var self =  this;
          if (subscription && subscription.status === 'active') {
            // Subscription is active, no customer actions required.
            return { subscription, priceId, paymentMethodId };
          }

          // If it's a first payment attempt, the payment intent is on the subscription latest invoice.
          // If it's a retry, the payment intent will be on the invoice itself.
          let paymentIntent = invoice ? invoice.payment_intent : subscription.latest_invoice.payment_intent;

          if (
            paymentIntent.status === 'requires_action' ||
            (isRetry === true && paymentIntent.status === 'requires_payment_method')
          ) {
            return stripe
              .confirmCardPayment(paymentIntent.client_secret, {
                payment_method: paymentMethodId,
              })
              .then((result) => {
                if (result.error) {
                  // Start code flow to handle updating the payment details.
                  // Display error message in your UI.
                  // The card was declined (i.e. insufficient funds, card has expired, etc).
                  throw result;
                } else {
                  if (result.paymentIntent.status === 'succeeded') {
                    // Show a success message to your customer.
                    // There's a risk of the customer closing the window before the callback.
                    // We recommend setting up webhook endpoints later in this guide.
                    return {
                      priceId: self.priceId,
                      subscription: subscription,
                      invoice: invoice,
                      paymentMethodId: paymentMethodId,
                    };
                  }
                }
              })
              .catch((error) => {
                displayError(error);
              });
          } else {
            // No customer action needed.
            return { subscription, priceId, paymentMethodId };
          }
        },
        handleRequiresPaymentMethod: function ({subscription,paymentMethodId,priceId,}) {
          var self = this;
            if (subscription.status === 'active') {
              // subscription is active, no customer actions required.
              return { subscription, priceId, paymentMethodId };
            } else if (
              subscription.latest_invoice.payment_intent.status ===
              'requires_payment_method'
            ) {
              // Using localStorage to manage the state of the retry here,
              // feel free to replace with what you prefer.
              // Store the latest invoice ID and status.
              localStorage.setItem('latestInvoiceId', subscription.latest_invoice.id);
              localStorage.setItem(
                'latestInvoicePaymentIntentStatus',
                subscription.latest_invoice.payment_intent.status
              );
              throw { error: { message: 'Your card was declined.' } };
            } else {
              return { subscription, priceId, paymentMethodId };
            }
          },
          retryInvoiceWithNewPaymentMethod: function ({customerId,paymentMethodId,invoiceId,priceId}) {
            var self = this;  
            return (
                fetch(self.backendUrl + 'retry-invoice', {
                  method: 'post',
                  headers: {
                    'Content-type': 'application/json',
                  },
                  body: JSON.stringify({
                    customerId: customerId,
                    paymentMethodId: paymentMethodId,
                    invoiceId: invoiceId,
                  }),
                })
                  .then((response) => {
                    return response.json();
                  })
                  // If the card is declined, display an error to the user.
                  .then((result) => {
                    if (result.error) {
                      console.log("invoice error", result);
                      // The card had an error when trying to attach it to a customer.
                      throw result;
                    }
                    return result;
                  })
                  // Normalize the result to contain the object returned by Stripe.
                  // Add the additional details we need.
                  .then((result) => {
                    return {
                      // Use the Stripe 'object' property on the
                      // returned result to understand what object is returned.
                      invoice: result,
                      paymentMethodId: paymentMethodId,
                      priceId: self.priceId,
                      isRetry: true,
                    };
                  })
                  // Some payment methods require a customer to be on session
                  // to complete the payment process. Check the status of the
                  // payment intent to handle these actions.
                  .then(self.handlePaymentThatRequiresCustomerAction)
                  // No more actions required. Provision your service for the user.
                  .then(self.onSubscriptionComplete)
                  .catch((error) => {
                    // An error has happened. Display the failure to the user here.
                    // We utilize the HTML element we created.
                    console.log("big error", error);
                    displayError(error);
                  })
              );
            },
          /*cancelSubscription: function () {
            var self = this;
            return fetch(self.backendUrl + 'cancel-subscription', {
              method: 'post',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                subscriptionId: subscriptionId,
              }),
            })
              .then(response => {
                return response.json();
              })
              .then(cancelSubscriptionResponse => {
                console.log("cancel sub", cancelSubscriptionResponse);
                // Display to the user that the subscription has been cancelled.
                self.showToast("subscription has been cancelled", "center");
              });
          },*/
      retrieveCustomerPaymentMethod: function (paymentMethodId) {
        var self = this;
          return fetch(self.backendUrl + 'retrieve-customer-payment-method', {
            method: 'post',
            headers: {
              'Content-type': 'application/json',
            },
            body: JSON.stringify({
              paymentMethodId: paymentMethodId,
            }),
          })
            .then((response) => {
              return response.json();
            })
            .then((response) => {
              console.log("retrieve payment method", response);
              return response;
            });
        },
        closeSubscribe: function(){
          var self = this;
          var popup = self.$app.popup.close('.subscriptionPage', true);
        },
        createPaymentElement: function(){
          var self = this;
          var elements = stripe.elements();
          // Set up Stripe.js and Elements to use in checkout form
          var style = {
            base: {
              color: "#32325d",
              fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
              fontSmoothing: "antialiased",
              fontSize: "16px",
              "::placeholder": {
                color: "#aab7c4"
              }
            },
            invalid: {
              color: "#fa755a",
              iconColor: "#fa755a"
            }
          };

          var cardElement = elements.create("card", { style: style });
          cardElement.mount("#card-element");
          cardElement.on('change', showCardError);
          self.registerStripeSubmit(cardElement);
          self.checkSubscription();
        },
        getUserFromStripe: function(){
          var self = this;
          self.$app.preloader.show();
          return (
                fetch(self.backendUrl + 'getStripeUserByEmail', {
                  method: 'post',
                  headers: {
                    'Content-type': 'application/json',
                  },
                  body: JSON.stringify({
                    email: self.email
                  }),
                })
                  .then((response) => {
                    return response.json();
                  }).then((response) => {
                    self.$app.preloader.hide();
                    return response;
                  }).catch((err) => {
                    self.$app.preloader.hide();
                    console.log("promise 1 err", err);
                  })
          )

        },
        createStripeCustomer: function(open){
          var self = this;
          self.getUserFromStripe().then((res) => {
            if(res.length > 0){
              var allUsers = res;
              var acc = allUsers.filter(x => x.email == self.email);
              if(acc != null){
                var cusID = acc[0].id;
                var saveObj;
                if(self.settings != null){
                  self.settings.stripeCustomerId = cusID;
                  saveObj = self.settings;
                }else{
                  saveObj = {};
                  saveObj._id = "settings";
                  saveObj.stripeCustomerId = cusID;
                }
                mogulsheetdb.put(saveObj).then((doc) => {
                  self.$setState({
                        settings:saveObj
                      }, function(){
                        self.checkSubscription2().then((ret) => {
                          if(open){
                            var popup = self.$app.popup.open('.subscriptionPage', true);
                          }
                        })
                      })
                })

                return;
              }
            }

            self.$app.preloader.show();
            var data = {};
            data.name = self.email;
            data.email = self.email;
            $.ajax({
              url: self.backendUrl + 'createStripeUser',
              headers: {
                  //'Authorization':'Basic xxxxxxxxxxxxx',
                  'Content-Type':'application/json'
              },
              method: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              success: function(customer){
                self.$app.preloader.hide();
                console.log(customer);
                var saveObj;
                if(self.settings != null){
                  self.settings.stripeCustomerId = customer.id;
                  saveObj = self.settings;
                }else{
                  saveObj = {};
                  saveObj._id = "settings";
                  saveObj.stripeCustomerId = customer.id;
                }

                mogulsheetdb.put(saveObj).then((doc) => {
                  self.$setState({
                        settings:saveObj
                      }, function(){
                        self.createPaymentElement();
                        var popup = self.$app.popup.open('.subscriptionPage', true);
                      })
                })
                
              },
              error: function(err){
                //console.log(err);
                self.$app.preloader.hide();
                self.showToast(err.responseJSON.message, "center");
                
              }
            });

          })
          
        },
        showSignUp: function(){
            $("#signUp").removeClass("display-none");
            $("#signIn").addClass("display-none");
        },
        showSignIn: function(){
            $("#signIn").removeClass("display-none");
            $("#signUp").addClass("display-none");
        },
        showPasswordSignIn: function(){
          var cur = $("#passwordSign").attr("type");
          if(cur.toLowerCase() == "password"){
            $("#passwordSign").attr("type", "text");
            $("#showPwdSignIn").text("Hide Password");
          }else{
            $("#passwordSign").attr("type", "password");
            $("#showPwdSignIn").text("Show Password");
          }
        },
        showPasswordSignUp: function(){
          var cur = $("#password").attr("type");
          if(cur.toLowerCase() == "password"){
            $("#password").attr("type", "text");
            $("#showPwdSignUp").text("Hide Password");
          }else{
            $("#password").attr("type", "password");
            $("#showPwdSignUp").text("Show Password");
          }
         
        },
        signUpMethod: function(){
            var self = this;
           var username = $("#signUp").find("#username").val().trim();
           var pwd = $("#signUp").find("#password").val();
           var email = $("#signUp").find("#email").val().trim();
           if(username == "" || pwd == "" || email == ""){
               self.showToast("Please fill all fields", "center");
               return;
           }
           if(pwd.length < 6){
               self.showToast("Your password should be longer than 5 characters", "center");
               return;
           }
           //self.$app.preloader.show();
           var unique = email + username;
           unique = unique.toLowerCase();
           unique = unique.replace(/[^a-z0-9\s]/gi, '').replace(/[_\s]/g, '-');
            //self.checkUsernameUnique(unique);
            self.finalRegister();
        },
        finalRegister: function() {
          var self = this;
          self.$app.preloader.show();
          var username = $("#signUp").find("#username").val().trim();
           var pwd = $("#signUp").find("#password").val();
           var email = $("#signUp").find("#email").val().trim();
           var unique = email;
           unique = unique.toLowerCase();
           unique = unique.replace(/[^a-z0-9\s]/gi, '').replace(/[_\s]/g, '-');
           var data = {};
            data.username = unique;
            data.password = pwd;
            data.user = username;
           $.ajax({
              url: self.backendUrl + 'createUsername',
              headers: {
                  //'Authorization':'Basic xxxxxxxxxxxxx',
                  //'X-CSRF-TOKEN':'xxxxxxxxxxxxxxxxxxxx',
                  'Content-Type':'application/json'
              },
              method: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              success: function(data){
                //console.log(data);
                self.$app.preloader.hide();

                if(data["ok"] == undefined){
                  if(data["name"] != undefined){
                    if(data["name"] == "conflict"){
                      self.showToast("email has been registered before", "center");
                      return;
                    }else{
                      self.showToast(data["name"], "center");
                      return;
                    }
                  }
                  return;
                }else{
                  if(data["ok"] != true){
                    self.showToast("an error occured", "center");
                    return;
                  }
                }
                var key = data.key;
                var pwd2 = data.password;
                var exp = new Date(new Date().getTime() + 30 * 60000).getTime();
                var coded = data.username;
                //console.log(data);
                self.$setState({
                  username: coded, //unique,
                  email: email,
                  password: pwd,
                  personalApiKey: key,
                  personalApiPwd: pwd2,
                  personalApiExpires: exp
                  }, function(){
                      self.saveUserAccount(email, pwd, coded, key, pwd2, exp);
                      self.showSignIn();
                      $("#signIn").addClass("display-none");
                      $(".syncParentClick").removeClass("display-none");
                      self.checkSubscription();
                  })
              },
              error: function(err){
                console.log(err);
                self.$app.preloader.hide();
                //self.showToast(err.responseJSON.message, "center");
              }
            });
        },
        loginMethodClick: function(){
            var self = this;
            var email = $("#emailSign").val().trim();
           var pwd = $("#passwordSign").val();
           //var username = $("#usernameSign").val().trim();
           if(email == "" || pwd == ""){
               self.showToast("Please fill all fields", "center");
               return;
           }
           //var uname = self.username
           self.loginMethod(email, pwd);
           
        },
        openPayPal: function(){
          var self = this;
             /* paypal.Buttons({
              style: {
                  shape: 'pill',
                  color: 'blue',
                  layout: 'vertical',
                  label: 'subscribe',
                  
              },
              createSubscription: function(data, actions) {
                return actions.subscription.create({
                  'plan_id':  'P-80590430LX1227222L44LMXI' // 'P-9MS648585E7816213L436UOY'
                });
              },
              onApprove: function(data, actions) {
                alert(data.subscriptionID);
              }
          }).render('#paypal-button-container');*/
        },
        deleteCurrentSession: function(sessionID, key){
          var self = this;
          self.$app.preloader.show();
          var data = {};
          data.session_id = sessionID;
            //data.session_id = sessionID;
            $.ajax({
              url: self.backendUrl + "logoutSession",
              headers: {
                //'Authorization':'Bearer ' + self.personalApiKey + ":" + self.personalApiPwd,
                  //'X-CSRF-TOKEN':'xxxxxxxxxxxxxxxxxxxx',
                  'Content-Type':'application/json'
              },
              method: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              success: function(data){
                self.$app.preloader.hide();
                self.showToast("Old session cleared", "center");
              },
              error: function(err){
                self.$app.preloader.hide();
              }
            });
        },
        refreshToken: function(email, pd, token){
          var self = this;
          self.$app.preloader.show();
          var data = {};
            data.token = token;
            $.ajax({
              url: self.backendUrl + 'auth/refresh', // 
              headers: {
                'Authorization':'Bearer ' + self.personalApiKey + ":" + self.personalApiPwd,
                  //'X-CSRF-TOKEN':'xxxxxxxxxxxxxxxxxxxx',
                  'Content-Type':'application/json'
              },
              method: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              success: function(data){
                self.$app.preloader.hide();
                var key = data.token;
                if(key != token){
                  self.showToast("Please log in again", "center");
                  self.showSignIn();
                  $("#signIn").removeClass("display-none");
                  $(".syncParentClick").addClass("display-none");
                  return;
                }
                var pwd = data.password;
                var exp = data.expires;
                var us = data.user_id;
                var ob = data.userDBs;
                var usDb = ob[Object.keys(ob)[0]];
                //console.log(usDb);
                var b = usDb.indexOf("$");
                var coded = usDb.substr(b + 1);

                self.$setState({
                  username: coded,
                  email: email,
                  password: pd,
                  personalApiKey: key,
                  personalApiPwd: pwd,
                  personalApiExpires: exp
                  }, function(){
                      self.saveUserAccount(email, pd, coded, key, pwd, exp);
                      self.showSignIn();
                      $("#signIn").addClass("display-none");
                      $(".syncParentClick").removeClass("display-none");
                      self.checkSubscription();
                      //console.log(key + " " + pwd + " " + exp);
                  })
              },
              error: function(err){
                self.$app.preloader.hide();
              }
            });
        },
        loginMethod: function(email, pd){
            var self = this;
            self.$app.preloader.show();
            var data = {};
            var unique = email;
           unique = unique.toLowerCase();
           unique = unique.replace(/[^a-z0-9\s]/gi, '').replace(/[_\s]/g, '-');
            data.username = unique;
            data.password = pd;
            $.ajax({
              url: self.backendUrl + 'loginUsername',
              headers: {
                  //'Authorization':'Basic xxxxxxxxxxxxx',
                  //'X-CSRF-TOKEN':'xxxxxxxxxxxxxxxxxxxx',
                  'Content-Type':'application/json'
              },
              method: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              success: function(data){
                self.$app.preloader.hide();
                //console.log(data);
                if(data["ok"] == undefined){
                  if(data["name"] != undefined){
                    if(data["name"] == "conflict"){
                      self.showToast("email has been registered before", "center");
                      return;
                    }else{
                      self.showToast(data["name"], "center");
                      return;
                    }
                  }
                  return;
                }else{
                  if(data["ok"] != true){
                    self.showToast("an error occured", "center");
                    return;
                  }
                }
                var key = data.key;
                var pwd2 = data.password;
                var exp = new Date(new Date().getTime() + 30 * 60000).getTime();
                var coded = data.username;
                self.$setState({
                  username: coded,
                  email: email,
                  password: pd,
                  personalApiKey: key,
                  personalApiPwd: pwd2,
                  personalApiExpires: exp
                  }, function(){
                      self.saveUserAccount(email, pd, coded, key, pwd2, exp);
                      self.showSignIn();
                      $("#signIn").addClass("display-none");
                      $(".syncParentClick").removeClass("display-none");
                      self.checkSubscription();
                      //console.log(key + " " + pwd + " " + exp + " " + coded);
                  })
              },
              error: function(err){
                //console.log(err);
                self.showToast(err.responseJSON.message, "center");
                self.$app.preloader.hide();
              }
            });
            
        },
        logOut: function(){
          var self = this;
          self.showToast("Logged Out", "center");
            $(".syncParentClick").addClass("display-none");
              $("#passwordSign").val("");
              self.showSignIn();
              dbAccount.get("myAccount").then(function(doc) {
              doc.signedIn = 0;
              doc.apiKey = "";
              doc.apiPwd = "";
              doc.apiExp = 0;
              doc._rev = doc._rev;
              doc._id = doc._id;
              return dbAccount.put(doc);
            }).catch(function(err){
              
            });
            mogulsheetdb.get("settings").then(function(doc) {
                doc.stripeCustomerId = null;
                return mogulsheetdb.put(doc);
              }).then(function(doc2){
                self.$setState({
                  settings:doc2,
                  subscriptionID: null
                })
              })
        },
        logOut1: function(){
            var self = this;
            self.$app.preloader.show();
            var data = {};
            data.username = self.email;
            data.password = self.pwd;
            $.ajax({
              url: self.backendUrl + 'auth/logout',
              headers: {
                  'Authorization':'Bearer ' + self.personalApiKey + ":" + self.personalApiPwd,
                  //'X-CSRF-TOKEN':'xxxxxxxxxxxxxxxxxxxx',
                  'Content-Type':'application/json'
              },
              method: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              success: function(data2){
                self.$app.preloader.hide();
                if(data2.success == "Logged out"){
                  self.showToast("Logged Out", "center");
                  $(".syncParentClick").addClass("display-none");
                    $("#passwordSign").val("");
                    self.showSignIn();
                    dbAccount.get("myAccount").then(function(doc) {
                    doc.signedIn = 0;
                    doc.apiKey = "";
                    doc.apiPwd = "";
                    doc.apiExp = 0;
                    doc._rev = doc._rev;
                    doc._id = doc._id;
                    return dbAccount.put(doc);
                  }).catch(function(err){
                    
                  });
                  mogulsheetdb.get("settings").then(function(doc) {
                      doc.stripeCustomerId = null;
                      return mogulsheetdb.put(doc);
                    }).then(function(doc2){
                      self.$setState({
                        settings:doc2,
                        subscriptionID: null
                      })
                    })
                }
                
              },
              error: function(err){
                self.$app.preloader.hide();
                console.log("err");
                console.log(err);
              }
            })
            
                    

        },
        savetest: function(){
          var self = this;
          self.$app.preloader.show();
          var data = {};
          //data.username = "bobobobocombobo";
          data.username = "bade";
            //data.session_id = sessionID;
            $.ajax({
              url: self.backendUrl + "checkUsername",
              headers: {
                //'Authorization':'Bearer ' + self.personalApiKey + ":" + self.personalApiPwd,
                  //'X-CSRF-TOKEN':'xxxxxxxxxxxxxxxxxxxx',
                  'Content-Type':'application/json'
              },
              method: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              success: function(data){
                self.$app.preloader.hide();
                console.log("success");
                console.log(data.responseText);
                //self.showToast("Old session cleared", "center");
              },
              error: function(err){
                self.$app.preloader.hide();
                console.log("failed");
                console.log(err.responseText);
              }
            });
        },
        checkUsernameUnique: function(user){
          var self = this;
          self.$app.preloader.show();
          var data = {};
          //data.username = "bobobobocombobo";
          data.email = user;
            //data.session_id = sessionID;
            $.ajax({
              url: self.backendUrl + "checkEmailUsername",
              headers: {
                //'Authorization':'Bearer ' + self.personalApiKey + ":" + self.personalApiPwd,
                  //'X-CSRF-TOKEN':'xxxxxxxxxxxxxxxxxxxx',
                  'Content-Type':'application/json'
              },
              method: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              success: function(data){
                self.$app.preloader.hide();
                var res = data.responseText;
                //console.log(res);
                if(res != ""){
                    self.showToast("Username: " + res, "center");
                }else{
                  self.finalRegister();
                }
              },
              error: function(err){
                self.$app.preloader.hide();
                console.log("failed");
                console.log(err);
                var res = err.responseText;
                console.log(res);
                if(res != ""){
                    self.showToast("Username: " + res, "center");
                }else{
                  self.finalRegister();
                }
              }
            });
        },
        saveUserAccount: function(email, pd, us, apiKey, apiPwd, apiExp){
            var self = this;
            dbAccount.get("myAccount").then(function(doc) {
                   doc.username = us;
                    doc.email = email;
                    doc.password = pd;
                    doc.signedIn = 1;
                    doc.apiKey = apiKey;
                    doc.apiPwd = apiPwd;
                    doc.apiExp = apiExp;
                    doc._rev = doc._rev;
                    doc._id = doc._id;
                    return dbAccount.put(doc);
                  }).catch(function(err){
                    var obj = {};
                    obj._id = "myAccount";
                    obj.username = us;
                    obj.password = pd;
                    obj.email = email;
                    obj.signedIn = 1;
                    obj.apiKey = apiKey;
                    obj.apiPwd = apiPwd;
                    obj.apiExp = apiExp;
                    dbAccount.put(obj);
                  });
                
        },
        removeFailedSync: function(db){
          var index = failedSync.indexOf(db);
            if (index > -1) {
              failedSync.splice(index, 1);
            }
        },
        addFailedSync: function(db){
          var index = failedSync.indexOf(db);
            if (index == -1) {
              failedSync.push(db);
            }
        },
        syncDBProducts: function(redirect){
          var self = this;
          var name = self.username;
          self.$app.preloader.show();
          //console.log(name);
          var dbProductsR = new PouchDB(self.cloudURL + 'dbproducts$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });

            dbProducts.sync(dbProductsR, self.opts).on('complete', function (info) {
                  self.showToast("products synced to server", "center");
                  //remove from failed
                  self.removeFailedSync("dbProducts");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBProdIngs(redirect); },1500);
                  }
                }).on('error', function (err) {
                  // handle error
                  //console.log(err);
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbProducts");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBProdIngs(redirect); },1500);
                  }
                })
        },
        syncDBProdIngs: function(redirect){
          var self = this;
          var name = self.username;
          var dbProdIngsR = new PouchDB(self.cloudURL + 'dbprodings$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });
            self.$app.preloader.show();
            dbProdIngs.sync(dbProdIngsR, self.opts).on('complete', function (info) {
                  self.showToast("products ingredients synced to server", "center");
                  //remove from failed
                  self.removeFailedSync("dbProdIngs");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBProdOthers(redirect); },1500);
                  }
                }).on('error', function (err) {
                  // handle error
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbProdIngs");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBProdOthers(redirect); },1500);
                  }
                })
        },
        syncDBProdOthers: function(redirect){
          var self = this;
          var name = self.username;
          var dbProdOthersR = new PouchDB(self.cloudURL + 'dbprodothers$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });
            self.$app.preloader.show();
            dbProdOthers.sync(dbProdOthersR, self.opts).on('complete', function (info) {
                  self.showToast("products custom charges synced to server", "center");
                  //remove from failed
                  self.removeFailedSync("dbProdOthers");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBSales(redirect); },1500);
                  }
                }).on('error', function (err) {
                  // handle error
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbProdOthers");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBSales(redirect); },1500);
                  }
                })
        },
        syncDBSales: function(redirect){
          var self = this;
          var name = self.username;
          var dbSalesR = new PouchDB(self.cloudURL + 'dbsales$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });
            self.$app.preloader.show();
            dbSales.sync(dbSalesR, self.opts).on('complete', function (info) {
                  self.showToast("sales synced to server", "center");
                  //remove from failed
                  self.removeFailedSync("dbSales");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBIngs(redirect); },1500);
                  }
                }).on('error', function (err) {
                  // handle error
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbSales");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBIngs(redirect); },1500);
                  }
                })
        },
        syncDBIngs: function(redirect){
          var self = this;
          var name = self.username;
          var dbIngsR = new PouchDB(self.cloudURL + 'dbings$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });
            self.$app.preloader.show();
            dbIngs.sync(dbIngsR, self.opts).on('complete', function (info) {
                  self.showToast("ingredients synced to server", "center");
                  //remove from failed
                  self.removeFailedSync("dbIngs");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBSettings(redirect); },1500);
                  }
                }).on('error', function (err) {
                  // handle error
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbIngs");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBSettings(redirect); },1500);
                  }
                })
        },
        syncDBSettings: function(redirect){
          var self = this;
          var name = self.username;
          var dbSettingsR = new PouchDB(self.cloudURL + 'dbsettings$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });
            self.$app.preloader.show();
            dbSettings.sync(dbSettingsR, self.opts).on('complete', function (info) {
                  self.showToast("settings synced to server", "center");
                  //remove from failed
                  self.removeFailedSync("dbSettings");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBClients(redirect); },1500);
                  }
                }).on('error', function (err) {
                  // handle error
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbSettings");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBClients(redirect); },1500);
                  }
                })
        },
        syncDBClients: function(redirect){
          var self = this;
          var name = self.username;
          var dbClientsR = new PouchDB(self.cloudURL + 'dbclients$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });
            self.$app.preloader.show();
            dbClients.sync(dbClientsR, self.opts).on('complete', function (info) {
                  self.showToast("clients synced to server", "center");
                  //remove from failed
                  self.removeFailedSync("dbClients");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBExpenses(redirect); },1500);
                  }
                }).on('error', function (err) {
                  // handle error
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbClients");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBExpenses(redirect); },1500);
                  }
                })
        },
        syncDBExpenses: function(redirect){
          var self = this;
          var name = self.username;
          var dbExpensesR = new PouchDB(self.cloudURL + 'dbexpenses$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });
            self.$app.preloader.show();
            dbExpenses.sync(dbExpensesR, self.opts).on('complete', function (info) {
                  self.showToast("expenses synced to server", "center");
                  //remove from failed
                  self.$app.preloader.hide();
                  self.removeFailedSync("dbExpenses");
                  if(redirect){
                    setTimeout(function(){ self.syncDBStocking(redirect); },1500);
                  }

                }).on('error', function (err) {
                  // handle error
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbExpenses");
                  self.$app.preloader.hide();
                  if(redirect){
                    setTimeout(function(){ self.syncDBStocking(redirect); },1500);
                  }
                })
        },
        syncDBStocking: function(redirect){
          var self = this;
          var name = self.username;
          var dbRestockR = new PouchDB(self.cloudURL + 'dbrestock$' + name, { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });
            self.$app.preloader.show();
            dbRestock.sync(dbRestockR, self.opts).on('complete', function (info) {
                  self.showToast("restocking data synced to server", "center");
                  //remove from failed
                  self.$app.preloader.hide();
                  self.removeFailedSync("dbRestock");
                  if(redirect){
                    self.retryFailedSyncs();
                  }

                }).on('error', function (err) {
                  // handle error
                  self.showToast("Error: " + err.error, "center");
                  self.addFailedSync("dbRestock");
                  self.$app.preloader.hide();
                  if(redirect){
                    self.retryFailedSyncs();
                  }
                })
        },
        retryFailedSyncs: function(){
          var self = this;
            if(failedSync.length > 0){
              if(self.syncRetries == 2){
                self.showToast("Sync failed too many times", "center");
                return;
              }
              var num = self.syncRetries;
              num += 1;
              self.$setState({
                  syncRetries: num
                })
              for(var i = 0; i < failedSync.length; i++){
                var db = failedSync[i];
                if(db == "dbProducts"){
                  self.syncDBProducts(false);
                }
                if(db == "dbProdIngs"){
                  self.syncDBProdIngs(false);
                }
                if(db == "dbProdOthers"){
                  self.syncDBProdOthers(false);
                }
                if(db == "dbSales"){
                  self.syncDBSales(false);
                }
                if(db == "dbIngs"){
                  self.syncDBIngs(false);
                }
                if(db == "dbSettings"){
                  self.syncDBSettings(false);
                }
                if(db == "dbClients"){
                  self.syncDBClients(false);
                }
                if(db == "dbExpenses"){
                  self.syncDBExpenses(false);
                }
              }
            }else{
              self.showToast("Sync Completed", "center");
            }
        },
        syncData: function(){
            var self = this;
            trackStartSyncing();
            self.syncSingleData();
            //self.syncDBProducts(true);
        },
        syncSingleData: function(){
          var self = this;
          var name = self.username;
          self.$app.preloader.show();
          //console.log(name);
          var mogulsheetdbR = new PouchDB(self.cloudURL + name + '$db', { //dbclients$bababosscombaba
                    auth: {
                        username:  self.personalApiKey,
                        password:  self.personalApiPwd  
                    },
                    skipSetup: true
            });

            mogulsheetdb.sync(mogulsheetdbR, self.opts).on('complete', function (info) {
                  self.showToast("data synced to server", "center");
                  //remove from failed
                  //self.removeFailedSync("dbProducts");
                  self.$app.preloader.hide();
                }).on('error', function (err) {
                  // handle error
                  //console.log(err);
                  self.showToast("Error: " + err.error + ". Continue syncing", "center");
                  self.$app.preloader.hide();
                  self.syncSingleData();
                })
        },
        syncData2: function(){
            var self = this;
            var url = 'https://' + self.personalApiKey + ":" + self.personalApiPwd +  '@fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix.cloudant.com/';
            var name = self.email;
            var prefix = name.toLowerCase();
            name = prefix.replace(/[^a-z0-9\s]/gi, '').replace(/[_\s]/g, '-');
            var options =  {
              live: true,
              retry: true
            }
            var urlFull = url + "dbproducts$" + name;
            var remoteOptions = {
                fetch: function (url, opts) {
                    //opts.headers.set("Authorization", "Bearer " + token);
                    return PouchDB.fetch(url, opts);
                }
            };
            var syncOptions = {
                live: true,
                retry: true,
                continuous: true,
            };
            //localDb = new PouchDB(localName);
            var remoteDb = new PouchDB(urlFull, remoteOptions);
            remoteDb.allDocs({
            include_docs: true,
            attachments: true
            }).then(function (result) {
            }).catch(function (err) {
            });

        },
        showToast: function(text, position){
            var self = this;
            self.$app.toast.create({
                            text: text,
                            position: position,
                            closeTimeout: 2000,
                            }).open();
        },
        getData: function(){
            var self = this;
            dbAccount.get("myAccount").then(function(doc) {
                   var now = new Date().getTime();
                   var expired = now > doc.apiExp;
                   if(doc.signedIn ==1 && expired){
                    //console.log(doc.email + " " + doc.password + " " + doc.apiKey);
                    //self.refreshToken(doc.email, doc.password, doc.apiKey);
                    self.showSignIn();
                    $("#signIn").removeClass("display-none");
                    $("#signUp").addClass("display-none");
                    $("#emailSign").val(doc.email);
                    $("#passwordSign").val(doc.password);
                    $(".syncParentClick").addClass("display-none");
                    //self.deleteCurrentSession(doc.apiKey, doc.email);
                    return;
                   }
                   if(doc.signedIn == undefined || doc.signedIn == 0){
                    self.showSignIn();
                    $("#signIn").removeClass("display-none");
                    $("#signUp").addClass("display-none");
                    $(".syncParentClick").addClass("display-none");
                    return;
                   }
                   self.showSignIn();
                   //self.$app.preloader.show();
                    $("#signIn").addClass("display-none");
                    $(".syncParentClick").removeClass("display-none");
                    
                    //console.log(doc.username, doc.email);
                    self.$setState({
                      username:doc.username,
                      email:doc.email,
                      password: doc.password,
                      personalApiKey: doc.apiKey,
                      personalApiPwd: doc.apiPwd,
                      personalApiExpires: doc.apiExp
                    }, function(){
                      self.checkSubscription();
                    })
                  }).catch(function(err){
                    self.showSignUp();
                    $("#signIn").addClass("display-none");
                    $("#signUp").removeClass("display-none");
                    $(".syncParentClick").addClass("display-none");
                  });
        },
        startPouch: function(){
          var self = this;
          mogulsheetdb = self.$app.methods.startPouch();
          var id = self.settingsID;
            mogulsheetdb.get(id).then(function(doc) {
                  self.$setState({
                      settings: doc
                    })
              })
          dbAccount = new PouchDB('dbAccount.db');
          dbAccount.createIndex({
                  index: {
                    fields: ['username', 'email']
                  }
                })
          self.getData();
          
          /*
            try{//id,name,unit_size,unit,cost_per_unit,status,created_date
            dbProducts = new PouchDB('products.db');
                dbProdIngs = new PouchDB('product_ingredients.db');
                dbProdOthers = new PouchDB('product_otherMaterials.db');
                dbExpenses = new PouchDB('expenses.db');
                dbSales = new PouchDB('sales.db');
                dbIngs = new PouchDB('ingredients.db');
                dbSettings = new PouchDB('settings.db');
                dbClients = new PouchDB('clients.db');
                dbRestock = new PouchDB('restock.db');
                dbRestock.createIndex({
                  index: {
                    fields: ['name', 'created_date']
                  }
                })
                dbAccount = new PouchDB('dbAccount.db');
                dbExpenses.createIndex({
                  index: {
                    fields: ['created_date', 'name', 'status']
                  }
                })
                dbClients.createIndex({
                  index: {
                    fields: ['name', 'created_date']
                  }
                })
                dbIngs.createIndex({
                  index: {
                    fields: ['name', 'status']
                  }
                })
                dbProdIngs.createIndex({
                  index: {
                    fields: ['productID', 'ingredientID', 'status']
                  }
                })
                dbProdOthers.createIndex({
                  index: {
                    fields: ['productID', 'name', 'status']
                  }
                })
                
                dbProducts.createIndex({
                  index: {
                    fields: ['name', 'status']
                  }
                })
                dbSales.createIndex({
                  index: {
                    fields: ['created_date','parentID', 'product_name', 'isParent', 'buyer_name', 'status']
                  }
                })
                dbAccount.createIndex({
                  index: {
                    fields: ['username', 'email']
                  }
                }).then(function (result) {
                  dbSettings.get("settings").then(function(doc) {
                    self.$setState({
                      settings: doc
                    })
                  });
                  self.getData();
                })
          }catch(err){
                
            }*/
            
        },
        
    },
      on: {
        pageAfterIn: function(e, page) {
        var self = this;
        trackSyncPage();
      },
          pageInit: function(e, page) {
            var self = this;
            self.startPouch();
          },
          pageReinit: function(e, page) {
            
          }
      }
    
    } 

    function trackSyncPage(){
      try{
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
    'event': 'Pageview',
    'pagePath': 'https://www.mogulsheet.com/sync',
    'pageTitle': 'Sync' //some arbitrary name for the page/state
    });
  }catch(err){
    
  }
    }

    function showCardError(event) {
      let displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    }

    function trackStartSyncing(){
      try{
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
    'event': 'Pageview',
    'pagePath': 'https://www.mogulsheet.com/syncingstarted',
    'pageTitle': 'Started Syncing' //some arbitrary name for the page/state
    });
  }catch(err){
    
  }
    }
    </script>