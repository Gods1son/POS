<template>
    <div class="page" data-name="sync">
      <div class="navbar">
        <div class="navbar navbar-bg"></div>
        <div class="navbar-inner sliding">
          <div class="left">
            <a href="#" class="link back">
              <i class="icon icon-back"></i>
              <span class="if-not-md">Back</span>
            </a>
          </div>
          <div class="title padding-vertical-half">Sync</div>
          <div class="right">
            <a href="#" class="link icon-only panel-toggle" data-panel="left">
              <i class="icon f7-icons if-not-md">menu</i>
              <i class="icon material-icons if-md">menu</i>
            </a>
          </div>
        </div>
      </div>

    
      <div class="page-content">
        <div class="signParent">
            <form id="signIn">
                <div class="text-align-center block-title-medium margin-vertical-half">Sign In</div>
                <div class="list no-margin-vertical">
                    
                  <ul>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Email</div>
                        <div class="item-input-wrap signingInput">
                          <input id="emailSign" type="email" name="email" placeholder="Enter Email">
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">Username</div>
                          <div class="item-input-wrap signingInput">
                            <input id="usernameSign" type="email" name="email" placeholder="Enter Username">
                            <span class="input-clear-button"></span>
                          </div>
                        </div>
                      </li>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Password</div>
                        <div class="item-input-wrap signingInput">
                          <input id="passwordSign" type="password" name="password" placeholder="Password">
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
                <div class="">
                    <a href="#" class="button button-fill button-outline button-raised margin color-green margin-vertical-half" @click="loginMethodClick()">Log In</a>
                    <a href="#" class="button button-outline button-raised margin button-green margin-vertical-half" @click="showSignUp()">Sign Up</a>
                </div>
                
              </form>

              <div class="display-none syncParentClick">
                  <a class="button button-outline button-raised margin-half button-green" @click="syncData()">Sync data online</a>
                  <a class="button button-outline button-raised margin-half button-fill color-red" @click="logOut()">Log Out</a>
                </div>

             <!--<div class=""><a class="button button-outline button-raised margin button-green" @click="savetest()">Get User</a></div>-->
              
              <form id="signUp" class="display-none">
                <div class="text-align-center block-title-medium margin-vertical-half">Sign Up</div>
                <div class="list no-margin-vertical">
                  <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title">Email</div>
                          <div class="item-input-wrap signingInput">
                            <input id="email" type="email" name="email" placeholder="Email">
                            <span class="input-clear-button"></span>
                          </div>
                        </div>
                      </li>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Username</div>
                        <div class="item-input-wrap signingInput">
                          <input id="username" type="text" name="username" placeholder="Username">
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-title">Password</div>
                        <div class="item-input-wrap signingInput">
                          <input id="password" type="password" name="password" placeholder="Password">
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
                <div class="">
                    <a href="#" class="button button-fill button-outline button-raised margin color-green margin-vertical-half" @click="signUpMethod()">Create Account</a>
                    <a href="#" class="button button-outline button-raised margin button-green margin-vertical-half" @click="showSignIn()">Sign In</a>
                </div>
                
              </form>
            
        </div>
      </div>
    
     
    
    </div>
    </template>
    <script>
    var dbProducts = null, dbProdIngs = null, dbProdOthers = null, dbSales = null, dbIngs = null, dbSettings = null, dbClients = null, dbExpenses = null, dbAccount = null;
    //import Cloudant from '@cloudant/cloudant';
    //var Cloudant = require('@cloudant/cloudant');
    export default {
      test: 5,
      data: function () {
          // Must return an object
          return {
            username: null,
            email:null,
            password: null,
            apiKey: "apikey-f3d864a4a757454db0036e479dc71dc6",
            apiPwd: "d4ab4d3b1a321b67a8064cfbcce11ba833897e19"
            
          }
        },
      methods:{
        showSignUp: function(){
            $("#signUp").removeClass("display-none");
            $("#signIn").addClass("display-none");
        },
        showSignIn: function(){
            $("#signIn").removeClass("display-none");
            $("#signUp").addClass("display-none");
        },
        signUpMethod: function(){
            var self = this;
            var db = new PouchDB('https://fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix.cloudant.com', 
            {
                auth: {
                    username: self.apiKey,
                    password: self.apiPwd
                },
                skip_setup: true
            }
            );
           var username = $("#signUp").find("#username").val().trim();
           var pwd = $("#signUp").find("#password").val();
           var email = $("#signUp").find("#email").val().trim();
           if(username == "" || pwd == "" || email == ""){
               self.showToast("Please fill all fields", "center");
               return;
           }
           email = email.toLowerCase();
            db.signUp(email, pwd, {
            roles: [email],
            password_scheme: "pbkdf2",
            metadata : {
                email : email,
                //roles: [email]
                }
            }, function (err, response) {
                if (err) {
                    if (err.name === 'conflict') {
                        self.showToast("already exists, choose another username", "center");
                        //self.loginMethod(email, pwd, username);
                    } else if (err.name === 'forbidden') {
                        self.showToast("invalid username", "center");
                    } else {
                        self.showToast(err.message, "center");
                    }
                }else{
                    db.logIn(email, pwd, function (err, response) {
                    if (err) {
                        console.log(err);
                            //self.showToast(err.message, "center");
                        }else{
                            console.log(response);
                            self.saveUserAccount(email, pwd, username);
                            self.showSignIn();
                            $("#signIn").addClass("display-none");
                            $(".syncParentClick").removeClass("display-none");
                            
                                self.$setState({
                                username:username,
                                email:email,
                                password: pwd
                            })
                        }
                    });
                    //console.log(response);
                    //console.log(response);
                   /* self.saveUserAccount(email.toLowerCase(), pwd, username);
                    self.showSignIn();
                    $("#signIn").addClass("display-none");
                    $(".syncParentClick").removeClass("display-none");
                    self.$setState({
                      username:username,
                      email:email.toLowerCase(),
                      password: pwd
                  })*/
                    //self.loginMethod(email, pwd, username);
                }
            });
        },
        loginMethodClick: function(){
            var self = this;
            var email = $("#emailSign").val().trim();
           var pwd = $("#passwordSign").val();
           var username = $("#usernameSign").val().trim();
           if(email == "" || pwd == "" || username == ""){
               self.showToast("Please fill all fields", "center");
               return;
           }
           //var uname = self.username
           self.loginMethod(email, pwd, username);
           
        },
        loginMethod: function(email, pd, us){
            var self = this;
            var db = new PouchDB('https://fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix.cloudant.com', 
            {
                /*auth: {
                    username: self.apiKey,
                    password: self.apiPwd
                },
                skipSetup: true*/
            }
            );
            db.logIn(email.toLowerCase(), pd, function (err, response) {
            if (err) {
                console.log(err);
                    self.showToast(err.message, "center");
                }else{
                    console.log(response);
                    self.saveUserAccount(email, pd, us);
                    self.showSignIn();
                    $("#signIn").addClass("display-none");
                    $(".syncParentClick").removeClass("display-none");
                    dbAccount.get("myAccount").then(function(doc) {
                    doc.signedIn = 1;
                    return dbAccount.put(doc);
                  }).catch(function(err){
                    
                  });
                    self.$setState({
                      username:us,
                      email:email,
                      password: pd
                  })
                }
            });
        },
        logOut: function(){
            var self = this;
            var db = new PouchDB('https://fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix.cloudant.com', 
            {
                auth: {
                    username: self.apiKey,
                    password: self.apiPwd
                },
                skipSetup: true
            }
            );
            db.logOut(function (err, response) {
                if (err) {
                    self.showToast("network error", "center");
                }else{
                    self.showToast("Logged Out", "center");
                    $(".syncParentClick").addClass("display-none");
                    $("#passwordSign").val("");
                    self.showSignIn();
                    dbAccount.get("myAccount").then(function(doc) {
                    doc.signedIn = 0;
                    return dbAccount.put(doc);
                  }).catch(function(err){
                    
                  });

                }
            })


        },
        savetest: function(){
                var self = this;
                var db = new PouchDB('https://fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix.cloudant.com/_users', //bossbosscombossman_dbproducts', 
                {
                   /* auth: {
                        username: "Boss@boss.com", // self.apiKey,
                        password: "Man", //self.apiPwd
                    },*/
                    //skipSetup: true
                }
            );
            db.allDocs({
            include_docs: true,
            attachments: true
            }).then(function (result) {
                console.log(result);
            }).catch(function (err) {
            console.log(err);
            });
        },
        saveUserAccount: function(email, pd, us){
            var self = this;
            dbAccount.get("myAccount").then(function(doc) {
                   // console.log(doc);
                   doc.username = us;
                    doc.email = email;
                    doc.password = pd;
                    doc.signedIn = 1;
                    return dbAccount.put(doc);
                  }).catch(function(err){
                    var obj = {};
                    obj._id = "myAccount";
                    obj.username = us;
                    obj.password = pd;
                    obj.email = email;
                    obj.signedIn = 1;
                    dbAccount.put(obj);
                  });
                
        },
        getUserMethod: function(){
            var self = this;
            var db = new PouchDB('https://fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix.cloudant.com', {
                    auth: {
                        username: self.apiKey,
                        password: self.apiPwd
                    },
                    skipSetup: true
                });
            db.getUser("Boss@boss.com", function (err, response) {
            if (err) {
                if (err.name === 'unauthorized' || err.name === 'forbidden') {
                // name or password incorrect
                } else {
                    console.log(err);
                    }
                }else{
                    console.log(response);
                }
            });
        },
        syncData: function(){
            var self = this;
            var url = 'https://fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix.cloudant.com/';
            var name = self.email + self.username;
            var prefix = name.toLowerCase();
            prefix = prefix.replace(/[^a-z0-9\s]/gi, '').replace(/[_\s]/g, '-');

            var u = "fc06d1ea-7cd0-4ba8-8be9-02ec889ef7bc-bluemix";
            var p = "d05ec632e8fc51febce78dabc7c9ea6ed772e3693c8339ceb7f0f1aab83747e2";
            var db = new PouchDB(url, 
            {
                auth: {
                    username: self.apiKey,
                    password: self.apiPwd
                },
                skipSetup: true
            }
            );
                  db.logIn(u, p, function (err, response) {
                    if (err) {
                            self.showToast(err.message, "center");
                        }else{
                            console.log(response);
                            let options = {
                            live: true,
                            retry: true,
                            //continuous: true,
                            auth: {
                                    username: self.apiKey,
                                    password: self.apiPwd
                                }
                            };
           
                    
                    dbProducts.sync(url + prefix + "_dbproducts", options).on('complete', function () {
                            alert("synced dpProducts");
                    }).on('error', function (err) {
                        alert(err);
                        //console.log("error syncing dpProducts");
                    });

                    dbProdIngs.sync(url + prefix + "_dbprodings", options).on('complete', function () {
                            alert("synced dbProdIngs");
                    }).on('error', function (err) {
                        alert(err);
                        //console.log("error syncing dbProdIngs");
                    });
                    
                    dbProdOthers.sync(url + prefix + "_dbprodothers", options).on('complete', function () {
                            alert("synced dbProdOthers");
                    }).on('error', function (err) {
                        alert(err);
                        //console.log("error syncing dbProdOthers");
                    });
                    
                    dbSales.sync(url + prefix + "_dbsales", options).on('complete', function () {
                            alert("synced dbSales");
                    }).on('error', function (err) {
                        alert(err);
                        //console.log("error syncing dbSales");
                    });
                    
                    dbIngs.sync(url + prefix + "_dbings", options).on('complete', function () {
                            alert("synced dbIngs");
                    }).on('error', function (err) {
                        alert(err);
                        //console.log("error syncing dbIngs");
                    });
                    
                    dbSettings.sync(url + prefix + "_dbsettings", options).on('complete', function () {
                            alert("synced dbSettings");
                    }).on('error', function (err) {
                        //console.log("error syncing dbSettings");
                    });
                    
                    dbClients.sync(url + prefix + "_dbclients", options).on('complete', function () {
                            alert("synced dbClients","center");
                    }).on('error', function (err) {
                        alert(err);
                        //console.log("error syncing dbClients");
                    });

                    dbExpenses.sync(url + prefix + "_dbexpenses", options).on('complete', function () {
                            alert("synced dbExpenses");
                    }).on('error', function (err) {
                        alert(err);
                        //console.log("error syncing dbExpenses");
                    });
                }
            });
            
        },
        showToast: function(text, position){
            var self = this;
            self.$app.toast.create({
                            text: text,
                            position: position,
                            closeTimeout: 2000,
                            }).open();
        },
        getData: function(){
            var self = this;
            dbAccount.get("myAccount").then(function(doc) {
                   // console.log(doc);
                   if(doc.signedIn == undefined || doc.signedIn == 0){
                    self.showSignIn();
                    $("#signIn").removeClass("display-none");
                    $("#signUp").addClass("display-none");
                    $(".syncParentClick").addClass("display-none");
                    return;
                   }
                   self.showSignIn();
                    $("#signIn").addClass("display-none");
                    $(".syncParentClick").removeClass("display-none");
                    self.$setState({
                      username:doc.username,
                      email:doc.email,
                      password: doc.password
                    })
                  }).catch(function(err){
                    self.showSignUp();
                    $("#signIn").removeClass("display-none");
                    $("#signUp").addClass("display-none");
                    $(".syncParentClick").addClass("display-none");
                  });
        },
        startPouch: function(){
          var self = this;
          /*products: "++id,name,cost,status,created_date",
            product_ingredient: "++id,productID,ingredientID,unit_size,cost,status,created_date",
            product_otherMaterials: "++id,productID,name,cost,status,created_date",*/
            //sales: "++id,parentID,product_name,isParent,buyer_name,cost,quantity,tax,total_price,afterTax,amountPaid,isPaid,date_paid,created_date,status",
          try{//id,name,unit_size,unit,cost_per_unit,status,created_date
            if(pdf != undefined){
                dbProducts = new PouchDB('products.db', { adapter: 'cordova-sqlite' });
                dbExpenses = new PouchDB('expenses.db', { adapter: 'cordova-sqlite' });
                dbProdIngs = new PouchDB('product_ingredients.db', { adapter: 'cordova-sqlite' });
                dbProdOthers = new PouchDB('product_otherMaterials.db', { adapter: 'cordova-sqlite' });
                dbSales = new PouchDB('sales.db', { adapter: 'cordova-sqlite' });
                dbIngs = new PouchDB('ingredients.db', { adapter: 'cordova-sqlite' });
                dbSettings = new PouchDB('settings.db', { adapter: 'cordova-sqlite' });
                dbClients = new PouchDB('clients.db', { adapter: 'cordova-sqlite' });
                dbAccount = new PouchDB('dbAccount.db', { adapter: 'cordova-sqlite' });
                dbExpenses.createIndex({
                  index: {
                    fields: ['created_date', 'name', 'status']
                  }
                })
                dbClients.createIndex({
                  index: {
                    fields: ['name', 'created_date']
                  }
                })
                dbIngs.createIndex({
                  index: {
                    fields: ['name', 'status']
                  }
                })
                dbProdIngs.createIndex({
                  index: {
                    fields: ['productID', 'ingredientID', 'status']
                  }
                })
                dbProdOthers.createIndex({
                  index: {
                    fields: ['productID', 'name', 'status']
                  }
                })
                
                dbProducts.createIndex({
                  index: {
                    fields: ['name', 'status']
                  }
                })
                dbSales.createIndex({
                  index: {
                    fields: ['created_date','parentID', 'product_name', 'isParent', 'buyer_name', 'status']
                  }
                })
                dbAccount.createIndex({
                  index: {
                    fields: ['username', 'email']
                  }
                }).then(function (result) {
                  self.getData();
                })
              }
          }catch(err){
                dbProducts = new PouchDB('products.db');
                dbProdIngs = new PouchDB('product_ingredients.db');
                dbProdOthers = new PouchDB('product_otherMaterials.db');
                dbExpenses = new PouchDB('expenses.db');
                dbSales = new PouchDB('sales.db');
                dbIngs = new PouchDB('ingredients.db');
                dbSettings = new PouchDB('settings.db');
                dbClients = new PouchDB('clients.db');
                dbAccount = new PouchDB('dbAccount.db');
                dbExpenses.createIndex({
                  index: {
                    fields: ['created_date', 'name', 'status']
                  }
                })
                dbClients.createIndex({
                  index: {
                    fields: ['name', 'created_date']
                  }
                })
                dbIngs.createIndex({
                  index: {
                    fields: ['name', 'status']
                  }
                })
                dbProdIngs.createIndex({
                  index: {
                    fields: ['productID', 'ingredientID', 'status']
                  }
                })
                dbProdOthers.createIndex({
                  index: {
                    fields: ['productID', 'name', 'status']
                  }
                })
                
                dbProducts.createIndex({
                  index: {
                    fields: ['name', 'status']
                  }
                })
                dbSales.createIndex({
                  index: {
                    fields: ['created_date','parentID', 'product_name', 'isParent', 'buyer_name', 'status']
                  }
                })
                dbAccount.createIndex({
                  index: {
                    fields: ['username', 'email']
                  }
                }).then(function (result) {
                  self.getData();
                })
            }
            
        },
        
    },
      on: {
          pageInit: function(e, page) {
            var self = this;
            self.startPouch();
          },
          pageReinit: function(e, page) {
            
          }
      }
    
    } 
    </script>